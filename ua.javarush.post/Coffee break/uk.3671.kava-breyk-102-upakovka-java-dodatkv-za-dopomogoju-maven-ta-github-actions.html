Кава-брейк #102. Упаковка Java-додатків за допомогою Maven та GitHub Actions
<p>----------------------------------------</p>
Джерело: У цій публікації показано, як створювати робочі процеси, які упаковують програму Java за допомогою Maven, а потім зберігають її як артефакт або публікують у GitHub Packages. За представленим тут ви можете знайти репозиторій з вихід
<p>----------------------------------------</p>
Джерело: <a href="https://dev.to/cvitaa11/packaging-java-apps-with-maven-and-github-actions-4gbn" rel="nofollow" target="_blank">Dev.to</a> У цій публікації показано, як створювати робочі процеси, які упаковують програму Java за допомогою Maven, а потім зберігають її як артефакт або публікують у GitHub Packages. <img data-max-width="800" data-id="e1e0bd30-9ecf-44d1-ab4a-7de4ce2a73f4" alt="Кава-брейк #102.  Упаковка Java-додатків за допомогою Maven та GitHub Actions - 1" src="https://cdn.javarush.com/images/article/e1e0bd30-9ecf-44d1-ab4a-7de4ce2a73f4/800.jpeg" style="width: 800px;">
<h2>Середовище розробки</h2>За представленим тут <a href="https://github.com/cvitaa11/java-spring-demo" rel="nofollow" target="_blank">посиланням</a> ви можете знайти репозиторій з вихідним кодом. Це проста програма Spring Boot, яка витягує імена студентів з бази даних. Програма виконує завантаження за допомогою Spring Initializr. Для залежностей ми додали Spring Web, який використовують для створення веб-додатків із використанням Spring MVC. Цей пакет також використовує Apache Tomcat як вбудований контейнер за умовчанням. Ми також використовували Spring Data JDBC для збереження даних у SQL за допомогою простого JDBC, і PostgreSQL Driver, який дозволяє Java-додаткам підключатися до бази даних Postgres з використанням стандартного, незалежного від бази даних Java коду. Для локальної розробки ми можемо запустити екземпляр Postgres із Docker, використовуючи наступну команду: 
<div class="terminal">
 docker run -d --name postgresDB -p &lt;port&gt;:5432 -e POSTGRES_PASSWORD=&lt;YourPassword&gt;-v /postgresdata:/var/lib/postgresql/data postgres:latest
</div> Spring Boot слід багаторівневою архітектурою, в якій кожен рівень взаємодіє з шаром безпосередньо під або над ним. Ми виконували цю практику і реалізували Controller, Service і Repository всередині нашого додатку та продемонстрували принципи впровадження залежностей. Вихідний код також містить клас <span class="code">StudentConfig</span>який просто вставляє студента в базу даних. Після успішного настроювання середовища розробки та написання деякого коду ми вирішабо перенести нашу роботу в систему керування вихідним кодом, в даному випадку GitHub. Тепер нам потрібно зібрати код та опублікувати його як пакет Maven. Цей процес можна виконати вручну, але ми хотіли б, щоб він виконувався автоматично, коли зміни вносяться у гілку main. Так ми уникнемо ручних завдань під час публікації нової версії. Як і більшість інших речей, цю проблему можна вирішити кількома способами, і ми будемо використовувати два різні підходи. По-перше, ми опублікуємо наш пакет як артефакт складання та зробимо його доступним для завантаження, а при другому підході ми опублікуємо пакет у репозиторії <a href="https://github.com/features/packages" rel="nofollow" target="_blank">GitHub Packages Maven</a> . 
<h2>Зберігання даних робочого процесу у вигляді артефактів</h2>У файлі <span class="code">main.yaml</span> кілька перших рядків повідомляють нам, які події запускають робочий процес. Крім запитів push і pull в основній гілці, ми також додали тег <span class="code">workflow_dispatch</span> , що дозволяє запускати робочий процес вручну. У розділі “Завдання” ми визначабо завдання <span class="code">build</span> , яке запуститься у засобі виконання Ubuntu. Перші два кроки перевіряють основну гілку з GitHub та налаштовують JDK (Java Development Kit). Далі ми створюємо проект та налаштовуємо кеш для Maven: 
<div class="terminal">
 - name: Build Maven project run: | mvn -B package --file pom.xml -Dmaven.test.skip mkdir staging &amp;&amp; cp target/*.jar staging - name: Встановити cache для Maven use: actions/cache@v2 with: path: ~/.m2 key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }} restore-keys: ${{ runner.os }}-m2
</div> Після завершення складання проміжний каталог міститиме створений файл .jar. Кожне завдання в робочому процесі виконується в новому віртуальному середовищі, що означає, що після виконання завдання <span class="code">build</span> ми не можемо отримати доступ до цього середовища і наш файл .jar зникне. Ось де відбувається наш останній крок, який завантажує артефакти з вашого робочого процесу, дозволяючи вам обмінюватися даними між завданнями та зберігати дані після завершення робочого процесу. 
<div class="terminal">
 - name: Persist workflow data як artifacts uses: actions/upload-artifact@v2 with: name: github-actions-artifact path: staging
</div> За умовчанням артефакти, створені робочими процесами, зберігаються протягом 90 днів, а потім автоматично видаляються. Ви можете налаштувати термін зберігання, залежно від типу репозиторію. Коли ви налаштовуєте термін зберігання, він застосовується лише до нових артефактів та не має зворотної сабо до існуючих об'єктів. Артефакти можна знайти на вкладці Actions, якщо натиснути потрібний запуск робочого процесу. <img data-max-width="800" data-id="9a1e97de-47d0-47e4-b1ba-e8d0d68329d5" alt="Кава-брейк #102.  Упаковка Java-додатків за допомогою Maven та GitHub Actions - 2" src="https://cdn.javarush.com/images/article/9a1e97de-47d0-47e4-b1ba-e8d0d68329d5/800.jpeg" style="width: 800px;">
<h2>Публікація у пакетах GitHub</h2>Ви можете налаштувати Apache Maven для публікації пакетів у GitHub Packages та використання пакетів, що зберігаються в GitHub Packages, як залежність у проекті Java. Крім Maven, GitHub Packages пропонує різні реєстри пакетів для часто використовуваних менеджерів пакетів, таких як npm, NuGet, Gradle та RubyGems. Також можна зберігати Docker та інші образи OCI. Завдяки цим функціям ви можете створювати комплексні рішення DevOps і централізувати розробку програмного забезпечення на GitHub. У файлі <span class="code">maven-publish.yaml</span> можна знайти деталі робочого процесу для публікації пакету в GitHub Packages. Як і в попередньому рішенні, ми вказуємо ім'я та події, які запускатимуть робочий процес. Потім у розділі завдань ми вибрали Ubuntu runner як середовище для завдання <span class="code">publish</span>та визначабо дозволи на читання вмісту та запис пакетів. 
<div class="terminal">
 name: Publish Package to GitHub Packages on: push: branches: [main] jobs: publish: runs-on: ubuntu-latest
</div> На наступних кроках ми перевіряємо основну гілку та налаштовуємо JDK з параметром <span class="code">java-version</span> . Останній крок - публікація пакета, для цього йому потрібен особистий токен доступу для автентифікації. PAT – це конфіденційна інформація, і ми не хочемо зберігати її у вигляді простого тексту, тому ми визначабо секрет на рівні репозиторію та отримали до нього доступ як змінне середовище. Для простоти ми пропустабо випробування під час розгортання. 
<div class="terminal">
 - name: Publish package run: mvn --batch-mode deploy -Dmaven.test.skip env: GITHUB_TOKEN: ${{ secrets.TOKEN }}
</div> Перед запуском робочого процесу нам також потрібна одна зміна конфігурації у вихідному коді програми. Всередині файлу <span class="code">pom.xml</span> нам потрібно передати інформацію про керування розповсюдженням пакетів. 
<div class="terminal">
 &lt;project ...&gt; ... &lt;distributionManagement&gt; &lt;repository&gt; &lt;id&gt;github&lt;/id&gt; &lt;name&gt;GitHub Packages&lt;/name&gt; &lt;url&gt;https://maven.pkg.github.com/cvitaa11/java -spring-demo&lt;/url&gt; &lt;/repository&gt; &lt;/distributionManagement&gt; &lt;/project&gt;
</div> Після внесення змін до основної галузі робочий процес запускається автоматично, і ми можемо стежити за виведенням журналу на вкладці Actions на сторінці репозиторію. Коли всі кроки будуть виконані, ми побачимо готовий до використання пакет Maven у нашому репозиторії коду у розділі Packages. <img data-max-width="800" data-id="9cc1b0a3-b3dd-401e-9008-14c91b733d05" alt="Кава-брейк #102.  Упаковка Java-додатків за допомогою Maven та GitHub Actions - 3" src="https://cdn.javarush.com/images/article/9cc1b0a3-b3dd-401e-9008-14c91b733d05/800.jpeg" style="width: 800px;"><img data-max-width="800" data-id="7bae1358-9e09-4c1b-86a9-e8686b7e130d" alt="Кава-брейк #102.  Упаковка Java-додатків за допомогою Maven та GitHub Actions - 4" src="https://cdn.javarush.com/images/article/7bae1358-9e09-4c1b-86a9-e8686b7e130d/800.jpeg" style="width: 800px;">За допомогою цих двох підходів ми успішно вирішабо проблему автоматичної публікації програм Java у вигляді пакетів Maven і продемонстрували використання GitHub Actions та GitHub Packages для створення повного рішення для наскрізної розробки в одному місці.