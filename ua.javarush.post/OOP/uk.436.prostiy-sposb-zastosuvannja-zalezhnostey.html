Простий спосіб застосування залежностей
<p>----------------------------------------</p>
У цій статті я покажу вам, як впроваджувати залежності (DI) у .NET-і Java-додатках. Концепція впровадження залежностей вперше з'явилася в полі зору розробників у 2000 році, коли Роберт Мартін написав статтю "Принципи та патерни проектування
<p>----------------------------------------</p>
<em>Впровадження залежностей або ін'єкція залежностей (Dependency injection, DI) – непроста для розуміння концепція, а її застосування до нових або вже існуючих програм – завдання ще більш заплутане. <a href="https://www.informit.com/articles/article.aspx?p=2302794" target="_blank" rel="nofollow">Джесс Сміт</a> покаже вам, як здійснювати використання залежностей без контейнера застосування мовами програмування C# і Java. </em> <img data-id="2c169f53-7f99-4009-9be7-b2b76c2b9b38" data-max-width="850" alt="Простий спосіб застосування залежностей - 1" src="https://cdn.javarush.com/images/article/2c169f53-7f99-4009-9be7-b2b76c2b9b38/800.jpeg" style="width: 850px;">У цій статті я покажу вам, як впроваджувати залежності (DI) у .NET-і Java-додатках. Концепція впровадження залежностей вперше з'явилася в полі зору розробників у 2000 році, коли Роберт Мартін написав статтю "Принципи та патерни проектування" (пізніше здобули популярність під абревіатурою <a href="https://codegym.cc/groups/posts/698-pjatjh-osnovnihkh-principov-dizayna-klassov-solid-v-java" target="_blank">SOLID</a>). Літера D у SOLID відноситься до інверсії залежностей (Dependency of Inversion, DOI), яку пізніше стали називати впровадженням залежностей. Початкове і найчастіше визначення: інверсія залежностей — це інверсія способу управління залежностями базовим класом. У вихідній статті Мартіна використовувався наступний код, що ілюструє залежність класу <code class=" language-none">Copy</code>від низькорівневого класу <code class=" language-none">WritePrinter</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">void</span></span> <span class="token class-name"><span class="token class-name">Copy</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
	<span class="token punctuation"><span class="token punctuation">{</span></span>
	 <span class="token keyword"><span class="token keyword">int</span></span> c<span class="token punctuation"><span class="token punctuation">;</span></span>
	 <span class="token keyword"><span class="token keyword">while</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>c <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">ReadKeyboard</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">!=</span></span> EOF<span class="token punctuation"><span class="token punctuation">)</span></span>
		<span class="token class-name"><span class="token class-name">WritePrinter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>c<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Перша очевидна проблема: якщо змінити список або типи параметрів методу <code class=" language-none">WritePrinter</code>, потрібно впровадити поновлення скрізь, де є залежність від цього методу. Цей процес підвищує витрати на обслуговування та є потенційним джерелом нових помилок. 
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <td>Цікаво читати про Java? Вступайте до групи <a href="https://codegym.cc/groups/java-developer" target="_blank">Java Developer</a> !</td>
   </tr>
  </tbody>
 </table>
</div>Інша проблема: клас Copy перестає бути потенційним кандидатом повторне використання. Наприклад, що робити, якщо вам потрібно вивести символи, що вводяться з клавіатури, у файл замість принтера? Для цього можна модифікувати клас <code class=" language-none">Copy</code>у такий спосіб (синтаксис мови C++): 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">void</span></span> <span class="token class-name"><span class="token class-name">Copy</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>outputDevice dev<span class="token punctuation"><span class="token punctuation">)</span></span>
	<span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">int</span></span> c<span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">while</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>c <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">ReadKeyboard</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">!=</span></span> EOF<span class="token punctuation"><span class="token punctuation">)</span></span>
		<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>dev <span class="token operator"><span class="token operator">==</span></span> printer<span class="token punctuation"><span class="token punctuation">)</span></span>
			<span class="token class-name"><span class="token class-name">WritePrinter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>c<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token keyword"><span class="token keyword">else</span></span>
			<span class="token class-name"><span class="token class-name">WriteDisk</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>c<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Незважаючи на появу нової залежності <code class=" language-none">WriteDisk</code>, ситуація не покращилася (а скоріше погіршилася), оскільки було порушено інший принцип: "програмні сутності, тобто класи, модулі, функції і так далі, повинні бути відкриті для розширення, але закриті для зміни". Мартін пояснює, що ці нові умовні оператори if/else знижують стабільність та гнучкість коду. Рішення полягає в інверсії залежностей, щоб методи запису та читання залежали від класу <code class=" language-none">Copy</code>. Замість "виштовхування" залежностей вони передаються через конструктор. Перероблений код виглядає так: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Reader</span></span>
	<span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">public</span></span><span class="token operator"><span class="token operator">:</span></span>
		virtual <span class="token keyword"><span class="token keyword">int</span></span> <span class="token class-name"><span class="token class-name">Read</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Writer</span></span>
	<span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">public</span></span><span class="token operator"><span class="token operator">:</span></span>
		virtual <span class="token keyword"><span class="token keyword">void</span></span> <span class="token class-name"><span class="token class-name">Write</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">char</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">void</span></span> <span class="token class-name"><span class="token class-name">Copy</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Reader</span></span><span class="token operator"><span class="token operator">&amp;</span></span> r<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Writer</span></span><span class="token operator"><span class="token operator">&amp;</span></span> w<span class="token punctuation"><span class="token punctuation">)</span></span>
	<span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">int</span></span> c<span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token keyword"><span class="token keyword">while</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>c<span class="token operator"><span class="token operator">=</span></span><span class="token class-name"><span class="token namespace"></span><span class="token class-name"><span class="token namespace"><span class="token namespace">r<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>Read</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">!=</span></span> EOF<span class="token punctuation"><span class="token punctuation">)</span></span>
		<span class="token class-name"><span class="token namespace"></span><span class="token class-name"><span class="token namespace"><span class="token namespace">w<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>Write</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>c<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Тепер клас <code class=" language-none">Copy</code>можна легко використовувати повторно з різними реалізаціями методів класів <code class=" language-none">Reader</code>та <code class=" language-none">Writer</code>. У класу <code class=" language-none">Copy</code>немає жодної інформації про внутрішній устрій типів <code class=" language-none">Reader</code>і <code class=" language-none">Writer</code>завдяки чому можливе їх перевикористання з різними реалізаціями. Але якщо все це здається вам якоюсь абракадаброю, можливо, ситуацію прояснять наведені нижче приклади мовами Java та C#. 
<h3>Приклад мовами Java і C#</h3>Для ілюстрації простоти застосування залежностей без контейнера залежностей, почнемо з простого прикладу, який можна переробити під використання <code class=" language-none">DI</code>всього за кілька кроків. Припустимо, у нас є клас <code class=" language-none">HtmlUserPresentation</code>, який, при виклику його методів, формує HTML-інтерфейс. Ось простий приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">HtmlUserPresentation</span></span> htmlUserPresentation <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">HtmlUserPresentation</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">String</span></span> table <span class="token operator"><span class="token operator">=</span></span> htmlUserPresentation<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">createTable</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>rowTableVals<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token string"><span class="token string">"Login Error Status"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> У будь-якого класу проекту, що використовує цей код, з'являється залежність від класу <code class=" language-none">HtmlUserPresentation</code>, що призводить до вищеописаних проблем зі зручністю використання та обслуговуванням. Відразу напрошується вдосконалення: створення інтерфейсу з сигнатурами всіх <code class=" language-none">HtmlUserPresentation</code>методів, що нині є в класі. Ось приклад цього інтерфейсу: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">interface</span></span> <span class="token class-name"><span class="token class-name">IHtmlUserPresentation</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">String</span></span> <span class="token function"><span class="token function">createTable</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">ArrayList</span></span> rowVals<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">String</span></span> caption<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">String</span></span> <span class="token function"><span class="token function">createTableRow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> tableCol<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token comment"><span class="token comment">// Оставшиеся сигнатуры</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Після створення інтерфейсу модифікуємо клас <code class=" language-none">HtmlUserPresentation</code>для його використання. Повертаючись до створення екземпляра типу <code class=" language-none">HtmlUserPresentation</code>, ми можемо використовувати тип інтерфейсу замість базового: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">IHtmlUserPresentation</span></span> htmlUserPresentation <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">HtmlUserPresentation</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">String</span></span> table <span class="token operator"><span class="token operator">=</span></span> htmlUserPresentation<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">createTable</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>rowTableVals<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token string"><span class="token string">"Login Error Status"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Створення інтерфейсу дозволяє легко використовувати інші реалізації типу <code class=" language-none">IHtmlUserPresentation</code>. Наприклад, якщо ми хочемо протестувати цей тип, то легко можемо замінити базовий тип <code class=" language-none">HtmlUserPresentation</code>іншим типом, під назвою <code class=" language-none">HtmlUserPresentationTest</code>. Виконані досі зміни спрощують тестування, обслуговування та масштабування коду, але нічого не роблять для перевикористання, оскільки всі <code class=" language-none">HtmlUserPresentation</code>класи, що використовують тип, все ще знають про його існування. Щоб прибрати цю пряму залежність, можна передавати інтерфейсний тип <code class=" language-none">IHtmlUserPresentation</code>конструктор (або список параметрів методу) класу або метод, який його використовуватиме: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">UploadFile</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">IHtmlUserPresentation</span></span> htmlUserPresentation<span class="token punctuation"><span class="token punctuation">)</span></span></code></pre> Конструктор <code class=" language-none">UploadFile</code>тепер має доступ до всієї функціональності типу <code class=" language-none">IHtmlUserPresentation</code>, але він нічого не знає про внутрішній пристрій реалізує цей інтерфейс класу. У цьому контексті, використання типу відбувається при створенні екземпляра класу <code class=" language-none">UploadFile</code>. Інтерфейсний тип <code class=" language-none">IHtmlUserPresentation</code>стає перевикористовуваним, передаючи різні реалізації різним класам чи методам, котрим необхідна різна функціональність. 
<h2>Висновок та рекомендації для закріплення матеріалу</h2>Ви дізналися про те, що таке використання залежностей і про те, що класи називаються безпосередньо залежними один від одного тоді, коли один з них створює екземпляр іншого для отримання доступу до функціональності цільового типу. Для розчеплення прямої залежності між двома типами слід створити інтерфейс. Інтерфейс надає типу можливість включати різні реалізації залежно від контексту необхідної функціональності. Завдяки передачі інтерфейсного типу конструктору або методу класу, клас/метод, для якого потрібна функціональність, не знає ніяких подробиць про тип, що реалізує інтерфейс. Через це інтерфейсний тип можна використовувати повторно для різних класів, що вимагають схожого, але з однакового поведінки. 
<ul>
 <li>Щоб поекспериментувати з впровадженням залежностей, перегляньте свій код з одного або декількох додатків і спробуйте переробити базовий тип, що інтенсивно використовується, в інтерфейс.</li>
 <br>
 <li>Змініть класи, що безпосередньо створюють екземпляри цього базового типу, так, щоб вони використовували цей новий інтерфейсний тип і передавали його через конструктор або список параметрів методу класу, який його повинен буде використовувати.</li>
 <br>
 <li>Створіть тестову реалізацію для перевірки цього типу інтерфейсу. Після рефакторингу вашого коду реалізувати <code class=" language-none">DI</code>стане простіше, і ви помітите, наскільки гнучкішим стане ваш додаток у сенсі перевикористання та супроводу.</li>
</ul>
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <th>Що ще почитати?</th>
   </tr>
   <tr>
    <td>
     <p><a href="https://codegym.cc/groups/posts/399-skaz-o-dvukh-iteratorakh-strategii-konkurentnoy-modifikacii-v-java-" target="_blank">Оповідь про двох ітераторів: стратегії конкурентної модифікації в Java</a></p>
     <p><a href="https://codegym.cc/groups/posts/394-mashinnihy-kod-i-bayt-kod-na-kakom-jazihke-govorit-vasha-programma" target="_blank">Машинний код та байт код: якою мовою говорить ваша програма?</a></p></td>
   </tr>
  </tbody>
 </table>
</div>