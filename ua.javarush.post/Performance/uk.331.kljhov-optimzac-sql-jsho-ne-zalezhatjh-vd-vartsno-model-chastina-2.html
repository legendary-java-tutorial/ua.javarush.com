Кльові оптимізації SQL, що не залежать від вартісної моделі. Частина 2
<p>----------------------------------------</p>
Такі ж безглузді є предикати, які (майже) завжди істинні. Як ви можете собі уявити, якщо ви запитуєте: ... бази даних не стануть його фактично виконувати, а просто проігнорують. і саме тому вирішив написати цю статтю. Залишу перевірку цього
<p>----------------------------------------</p>
<a href="https://codegym.cc/groups/posts/292-kljevihe-optimizacii-sql-ne-zavisjajshie-ot-stoimostnoy-modeli" target="_blank">Кльові оптимізації SQL, що не залежать від вартісної моделі. Частина 1</a> <img data-id="88e09c20-415a-46d3-a0c0-1b4259a94383" data-max-width="850" alt="Кльові оптимізації SQL, що не залежать від вартісної моделі.  Частина 2 - 1" src="https://cdn.javarush.com/images/article/88e09c20-415a-46d3-a0c0-1b4259a94383/800.jpeg" style="width: 850px;">
<h2>4. Усунення "безглуздих" предикатів</h2>Такі ж безглузді є предикати, які (майже) завжди істинні. Як ви можете собі уявити, якщо ви запитуєте: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java">SELECT <span class="token operator">*</span> FROM actor <span class="token class-name">WHERE</span> <span class="token number">1</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code></pre> ... бази даних не стануть його фактично виконувати, а просто проігнорують. <a href="https://stackoverflow.com/q/46366684/521799" target="_blank">Я одного разу відповідав на це питання на сайті Stack Overflow</a> і саме тому вирішив написати цю статтю. Залишу перевірку цього як вправу читачеві, але що станеться, якщо предикат трохи менш "безглуздий"? Наприклад: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java">SELECT <span class="token operator">*</span> FROM film <span class="token class-name">WHERE</span> release_year <span class="token operator">=</span> release_year<span class="token punctuation">;</span></code></pre> Чи потрібно справді порівнювати значення із самим собою для кожного рядка? Ні, адже значення, для якого цей предикат буде <em><strong>FALSE</strong></em> , не існує, правда? Але нам все одно треба перевірити це. Хоча предикат не може виявитися рівним <em><strong>FALSE</strong></em> , він цілком може виявитися скрізь рівним <em><strong>NULL</strong></em> , знову ж таки внаслідок тризначної логіки. Стовпець <em><strong>RELEASE_YEAR</strong></em> допускає невизначене значення, і якщо якийсь із рядків <em><strong>RELEASE_YEAR IS NULL</strong></em> , то <em><strong>NULL = NULL</strong></em> дає <em><strong>NULL</strong></em> і рядок необхідно виключити. Отже, запит перетворюється на наступний: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java">SELECT <span class="token operator">*</span> FROM film WHERE release_year IS <span class="token class-name">NOT</span> NULL<span class="token punctuation">;</span></code></pre> Які ж із баз даних це виконують? 
<h3>DB2</h3>Так! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">Explain</span> <span class="token class-name">Plan</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
ID <span class="token operator">|</span> <span class="token class-name">Operation</span>    <span class="token operator">|</span>                   <span class="token class-name">Rows</span> <span class="token operator">|</span> <span class="token class-name">Cost</span>
 <span class="token number">1</span> <span class="token operator">|</span> RETURN       <span class="token operator">|</span>                        <span class="token operator">|</span>   <span class="token number">49</span>
 <span class="token number">2</span> <span class="token operator">|</span>  TBSCAN FILM <span class="token operator">|</span> <span class="token number">1000</span> of <span class="token number">1000</span> <span class="token punctuation">(</span><span class="token number">100.00</span><span class="token operator">%</span><span class="token punctuation">)</span> <span class="token operator">|</span>   <span class="token number">49</span>
<span class="token class-name">Predicate</span> <span class="token class-name">Information</span>
 <span class="token number">2</span> <span class="token operator">-</span> SARG Q1<span class="token punctuation">.</span>RELEASE_YEAR IS NOT NULL</code></pre>
<h3>MySQL</h3>Як не шкода, але MySQL, знову-таки, не відображає предикати в планах виконання, тому з'ясувати, чи здійснює MySQL цю конкретну оптимізацію, трохи важко. Можна здійснити оцінку продуктивності і з'ясувати, чи проводяться якісь масштабні порівняння. Або можна додати індекс: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java">CREATE INDEX i_release_year <span class="token class-name">ON</span> film <span class="token punctuation">(</span>release_year<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> І отримати натомість плани для наступних запитів: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java">SELECT <span class="token operator">*</span> FROM film <span class="token class-name">WHERE</span> release_year <span class="token operator">=</span> release_year<span class="token punctuation">;</span>
SELECT <span class="token operator">*</span> FROM film WHERE release_year IS <span class="token class-name">NOT</span> NULL<span class="token punctuation">;</span></code></pre> Якщо оптимізація працює, то плани обох запитів мають бути приблизно однаковими. Але в даному випадку це не так: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">ID  TABLE  POSSIBLE_KEYS   ROWS  FILTERED  EXTRA
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token number">1</span>   film             <span class="token number">1000</span>  <span class="token number">10.00</span>           <span class="token class-name">Using</span> where

ID  TABLE  POSSIBLE_KEYS   ROWS  FILTERED  EXTRA
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token number">1</span>   film   i_release_year  <span class="token number">1000</span>  <span class="token number">100.00</span>    <span class="token class-name">Using</span> where</code></pre> Як ви можете бачити, два наші запити суттєво різняться у значеннях стовпців <em><strong>POSSIBLE_KEYS</strong></em> та <em><strong>FILTERED</strong></em> . Отже, я ризикну обґрунтовано припустити, що MySQL це не оптимізує. 
<h3>Oracle</h3>Так! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">|</span> <span class="token class-name">Id</span>  <span class="token operator">|</span> <span class="token class-name">Operation</span>         <span class="token operator">|</span> <span class="token class-name">Name</span> <span class="token operator">|</span> <span class="token class-name">Starts</span> <span class="token operator">|</span> <span class="token class-name">E</span><span class="token operator">-</span><span class="token class-name">Rows</span> <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> SELECT STATEMENT  <span class="token operator">|</span>      <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">1</span> <span class="token operator">|</span>  TABLE ACCESS FULL<span class="token operator">|</span> FILM <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">1000</span> <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token class-name">Predicate</span> <span class="token class-name">Information</span> <span class="token punctuation">(</span>identified by operation id<span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
   <span class="token number">1</span> <span class="token operator">-</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token string">"RELEASE_YEAR"</span> IS <span class="token class-name">NOT</span> NULL<span class="token punctuation">)</span></code></pre>
<h3>PostgreSQL</h3>На жаль немає! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java">QUERY PLAN
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token class-name">Seq</span> <span class="token class-name">Scan</span> on film  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.67</span><span class="token number">.50</span> rows<span class="token operator">=</span><span class="token number">5</span> width<span class="token operator">=</span><span class="token number">386</span><span class="token punctuation">)</span>
  <span class="token class-name">Filter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>release_year<span class="token punctuation">)</span><span class="token operator">::</span><span class="token function">integer</span> <span class="token operator">=</span> <span class="token punctuation">(</span>release_year<span class="token punctuation">)</span><span class="token operator">::</span><span class="token function">integer</span><span class="token punctuation">)</span></code></pre> Плани та вартості різні. Зокрема, погляньте на оцінку кардинальності, яка зовсім нікуди не годиться, тоді як цей предикат: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java">SELECT <span class="token operator">*</span> FROM film WHERE release_year IS <span class="token class-name">NOT</span> NULL<span class="token punctuation">;</span></code></pre> дає набагато кращі результати: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java">QUERY PLAN
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token class-name">Seq</span> <span class="token class-name">Scan</span> on film  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.65</span><span class="token number">.00</span> rows<span class="token operator">=</span><span class="token number">1000</span> width<span class="token operator">=</span><span class="token number">386</span><span class="token punctuation">)</span>
  <span class="token class-name">Filter</span><span class="token operator">:</span> <span class="token punctuation">(</span>release_year IS <span class="token class-name">NOT</span> NULL<span class="token punctuation">)</span></code></pre> Облом! 
<h3>SQL Server</h3>Як не дивно, але SQL Server, схоже, також цього не робить: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token operator">|</span><span class="token operator">--</span><span class="token class-name">Table</span> <span class="token class-name">Scan</span><span class="token punctuation">(</span>OBJECT<span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">[</span>film<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> WHERE<span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">[</span>release_year<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span>release_year<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre> Однак на вигляд плану оцінка кардинальності правильна, як і вартості. Але за своїм досвідом роботи з SQL Server я б сказав, що, в даному випадку, ніякої оптимізації не відбувається, оскільки SQL Server відобразив би в плані фактично виконаний предикат (щоб зрозуміти чому, погляньте на приклади обмеження CHECK нижче <em><strong>)</strong></em> . А що ж щодо "безглуздих" предикатів по стовпцям, що не допускають невизначеного значення ( <em><strong>NOT NULL</strong></em> )? Наведене вище перетворення було необхідно лише тому, що <em><strong>RELEASE_YEAR</strong></em> може приймати невизначене значення. Що вийде, якщо виконати той же безглуздий запит, наприклад зі стовпцем <em><strong>FILM_ID</strong></em> ? 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java">SELECT <span class="token operator">*</span> FROM film <span class="token class-name">WHERE</span> film_id <span class="token operator">=</span> film_id</code></pre> Тепер він відповідає відсутності предикату загалом? Або принаймні так має бути. Але чи це так? 
<h3>DB2</h3>Так! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">Explain</span> <span class="token class-name">Plan</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
ID <span class="token operator">|</span> <span class="token class-name">Operation</span>    <span class="token operator">|</span>                   <span class="token class-name">Rows</span> <span class="token operator">|</span> <span class="token class-name">Cost</span>
 <span class="token number">1</span> <span class="token operator">|</span> RETURN       <span class="token operator">|</span>                        <span class="token operator">|</span>   <span class="token number">49</span>
 <span class="token number">2</span> <span class="token operator">|</span>  TBSCAN FILM <span class="token operator">|</span> <span class="token number">1000</span> of <span class="token number">1000</span> <span class="token punctuation">(</span><span class="token number">100.00</span><span class="token operator">%</span><span class="token punctuation">)</span> <span class="token operator">|</span>   <span class="token number">49</span></code></pre> Жодних предикатів взагалі не застосовується і ми обираємо всі фільми. 
<h3>MySQL</h3>Так! (Знову ж таки, обґрунтоване припущення) 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java">ID  TABLE  POSSIBLE_KEYS   ROWS  FILTERED  EXTRA
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token number">1</span>   film                   <span class="token number">1000</span>  <span class="token number">100.00</span></code></pre> Зверніть увагу, що стовпець <em><strong>EXTRA</strong></em> тепер порожній, начебто у нас взагалі немає пропозиції <em><strong>WHERE!</strong></em>
<h3>Oracle</h3>Так! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">|</span> <span class="token class-name">Id</span>  <span class="token operator">|</span> <span class="token class-name">Operation</span>         <span class="token operator">|</span> <span class="token class-name">Name</span> <span class="token operator">|</span> <span class="token class-name">Starts</span> <span class="token operator">|</span> <span class="token class-name">E</span><span class="token operator">-</span><span class="token class-name">Rows</span> <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> SELECT STATEMENT  <span class="token operator">|</span>      <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>  TABLE ACCESS FULL<span class="token operator">|</span> FILM <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">1000</span> <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span></code></pre> Знову ж таки, ніяких предикатів не застосовується. 
<h3>PostgreSQL</h3>Нічого собі, ні! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java">QUERY PLAN
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token class-name">Seq</span> <span class="token class-name">Scan</span> on film  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.67</span><span class="token number">.50</span> rows<span class="token operator">=</span><span class="token number">5</span> width<span class="token operator">=</span><span class="token number">386</span><span class="token punctuation">)</span>
  <span class="token class-name">Filter</span><span class="token operator">:</span> <span class="token punctuation">(</span>film_id <span class="token operator">=</span> film_id<span class="token punctuation">)</span></code></pre> Застосовується фільтр та оцінка кардинальності як і дорівнює 5. Облом! 
<h3>SQL Server</h3>І тут знову ні! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token operator">|</span><span class="token operator">--</span><span class="token class-name">Table</span> <span class="token class-name">Scan</span><span class="token punctuation">(</span>OBJECT<span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">[</span>film<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> WHERE<span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">[</span>film_id<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span>film_id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h2>Резюме</h2>Начебто і проста оптимізація, але вона застосовується аж ніяк не у всіх СУБД, зокрема, як не дивно, не застосовується в SQL Server! 
<div class="table-container">
 <table style="text-align: center">
  <thead>
   <tr>
    <th style="text-align: center">База даних</th>
    <th style="text-align: center">Безглузді, але необхідні предикати (семантика NULL)</th>
    <th style="text-align: center">Безглузді та не потрібні предикати (семантика не NULL)</th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>DB2 LUW 10.5</td>
    <td>Так</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>MySQL 8.0.2</td>
    <td>Ні</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>Oracle 12.2.0.1</td>
    <td>Так</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>PostgreSQL 9.6</td>
    <td>Ні</td>
    <td>Ні</td>
   </tr>
   <tr>
    <td>SQL Server 2014</td>
    <td>Ні</td>
    <td>Ні</td>
   </tr>
  </tbody>
 </table>
</div>
<h2>5. Проекції у підзапитах EXISTS</h2>Що цікаво, про них мене весь час запитують на моєму майстер-класі, де я відстоюю точку зору про те, що <em><strong>SELECT</strong></em> зазвичай до добра не доводить. Питання полягає в тому: чи можна використовувати <em><strong>SELECT *</strong></em> у підзапиті <em><strong>EXISTS</strong></em> ? Наприклад, якщо нам потрібно знайти акторів, які грали у фільмах... 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">SELECT</span> first_name<span class="token punctuation">,</span> last_name
FROM actor a
<span class="token class-name">WHERE</span> EXISTS <span class="token punctuation">(</span>
  SELECT <span class="token operator">*</span> <span class="token operator">--</span> <span class="token class-name">Is</span> <span class="token keyword">this</span> OK<span class="token operator">?</span>
  FROM film_actor fa
  WHERE a<span class="token punctuation">.</span>actor_id <span class="token operator">=</span> fa<span class="token punctuation">.</span>actor_id
<span class="token punctuation">)</span></code></pre> І відповідь... так. Можна, можливо. Зірочка не впливає на запит. Як переконатися у цьому? Розглянемо наступний запит: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token operator">--</span> DB2
SELECT <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span> FROM sysibm<span class="token punctuation">.</span>dual
<span class="token operator">--</span> <span class="token class-name">Oracle</span>
SELECT <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span> FROM dual
<span class="token operator">--</span> <span class="token class-name">PostgreSQL</span><span class="token punctuation">,</span> SQL <span class="token class-name">Server</span>
SELECT <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span>
<span class="token operator">--</span> <span class="token class-name">MySQL</span>
<span class="token class-name">SELECT</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Всі ці бази даних повідомляють про помилку поділу на нуль. Зверніть увагу на цікавий факт: у MySQL, при розподілі на нуль, в результаті ми отримуємо <strong>NULL</strong> , а не помилку, тому нам доводиться виконувати іншу заборонену дію. Тепер, що станеться, якщо ми виконаємо, замість наведених вище, ось такі запити? 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token operator">--</span> DB2
SELECT CASE <span class="token class-name">WHEN</span> EXISTS <span class="token punctuation">(</span>
  SELECT <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span> FROM sysibm<span class="token punctuation">.</span>dual
<span class="token punctuation">)</span> THEN <span class="token number">1</span> ELSE <span class="token number">0</span> END
FROM sysibm<span class="token punctuation">.</span>dual
<span class="token operator">--</span> <span class="token class-name">Oracle</span>
SELECT CASE <span class="token class-name">WHEN</span> EXISTS <span class="token punctuation">(</span>
  SELECT <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span> <span class="token class-name">FROM</span> dual
<span class="token punctuation">)</span> THEN <span class="token number">1</span> ELSE <span class="token number">0</span> END
FROM dual
<span class="token operator">--</span> <span class="token class-name">PostgreSQL</span>
<span class="token class-name">SELECT</span> EXISTS <span class="token punctuation">(</span>SELECT <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">--</span> SQL <span class="token class-name">Server</span>
SELECT CASE <span class="token class-name">WHEN</span> EXISTS <span class="token punctuation">(</span>
  SELECT <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span>
<span class="token punctuation">)</span> THEN <span class="token number">1</span> ELSE <span class="token number">0</span> END
<span class="token operator">--</span> <span class="token class-name">MySQL</span>
<span class="token class-name">SELECT</span> EXISTS <span class="token punctuation">(</span><span class="token class-name">SELECT</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Тепер жодна з баз даних не повертає помилки. Усі вони повертають <em><strong>TRUE</strong></em> або <em><strong>1</strong></em> . Це означає, що жодна з наших баз даних, насправді, не обчислює проекцію (тобто пропозицію <em><strong>SELECT</strong></em> ) підзапиту <em><strong>EXISTS</strong></em> . SQL Server, наприклад, показує наступний план: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token operator">|</span><span class="token operator">--</span><span class="token class-name">Constant</span> <span class="token class-name">Scan</span><span class="token punctuation">(</span>VALUES<span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CASE</span> WHEN <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> THEN <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> ELSE <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> END<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre> Як ви можете бачити, вираз <em><strong>CASE</strong></em> було перетворено на константу, а підзапит було усунено. В інших баз даних підзапит зберігається в плані, а щодо проекції нічого не згадується, так що давайте ще раз поглянемо на план вихідного запиту в Oracle: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">SELECT</span> first_name<span class="token punctuation">,</span> last_name
FROM actor a
<span class="token class-name">WHERE</span> EXISTS <span class="token punctuation">(</span>
  SELECT <span class="token operator">*</span>
  FROM film_actor fa
  WHERE a<span class="token punctuation">.</span>actor_id <span class="token operator">=</span> fa<span class="token punctuation">.</span>actor_id
<span class="token punctuation">)</span></code></pre> План вищенаведеного запиту виглядає так: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">|</span> <span class="token class-name">Id</span>  <span class="token operator">|</span> <span class="token class-name">Operation</span>             <span class="token operator">|</span> <span class="token class-name">Name</span>                    <span class="token operator">|</span> <span class="token class-name">E</span><span class="token operator">-</span><span class="token class-name">Rows</span> <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> SELECT STATEMENT      <span class="token operator">|</span>                         <span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">1</span> <span class="token operator">|</span>  HASH JOIN SEMI       <span class="token operator">|</span>                         <span class="token operator">|</span>    <span class="token number">200</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">2</span> <span class="token operator">|</span>   TABLE ACCESS FULL   <span class="token operator">|</span> ACTOR                   <span class="token operator">|</span>    <span class="token number">200</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span>   INDEX FAST FULL SCAN<span class="token operator">|</span> IDX_FK_FILM_ACTOR_ACTOR <span class="token operator">|</span>   <span class="token number">5462</span> <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token class-name">Predicate</span> <span class="token class-name">Information</span> <span class="token punctuation">(</span>identified by operation id<span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
   <span class="token number">1</span> <span class="token operator">-</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">.</span><span class="token string">"ACTOR_ID"</span><span class="token operator">=</span><span class="token string">"FA"</span><span class="token punctuation">.</span><span class="token string">"ACTOR_ID"</span><span class="token punctuation">)</span>
<span class="token class-name">Column</span> <span class="token class-name">Projection</span> <span class="token class-name">Information</span> <span class="token punctuation">(</span>identified by operation id<span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
   <span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span>#keys<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> LAST_NAME<span class="token punctuation">,</span> FIRST_NAME
   <span class="token number">2</span> <span class="token operator">-</span> <span class="token punctuation">(</span>rowset<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token class-name">A</span><span class="token punctuation">.</span>ACTOR_ID<span class="token punctuation">,</span> FIRST_NAME<span class="token punctuation">,</span> LAST_NAME
   <span class="token number">3</span> <span class="token operator">-</span> FA<span class="token punctuation">.</span>ACTOR_ID</code></pre> Спостерігаємо інформацію про проекцію при <em><strong>Id=3</strong></em> . Насправді ми навіть не звертаємось до таблиці <em><strong>FILM_ACTOR</strong></em> , оскільки нам цього не потрібно. Предикат <em><strong>EXISTS</strong></em> можна виконати за допомогою індексу зовнішнього ключа по одному стовпцю <em><strong>ACTOR_ID</strong></em> – все, що потрібно для цього запиту – незважаючи на те, що ми написали <em><strong>SELECT *</strong></em> . 
<h2>Резюме</h2>На щастя, всі наші бази даних прибирають проекцію з підзапитів <em><strong>EXISTS</strong></em> : 
<div class="table-container">
 <table style="text-align: center">
  <thead>
   <tr>
    <th style="text-align: center">База даних</th>
    <th style="text-align: center">Проекція EXISTS</th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>DB2 LUW 10.5</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>MySQL 8.0.2</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>Oracle 12.2.0.1</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>PostgreSQL 9.6</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>SQL Server 2014</td>
    <td>Так</td>
   </tr>
  </tbody>
 </table>
</div>Залишайтеся з нами, адже на вас чекає <a href="https://codegym.cc/groups/posts/397-kljevihe-optimizacii-sql-ne-zavisjajshie-ot-stoimostnoy-modeli-chastjh-3-" target="_blank">частина 3</a> , в якій ми обговоримо інші кльові оптимізації SQL. 
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <th>Що ще почитати?</th>
   </tr>
   <tr>
    <td>
     <p><a href="https://codegym.cc/groups/posts/273-problemih-s-proizvoditeljhnostjhju-sql-voznikajujshie-iz-za-nenuzhnoy-no-objazateljhnoy-rabotih" target="_blank">Проблеми з продуктивністю SQL, що виникають через "непотрібну, але обов'язкову роботу"</a></p>
     <p><a href="https://codegym.cc/groups/posts/72-kak-praviljhno-nachatjh-razrabotku-pod-subd-oracle" target="_blank">Як правильно розпочати розробку під СУБД Oracle</a></p>
     <p><a href="https://codegym.cc/groups/posts/397-kljevihe-optimizacii-sql-ne-zavisjajshie-ot-stoimostnoy-modeli-chastjh-3-" target="_blank">Кльові оптимізації SQL, що не залежать від вартісної моделі. Частина 3</a></p></td>
   </tr>
  </tbody>
 </table>
</div>