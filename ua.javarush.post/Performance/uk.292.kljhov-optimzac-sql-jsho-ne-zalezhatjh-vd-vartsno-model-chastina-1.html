Кльові оптимізації SQL, що не залежать від вартісної моделі. Частина 1
<p>----------------------------------------</p>
Пропонуємо вам адаптацію статті Лукаса Едера, розраховану на тих, хто має загальне уявлення про бази даних і SQL, а також невеликий практичний досвід роботи з СУБД. – практично стандартний метод оптимізації SQL-запитів у сучасних базах дани
<p>----------------------------------------</p>
<img data-id="8797c98b-90a5-455d-936e-8961fff0f2bc" data-max-width="850" alt="Кльові оптимізації SQL, що не залежать від вартісної моделі.  Частина 1 - 1" src="https://cdn.javarush.com/images/article/8797c98b-90a5-455d-936e-8961fff0f2bc/800.jpeg" style="width: 850px;">Пропонуємо вам адаптацію статті Лукаса Едера, розраховану на тих, хто має загальне уявлення про бази даних і SQL, а також невеликий практичний досвід роботи з СУБД. <a href="https://ru.wikipedia.org/wiki/%D0%9E%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F_%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%BE%D0%B2_%D0%A1%D0%A3%D0%91%D0%94" target="_blank">Вартісна оптимізація</a> – практично стандартний метод оптимізації SQL-запитів у сучасних базах даних. Саме тому настільки складно написати вручну складний алгоритм на <a href="https://en.wikipedia.org/wiki/Third-generation_programming_language" target="_blank">3GL (мовах програмування третього покоління)</a>, продуктивність якого перевищувала б план виконання, що динамічно розраховується, згенерований сучасним оптимізатором. Сьогодні ми не обговорюватимемо вартісну оптимізацію, тобто оптимізацію на основі вартісної моделі бази даних. Ми розглянемо набагато простіші оптимізації. Ті, які можна реалізувати на основі самих лише метаданих (тобто обмежень) і самого запиту. Зазвичай їх реалізація для бази даних – не біном Ньютона, оскільки, у разі, будь-яка оптимізація призведе до кращого плану виконання, незалежно від наявності індексів, обсягів даних, і асиметрії розподілу даних. "Не біном Ньютона" не в сенсі легкості реалізації оптимізації, а в тому, чи це слід робити. Ці оптимізації усувають [для бази даних] непотрібну, додаткову роботу (<a href="https://codegym.cc/groups/posts/273-problemih-s-proizvoditeljhnostjhju-sql-voznikajujshie-iz-za-nenuzhnoy-no-objazateljhnoy-rabotih" target="_blank">на відміну від непотрібної, обов'язкової роботи, про яку я вже писав</a> ). 
<h3>Навіщо ці оптимізації застосовуються?</h3>Більшість із них застосовується для: 
<ul>
 <li>виправлення помилок у запитах;</li>
 <li>забезпечення повторного використання уявлень без фактичного виконання логіки подання базою даних</li>
</ul> У першому випадку, можна було б заявити: "Ну і що, просто візьми, і виправи цей безглуздий SQL-запит". Але нехай першим кине в мене камінь той, кому не доводилося помилятися. Другий випадок особливо цікавий: це дає нам можливість створення складних бібліотек уявлень та табличних функцій, що допускають багаторазове використання у кількох шарах. 
<h3>Використовувані бази даних</h3>У цій статті ми будемо порівнювати 10 SQL-оптимізацій у п'яти найбільш широко використовуваних СУБД ( <a href="http://db-engines.com/en/ranking" target="_blank">згідно з рейтингом баз даних</a> ): 
<ul>
 <li>Oracle 12.2;</li>
 <li>MySQL 8.0.2;</li>
 <li>SQL Server 2014;</li>
 <li>PostgreSQL 9.6;</li>
 <li>DB2 LUW 10.5.</li>
</ul> Інший <a href="https://codegym.cc/groups/posts/251-indeks-pypl-samaja-populjarnaja-subd--oracle-a-firebase-rastjet-pugajujshe-bihstro-" target="_blank">рейтинг</a> майже вторить йому. Як завжди, у цій статті я виконуватиму запити до бази даних <a href="https://www.jooq.org/sakila" target="_blank">Sakila.</a>
<center>
 <img data-id="af419cdc-b676-4f36-a06b-5d79ab9e6eca" data-max-width="710" alt="Кльові оптимізації SQL, що не залежать від вартісної моделі.  Частина 1 - 2" src="https://cdn.javarush.com/images/article/af419cdc-b676-4f36-a06b-5d79ab9e6eca/512.jpeg" style="width: 710px;">
</center> Ось список цих десяти різновидів оптимізації: 
<ol>
 <li>транзитивне замикання;</li>
 <li>неможливі предикати та непотрібні звернення до таблиць;</li>
 <li>усунення JOIN;</li>
 <li>усунення "безглуздих" предикатів;</li>
 <li>проекції у підзапитах EXISTS;</li>
 <li>злиття предикатів;</li>
 <li>доведено порожні множини;</li>
 <li>обмеження CHECK;</li>
 <li>непотрібні рефлексивні сполуки;</li>
 <li>Pushdown предикатів</li>
</ol> Сьогодні ми обговоримо пп. 1-3, у другій частині - 4 і 5, а в частині 3 - 6-10. 
<h3>1. Транзитивне замикання</h3>
<p>Почнемо з чогось простіше: <a href="https://ru.wikipedia.org/wiki/%D0%A2%D1%80%D0%B0%D0%BD%D0%B7%D0%B8%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5_%D0%B7%D0%B0%D0%BC%D1%8B%D0%BA%D0%B0%D0%BD%D0%B8%D0%B5" target="_blank">транзитивного замикання</a> . Це очевидне поняття, застосовне до багатьох математичних операцій, наприклад, оператору рівності. Його можна сформулювати у разі таким чином: якщо A = B і B = C, то A = C.</p> Нескладно, правда? Але це тягне за собою деякі цікаві наслідки для оптимізаторів SQL. Розглянемо приклад. Витягнемо всі фільми з ACTOR_ID = 1: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">SELECT</span> first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">,</span> film_id
FROM actor a
JOIN film_actor fa ON a<span class="token punctuation">.</span>actor_id <span class="token operator">=</span> fa<span class="token punctuation">.</span>actor_id
WHERE a<span class="token punctuation">.</span>actor_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code></pre> Результат наступний: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">FIRST_NAME      LAST_NAME  FILM_ID
PENELOPE        GUINESS    <span class="token number">1</span>
PENELOPE        GUINESS    <span class="token number">23</span>
PENELOPE        GUINESS    <span class="token number">25</span>
PENELOPE        GUINESS    <span class="token number">106</span>
PENELOPE        GUINESS    <span class="token number">140</span>
PENELOPE        GUINESS    <span class="token number">166</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre> Погляньмо тепер на план виконання цього запиту у разі СУБД Oracle: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">|</span> <span class="token class-name">Id</span>  <span class="token operator">|</span> <span class="token class-name">Operation</span>                    <span class="token operator">|</span> <span class="token class-name">Name</span>          <span class="token operator">|</span> <span class="token class-name">Rows</span>  <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> SELECT STATEMENT             <span class="token operator">|</span>               <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>  NESTED LOOPS                <span class="token operator">|</span>               <span class="token operator">|</span>    <span class="token number">19</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">2</span> <span class="token operator">|</span>   TABLE ACCESS BY INDEX ROWID<span class="token operator">|</span> ACTOR         <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">3</span> <span class="token operator">|</span>    INDEX UNIQUE SCAN         <span class="token operator">|</span> PK_ACTOR      <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">4</span> <span class="token operator">|</span>   INDEX RANGE SCAN           <span class="token operator">|</span> PK_FILM_ACTOR <span class="token operator">|</span>    <span class="token number">19</span> <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token class-name">Predicate</span> <span class="token class-name">Information</span> <span class="token punctuation">(</span>identified by operation id<span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
   <span class="token number">3</span> <span class="token operator">-</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">.</span><span class="token string">"ACTOR_ID"</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token number">4</span> <span class="token operator">-</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"FA"</span><span class="token punctuation">.</span><span class="token string">"ACTOR_ID"</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre> Особливо тут цікавим є розділ предикатів. Предикат ACTOR_ID = 1, внаслідок транзитивного замикання застосовується як до таблиці ACTOR, і до таблиці FILM_ACTOR. Якщо: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java">• <span class="token class-name">A</span><span class="token punctuation">.</span>ACTOR_ID <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">(</span>из предиката WHERE<span class="token punctuation">)</span> и…
• <span class="token class-name">A</span><span class="token punctuation">.</span>ACTOR_ID <span class="token operator">=</span> FA<span class="token punctuation">.</span>ACTOR_ID <span class="token punctuation">(</span>из предиката ON<span class="token punctuation">)</span>
  То<span class="token operator">:</span>
• FA<span class="token punctuation">.</span>ACTOR_ID <span class="token operator">=</span> <span class="token number">1</span></code></pre> У разі більш складних запитів, це призводить до деяких дуже приємних результатів. Зокрема, точність оцінок кардинальності суттєво підвищується, оскільки з'являється можливість підбору оцінок на основі конкретного константного значення предикату, а не, наприклад, середньої кількості фільмів за акторами, як у наступному запиті (що повертає такий самий результат): 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">SELECT</span> first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">,</span> film_id
FROM actor a
JOIN film_actor fa ON a<span class="token punctuation">.</span>actor_id <span class="token operator">=</span> fa<span class="token punctuation">.</span>actor_id
<span class="token class-name">WHERE</span> first_name <span class="token operator">=</span> <span class="token string">'PENELOPE'</span>
<span class="token class-name">AND</span> last_name <span class="token operator">=</span> <span class="token string">'GUINESS'</span></code></pre> Його план: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">|</span> <span class="token class-name">Id</span>  <span class="token operator">|</span> <span class="token class-name">Operation</span>                            <span class="token operator">|</span> <span class="token class-name">Name</span>                <span class="token operator">|</span> <span class="token class-name">Rows</span>  <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> SELECT STATEMENT                     <span class="token operator">|</span>                     <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>  NESTED LOOPS                        <span class="token operator">|</span>                     <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">2</span> <span class="token operator">|</span>   TABLE ACCESS BY INDEX ROWID BATCHED<span class="token operator">|</span> ACTOR               <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">3</span> <span class="token operator">|</span>    INDEX RANGE SCAN                  <span class="token operator">|</span> IDX_ACTOR_LAST_NAME <span class="token operator">|</span>     <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">4</span> <span class="token operator">|</span>   INDEX RANGE SCAN                   <span class="token operator">|</span> PK_FILM_ACTOR       <span class="token operator">|</span>    <span class="token number">27</span> <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token class-name">Predicate</span> <span class="token class-name">Information</span> <span class="token punctuation">(</span>identified by operation id<span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
   <span class="token number">2</span> <span class="token operator">-</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">.</span><span class="token string">"FIRST_NAME"</span><span class="token operator">=</span><span class="token string">'PENELOPE'</span><span class="token punctuation">)</span>
   <span class="token number">3</span> <span class="token operator">-</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">.</span><span class="token string">"LAST_NAME"</span><span class="token operator">=</span><span class="token string">'GUINESS'</span><span class="token punctuation">)</span>
   <span class="token number">4</span> <span class="token operator">-</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">.</span><span class="token string">"ACTOR_ID"</span><span class="token operator">=</span><span class="token string">"FA"</span><span class="token punctuation">.</span><span class="token string">"ACTOR_ID"</span><span class="token punctuation">)</span></code></pre> Як можна бачити, оцінка числа рядків таблиці FILM_ACTOR завищена, а оцінка для вкладених циклів (NESTED LOOP) занижена. Ось кілька цікавих значень: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">SELECT</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> FROM film_actor <span class="token class-name">WHERE</span> actor_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">SELECT</span> <span class="token function">avg</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> FROM <span class="token punctuation">(</span>
  <span class="token class-name">SELECT</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> c FROM film_actor GROUP <span class="token class-name">BY</span> actor_id
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Результат: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token number">19</span>
<span class="token number">27.315</span></code></pre> Звідси й виходять оцінки. Якщо база даних знає, що йдеться про ACTOR_ID = 1, може зібрати статистику за кількістю фільмів для <em>цього конкретного актора</em> . Якщо <em>не знає</em> (оскільки стандартний механізм збору статистики не співвідносить FIRST_NAME/LAST_NAME з ACTOR_ID), ми отримаємо середнє число фільмів всім <em>акторів</em> . Проста, несуттєва помилка в даному конкретному випадку, але у складному запиті вона може поширюватися далі, накопичуватися та приводити далі у запиті (вище у плані) до неправильного вибору JOIN. Тому завжди, коли тільки можете, проектуйте свої з'єднання і прості предикати так, що скористатися перевагами транзитивного замикання. Які ще бази даних підтримують цю можливість? 
<h4>DB2</h4>Так! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">Explain</span> <span class="token class-name">Plan</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
ID <span class="token operator">|</span> <span class="token class-name">Operation</span>              <span class="token operator">|</span>                 <span class="token class-name">Rows</span> <span class="token operator">|</span> <span class="token class-name">Cost</span>
 <span class="token number">1</span> <span class="token operator">|</span> RETURN                 <span class="token operator">|</span>                      <span class="token operator">|</span>   <span class="token number">13</span>
 <span class="token number">2</span> <span class="token operator">|</span>  NLJOIN                <span class="token operator">|</span>              <span class="token number">27</span> of <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">13</span>
 <span class="token number">3</span> <span class="token operator">|</span>   FETCH ACTOR          <span class="token operator">|</span>     <span class="token number">1</span> of <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">100.00</span><span class="token operator">%</span><span class="token punctuation">)</span> <span class="token operator">|</span>    <span class="token number">6</span>
 <span class="token number">4</span> <span class="token operator">|</span>    IXSCAN PK_ACTOR     <span class="token operator">|</span>   <span class="token number">1</span> of <span class="token number">200</span> <span class="token punctuation">(</span>   <span class="token number">.50</span><span class="token operator">%</span><span class="token punctuation">)</span> <span class="token operator">|</span>    <span class="token number">0</span>
 <span class="token number">5</span> <span class="token operator">|</span>   IXSCAN PK_FILM_ACTOR <span class="token operator">|</span> <span class="token number">27</span> of <span class="token number">5462</span> <span class="token punctuation">(</span>   <span class="token number">.49</span><span class="token operator">%</span><span class="token punctuation">)</span> <span class="token operator">|</span>    <span class="token number">6</span>
<span class="token class-name">Predicate</span> <span class="token class-name">Information</span>
 <span class="token number">4</span> <span class="token operator">-</span> START <span class="token punctuation">(</span>Q2<span class="token punctuation">.</span>ACTOR_ID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
      STOP <span class="token punctuation">(</span>Q2<span class="token punctuation">.</span>ACTOR_ID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
 <span class="token number">5</span> <span class="token operator">-</span> START <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">=</span> Q1<span class="token punctuation">.</span>ACTOR_ID<span class="token punctuation">)</span>
      STOP <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">=</span> Q1<span class="token punctuation">.</span>ACTOR_ID<span class="token punctuation">)</span></code></pre> До речі, якщо вам подобаються круті плани виконання на зразок цього, скористайтеся сценарієм <a href="http://use-the-index-luke.com/s/last_explained" target="_blank">Маркуса Вінанда (Markus Winand)</a> . 
<h4>MySQL</h4>На жаль, плани виконання MySQL погано підходять для такого аналізу. У інформації, що виводиться, відсутній сам предикат: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java">ID  SELECT TYPE  TABLE  TYPE   REF    ROWS
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token number">1</span>   SIMPLE       a      <span class="token keyword">const</span>  <span class="token keyword">const</span>  <span class="token number">1</span>
<span class="token number">1</span>   SIMPLE       fa     ref    <span class="token keyword">const</span>  <span class="token number">19</span></code></pre> Але те що, що у стовпці REF двічі зазначено const показує, що у обох таблицях йде пошук за константним значенням. У той же час план запиту з FIRST_NAME / LAST_NAME виглядає таким чином: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java">ID  SELECT TYPE  TABLE  TYPE   REF         ROWS
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token number">1</span>   SIMPLE       a      ref    <span class="token keyword">const</span>       <span class="token number">3</span>
<span class="token number">1</span>   SIMPLE       fa     ref    a<span class="token punctuation">.</span>actor_id  <span class="token number">27</span></code></pre> І, як ви можете бачити, в REF тепер вказано посилання на стовпець із предикату JOIN. Оцінка кардинальності практично така сама, як у Oracle. Так що так, MySQL також підтримує транзитивне замикання. 
<h4>PostgreSQL</h4>Так! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">QUERY PLAN
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token class-name">Nested</span> <span class="token class-name">Loop</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">4.49</span><span class="token punctuation">.</span><span class="token number">.40</span><span class="token number">.24</span> rows<span class="token operator">=</span><span class="token number">27</span> width<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
  <span class="token operator">-&gt;</span>  <span class="token class-name">Seq</span> <span class="token class-name">Scan</span> on actor a  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.4</span><span class="token number">.50</span> rows<span class="token operator">=</span><span class="token number">1</span> width<span class="token operator">=</span><span class="token number">17</span><span class="token punctuation">)</span>
        <span class="token class-name">Filter</span><span class="token operator">:</span> <span class="token punctuation">(</span>actor_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token operator">-&gt;</span>  <span class="token class-name">Bitmap</span> <span class="token class-name">Heap</span> <span class="token class-name">Scan</span> on film_actor fa  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">4.49</span><span class="token punctuation">.</span><span class="token number">.35</span><span class="token number">.47</span> rows<span class="token operator">=</span><span class="token number">27</span> width<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token class-name">Recheck</span> <span class="token class-name">Cond</span><span class="token operator">:</span> <span class="token punctuation">(</span>actor_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token operator">-&gt;</span>  <span class="token class-name">Bitmap</span> <span class="token class-name">Index</span> <span class="token class-name">Scan</span> on film_actor_pkey  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.4</span><span class="token number">.48</span> rows<span class="token operator">=</span><span class="token number">27</span> width<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token class-name">Index</span> <span class="token class-name">Cond</span><span class="token operator">:</span> <span class="token punctuation">(</span>actor_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span></code></pre>
<h4>SQL Server</h4>Так! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token operator">|</span><span class="token operator">--</span><span class="token class-name">Nested</span> <span class="token class-name">Loops</span><span class="token punctuation">(</span><span class="token class-name">Inner</span> <span class="token class-name">Join</span><span class="token punctuation">)</span>
     <span class="token operator">|</span><span class="token operator">--</span><span class="token class-name">Nested</span> <span class="token class-name">Loops</span><span class="token punctuation">(</span><span class="token class-name">Inner</span> <span class="token class-name">Join</span><span class="token punctuation">)</span>
     <span class="token operator">|</span>    <span class="token operator">|</span><span class="token operator">--</span><span class="token class-name">Index</span> <span class="token class-name">Seek</span> <span class="token punctuation">(</span>SEEK<span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>actor_id<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token operator">|</span>    <span class="token operator">|</span><span class="token operator">--</span>RID <span class="token class-name">Lookup</span>
     <span class="token operator">|</span><span class="token operator">--</span><span class="token class-name">Index</span> <span class="token class-name">Seek</span> <span class="token punctuation">(</span>SEEK<span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">[</span>fa<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>actor_id<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h4>Резюме</h4>Усі наші бази даних підтримують транзитивне замикання. 
<div class="table-container">
 <table align="center">
  <tbody>
   <tr>
   </tr>
  </tbody>
  <thead>
   <tr>
    <th>База даних</th>
    <th>Транзитивне замикання</th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>DB2 LUW 10.5</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>MySQL 8.0.2</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>Oracle 12.2.0.1</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>PostgreSQL 9.6</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>SQL Server 2014</td>
    <td>Так</td>
   </tr>
  </tbody>
 </table>
</div> Проте зачекайте №6 у наступній частині статті. Існують складні випадки транзитивного замикання, із якими справляються в повному обсязі бази даних. 
<h2>2. Неможливі предикати та непотрібні звернення до таблиць</h2>Ця зовсім безглузда оптимізація, але чому б і ні? Якщо користувачі пишуть неможливі предикати, то навіщо їх виконувати? Ось кілька прикладів: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token operator">--</span> <span class="token string">"Очевидный"</span>
SELECT <span class="token operator">*</span> FROM actor <span class="token class-name">WHERE</span> <span class="token number">1</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token operator">--</span> <span class="token string">"Хитрый"</span>
SELECT <span class="token operator">*</span> FROM actor <span class="token class-name">WHERE</span> NULL <span class="token operator">=</span> NULL</code></pre> Перший запит, очевидно, ніколи не поверне жодних результатів, але те саме твердження справедливе і щодо другого. Адже хоча NULL IS NULL завжди TRUE, результат обчислення NULL = NULL дорівнює NULL, що, згідно з <a href="https://ru.wikipedia.org/wiki/%D0%A2%D1%80%D0%BE%D0%B8%D1%87%D0%BD%D0%B0%D1%8F_%D0%BB%D0%BE%D0%B3%D0%B8%D0%BA%D0%B0" target="_blank">тризначною логікою</a> , еквівалентно FALSE. Це не вимагає особливих пояснень, тому перейдемо відразу до з'ясування, які з баз даних виконують таку оптимізацію. 
<h4>DB2</h4>Так! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">Explain</span> <span class="token class-name">Plan</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
ID <span class="token operator">|</span> <span class="token class-name">Operation</span>      <span class="token operator">|</span>   <span class="token class-name">Rows</span> <span class="token operator">|</span> <span class="token class-name">Cost</span>
 <span class="token number">1</span> <span class="token operator">|</span> RETURN         <span class="token operator">|</span>        <span class="token operator">|</span>    <span class="token number">0</span>
 <span class="token number">2</span> <span class="token operator">|</span>  TBSCAN GENROW <span class="token operator">|</span> <span class="token number">0</span> of <span class="token number">0</span> <span class="token operator">|</span>    <span class="token number">0</span></code></pre> Як можна побачити, звернення до таблиці ACTOR повністю виключено з плану. У ньому є тільки операція GENROW, що генерує нуль рядків. Ідеально. 
<h4>MySQL</h4>Так! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java">ID  SELECT TYPE  TABLE   EXTRAS
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token number">1</span>   SIMPLE         <span class="token class-name">Impossible</span> WHERE</code></pre> На цей раз, MySQL був настільки люб'язний, що повідомив нам про неможливу пропозицію WHERE. Дякую! Це полегшує аналіз, особливо проти іншими базами даних. 
<h4>Oracle</h4>Так! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token operator">|</span> <span class="token class-name">Id</span>  <span class="token operator">|</span> <span class="token class-name">Operation</span>          <span class="token operator">|</span> <span class="token class-name">Name</span>  <span class="token operator">|</span> <span class="token class-name">Starts</span> <span class="token operator">|</span> <span class="token class-name">E</span><span class="token operator">-</span><span class="token class-name">Rows</span> <span class="token operator">|</span> <span class="token class-name">A</span><span class="token operator">-</span><span class="token class-name">Rows</span> <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> SELECT STATEMENT   <span class="token operator">|</span>       <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>        <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">*</span>  <span class="token number">1</span> <span class="token operator">|</span>  FILTER            <span class="token operator">|</span>       <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>        <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">2</span> <span class="token operator">|</span>   TABLE ACCESS FULL<span class="token operator">|</span> ACTOR <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span>    <span class="token number">200</span> <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token class-name">Predicate</span> <span class="token class-name">Information</span> <span class="token punctuation">(</span>identified by operation id<span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
   <span class="token number">1</span> <span class="token operator">-</span> <span class="token function">filter</span><span class="token punctuation">(</span>NULL IS <span class="token class-name">NOT</span> NULL<span class="token punctuation">)</span></code></pre> Бачимо, що в плані, як і раніше, згадується звернення до таблиці ACTOR, причому очікуване число рядків, як і раніше, 200, але є і операція фільтрації (FILTER) при Id=1, де ніколи не буде TRUE. В силу нелюбові Oracle до <a href="https://community.oracle.com/ideas/2633" target="_blank">стандартного булевого типу даних SQL</a> Oracle відображає в плані NULL IS NOT NULL, замість простого FALSE. Але якщо серйозно, стежте за цим предикатом. Мені траплялося налагоджувати плани виконання з піддеревами в 1000 рядків і вкрай високими значеннями вартості і лише постфактум виявляти, що все це дерево "відсікалося" фільтром NULL IS NOT NULL. Трохи бентежить, скажу я вам. 
<h4>PostgreSQL</h4>Так! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java">QUERY PLAN
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token class-name">Result</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.0</span><span class="token number">.00</span> rows<span class="token operator">=</span><span class="token number">0</span> width<span class="token operator">=</span><span class="token number">228</span><span class="token punctuation">)</span>
  <span class="token class-name">One</span><span class="token operator">-</span><span class="token class-name">Time</span> <span class="token class-name">Filter</span><span class="token operator">:</span> <span class="token boolean">false</span></code></pre> Вже краще. Жодного докучливого звернення до таблиці ACTOR і маленький акуратний предикат FALSE. 
<h4>SQL Server?</h4>Так! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token operator">|</span><span class="token operator">--</span><span class="token class-name">Constant</span> <span class="token class-name">Scan</span></code></pre> SQL Server називає це " <em><strong>константним</strong></em> переглядом", тобто переглядом, при якому нічого не відбувається - аналогічно DB2. Всі наші бази даних можуть виключати неможливі предикати: 
<div class="table-container">
 <table>
  <thead>
   <tr>
    <th>База даних</th>
    <th>Неможливі предикати</th>
    <th>Непотрібні звернення до таблиць</th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>DB2 LUW 10.5</td>
    <td>Так</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>MySQL 8.0.2</td>
    <td>Так</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>Oracle 12.2.0.1</td>
    <td>Так</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>PostgreSQL 9.6</td>
    <td>Так</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>SQL Server 2014</td>
    <td>Так</td>
    <td>Так</td>
   </tr>
  </tbody>
 </table>
</div>
<h3>3. Усунення JOIN</h3> У попередньому розділі спостерігали непотрібні звернення до таблиць в однотабличних запитах. Але що станеться, якщо JOIN не потребує одного з декількох звернень до таблиць? <a href="https://blog.jooq.org/2017/09/01/join-elimination-an-essential-optimiser-feature-for-advanced-sql-usage/" target="_blank">Я вже писав про усунення JOIN у попередньому пості з мого блогу</a> . SQL-движок здатний визначити, на основі виду запиту, а також наявності первинних та зовнішніх ключів, чи дійсно конкретний JOIN необхідний у даному запиті, чи його усунення не вплине на семантику запиту. У всіх наступних трьох прикладах JOIN не потрібен. Внутрішнє з'єднання типу "...-к-одному" можна усунути за наявності неприпустимого невизначеного значення (NOT NULL) зовнішнього ключа Замість цього: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">SELECT</span> first_name<span class="token punctuation">,</span> last_name
FROM customer c
JOIN address a ON c<span class="token punctuation">.</span>address_id <span class="token operator">=</span> a<span class="token punctuation">.</span>address_id</code></pre> База даних може виконати таке: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token class-name">SELECT</span> first_name<span class="token punctuation">,</span> last_name
FROM customer c</code></pre> Внутрішнє з'єднання (INNER JOIN) типу "...-до-одного" можна замінити за наявності невизначеного значення зовнішнього ключа, що допускає. Наведений вище запит працює, якщо на зовнішній ключ накладено обмеження NOT NULL. Якщо ж ні, наприклад, як у цьому запиті: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java">SELECT title
FROM film f
JOIN language l ON f<span class="token punctuation">.</span>original_language_id <span class="token operator">=</span> l<span class="token punctuation">.</span>language_id</code></pre> то JOIN все одно можна усунути, але доведеться додати предикат NOT NULL, ось так: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java">SELECT title
FROM film
WHERE original_language_id IS NOT NULL</code></pre> Зовнішнє з'єднання (OUTER JOIN) типу "...-до одного" можна прибрати за наявності унікального ключа. Замість цього: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">SELECT</span> first_name<span class="token punctuation">,</span> last_name
FROM customer c
LEFT JOIN address a ON c<span class="token punctuation">.</span>address_id <span class="token operator">=</span> a<span class="token punctuation">.</span>address_id</code></pre> База даних, знову ж таки, може виконати таке: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token class-name">SELECT</span> first_name<span class="token punctuation">,</span> last_name
FROM customer c</code></pre> ... навіть якщо зовнішнього ключа CUSTOMER.ADDRESS_ID немає. Унікальне зовнішнє з'єднання (DISTINCT OUTER JOIN) типу "...-ко-многим" можна прибрати. Замість цього: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java">SELECT <span class="token class-name">DISTINCT</span> first_name<span class="token punctuation">,</span> last_name
FROM actor a
LEFT JOIN film_actor fa ON a<span class="token punctuation">.</span>actor_id <span class="token operator">=</span> fa<span class="token punctuation">.</span>actor_id</code></pre> База даних може виконати таке: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java">SELECT <span class="token class-name">DISTINCT</span> first_name<span class="token punctuation">,</span> last_name
FROM actor a</code></pre> Всі ці приклади були детально вивчені в попередній статті, так що я не повторюватимуся, а лише підсумую все, що можуть усувати різні бази даних: 
<div class="table-container">
 <table>
  <thead>
   <tr>
    <th>База даних</th>
    <th>INNER JOIN: ...-до одного</th>
    <th>(може бути NULL): ...-до одного</th>
    <th>OUTER JOIN: ...-до одного</th>
    <th>OUTER JOIN DISTINCT: ...-багатьом</th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>DB2 LUW 10.5</td>
    <td>Так</td>
    <td>Так</td>
    <td>Так</td>
    <td>Так</td>
   </tr>
   <tr>
    <td>MySQL 8.0.2</td>
    <td>Ні</td>
    <td>Ні</td>
    <td>Ні</td>
    <td>Ні</td>
   </tr>
   <tr>
    <td>Oracle 12.2.0.1</td>
    <td>Так</td>
    <td>Так</td>
    <td>Так</td>
    <td>Ні</td>
   </tr>
   <tr>
    <td>PostgreSQL 9.6</td>
    <td>Ні</td>
    <td>Ні</td>
    <td>Так</td>
    <td>Ні</td>
   </tr>
   <tr>
    <td>SQL Server 2014</td>
    <td>Так</td>
    <td>Ні</td>
    <td>Так</td>
    <td>Так</td>
   </tr>
  </tbody>
 </table>
</div> На жаль, не всі бази даних можуть усувати всі види з'єднань. DB2 та SQL Server тут – безумовні лідери! <strong><em><a href="https://codegym.cc/groups/posts/331-kljevihe-optimizacii-sql-ne-zavisjajshie-ot-stoimostnoy-modeli-chastjh-2" target="_blank">Далі буде</a></em></strong>
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <th>Що ще почитати?</th>
   </tr>
   <tr>
    <td>
     <p><a href="https://codegym.cc/groups/posts/273-problemih-s-proizvoditeljhnostjhju-sql-voznikajujshie-iz-za-nenuzhnoy-no-objazateljhnoy-rabotih" target="_blank">Проблеми з продуктивністю SQL, що виникають через "непотрібну, але обов'язкову роботу"</a></p>
     <p><a href="https://codegym.cc/groups/posts/72-kak-praviljhno-nachatjh-razrabotku-pod-subd-oracle" target="_blank">Як правильно розпочати розробку під СУБД Oracle</a></p>
     <p><a href="https://codegym.cc/groups/posts/331-kljevihe-optimizacii-sql-ne-zavisjajshie-ot-stoimostnoy-modeli-chastjh-2" target="_blank">Кльові оптимізації SQL, що не залежать від вартісної моделі. Частина 2</a></p></td>
   </tr>
  </tbody>
 </table>
</div>