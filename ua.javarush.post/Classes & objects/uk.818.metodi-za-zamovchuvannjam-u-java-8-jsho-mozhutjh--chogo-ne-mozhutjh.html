Методи за замовчуванням у Java 8: що можуть і чого не можуть?
<p>----------------------------------------</p>
Тепер, з виходом Java 8, можна додавати нові методи в інтерфейси так, що цей інтерфейс залишається сумісним з класами, які його реалізують. Це дуже важливо, якщо ви розробляєте бібліотеку, яку використовують багато програмістів від Києва до
<p>----------------------------------------</p>
<em>Переклад <a href="https://www.javacodegeeks.com/2014/04/java-8-default-methods-what-can-and-can-not-do.html" rel="nofollow" target="_blank">статті</a> , написаної <a href="https://www.javacodegeeks.com/2014/04/java-8-default-methods-what-can-and-can-not-do.html" rel="nofollow" target="_blank">Peter Verhas</a> від квітня 2014 року. </em> <img data-id="c64abb25-c169-48db-abd2-c9d621599a92" data-max-width="850" alt="Методи за замовчуванням у Java 8: що можуть і чого не можуть?  - 1" src="https://cdn.javarush.com/images/article/c64abb25-c169-48db-abd2-c9d621599a92/800.jpeg" style="width: 850px;"><em>Від перекладача: термін " <strong>default method</strong> " в Java тільки з'явився і я не впевнений, чи є для нього усталений переклад російською. Я використовуватиму термін "метод за умовчанням", хоча й не вважаю його ідеальним. Запрошую до обговорення щодо вдалого перекладу.</em>
<h2>Що таке метод за замовчуванням</h2>Тепер, з виходом Java 8, можна додавати нові методи в інтерфейси так, що цей інтерфейс залишається сумісним з класами, які його реалізують. Це дуже важливо, якщо ви розробляєте бібліотеку, яку використовують багато програмістів від Києва до Нью-Йорка. До виходу Java 8, якщо ви описали інтерфейс у бібліотеці, ви не могли додавати до нього методи не ризикуючи, що будь-яка програма, що працює з вашим інтерфейсом, не зламається при його оновленні. Так що в Java 8 цього можна більше не боятися? Ні, не можна. <em>Додавання методу за замовчуванням до інтерфейсу може призвести до неможливості використання деяких класів.</em> Давайте спочатку подивимося на добрі сторони методів за промовчанням. У Java 8 метод можна реалізувати безпосередньо в інтерфейсі. (Статичні методи в інтерфейсі тепер теж можна реалізовувати, але це інша історія.) Метод, реалізований в інтерфейсі, називається за замовчуванням і позначається ключовим словом <strong>default</strong> . Якщо клас реалізує інтерфейс, може, але з зобов'язаний, реалізувати методи, реалізовані в интерфейсе. Клас успадковує реалізацію за умовчанням. Ось чому не обов'язково модифікувати класи за зміни інтерфейсу, який вони реалізують. 
<h2>Множинне успадкування?</h2>Все ускладнюється, якщо якийсь клас реалізує більше одного (скажімо, два) інтерфейсу, а вони реалізують один і той самий метод за умовчанням. Який із методів успадкує клас? Відповідь - ніяка. У такому разі клас повинен реалізувати метод самостійно (безпосередньо, або успадкувавши його від іншого класу). Ситуація аналогічна, якщо тільки один інтерфейс має метод за замовчуванням, а в іншому цей метод є абстрактним. Java 8 намагається бути дисциплінованою та уникати неоднозначних ситуацій. Якщо методи оголошені більш ніж в одному інтерфейсі, то жодної реалізації за умовчанням класом не успадковується – ви отримаєте помилку компіляції. Хоча помилку компіляції можна і не отримати, якщо ваш клас вже скомпільований. У цьому плані Java 8 недостатньо стійка. На те є свої причини, в обговорення яких я не хочу вдаватися (наприклад: 
<ul>
 <li>Скажімо, у вас є два інтерфейси, і клас реалізує їх обидва.</li>
 <li>Один із інтерфейсів реалізує метод за замовчуванням m().</li>
 <li>Ви компілюєте всі інтерфейси та клас.</li>
 <li>Ви змінюєте інтерфейс, у якому немає методу m(), оголошуючи його як абстрактний метод.</li>
 <li>Компілюєте лише модифікований інтерфейс.</li>
 <li>Запускаєте клас.</li>
</ul><img data-id="7458fec4-8b16-46c0-8c49-7ab11320188e" data-max-width="650" alt="Методи за замовчуванням у Java 8: що можуть і чого не можуть?  - 2" src="https://cdn.javarush.com/images/article/7458fec4-8b16-46c0-8c49-7ab11320188e/512.jpeg" style="width: 650px;">І тут клас працює. Ви не можете скомпілювати його з оновленими інтерфейсами, але він був скомпільований зі старими версіями і тому працює. Тепер 
<ul>
 <li>змініть інтерфейс з абстрактним методом m() та додайте реалізацію за умовчанням.</li>
 <li>Скомпілюйте модифікований інтерфейс.</li>
 <li>Запустіть клас: помилка.</li>
</ul>Коли є два інтерфейси, що надають реалізацію методу за замовчуванням, цей метод не може бути викликаний у класі, якщо він не реалізований самим класом (знов-таки, самостійно, або успадкований від іншого класу). <img data-id="ab603b78-6855-490a-bb14-f8c8f37744e4" data-max-width="650" alt="Методи за замовчуванням у Java 8: що можуть і чого не можуть?  - 3" src="https://cdn.javarush.com/images/article/ab603b78-6855-490a-bb14-f8c8f37744e4/512.jpeg" style="width: 650px;">Клас сумісний. Він може бути завантажений із модифікованим інтерфейсом. Він може навіть працювати доти, доки не буде викликаний метод, що має реалізацію за умовчанням в обох інтерфейсах. 
<h2>Приклад коду</h2><img data-max-width="104" alt="Методи за замовчуванням у Java 8: що можуть і чого не можуть?  - 4" src="https://cdn.javarush.com/images/article/01a93a14-b45e-4a9b-a060-a47ad047dd73/original.jpeg">Для того, щоб продемонструвати вищесказане, я створив тестовий каталог для класу C.java і 3 підкаталоги для інтерфейсів у файлух I1.java та I2.java. Кореневий каталог тесту містить вихідний код класу C.java. Каталог base містить версію інтерфейсів, які підходять до виконання та компіляції: інтерфейс I1 має метод за замовчуванням m(); Інтерфейс I2 поки не має жодних методів. У класі є метод <code class=" language-none">main</code>, тому ми можемо виконати його для перевірки. Він перевіряє, чи є якісь аргументи командного рядка, тому ми легко можемо виконати його як з викликом, так і без виклику методу <code class=" language-none">m()</code>. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token operator"><span class="token operator">~</span></span><span class="token operator"><span class="token operator">/</span></span>github<span class="token operator"><span class="token operator">/</span></span>test$ cat <span class="token class-name"><span class="token class-name">C</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>java
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">C</span></span> <span class="token keyword"><span class="token keyword">implements</span></span> I1<span class="token punctuation"><span class="token punctuation">,</span></span> I2 <span class="token punctuation"><span class="token punctuation">{</span></span>
  <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token class-name"><span class="token class-name">C</span></span> c <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">C</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">if</span></span><span class="token punctuation"><span class="token punctuation">(</span></span> args<span class="token punctuation"><span class="token punctuation">.</span></span>length <span class="token operator"><span class="token operator">==</span></span> <span class="token number"><span class="token number">0</span></span> <span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
      c<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">m</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
  <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token operator"><span class="token operator">~</span></span><span class="token operator"><span class="token operator">/</span></span>github<span class="token operator"><span class="token operator">/</span></span>test$ cat base<span class="token operator"><span class="token operator">/</span></span>I1<span class="token punctuation"><span class="token punctuation">.</span></span>java
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">interface</span></span> I1 <span class="token punctuation"><span class="token punctuation">{</span></span>
  <span class="token keyword"><span class="token keyword">default</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">m</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"hello interface 1"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
  <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token operator"><span class="token operator">~</span></span><span class="token operator"><span class="token operator">/</span></span>github<span class="token operator"><span class="token operator">/</span></span>test$ cat base<span class="token operator"><span class="token operator">/</span></span>I2<span class="token punctuation"><span class="token punctuation">.</span></span>java
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">interface</span></span> I2 <span class="token punctuation"><span class="token punctuation">{</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Можна скомпілювати та виконати клас із командного рядка. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token operator"><span class="token operator">~</span></span><span class="token operator"><span class="token operator">/</span></span>github<span class="token operator"><span class="token operator">/</span></span>test$ javac <span class="token operator"><span class="token operator">-</span></span>cp <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token punctuation"><span class="token punctuation">:</span></span>base <span class="token class-name"><span class="token class-name">C</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>java
<span class="token operator"><span class="token operator">~</span></span><span class="token operator"><span class="token operator">/</span></span>github<span class="token operator"><span class="token operator">/</span></span>test$ java <span class="token operator"><span class="token operator">-</span></span>cp <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token punctuation"><span class="token punctuation">:</span></span>base <span class="token class-name"><span class="token class-name">C</span></span>
hello <span class="token keyword"><span class="token keyword">interface</span></span> <span class="token number"><span class="token number">1</span></span></code></pre> Каталог compatible містить версію інтерфейсу I2, який оголошує метод m() абстрактним, а також з технічних причин не змінену копію I1.java. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token operator"><span class="token operator">~</span></span><span class="token operator"><span class="token operator">/</span></span>github<span class="token operator"><span class="token operator">/</span></span>test$ cat compatible<span class="token operator"><span class="token operator">/</span></span>I2<span class="token punctuation"><span class="token punctuation">.</span></span>java

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">interface</span></span> I2 <span class="token punctuation"><span class="token punctuation">{</span></span>
  <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">m</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Такий набір не можна використовувати для компіляції класу C: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token operator"><span class="token operator">~</span></span><span class="token operator"><span class="token operator">/</span></span>github<span class="token operator"><span class="token operator">/</span></span>test$ javac <span class="token operator"><span class="token operator">-</span></span>cp <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token punctuation"><span class="token punctuation">:</span></span>compatible <span class="token class-name"><span class="token class-name">C</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>java
<span class="token class-name"><span class="token class-name">C</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>java<span class="token operator"><span class="token operator">:</span></span><span class="token number"><span class="token number">1</span></span><span class="token operator"><span class="token operator">:</span></span> error<span class="token operator"><span class="token operator">:</span></span> <span class="token class-name"><span class="token class-name">C</span></span> is not <span class="token keyword"><span class="token keyword">abstract</span></span> and does not override <span class="token keyword"><span class="token keyword">abstract</span></span> method <span class="token function"><span class="token function">m</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> in I2
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">C</span></span> <span class="token keyword"><span class="token keyword">implements</span></span> I1<span class="token punctuation"><span class="token punctuation">,</span></span> I2 <span class="token punctuation"><span class="token punctuation">{</span></span>
       <span class="token operator"><span class="token operator">^</span></span>
<span class="token number"><span class="token number">1</span></span> error</code></pre> Повідомлення про помилку є дуже точним. Тим не менш, у нас є C.class з попередньої компіляції і, якщо ми скомпілюємо інтерфейси до каталогу compatible, у нас буде два інтерфейси , які все ще можна використовувати для запуску класу: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token operator"><span class="token operator">~</span></span><span class="token operator"><span class="token operator">/</span></span>github<span class="token operator"><span class="token operator">/</span></span>test$ javac compatible<span class="token operator"><span class="token operator">/</span></span><span class="token class-name"><span class="token class-name">I</span></span><span class="token operator"><span class="token operator">*</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>java
<span class="token operator"><span class="token operator">~</span></span><span class="token operator"><span class="token operator">/</span></span>github<span class="token operator"><span class="token operator">/</span></span>test$ java <span class="token operator"><span class="token operator">-</span></span>cp <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token punctuation"><span class="token punctuation">:</span></span>compatible <span class="token class-name"><span class="token class-name">C</span></span>
hello <span class="token keyword"><span class="token keyword">interface</span></span> <span class="token number"><span class="token number">1</span></span></code></pre> Третій каталог — <code class=" language-none">wrong</code>містить версію I2, в якому також оголошено метод <code class=" language-none">m()</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token operator"><span class="token operator">~</span></span><span class="token operator"><span class="token operator">/</span></span>github<span class="token operator"><span class="token operator">/</span></span>test$ cat wrong<span class="token operator"><span class="token operator">/</span></span>I2<span class="token punctuation"><span class="token punctuation">.</span></span>java
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">interface</span></span> I2 <span class="token punctuation"><span class="token punctuation">{</span></span>
  <span class="token keyword"><span class="token keyword">default</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">m</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"hello interface 2"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
  <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Можна навіть не мучитися з компіляцією. Незважаючи на те, що метод оголошений двічі, клас все ще може використовуватися і працювати, доки не відбудеться виклик методу m(). Ось навіщо нам потрібен аргумент командного рядка: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token operator"><span class="token operator">~</span></span><span class="token operator"><span class="token operator">/</span></span>github<span class="token operator"><span class="token operator">/</span></span>test$ javac wrong<span class="token comment"><span class="token comment">/*.java
~/github/test$ java -cp .:wrong C
Exception in thread "main" java.lang.IncompatibleClassChangeError: Conflicting default methods: I1.m I2.m
    at C.m(C.java)
    at C.main(C.java:5)
~/github/test$ java -cp .:wrong C x
~/github/test$</span></span></code></pre>
<h2>Висновок</h2>Коли ви переносите вашу бібліотеку в Java 8 і змінюєте ваші інтерфейси, додаючи в них методи за промовчанням, швидше за все, проблем у вас не виникне. У всякому разі, на це сподіваються розробники бібліотек Java 8, додаючи функціональність. Програми, які використовують вашу бібліотеку, поки використовують її для Java 7, де немає методів за промовчанням. Якщо кілька бібліотек використовують разом, ймовірність конфлікту є. Як його уникнути? Проектуйте API вашої бібліотеки так само, як і раніше. Не розслабляйтеся, покладаючись на методи за замовчуванням. Вони – це крайній засіб. Ретельно вибирайте імена, щоб уникнути колізій з іншими інтерфейсами. Подивимося, як розвиватиметься розробка для Java з використанням цієї фічі.