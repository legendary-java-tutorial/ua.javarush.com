Багатопоточність у Java
<p>----------------------------------------</p>
Перш ніж дізнатися про потоки Java, давайте заглянемо в недалеке майбутнє. Уявіть, що ви подали резюме та пройшли співбесіду. Вас та пару дюжин майбутніх колег запросили на роботу у велику Software-компанію. Серед інших клопотів потрібно по
<p>----------------------------------------</p>
<h2>Вступ</h2>Перш ніж дізнатися про потоки Java, давайте заглянемо в недалеке майбутнє. Уявіть, що ви подали резюме та пройшли співбесіду. Вас та пару дюжин майбутніх колег запитабо на роботу у велику Software-компанію. Серед інших клопотів потрібно подати паперові документи для працевлаштування співробітнику HR-відділу, що втомився. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="2c598518-12ed-4340-b90e-d93ccdc2edb4" data-max-width="710" alt="Багатопоточність у Java - 1" src="https://cdn.javarush.com/images/article/2c598518-12ed-4340-b90e-d93ccdc2edb4/512.jpeg" style="width: 710px;">
 </div>
</div>Щоб прискорити процес, претендентів на посаду можна поділити на дві групи та розподілити їх між двома HR-менеджерами (якщо такі є у компанії). В результаті ми отримуємо прискорення процесу за рахунок паралельної ( <strong>parallel</strong> ) роботи з оформлення. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="dfdf82b7-3e6c-43ae-8487-c3a9edf82af3" data-max-width="710" alt="Багатопоточність у Java - 2" src="https://cdn.javarush.com/images/article/dfdf82b7-3e6c-43ae-8487-c3a9edf82af3/512.jpeg" style="width: 710px;">
 </div>
</div>Якщо ж кадровик у компанії один, то доведеться якось викручуватися. Наприклад, можна знову розбити всіх на дві групи, наприклад, співбесідувати по черзі дівчат і юнаків. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="1aa9d9e7-064b-47f7-b07a-298574392956" data-max-width="710" alt="Багатопоточність у Java - 3" src="https://cdn.javarush.com/images/article/1aa9d9e7-064b-47f7-b07a-298574392956/512.jpeg" style="width: 710px;">
 </div>
</div>Або за іншим принципом: так як у нижній групі більше народу, чергуватимемо на одного юнака двох дівчат. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="b71a2a0c-089c-4540-beff-2eb5603df77b" data-max-width="710" alt="Багатопоточність у Java - 4" src="https://cdn.javarush.com/images/article/b71a2a0c-089c-4540-beff-2eb5603df77b/512.jpeg" style="width: 710px;">
 </div>
</div>Такий спосіб організації роботи називається <strong>багатопоточним</strong> . Наша стомлена кадровик переключається на різні групи для оформлення з них чергового співробітника. Груп, можливо, одинадцять, а кадровиків – чотири. У цьому випадку багатопотокова ( <strong>multithreading</strong> ) обробка буде відбуватися паралельно кількома HR-ами, які можуть брати чергову людину з будь-якої групи для обробки її документів. 
<h2>Процеси</h2>Процесом ( <strong>process</strong> ) у разі буде організація роботи прийому документів. В організації можна виділити кілька процесів: бухгалтерський облік, розробка програмного забезпечення, зустрічі з клієнтами, робота складу і т. д. На кожен процес виділені ресурси: приміщення, співробітники для його виконання. Процеси ізольовані один від одного: у кадровиків відсутній доступ до бухгалтерської бази, а менеджери по роботі з клієнтами не бігають по складу. Якщо процес має отримати доступ до чужих ресурсів, необхідно налагодити міжпроцесну взаємодію: службові записки, спільні наради. 
<h2>Потоки</h2>Робота у процесі організована як потоків ( <code class=" language-none">java thread</code>). Для відділу кадрів потік – це організація роботи з обслуговування групи. На першій картинці – один потік, наступних трьох – два. Усередині процесу потоки можуть виконуватися паралельно – два кадровики приймають дві чи більше групи майбутніх співробітників. Взаємодія кадровиків із групами – обробку потоків усередині процесу – називають <strong>синхронізацією потоків</strong>. На малюнках оформлення одним кадровиком двох груп видно показані методи: рівномірний (дівчина – юнак – дівчина – юнак) і з різними пріоритетами (дві дівчини чергуються з одним юнаком). Потоки мають доступ до ресурсів процесу, до якого вони належать: груп до кадровика дано зразки бланків заяв, ручки для заповнення документів. Але якщо потоки взаємодіють із спільними для них речами – то можливі казуси. Якщо кадровик попросить крикнути ім'я останньої людини у черзі – то, у випадку із двома групами, він не впевнений заздалегідь, що почує жіноче чи чоловіче ім'я. Подібні конфлікти доступу до даних, блокування та способи їх вирішення є дуже важливою темою. 
<h2>Стан потоку</h2>Кожен потік перебуває в одному з наступних станів: 
<ul>
 <li>Створено ( <code class=" language-none">New</code>) – черга до кадровика готується, люди організовуються.</li>
 <li>Запущено ( <code class=" language-none">Runnable</code>) – наша черга вишикувалася до кадровика та обробляється.</li>
 <li>Заблокований ( <code class=" language-none">Blocked</code>) – останній у черзі юнак намагається вигукнути ім'я, але почувши, що дівчина у сусідній групі почала робити це раніше за нього, замовк.</li>
 <li>Завершено ( <code class=" language-none">Terminated</code>) — вся черга оформилася у кадровика і не потребує.</li>
 <li>Чекає( <code class=" language-none">Waiting</code>) – одна черга чекає сигналу з іншого.</li>
</ul>Організація потоків та його взаємодія – це основа ефективної роботи процесів. 
<h2>Повернемося до IT-світу</h2>У XXI столітті багатопоточне та паралельне виконання стало актуальним. З 90-х років минулого століття багатозадачні операційні системи Windows, MacOS та Linux міцно влаштувалися на домашніх комп'ютерах. Вони часто можна зустріти чотири- і більше ядерні процесори. Число паралельних блоків GPU-відеокарту вже перевалило за тисячу. Популярні програми пишуться з урахуванням багатопоточності (multithreading), наприклад, сучасні версії програмного забезпечення обробки графіки, відео або оперують великим обсягом даних: Adobe Photoshop, WinRar, Mathematica, сучасні ігри. Багатопотоковість Java - дуже важлива, затребувана і складна тема. Тому в курсі CodeGym зустрічається багато завдань, щоб розібратися з нею дуже добре. Java-приклади на багатопоточність допоможуть освоїти основні нюанси та тонкощі цієї галузі, синхронізацію роботи потоків. 
<h2>Процес</h2><strong>Process</strong> (процес) – екземпляр програми, що виконується, якому Операційна Система (ОС) виділила пам'ять, процесорний час/ядра та інші ресурси. Важливо, що пам'ять виділяється окремо, адресані простори різних процесів недоступні одне одному. Якщо процесам необхідно обмінюватися даними, можуть це зробити з допомогою файлів, каналів та інших методів межпроцессного взаємодії. 
<h2>Потік</h2>Java <code class=" language-none">Thread</code>(потік). Іноді, щоб не плутати з іншими класами Java - <code class=" language-none">Stream</code>і подібними, потоки Java часто переводять як нитку. Вони використовують виділені для процесу ресурси та є способом виконання процесу. Головний потік виконує метод <code class=" language-none">main</code>та завершується. При виконанні процесу можуть бути додаткові потоки (дочірні). Потоки одного процесу можуть обмінюватися даними між собою. Багатопотоковість Java вимагає враховувати синхронізацію даних, не забувайте про це. У Java процес завершується тоді, коли закінчив роботу останній його потік. Для фонових завдань потік можна запустити як демон ( <code class=" language-none">daemon</code>), відмінність якого від звичайного в тому, що вони будуть примусово завершені після закінчення роботи всіх потоків <code class=" language-none">daemon</code>процесу. 
<h2>Перший багатопотоковий додаток</h2>Існує більш ніж півдюжини способів створення потоків, в рамках CodeGym курсу ми їх докладно розберемо. Для початку познайомимося з одним із базових. Є спеціальний клас <code class=" language-none">Thread</code>у методі <code class=" language-none">run()</code>якого необхідно написати код, що реалізує логіку програми. Після створення потоку можна запустити його, викликавши метод <code class=" language-none">start()</code>. Напишемо демонстраційну програму, що реалізує приклад багатопоточності Java. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">PeopleQueue</span></span> <span class="token keyword"><span class="token keyword">extends</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span>    <span class="token punctuation"><span class="token punctuation">{</span></span><span class="token comment"><span class="token comment">// Наша очередь из сотрудников, наследник класса Thread</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> names<span class="token punctuation"><span class="token punctuation">;</span></span>

    <span class="token class-name"><span class="token class-name">PeopleQueue</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token punctuation"><span class="token punctuation">.</span></span> names<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span><span class="token comment"><span class="token comment">// Конструктор, аргумент- массив имен сотрудников</span></span>
        <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>names <span class="token operator"><span class="token operator">=</span></span> names<span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">run</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span> <span class="token comment"><span class="token comment">// Этот метод будет вызван при старте потока</span></span>
        <span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> i <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i <span class="token operator"><span class="token operator">&lt;</span></span> names<span class="token punctuation"><span class="token punctuation">.</span></span>length<span class="token punctuation"><span class="token punctuation">;</span></span> i<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span> <span class="token comment"><span class="token comment">// Вывод в цикле с паузой 0.5 сек очередного сотрудника</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Обработаны документы: "</span></span> <span class="token operator"><span class="token operator">+</span></span> names<span class="token punctuation"><span class="token punctuation">[</span></span>i<span class="token punctuation"><span class="token punctuation">]</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                <span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">500</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Задержка в 0.5 сек</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Exception</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span><span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> HR    <span class="token punctuation"><span class="token punctuation">{</span></span><span class="token comment"><span class="token comment">// Класс для демонстрации работы потока</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token comment"><span class="token comment">// Создаем две очереди</span></span>
        <span class="token class-name"><span class="token class-name">PeopleQueue</span></span> queue1 <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">PeopleQueue</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Іван"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span><span class="token string"><span class="token string">"Сергей"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span><span class="token string"><span class="token string">"Николай"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span><span class="token string"><span class="token string">"Фердинанд"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span><span class="token string"><span class="token string">"Василь"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">PeopleQueue</span></span> queue2 <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">PeopleQueue</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Мария"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span><span class="token string"><span class="token string">"Людмила"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span><span class="token string"><span class="token string">"Алиса"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span><span class="token string"><span class="token string">"Карина"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span><span class="token string"><span class="token string">"Ольга"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Начали!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Сообщение из главного потока программы</span></span>
        queue1<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>    <span class="token comment"><span class="token comment">//Запускаем одну очередь (дочерний поток)</span></span>
        queue2<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">//Запускаем вторую (дочерний поток)</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Запустимо програму. У консолі видно виведення повідомлення основним потоком. Далі кожен дочірній потік <code class=" language-none">queue1</code>і <code class=" language-none">queue2</code>по черзі виводять повідомлення в загальну для них консоль про чергового обробленого співробітника. Один із можливих варіантів роботи програми: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java">Начали<span class="token operator"><span class="token operator">!</span></span>
Обработаны документы<span class="token operator"><span class="token operator">:</span></span> Мария
Обработаны документы<span class="token operator"><span class="token operator">:</span></span> Іван
Обработаны документы<span class="token operator"><span class="token operator">:</span></span> Людмила
Обработаны документы<span class="token operator"><span class="token operator">:</span></span> Сергей
Обработаны документы<span class="token operator"><span class="token operator">:</span></span> Алиса
Обработаны документы<span class="token operator"><span class="token operator">:</span></span> Николай
Обработаны документы<span class="token operator"><span class="token operator">:</span></span> Карина
Обработаны документы<span class="token operator"><span class="token operator">:</span></span> Фердинанд
Обработаны документы<span class="token operator"><span class="token operator">:</span></span> Ольга
Обработаны документы<span class="token operator"><span class="token operator">:</span></span> Васабой

<span class="token class-name"><span class="token class-name">Process</span></span> finished <span class="token keyword"><span class="token keyword">with</span></span> <span class="token namespace"><span class="token namespace">exit</span></span> code <span class="token number"><span class="token number">0</span></span></code></pre><strong>Багатопотоковість в Java</strong> - тема важка і багатостороння. Вміння писати код з використанням паралельних, багатозадачних та багатопотокових обчислень допоможе вам ефективно реалізувати завдання на сучасних багатоядерних процесорах та кластерах, що складаються з безлічі комп'ютерів.