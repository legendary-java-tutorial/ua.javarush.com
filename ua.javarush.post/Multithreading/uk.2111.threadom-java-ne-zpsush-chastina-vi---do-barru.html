Thread'ом Java не зіпсуєш: Частина VI - До бар'єру!
<p>----------------------------------------</p>
Потоки – штука цікава. У попередніх оглядах ми розглянули деякі доступні засоби реалізації багатопоточності. Погляньмо, що ми можемо зробити ще цікавого. На цей момент ми багато що знаємо. Наприклад, з " " ми знаємо, що потік - це Thread. М
<p>----------------------------------------</p>
<h2>Вступ</h2>Потоки – штука цікава. У попередніх оглядах ми розглянули деякі доступні засоби реалізації багатопоточності. Погляньмо, що ми можемо зробити ще цікавого. На цей момент ми багато що знаємо. Наприклад, з " <a href="https://codegym.cc/groups/posts/2047-threadom-java-ne-isportishjh--chastjh-i---potoki" target="_blank" rel="nofollow">Thread'ом Java не зіпсуєш: Частина I - потоки</a> " ми знаємо, що потік - це Thread. Ми знаємо, що потік виконує певне завдання. Якщо хочемо, щоб наше завдання могли запустити ( <code class=" language-none">run</code>), ми повинні вказати потоку якийсь <code class=" language-none">Runnable</code>. <img data-max-width="800" data-id="149aed84-6a69-4a07-a0ea-747b52edd8cb" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина VI - До бар'єру!  - 1" src="https://cdn.javarush.com/images/article/149aed84-6a69-4a07-a0ea-747b52edd8cb/800.jpeg" style="width: 800px;">Щоб згадати, можемо скористатися <a href="https://www.tutorialspoint.com/compile_java_online.php" target="_blank" rel="nofollow">Tutorialspoint Java Online Compiler</a> 'ом: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
 		<span class="token class-name"><span class="token class-name">Thread</span></span> thread <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Hello from "</span></span> <span class="token operator"><span class="token operator">+</span></span> thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Thread</span></span> thread <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Також ми знаємо про те, що у нас є таке поняття, як лок. Про нього ми читали в " <a href="https://codegym.cc/groups/posts/2048-threadom-java-ne-isportishjh--chastjh-ii---sinkhronizacija" target="_blank" rel="nofollow">Thread'ом Java не зіпсуєш: Частина II - синхронізація</a> ". Потік може займати лок і тоді інший потік, який спробує зайняти лок, буде змушений чекати на звільнення локу: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span>locks<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token operator"><span class="token operator">*</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">HelloWorld</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token class-name"><span class="token class-name">Lock</span></span> lock <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ReentrantLock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">lock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token class-name"><span class="token class-name">Thread</span></span> thread <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Hello from "</span></span> <span class="token operator"><span class="token operator">+</span></span> thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">unlock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token class-name"><span class="token class-name">Thread</span></span> thread <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Думаю, настав час поговорити про те, що ми ще можемо цікаве зробити. 
<h2>Семафори</h2>Найпростіший засіб контролю над тим, скільки потоків можуть одночасно працювати — семафор. Як на залізниці. Горить зелений – можна. Горить червоний – чекаємо. Що ми чекаємо на семафор? Дозволи. Дозвіл англійською - permit. Щоб отримати дозвіл - його потрібно отримати, що англійською буде acquire. А коли дозвіл більше не потрібно ми його повинні віддати, тобто звільнити його або позбудеться його, що англійською буде release. Подивимося, як це працює. Нам буде потрібно імпорт класу <code class=" language-none">java.util.concurrent.Semaphore</code>. Приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Semaphore</span></span> semaphore <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Semaphore</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			semaphore<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">acquire</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Finished"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			semaphore<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">release</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			e<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">printStackTrace</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">5000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	semaphore<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">release</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як бачимо, запам'ятавши англійські слова, ми розуміємо як працює семафор. Цікаво, що головна умова - на "рахунку" семафору має бути позитивна кількість permit'ів. Тому ініціювати його можна і з мінусом. І вимагати (acquire) можна більше, ніж 1. 
<h2>CountDownLatch</h2>Наступний механізм - <code class=" language-none">CountDownLatch</code>. CountDown англійською – це відлік, а Latch – засувка або клямка. Тобто якщо перекладати, це засувка з відліком. Тут нам знадобиться відповідний імпорт класу <code class=" language-none">java.util.concurrent.CountDownLatch</code>. Це схоже на біги чи гонки, коли всі збираються біля стартової лінії і коли всі готові – дають дозвіл, і всі одночасно стартують. Приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">CountDownLatch</span></span> countDownLatch <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">CountDownLatch</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">3</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			countDownLatch<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">countDown</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Countdown: "</span></span> <span class="token operator"><span class="token operator">+</span></span> countDownLatch<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getCount</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			countDownLatch<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">await</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Finished"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			e<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">printStackTrace</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> i <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">3</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
 	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> await англійською - очікувати. Тобто ми спочатку говоримо <code class=" language-none">countDown</code>. Як каже ґуґл перекладач, count down - "an act of counting numerals in reverse order to zero", тобто виконати дію за зворотним відліком, мета якого - дорахувати до нуля. А далі говоримо <code class=" language-none">await</code>— тобто чекати, доки значення лічильника не стане нульовим. Цікаво, що такий лічильник є одноразовим. Як сказано в JavaDoc - "When threads must repeatedly count down in this way, instead use a CyclicBarrier", тобто якщо потрібен багаторазовий рахунок - треба використовувати інший варіант, який називається <code class=" language-none">CyclicBarrier</code>. 
<h2>CyclicBarrier</h2>Як і випливає з назви, <code class=" language-none">CyclicBarrier</code>це циклічний бар'єр. Нам знадобиться імпорт класу <code class=" language-none">java.util.concurrent.CyclicBarrier</code>. Подивимося на приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Runnable</span></span> action <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"На старт!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">CyclicBarrier</span></span> berrier <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">CyclicBarrier</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">3</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> action<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			berrier<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">await</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Finished"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">BrokenBarrierException</span></span> <span class="token operator"><span class="token operator">|</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			e<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">printStackTrace</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Limit: "</span></span> <span class="token operator"><span class="token operator">+</span></span> berrier<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getParties</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> i <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">3</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як бачимо, потік виконує <code class=" language-none">await</code>, тобто чекає. У цьому зменшується значення бар'єру. Бар'єр вважається зламаним ( <code class=" language-none">berrier.isBroken()</code>), коли відлік дійшов до нуля. Щоб скинути бар'єр, потрібно викликати <code class=" language-none">berrier.reset()</code>, чого не вистачало <code class=" language-none">CountDownLatch</code>. 
<h2>Exchanger</h2>Наступний засіб - <code class=" language-none">Exchanger</code>. Exchange з англійської перекладається як обмін або обмінюватися. А <code class=" language-none">Exchanger</code>обмінник, тобто те, через що обмінюються. Подивимося на найпростіший приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Exchanger</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> exchanger <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Exchanger</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token class-name"><span class="token class-name">Thread</span></span> thread <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token class-name"><span class="token class-name">String</span></span> withThreadName <span class="token operator"><span class="token operator">=</span></span> exchanger<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">exchange</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">" обменялся с "</span></span> <span class="token operator"><span class="token operator">+</span></span> withThreadName<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			e<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">printStackTrace</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Тут ми запускаємо два потоки. Кожен з них виконує метод exchange і чекає, коли інший потік так само виконає метод exchange. Отже, потоки обміняються між собою переданими аргументами. Цікава річ. Чи вона вам нічого не нагадує? А нагадує він <code class=" language-none">SynchronousQueue</code>, яка лежить в основі <code class=" language-none">cachedThreadPool</code>'а. Для наочності приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">SynchronousQueue</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> queue <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">SynchronousQueue</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>queue<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">take</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			e<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">printStackTrace</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	queue<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">put</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Message"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> У прикладі видно, що запустивши новий потік, цей потік піде в очікування, т.к. у черзі буде порожньо. А далі <code class=" language-none">main</code>потік покладе на чергу текст "Message". При цьому він сам зупиниться на час, який потрібно, доки не отримають із черги цей текстовий елемент. З цієї теми також можна почитати " <a href="https://stackoverflow.com/questions/9735709/synchronousqueue-vs-exchanger" target="_blank" rel="nofollow">SynchronousQueue Vs Exchanger</a> ". 
<h2>Phaser</h2>І насамкінець найсолодше — <code class=" language-none">Phaser</code>. Нам знадобиться імпорт класу <code class=" language-none">java.util.concurrent.Phaser</code>. Подивимося на простий приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">Phaser</span></span> phaser <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Phaser</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token comment"><span class="token comment">// Вызывая метод register, мы регистрируем текущий поток (main) як участника</span></span>
        phaser<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">register</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Phasecount is "</span></span> <span class="token operator"><span class="token operator">+</span></span> phaser<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getPhase</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token function"><span class="token function">testPhaser</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>phaser<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token function"><span class="token function">testPhaser</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>phaser<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token function"><span class="token function">testPhaser</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>phaser<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token comment"><span class="token comment">// Через 3 секунды прибываем к барьеру и снимаемся регистрацию. Кол-во прибывших = кол-во регистраций = пуск</span></span>
        <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">3000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        phaser<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">arriveAndDeregister</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Phasecount is "</span></span> <span class="token operator"><span class="token operator">+</span></span> phaser<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getPhase</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">testPhaser</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Phaser</span></span> phaser<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token comment"><span class="token comment">// Говорим, что будет +1 участник на Phaser</span></span>
        phaser<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">register</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token comment"><span class="token comment">// Запускаем новый поток</span></span>
        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">String</span></span> name <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>name <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">" arrived"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            phaser<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">arriveAndAwaitAdvance</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">//threads register arrival to the phaser.</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>name <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">" after passing barrier"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> З прикладу видно, що бар'єр при використанні <code class=" language-none">Phaser</code>проривається, коли кількість реєстрацій збігається з кількістю прибулих до бар'єру. Детальніше можна ознайомитися з <code class=" language-none">Phaser</code>'ом у статті з хабра " <a href="https://habr.com/post/117185/" target="_blank" rel="nofollow">Новий синхронізатор Phaser</a> ". <a href="https://codegym.cc/welcome" target="_blank"><img id="click_banner1_articles" data-max-width="1024" data-id="014606e4-b96a-4278-9bc8-94eb58f63cdb" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина VI - До бар'єру!  - 2" src="https://cdn.javarush.com/images/article/014606e4-b96a-4278-9bc8-94eb58f63cdb/1024.jpeg" style="width: 1024px;"></a>
<h2>Підсумки</h2>Як очевидно з прикладів, існують різні способи синхронізації потоків. Раніше я постарався вже згадати щось із багатопоточності, сподіваюся, минулі частини були корисні. Кажуть, що шлях до багатопоточності починається з книги Java Concurrency in Practice. Хоча вона вийшла у 2006 році, люди відповідають, що книга є досить фундаментальною і досі тримає удар. Наприклад, можна прочитати обговорення тут: " <a href="https://stackoverflow.com/questions/10202768/is-java-concurrency-in-practice-still-valid" target="_blank" rel="nofollow">Is Java Concurrency In Practice still valid?</a> ". Також корисно прочитати посилання із обговорення. Наприклад, там є посилання на книгу " <a href="https://www.manning.com/books/the-well-grounded-java-developer" target="_blank" rel="nofollow">The Well-Grounded Java Developer</a> ", в якій варто звернутися на " <a href="https://livebook.manning.com/#!/book/the-well-grounded-java-developer/chapter-4/" target="_blank" rel="nofollow">Chapter 4. Modern concurrency</a> ". Є ще цілий огляд на цю тему: "<a href="https://javarevisited.blogspot.com/2018/07/is-java-concurrency-in-practice-still-relevant-in-era-of-java8.html" target="_blank" rel="nofollow"></a>Там також є поради з приводу того, що ще слід почитати, щоб дійсно зрозуміти цю тему. Після цього, можна придивитися до такої чудової книги, як OCA OCP JavaSE 8 Programmer Practice Tests <a href="https://www.oreilly.com/library/view/oca-ocp/9781119363392/fcover.xhtml" target="_blank" rel="nofollow">.</a> І там є тести в "∫". У цій книзі є як питання, так і відповіді з поясненням. Наприклад: <img data-max-width="800" data-id="0289b09a-0d27-45d4-8338-d94fc2a2f45b" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина VI - До бар'єру!  - 3" src="https://cdn.javarush.com/images/article/0289b09a-0d27-45d4-8338-d94fc2a2f45b/800.jpeg" style="width: 800px;">Багато хто може почати говорити, що це чергове заучування методів. З одного боку - так. З іншого боку, на це питання можна дати відповідь, згадавши, що <code class=" language-none">ExecutorService</code>- це свого роду "апгрейд" <code class=" language-none">Executor</code>'а. А <code class=" language-none">Executor</code>покликаний просто приховати спосіб створення потоків, але не основний спосіб їх виконання, тобто запуск <code class=" language-none">Runnable</code>у <code class=" language-none">execute(Callable)</code>новому <code class=" language-none">ExecutorService</code>потоці <code class=" language-none">Executor</code>.у просто додали методи<code class=" language-none">submit</code>, які вміють повертати <code class=" language-none">Future</code>. Як бачите, ми можемо і завчити список методів, але набагато простіше здогадатися, знаючи природу самих класів. Ну і трохи додаткових матеріалів на тему: 
<ul>
 <li>" <a href="https://habr.com/post/277669/" target="_blank" rel="nofollow">Довідник із синхронізаторів java.util.concurrent.*</a> "</li>
 <li>" <a href="http://java-online.ru/concurrent-synchronizers.xhtml" target="_blank" rel="nofollow">Синхронізатори пакета concurrent</a> "</li>
 <li>Юрій Ткач " <a href="https://www.youtube.com/watch?v=XkAjmCIY2WI" target="_blank" rel="nofollow">Синхронізатори - Concurrency #4 - Advanced Java</a> "</li>
</ul>#Viacheslav
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <th>Що ще почитати:</th>
   </tr>
   <tr>
    <td><a href="https://codegym.cc/groups/posts/2047-threadom-java-ne-isportishjh--chastjh-i---potoki" target="_blank">Thread'ом Java не зіпсуєш: Частина I - потоки </a><br><a href="https://codegym.cc/groups/posts/2048-threadom-java-ne-isportishjh--chastjh-ii---sinkhronizacija" target="_blank">Thread'ом Java не зіпсуєш: Частина II - синхронізація </a><br><a href="https://codegym.cc/groups/posts/2060-threadom-java-ne-isportishjh--chastjh-iii---vzaimodeystvie" target="_blank">Thread'ом Java не зіпсуєш : Частина III - взаємодія </a><br><a href="https://codegym.cc/groups/posts/2065-threadom-java-ne-isportishjh--chastjh-iv---callable-future-i-druzjhja" target="_blank">Thread'ом Java не зіпсуєш : Частина IV - Callable, Future та друзі </a><br><a href="https://codegym.cc/groups/posts/2078-threadom-java-ne-isportishjh--chastjh-v---executor-threadpool-fork-join-pool" target="_blank">Thread' ом Java не зіпсуєш: Частина V - Executor, ThreadPool, Fork Join</a></td>
   </tr>
  </tbody>
 </table>
</div>