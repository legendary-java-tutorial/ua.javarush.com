Що таке Deadlock в Java?
<p>----------------------------------------</p>
Рівень знань, необхідних розуміння статті: ви пройшли квести Java Syntax і Java Core, і у процесі вивчення Java Multithreading. Deadlock або дідлок в Java або взаємне блокування - це помилка, яка відбувається, коли нитки мають циклічну зале
<p>----------------------------------------</p>
Рівень знань, необхідних розуміння статті: ви пройшли квести Java Syntax і Java Core, і у процесі вивчення Java Multithreading. Deadlock або дідлок в Java або взаємне блокування - це помилка, яка відбувається, коли нитки мають циклічну залежність від пари синхронізованих об'єктів. Уявіть, що одна нитка входить до монітора об'єкта <code class=" language-none">x</code>, а інша – об'єкта <code class=" language-none">y</code>. Якщо нитка в об'єкті <code class=" language-none">x</code>намагається викликати будь-який синхронізований метод об'єкта <code class=" language-none">y</code>, а об'єкт <code class=" language-none">y</code>одночасно намагається викликати будь-який синхронізований метод об'єкта <code class=" language-none">x</code>, то нитки застрянуть у процесі очікування. <img data-id="5f05102e-df6d-4f7d-82b0-ebb3f9e4e11f" data-max-width="850" alt="Що таке Deadlock?  - 1" src="https://cdn.javarush.com/images/article/5f05102e-df6d-4f7d-82b0-ebb3f9e4e11f/800.jpeg" style="width: 850px;">Нижче приклад з туторіалу java docs про таке поняття, як deadlock. Де тут відбувається блокування ниток? 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Deadlock</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Friend</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">String</span></span> name<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Friend</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> name<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>name <span class="token operator"><span class="token operator">=</span></span> name<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">String</span></span> <span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">return</span></span> <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>name<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">bow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Friend</span></span> bower<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">format</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"%s: %s"</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">"  has bowed to me!%n"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>name<span class="token punctuation"><span class="token punctuation">,</span></span> bower<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            bower<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bowBack</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">bowBack</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Friend</span></span> bower<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">format</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"%s: %s"</span></span>
                <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">" has bowed back to me!%n"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span>
                <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>name<span class="token punctuation"><span class="token punctuation">,</span></span> bower<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Friend</span></span> alphonse <span class="token operator"><span class="token operator">=</span></span>
            <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Friend</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Alphonse"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Friend</span></span> gaston <span class="token operator"><span class="token operator">=</span></span>
            <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Friend</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Gaston"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Runnable</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
            <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">run</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
               <span class="token comment"><span class="token comment">// System.out.println("Thread 1");</span></span>
                alphonse<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>gaston<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
               <span class="token comment"><span class="token comment">// System.out.println("Th: gaston bowed to alphonse");</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Runnable</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
            <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">run</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
              <span class="token comment"><span class="token comment">//  System.out.println("Thread 2");</span></span>
                gaston<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>alphonse<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
              <span class="token comment"><span class="token comment">//  System.out.println("2.gaston waiting alph bowed");</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Тут потрібно зрозуміти дві важливі речі: 
<ol>
 <li>Що саме робить кожна з ниток, що одночасно виконуються?</li>
 <li>Які локи використовуються?</li>
</ol>Почнемо з кінця. Припустимо, ви створабо два об'єкти класу <code class=" language-none">Friend</code>: <code class=" language-none">alphonse</code>і <code class=" language-none">gaston</code>. У кожного є свій лок. Таким чином, цих локів два: альфонсів та гастонів. При вході в синхронізований метод об'єкта його лок замикається, а коли з методу виходять, він звільняється (або відмикається). Тепер про нитки. Назвемо першу нитку <code class=" language-none">Alphonse</code>(з великої літери, щоб відрізнити від об'єкта alphonse). Ось що вона робить (позначимо її буквою <code class=" language-none">A</code>, скорочено від <code class=" language-none">Alphonse</code>): 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">A</span></span><span class="token operator"><span class="token operator">:</span></span> alphonse<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>gaston<span class="token punctuation"><span class="token punctuation">)</span></span> — получает лок alphonse<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">A</span></span><span class="token operator"><span class="token operator">:</span></span> gaston<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bowBack</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>alphonse<span class="token punctuation"><span class="token punctuation">)</span></span> — получает лок gaston<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">A</span></span><span class="token operator"><span class="token operator">:</span></span> возвращается из обоих методов<span class="token punctuation"><span class="token punctuation">,</span></span> тем самым освобождая лок<span class="token punctuation"><span class="token punctuation">.</span></span></code></pre> А ось чим у цей час зайнята нитка <code class=" language-none">Gaston</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">G</span></span><span class="token operator"><span class="token operator">:</span></span> gaston<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>alphonse<span class="token punctuation"><span class="token punctuation">)</span></span> — получает лок gaston<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">G</span></span><span class="token operator"><span class="token operator">:</span></span> alphonse<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bowBack</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>gaston<span class="token punctuation"><span class="token punctuation">)</span></span> — получает лок alphonse<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">G</span></span><span class="token operator"><span class="token operator">:</span></span> возвращается из обоих методов<span class="token punctuation"><span class="token punctuation">,</span></span> тем самым освобождая лок<span class="token punctuation"><span class="token punctuation">.</span></span></code></pre> Тепер зведемо ці дані разом та отримаємо відповідь. Нитки можуть переплітатися (тобто їх події відбуватимуться) у різних порядках. Дідлок вийде, наприклад, якщо порядок буде таким: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">A</span></span><span class="token operator"><span class="token operator">:</span></span> alphonse<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>gaston<span class="token punctuation"><span class="token punctuation">)</span></span> — получает лок alphonse
<span class="token class-name"><span class="token class-name">G</span></span><span class="token operator"><span class="token operator">:</span></span> gaston<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>alphonse<span class="token punctuation"><span class="token punctuation">)</span></span> — получает лок gaston
<span class="token class-name"><span class="token class-name">G</span></span><span class="token operator"><span class="token operator">:</span></span> пытается вызвать alphonse<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bowBack</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>gaston<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> но блокируется<span class="token punctuation"><span class="token punctuation">,</span></span> ожидая лока alphonse
<span class="token class-name"><span class="token class-name">A</span></span><span class="token operator"><span class="token operator">:</span></span> пытается вызвать gaston<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bowBack</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>alphonse<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> но блокируется<span class="token punctuation"><span class="token punctuation">,</span></span> ожидая лока gaston</code></pre>
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="c42c278d-3ce4-45b4-95e5-c7b8c8c024c3" data-max-width="710" alt="Що таке Deadlock?  - 2" src="https://cdn.javarush.com/images/article/c42c278d-3ce4-45b4-95e5-c7b8c8c024c3/512.jpeg" style="width: 710px;">
 </div>
</div>У цьому випадку обидві нитки заблоковані, і кожна очікує, що інша віддасть лок. Але жодна це не зробить, тому що для цього потрібно завершити свій метод, а він заблокований іншою ниткою. Тому вони застрягли на місці, трапився <code class=" language-none">deadlock</code>. Втім, можливе й інше переплетення, в якому одна з ниток встигне завершитися до початку другої: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">A</span></span><span class="token operator"><span class="token operator">:</span></span> alphonse<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>gaston<span class="token punctuation"><span class="token punctuation">)</span></span> — получает лок alphonse
<span class="token class-name"><span class="token class-name">A</span></span><span class="token operator"><span class="token operator">:</span></span> gaston<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bowBack</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>alphonse<span class="token punctuation"><span class="token punctuation">)</span></span> — получает лок gaston
<span class="token class-name"><span class="token class-name">A</span></span><span class="token operator"><span class="token operator">:</span></span> возвращается из обоих методов<span class="token punctuation"><span class="token punctuation">,</span></span> открывая оба лока
<span class="token class-name"><span class="token class-name">G</span></span><span class="token operator"><span class="token operator">:</span></span> gaston<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>alphonse<span class="token punctuation"><span class="token punctuation">)</span></span> — получает лок gaston
<span class="token class-name"><span class="token class-name">G</span></span><span class="token operator"><span class="token operator">:</span></span> alphonse<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bowBack</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>gaston<span class="token punctuation"><span class="token punctuation">)</span></span> — получает лок alphonse
<span class="token class-name"><span class="token class-name">G</span></span><span class="token operator"><span class="token operator">:</span></span> возвращается из обоих методов<span class="token punctuation"><span class="token punctuation">,</span></span> открывая оба лока</code></pre> В цьому випадку взаємного блокування ниток немає. Наприклад, доданий якийсь метод, що дозволяє іншій нитки встигнути виконатися. Коли результат залежить від порядку подій, що одночасно відбуваються (запланованого порядку або швидкості виконання), такий процес називається race condition російською — «стан гонки». Не всі race condition потенційно виробляють дідлок, проте, на мій досвід, дідлоки відбуваються тільки в race condition. <strong>Автор відповіді: </strong> <a href="https://stackoverflow.com/users/2535549/dave-lillethun" target="_blank">Dave Lillethun</a>
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <th>Що ще почитати:</th>
   </tr>
   <tr>
    <td>
     <p><strong><em>Група Java Developer:</em></strong></p>
     <p><a href="https://codegym.cc/groups/posts/292-kljevihe-optimizacii-sql-ne-zavisjajshie-ot-stoimostnoy-modeli" target="_blank">Кльові оптимізації SQL, що не залежать від вартісної моделі. Частина 1</a></p>
     <p><a href="https://codegym.cc/groups/posts/136-reguljarnihe-vihrazhenija-v-java-chastjh-1" target="_blank">Регулярні вирази в Java, частина 1</a></p></td>
   </tr>
  </tbody>
 </table>
</div>