Thread'ом Java не зіпсуєш: Частина III - взаємодія
<p>----------------------------------------</p>
Короткий огляд особливостей взаємодії потоків. Раніше ми розібрали, як потоки синхронізуються один з одним. На цей раз ми поринемо в проблеми, які можуть виникнути при взаємодії потоків і поговоримо про те, як їх можна уникнути. Також навед
<p>----------------------------------------</p>
Короткий огляд особливостей взаємодії потоків. Раніше ми розібрали, як потоки синхронізуються один з одним. На цей раз ми поринемо в проблеми, які можуть виникнути при взаємодії потоків і поговоримо про те, як їх можна уникнути. Також наведемо кілька корисних посилань для глибшого вивчення. <img data-max-width="800" data-id="f9de239f-14b1-4eb0-878d-36849844baa7" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина III - взаємодія - 1" src="https://cdn.javarush.com/images/article/f9de239f-14b1-4eb0-878d-36849844baa7/800.jpeg" style="width: 800px;">
<h2>Вступ</h2>Отже, ми знаємо, що в Java є потоки, про що можна прочитати в огляді " <a href="https://codegym.cc/groups/posts/2047-threadom-java-ne-isportishjh--chastjh-i---potoki" target="_blank" rel="nofollow">Thread'ом Java не зіпсуєш: Частина I - потоки</a> " і що потоки можна синхронізувати між собою, з чим ми розбиралися в огляді " <a href="https://codegym.cc/groups/posts/2048-threadom-java-ne-isportishjh--chastjh-ii---sinkhronizacija" target="_blank" rel="nofollow">Thread'ом Java не зіпсуєш: Частина II – синхронізація</a> ”. Настав час поговорити про те, як потоки взаємодіють між собою. Як вони ділять спільні ресурси? Які із цим можуть бути проблеми? 
<h2>Deadlock</h2>Найстрашнішою проблемою є Deadlock. Коли два і більше потоків завжди чекають один одного — це називається Deadlock. Візьмемо приклад із сайту Oracle з опису поняття " <a href="https://docs.oracle.com/javase/tutorial/essential/concurrency/deadlock.html" target="_blank" rel="nofollow">Deadlock</a> ": 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Deadlock</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Friend</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">String</span></span> name<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Friend</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> name<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>name <span class="token operator"><span class="token operator">=</span></span> name<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">String</span></span> <span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">return</span></span> <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>name<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">bow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Friend</span></span> bower<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">format</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"%s: %s has bowed to me!%n"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span>
                    <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>name<span class="token punctuation"><span class="token punctuation">,</span></span> bower<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            bower<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bowBack</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">bowBack</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Friend</span></span> bower<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">format</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"%s: %s has bowed back to me!%n"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span>
                    <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>name<span class="token punctuation"><span class="token punctuation">,</span></span> bower<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Friend</span></span> alphonse <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Friend</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Alphonse"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Friend</span></span> gaston <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Friend</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Gaston"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> alphonse<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>gaston<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> gaston<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bow</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>alphonse<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Deadlock тут може проявитися не з першого разу, але якщо у вас виконання програми зависло, саме час запустити <code class=" language-none">jvisualvm</code>: <img data-max-width="800" data-id="0ec52f6a-18d2-42bf-b1e8-4fc0596fb697" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина III - взаємодія - 2" src="https://cdn.javarush.com/images/article/0ec52f6a-18d2-42bf-b1e8-4fc0596fb697/800.jpeg" style="width: 800px;">Якщо в JVisualVM встановлений плагін (через Tools -&gt; Plugins), ми зможемо побачити, де стався дідлок: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token string"><span class="token string">"Thread-1"</span></span> <span class="token operator"><span class="token operator">-</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span> t<span class="token annotation punctuation"><span class="token annotation punctuation">@12</span></span>
   <span class="token class-name"><span class="token namespace"></span><span class="token class-name"><span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>Thread<span class="token punctuation"><span class="token punctuation">.</span></span>State</span></span><span class="token operator"><span class="token operator">:</span></span> BLOCKED
    at <span class="token class-name"><span class="token class-name">Deadlock</span></span>$<span class="token class-name"><span class="token class-name">Friend</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">bowBack</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Deadlock</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>java<span class="token operator"><span class="token operator">:</span></span><span class="token number"><span class="token number">16</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
    <span class="token operator"><span class="token operator">-</span></span> waiting <span class="token keyword"><span class="token keyword">to</span></span> <span class="token namespace"><span class="token namespace">lock</span></span> <span class="token operator"><span class="token operator">&amp;</span></span>lt33a78231<span class="token operator"><span class="token operator">&gt;</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>a <span class="token class-name"><span class="token class-name">Deadlock</span></span>$<span class="token class-name"><span class="token class-name">Friend</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> owned by <span class="token string"><span class="token string">"Thread-0"</span></span> t<span class="token annotation punctuation"><span class="token annotation punctuation">@11</span></span></code></pre> Потік 1 чекає на лок від потоку 0. Чому так виходить? <code class=" language-none">Thread-1</code>починає виконання і виконує метод <code class=" language-none">Friend#bow</code>. Він позначений ключовим словом <code class=" language-none">synchronized</code>, тобто ми забираємо монітор <code class=" language-none">this</code>. Ми на вхід у метод отримали посилання на іншого <code class=" language-none">Friend</code>. Тепер, потік <code class=" language-none">Thread-1</code>хоче виконати метод в іншого <code class=" language-none">Friend</code>, тим самим отримавши лок і в нього. Але якщо інший потік (в даному випадку <code class=" language-none">Thread-0</code>) встиг увійти в метод <code class=" language-none">bow</code>, то лок вже зайнятий і <code class=" language-none">Thread-1</code>чекає <code class=" language-none">Thread-0</code>, і навпаки. Блокування нерозв'язне, тому воно Dead, тобто мертве. Як мертва хватка (яку не розтиснути), так і мертве блокування, з якого не вийти. На тему дідлока можна подивитися відео: " <a href="https://youtu.be/s032s29-NUU?t=698" target="_blank" rel="nofollow">Deadlock - Concurrency #1 - Advanced Java</a> ". 
<h2>Livelock</h2>Якщо є Deadlock, чи є Livelock? Так, є) Livelock полягає в тому, що потоки зовні живуть, але при цьому не можуть нічого зробити, т.к. умова, якими вони намагаються продовжити своєї роботи, що неспроможні виконатися. Насправді Livelock схожий на deadlock, але тільки потоки не "зависають" на системному очікуванні монітора, а щось завжди роблять. Наприклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span>locks<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Lock</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span>locks<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">ReentrantLock</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">App</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">String</span></span> ANSI_BLUE <span class="token operator"><span class="token operator">=</span></span> <span class="token string"><span class="token string">"\u001B[34m"</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">String</span></span> ANSI_PURPLE <span class="token operator"><span class="token operator">=</span></span> <span class="token string"><span class="token string">"\u001B[35m"</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">log</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> text<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">String</span></span> name <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">//like Thread-1 or Thread-0</span></span>
        <span class="token class-name"><span class="token class-name">String</span></span> color <span class="token operator"><span class="token operator">=</span></span> ANSI_BLUE<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">int</span></span> val <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Integer</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">valueOf</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>name<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">substring</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>name<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">lastIndexOf</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"-"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>val <span class="token operator"><span class="token operator">!=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            color <span class="token operator"><span class="token operator">=</span></span> ANSI_PURPLE<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>color <span class="token operator"><span class="token operator">+</span></span> name <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">": "</span></span> <span class="token operator"><span class="token operator">+</span></span> text <span class="token operator"><span class="token operator">+</span></span> color<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>color <span class="token operator"><span class="token operator">+</span></span> name <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">": wait for "</span></span> <span class="token operator"><span class="token operator">+</span></span> val <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">" sec"</span></span> <span class="token operator"><span class="token operator">+</span></span> color<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>val <span class="token operator"><span class="token operator">*</span></span> <span class="token number"><span class="token number">1000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            e<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">printStackTrace</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">Lock</span></span> first <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ReentrantLock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">Lock</span></span> second <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ReentrantLock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

        <span class="token class-name"><span class="token class-name">Runnable</span></span> locker <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">boolean</span></span> firstLocked <span class="token operator"><span class="token operator">=</span></span> <span class="token boolean"><span class="token boolean">false</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token keyword"><span class="token keyword">boolean</span></span> secondLocked <span class="token operator"><span class="token operator">=</span></span> <span class="token boolean"><span class="token boolean">false</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                <span class="token keyword"><span class="token keyword">while</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token operator"><span class="token operator">!</span></span>firstLocked <span class="token operator"><span class="token operator">||</span></span> <span class="token operator"><span class="token operator">!</span></span>secondLocked<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                    firstLocked <span class="token operator"><span class="token operator">=</span></span> first<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">tryLock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">100</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>MILLISECONDS<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                    <span class="token function"><span class="token function">log</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"First Locked: "</span></span> <span class="token operator"><span class="token operator">+</span></span> firstLocked<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                    secondLocked <span class="token operator"><span class="token operator">=</span></span> second<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">tryLock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">100</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>MILLISECONDS<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                    <span class="token function"><span class="token function">log</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Second Locked: "</span></span> <span class="token operator"><span class="token operator">+</span></span> secondLocked<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token punctuation"><span class="token punctuation">}</span></span>
                first<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">unlock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                second<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">unlock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                e<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">printStackTrace</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>locker<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>locker<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Успішність цього коду залежить від того, як планувальник потоків Java запустить потоки. Якщо першим запуститься <code class=" language-none">Thead-1</code>, ми отримаємо Livelock: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Thread</span></span><span class="token operator"><span class="token operator">-</span></span><span class="token number"><span class="token number">1</span></span><span class="token operator"><span class="token operator">:</span></span> <span class="token class-name"><span class="token class-name">First</span></span> <span class="token class-name"><span class="token class-name">Locked</span></span><span class="token operator"><span class="token operator">:</span></span> <span class="token boolean"><span class="token boolean">true</span></span>
<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token operator"><span class="token operator">-</span></span><span class="token number"><span class="token number">1</span></span><span class="token operator"><span class="token operator">:</span></span> wait <span class="token keyword"><span class="token keyword">for</span></span> <span class="token number"><span class="token number">2</span></span> sec
<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token operator"><span class="token operator">-</span></span><span class="token number"><span class="token number">0</span></span><span class="token operator"><span class="token operator">:</span></span> <span class="token class-name"><span class="token class-name">First</span></span> <span class="token class-name"><span class="token class-name">Locked</span></span><span class="token operator"><span class="token operator">:</span></span> <span class="token boolean"><span class="token boolean">false</span></span>
<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token operator"><span class="token operator">-</span></span><span class="token number"><span class="token number">0</span></span><span class="token operator"><span class="token operator">:</span></span> wait <span class="token keyword"><span class="token keyword">for</span></span> <span class="token number"><span class="token number">1</span></span> sec
<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token operator"><span class="token operator">-</span></span><span class="token number"><span class="token number">0</span></span><span class="token operator"><span class="token operator">:</span></span> <span class="token class-name"><span class="token class-name">Second</span></span> <span class="token class-name"><span class="token class-name">Locked</span></span><span class="token operator"><span class="token operator">:</span></span> <span class="token boolean"><span class="token boolean">true</span></span>
<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token operator"><span class="token operator">-</span></span><span class="token number"><span class="token number">0</span></span><span class="token operator"><span class="token operator">:</span></span> wait <span class="token keyword"><span class="token keyword">for</span></span> <span class="token number"><span class="token number">1</span></span> sec
<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token operator"><span class="token operator">-</span></span><span class="token number"><span class="token number">1</span></span><span class="token operator"><span class="token operator">:</span></span> <span class="token class-name"><span class="token class-name">Second</span></span> <span class="token class-name"><span class="token class-name">Locked</span></span><span class="token operator"><span class="token operator">:</span></span> <span class="token boolean"><span class="token boolean">false</span></span>
<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token operator"><span class="token operator">-</span></span><span class="token number"><span class="token number">1</span></span><span class="token operator"><span class="token operator">:</span></span> wait <span class="token keyword"><span class="token keyword">for</span></span> <span class="token number"><span class="token number">2</span></span> sec
<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token operator"><span class="token operator">-</span></span><span class="token number"><span class="token number">0</span></span><span class="token operator"><span class="token operator">:</span></span> <span class="token class-name"><span class="token class-name">First</span></span> <span class="token class-name"><span class="token class-name">Locked</span></span><span class="token operator"><span class="token operator">:</span></span> <span class="token boolean"><span class="token boolean">false</span></span>
<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token operator"><span class="token operator">-</span></span><span class="token number"><span class="token number">0</span></span><span class="token operator"><span class="token operator">:</span></span> wait <span class="token keyword"><span class="token keyword">for</span></span> <span class="token number"><span class="token number">1</span></span> sec
<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token punctuation"><span class="token punctuation">.</span></span></code></pre> Як видно з прикладу, обидва потоки по черзі намагаються захопити обидва локи, але їм це не вдається. При цьому вони не в deadlock, тобто візуально з ними все добре, і вони виконують свою роботу. <img data-max-width="800" data-id="9deb012c-95e3-4578-a5a5-4dd9a8a64cf7" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина III - взаємодія - 3" src="https://cdn.javarush.com/images/article/9deb012c-95e3-4578-a5a5-4dd9a8a64cf7/800.jpeg" style="width: 800px;">По JVisualVM ми бачимо періоди sleep і період park (це коли потік намагається зайняти лок, він переходить у стан park, як ми розбирали раніше, говорячи про <a href="https://codegym.cc/groups/posts/2048-threadom-java-ne-isportishjh--chastjh-ii---sinkhronizacija" target="_blank" rel="nofollow">синхронізацію потоків</a> ). На тему лайвлока можна подивитися приклад: " <a href="https://www.logicbig.com/tutorials/core-java-tutorial/java-multi-threading/thread-livelock.html" target="_blank" rel="nofollow">Java - Thread Livelock</a> ". 
<h2>Starvation</h2>Крім блокувань (deadlock та livelock) є ще одна проблема при роботі з багатопоточністю - Starvation, або "голодування". Від блокувань це явище відрізняється тим, що потоки не заблоковані, а просто не вистачає ресурсів на всіх. Тому поки одні потоки на себе беруть весь час виконання, інші не можуть виконатися: <img data-max-width="800" data-id="e82cb897-6396-449f-bef1-b8870c2e3b83" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина III - взаємодія - 4" src="https://cdn.javarush.com/images/article/e82cb897-6396-449f-bef1-b8870c2e3b83/800.jpeg" style="width: 800px;">
<center>
 <p><small><em>https://www.logicbig.com/</em></small></p>
</center>Супер приклад можна подивитися тут: " <a href="https://www.logicbig.com/tutorials/core-java-tutorial/java-multi-threading/thread-starvation.html" target="_blank" rel="nofollow">Java - Thread Starvation and Fairness</a> ". У цьому прикладі показано, як працюють потоки при Starvation і як одна маленька зміна Thread.sleep на Thread.wait дозволяє розподілити навантаження рівномірно. <img data-max-width="800" data-id="b48844ed-680e-4719-8730-c4e0a3875450" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина III - взаємодія - 5" src="https://cdn.javarush.com/images/article/b48844ed-680e-4719-8730-c4e0a3875450/800.jpeg" style="width: 800px;">
<h2>Race Condition</h2>Працюючи з многопоточностью є таке поняття, як " стан гонки " . Це явище полягає в тому, що потоки ділять між собою певний ресурс і код написаний таким чином, що не передбачає коректної роботи в такому випадку. Погляньмо на приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">App</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">int</span></span> value <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> i <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">10000</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                <span class="token keyword"><span class="token keyword">int</span></span> oldValue <span class="token operator"><span class="token operator">=</span></span> value<span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token keyword"><span class="token keyword">int</span></span> newValue <span class="token operator"><span class="token operator">=</span></span> <span class="token operator"><span class="token operator">++</span></span>value<span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>oldValue <span class="token operator"><span class="token operator">+</span></span> <span class="token number"><span class="token number">1</span></span> <span class="token operator"><span class="token operator">!=</span></span> newValue<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                    <span class="token keyword"><span class="token keyword">throw</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">IllegalStateException</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>oldValue <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">" + 1 = "</span></span> <span class="token operator"><span class="token operator">+</span></span> newValue<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token punctuation"><span class="token punctuation">}</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Цей код може видати помилку не з першого разу. І виглядати вона може таким чином: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Exception</span></span> in thread <span class="token string"><span class="token string">"Thread-1"</span></span> <span class="token class-name"><span class="token namespace"></span><span class="token class-name"><span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>IllegalStateException</span></span><span class="token operator"><span class="token operator">:</span></span> <span class="token number"><span class="token number">7899</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token number"><span class="token number">1</span></span> <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">7901</span></span>
    at <span class="token class-name"><span class="token class-name">App</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>lambda$main$<span class="token function"><span class="token function">0</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">App</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>java<span class="token operator"><span class="token operator">:</span></span><span class="token number"><span class="token number">13</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
    at <span class="token class-name"><span class="token namespace"></span><span class="token class-name"><span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">run</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>java<span class="token operator"><span class="token operator">:</span></span><span class="token number"><span class="token number">745</span></span><span class="token punctuation"><span class="token punctuation">)</span></span></code></pre> Як видно, поки що присвоювалося <code class=" language-none">newValue</code>щось пішло не так, і <code class=" language-none">newValue</code>стало більше. Якийсь із потоків у стані гонки встиг змінити <code class=" language-none">value</code>між цими двома командами. Як бачимо, виявилася гонка між потоками. А тепер уявіть, як важливо не робити схожі помилки з грошовими операціями... Приклади та схеми можна подивитися ще й тут: "Code <a href="https://stackoverflow.com/questions/25156724/code-to-simulate-race-condition-in-java-thread" target="_blank" rel="nofollow">to simulate race condition in Java thread</a> ". 
<h2>Volatile</h2>Говорячи про взаємодію потоків, варто особливо відзначити ключове слово <code class=" language-none">volatile</code>. Подивимося на простий приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">App</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">boolean</span></span> flag <span class="token operator"><span class="token operator">=</span></span> <span class="token boolean"><span class="token boolean">false</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">Runnable</span></span> whileFlagFalse <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">while</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token operator"><span class="token operator">!</span></span>flag<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Flag is now TRUE"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>whileFlagFalse<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">1000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        flag <span class="token operator"><span class="token operator">=</span></span> <span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Найцікавіше, що він із високою ймовірністю не відпрацює. Новий потік не побачить зміни <code class=" language-none">flag</code>. Щоб це виправити для поля, <code class=" language-none">flag</code>потрібно вказати ключове слово <code class=" language-none">volatile</code>. Як же і чому? Усі дії виконує процесор. Але результати обчислень треба десь зберігати. Для цього є основна пам'ять і є апаратний кеш процесора. Ці кеші процесора - свого роду маленький шматочок пам'яті для швидшого звернення до даних, ніж звернення до основної пам'яті. Але всього є і мінус: дані в кеші можуть бути не актуальні (як у прикладі вище, коли значення прапора не оновилося). Так ось, ключове слово <code class=" language-none">volatile</code>вказує на JVM, що ми не хочемо кешувати нашу змінну. Це дає змогу побачити актуальний результат у всіх потоках. Це дуже спрощене формулювання. На тему<code class=" language-none">volatile</code>настійно рекомендується до прочитання перекладу " <a href="https://habr.com/company/golovachcourses/blog/221133/#10" target="_blank" rel="nofollow">JSR 133 (Java Memory Model) FAQ</a> ". Детальніше раджу також ознайомитися з матеріалами " <a href="http://tutorials.jenkov.com/java-concurrency/java-memory-model.html" target="_blank" rel="nofollow">Java Memory Model</a> " та " <a href="http://tutorials.jenkov.com/java-concurrency/volatile.html" target="_blank" rel="nofollow">Java Volatile Keyword</a> ". Крім того, важливо пам'ятати, що <code class=" language-none">volatile</code>це про видимість, а не про атомарність змін. Якщо взяти код з "Race Condition", то ми побачимо в IntelliJ Idea підказку: <img data-max-width="512" data-id="226a818d-c6d6-4414-87f8-f4aee1a63060" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина III - взаємодія - 6" src="https://cdn.javarush.com/images/article/226a818d-c6d6-4414-87f8-f4aee1a63060/512.jpeg" style="width: 512px;">Ця перевірка (Inspection) була додана до IntelliJ Idea в рамках issue <a href="https://youtrack.jetbrains.net/issue/IDEA-61117" target="_blank" rel="nofollow">IDEA-61117</a> , який вказаний у <a href="https://confluence.jetbrains.com/display/IDEADEV/IDEA+X+98.382+Release+Notes" target="_blank" rel="nofollow">Release Notes</a> ще в далекому 2010 році. <a href="https://codegym.cc/welcome" target="_blank"><img id="click_banner1_articles" data-max-width="1024" data-id="305c6300-8f17-42bc-9ead-f24873120256" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина III - взаємодія - 7" src="https://cdn.javarush.com/images/article/305c6300-8f17-42bc-9ead-f24873120256/1024.jpeg" style="width: 1024px;"></a>
<h2>Атомарність</h2>Атомарні операції це операції, які не можна розділити. Наприклад, операція надання значення змінної — атомарна. На жаль, інкремент перестав бути атомарної операцією, т.к. для інкременту потрібно аж три операції: отримати старе значення, додати до нього одиницю, зберегти значення. Чому важлива атомарність? У прикладі з інкрементом, якщо з'явиться стан гонки, будь-якої миті загальний ресурс (тобто загальне значення) може раптово змінитися. Крім того, важливо, що 64-бітові структури теж не атомарні, наприклад, <code class=" language-none">long</code>і <code class=" language-none">double</code>. Детальніше можна прочитати тут: " <a href="https://wiki.sei.cmu.edu/confluence/display/java/VNA05-J.+Ensure+atomicity+when+reading+and+writing+64-bit+values" target="_blank" rel="nofollow">Ensure atomicity when reading and writing 64-bit values</a> ​​". Приклад проблем з атомарністю можна побачити на прикладі: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">App</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">int</span></span> value <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">AtomicInteger</span></span> atomic <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">AtomicInteger</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> i <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">10000</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                value<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                atomic<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">incrementAndGet</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> i <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">3</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">300</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>value<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>atomic<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">get</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Спеціальний клас для роботи з атомарним <code class=" language-none">Integer</code>завжди виводитиме нам 30000, а ось <code class=" language-none">value</code>змінюватиметься від разу до разу. На цю тему є невеликий огляд " <a href="https://www.baeldung.com/java-atomic-variables" target="_blank" rel="nofollow">An Introduction to Atomic Variables in Java</a> ". В основі Atomic'ів лежить алгоритм "Compare-and-Swap". Докладніше про нього можна прочитати у статті на хабрі " <a href="https://habr.com/post/319036/" target="_blank" rel="nofollow">Порівняння Lock-free алгоритмів - CAS і FAA на прикладі JDK 7 і 8</a> " або на вікіпедії у статті про " <a href="https://ru.wikipedia.org/wiki/%D0%A1%D1%80%D0%B0%D0%B2%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D1%81_%D0%BE%D0%B1%D0%BC%D0%B5%D0%BD%D0%BE%D0%BC" target="_blank" rel="nofollow">Порівняння з обміном</a> ". <img data-max-width="512" data-id="78607131-1e74-4e1f-8f1c-bd81164525d9" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина III - взаємодія - 8" src="https://cdn.javarush.com/images/article/78607131-1e74-4e1f-8f1c-bd81164525d9/512.jpeg" style="width: 512px;">
<center>
 <p><small><em>http://jeremymanson.blogspot.com/2008/11/what-volatile-means-in-java.html</em></small></p>
</center>
<h2>Happens Before</h2>Є цікава та загадкова штука – Happens Before. Розмірковуючи про потоки, про неї варто також прочитати. Відношення Happens Before показує, в якому порядку буде видно дії між потоками. Існує чимало трактувань та тлумачень. Однією з останніх доповідей на цю тему є ось ця доповідь:
<div class="row">
 <div class="col col-md-10 col-lg-8">
  <div class="embed-responsive embed-responsive-16by9" style="white-space: normal">
   <iframe width="560" height="315" src="https://www.youtube.com/embed/C6b_dFtujKo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen data-savepage-key="0-2"></iframe>
  </div>
 </div>
</div>Напевно, краще, ніж це відео, нічого не розповість про це. Тому я просто залишу посилання на відео. Прочитати можна " <a href="https://www.logicbig.com/tutorials/core-java-tutorial/java-multi-threading/happens-before.html" target="_blank" rel="nofollow">Java - Understanding Happens-before relationship</a> ". 
<h2>Підсумки</h2>У цьому огляді ми переглянули особливості взаємодії потоків. Обговорабо проблеми, які можуть виникнути та способи їх виявлення та усунення. Список додаткових матеріалів на тему: 
<ul>
 <li><a href="https://habr.com/post/248041/" target="_blank" rel="nofollow">Ще раз про double-checked locking</a><!--*li--></li>
 <li><a href="https://habr.com/company/golovachcourses/blog/221133/" target="_blank" rel="nofollow">JSR 133 (Java Memory Model) FAQ (переклад)</a></li>
 <li><a href="https://www.youtube.com/watch?v=s032s29-NUU&amp;list=PL6jg6AGdCNaXo06LjCBmRao-qJdf38oKp" target="_blank" rel="nofollow">Advanced Java - Concurrency (Юрій Ткач)</a></li>
 <li><a href="https://www.youtube.com/watch?v=ADxUsCkWdbE&amp;t=470s" target="_blank" rel="nofollow">Concurrency Concepts in Java by Douglas Hawkins (2017)</a></li>
</ul>#Viacheslav 
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <th>Що ще почитати:</th>
   </tr>
   <tr>
    <td><a href="https://codegym.cc/groups/posts/2047-threadom-java-ne-isportishjh--chastjh-i---potoki" target="_blank">Thread'ом Java не зіпсуєш: Частина I - потоки </a><br><a href="https://codegym.cc/groups/posts/2048-threadom-java-ne-isportishjh--chastjh-ii---sinkhronizacija" target="_blank">Thread'ом Java не зіпсуєш: Частина II - синхронізація </a><br><a href="https://codegym.cc/groups/posts/2065-threadom-java-ne-isportishjh--chastjh-iv---callable-future-i-druzjhja" target="_blank">Thread'ом Java не зіпсуєш: Частина IV - Callable, Future та друзі </a><br><a href="https://codegym.cc/groups/posts/2078-threadom-java-ne-isportishjh--chastjh-v---executor-threadpool-fork-join-pool" target="_blank">Thread'ом Java не зіпсуєш: Частина V - Executor, ThreadPool , Fork Join </a><br><a href="https://codegym.cc/groups/posts/2111-threadom-java-ne-isportishjh--chastjh-vi---k-barjheru" target="_blank">Thread'ом Java не зіпсуєш: Частина VI - До бар'єру!</a></td>
   </tr>
  </tbody>
 </table>
</div>