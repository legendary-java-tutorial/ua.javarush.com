Thread'ом Java не зіпсуєш: Частина IV - Callable, Future та друзі
<p>----------------------------------------</p>
Ми вже розглядали у , як створюються потоки. Ще раз згадаємо. Потік - це , в ньому щось запускається , тому скористаємося і виконаємо наступний код: Чи єдиний це варіант запуску завдання в потоці? Виявляється, у є брат і звуть його і з'явив
<p>----------------------------------------</p>
<h2>Вступ</h2>Ми вже розглядали у <a href="https://codegym.cc/groups/posts/2047-threadom-java-ne-isportishjh--chastjh-i---potoki" target="_blank" rel="nofollow">першій частині</a> , як створюються потоки. Ще раз згадаємо. <img data-max-width="800" data-id="2e89a4c6-8d22-4ca5-95d2-9151e6ca180b" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина IV - Callable, Future та друзі - 1" src="https://cdn.javarush.com/images/article/2e89a4c6-8d22-4ca5-95d2-9151e6ca180b/800.jpeg" style="width: 800px;">Потік - це <code class=" language-none">Thread</code>, в ньому щось запускається <code class=" language-none">run</code>, тому скористаємося <a href="https://www.tutorialspoint.com/compile_java_online.php" target="_blank" rel="nofollow">tutorialspoint java online compiler'ом</a> і виконаємо наступний код: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">HelloWorld</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Hello World"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Чи єдиний це варіант запуску завдання в потоці? 
<h2>java.util.concurrent.Callable</h2>Виявляється, у <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Runnable.html" target="_blank" rel="nofollow">java.lang.Runnable</a> є брат і звуть його <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Callable.html" target="_blank" rel="nofollow">java.util.concurrent.Callable</a> і з'явився він на світ Java 1.5. У чому ж різниця? Якщо придивитися до JavaDoc цього інтерфейсу, ми бачимо, що на відміну від <code class=" language-none">Runnable</code>, новий інтерфейс оголошує метод <code class=" language-none">call</code>, який повертає результат. Крім того, за умовчанням він throws Exception. Тобто позбавляє нас необхідності на виключення, що перевіряються, писати <code class=" language-none">try-catch</code>блоки. Вже непогано, правда? Тепер у нас є замість <code class=" language-none">Runnable</code>нового task: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Callable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">return</span></span> <span class="token string"><span class="token string">"Hello, World!"</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Але що з нею робити? Навіщо нам взагалі завдання, яке виконується в потоці, яке повертає результат? Очевидно, що надалі ми розраховуємо отримати результат дій, які в майбутньому будуть виконані. Майбутнє англійською — Future. І інтерфейс є з таким самим ім'ям:<code class=" language-none">java.util.concurrent.Future</code>
<h2>java.util.concurrent.Future</h2>Інтерфейс <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Future.html" target="_blank" rel="nofollow">java.util.concurrent.Future</a> описує API для роботи із завданнями, результат яких ми плануємо отримати в майбутньому: методи отримання результату, методи перевірки статусу. Для <code class=" language-none">Future</code>нас цікавить його реалізація <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/FutureTask.html" target="_blank" rel="nofollow">java.util.concurrent.FutureTask</a> . Тобто це <code class=" language-none">Task</code>, який буде виконано <code class=" language-none">Future</code>. Чим ця реалізація ще цікава, то це тим, що вона реалізує і <code class=" language-none">Runnable</code>. Можна вважати це свого роду адаптером старої моделі роботи із завданнями в потоках та нової моделі (нової в тому сенсі, що вона з'явилася в java 1.5). Ось приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Callable</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">FutureTask</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">HelloWorld</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">Exception</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">Callable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">return</span></span> <span class="token string"><span class="token string">"Hello, World!"</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">FutureTask</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> future <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">FutureTask</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>future<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>future<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">get</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як видно з прикладу, ми отримуємо за допомогою методу <code class=" language-none">get</code>результат із завдання <code class=" language-none">task</code>. <mark>(!) Важливо</mark>, що у момент отримання результату з допомогою методу <code class=" language-none">get</code>виконання стає синхронним. Як ви вважаєте, який механізм тут буде використаний? Правильно, немає блоку синхронізації - тому <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Thread.State.html#WAITING" target="_blank" rel="nofollow">WAITING</a> в JVisualVM ми побачимо не як <code class=" language-none">monitor</code>або <code class=" language-none">wait</code>, а як цей <code class=" language-none">park</code>(т.к. використовується механізм <code class=" language-none">LockSupport</code>). 
<h2>Функціональні інтерфейси</h2>Далі йтиметься про класи з Java 1.8, тому не зайвим буде зробити короткий вступ. Подивимося на наступний код: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Supplier</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> supplier <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Supplier</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">String</span></span> <span class="token function"><span class="token function">get</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">return</span></span> <span class="token string"><span class="token string">"String"</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">Consumer</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> consumer <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Consumer</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">accept</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> s<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>s<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">Function</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Integer</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> converter <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Function</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Integer</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Integer</span></span> <span class="token function"><span class="token function">apply</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> s<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">return</span></span> <span class="token class-name"><span class="token class-name">Integer</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">valueOf</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>s<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Як же багато зайвого коду, чи не так? Кожен з класів, що оголошуються, виконує якусь одну функцію, але для її опису ми використовуємо купу зайвого допоміжного коду. І розробники Java так само подумали. Тому вони ввели набір "функціональних інтерфейсів" ( <code class=" language-none">@FunctionalInterface</code>) і вирішабо, що тепер Java сама "додумуватиме" за нас все, крім важливого: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Supplier</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> supplier <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token string"><span class="token string">"String"</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">Consumer</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> consumer <span class="token operator"><span class="token operator">=</span></span> s <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>s<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">Function</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Integer</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> converter <span class="token operator"><span class="token operator">=</span></span> s <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token class-name"><span class="token class-name">Integer</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">valueOf</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>s<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre><code class=" language-none">Supplier</code>- Постачальник. Він не має параметрів, але повертає щось, тобто постачає це. <code class=" language-none">Consumer</code>- Споживач. Він приймає на вхід щось (параметр s) і з цим щось робить, тобто споживає щось. Є ще функція. Вона приймає на вхід щось (параметр <code class=" language-none">s</code>), щось робить і щось повертає. Як бачимо, активно використовуються дженерики. У разі невпевненості можна згадати про них і прочитати " <a href="https://codegym.cc/groups/posts/2004-teorija-dzhenerikov-v-java-ili-gde-na-praktike-stavitjh-skobki" target="_blank" rel="nofollow">Теорія дженериків у Java або як на практиці ставити дужки</a> ". 
<h2>CompletableFuture</h2>Минав час, і в Java 1.8 з'явився новий клас, який зветься <code class=" language-none">CompletableFuture</code>. Він реалізує інтерфейс <code class=" language-none">Future</code>, тобто наші <code class=" language-none">task</code>будуть виконані в майбутньому, і ми зможемо виконати <code class=" language-none">get</code>та отримати результат. Але ще він реалізує деякий <code class=" language-none">CompletionStage</code>. З перекладу зрозуміло його призначення: це якийсь етап (Stage) якихось обчислень. З коротким введенням у тему можна ознайомитись у огляді " <a href="http://millross-consultants.com/completion-stage-future-introduction.html" target="_blank" rel="nofollow">Introduction to CompletionStage and CompletableFuture</a> ". Давайте перейдемо одразу до справи. Подивімося на список доступних статичних методів, які нам допоможуть розпочати: <img data-max-width="800" data-id="231e6b36-edb8-42b1-b8bb-04ed8b95c034" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина IV - Callable, Future та друзі - 2" src="https://cdn.javarush.com/images/article/231e6b36-edb8-42b1-b8bb-04ed8b95c034/800.jpeg" style="width: 800px;">Ось варіанти їх використання: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">App</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">Exception</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token comment"><span class="token comment">// CompletableFuture уже содержащий результат</span></span>
        <span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> completed<span class="token punctuation"><span class="token punctuation">;</span></span>
        completed <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">completedFuture</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Просто значення"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token comment"><span class="token comment">// CompletableFuture, запускающий (run) новый поток с Runnable, поэтому он Void</span></span>
        <span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Void</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> voidCompletableFuture<span class="token punctuation"><span class="token punctuation">;</span></span>
        voidCompletableFuture <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">runAsync</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"run "</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token comment"><span class="token comment">// CompletableFuture, запускающий новый поток, результат которого возьмём у Supplier</span></span>
        <span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> supplier<span class="token punctuation"><span class="token punctuation">;</span></span>
        supplier <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">supplyAsync</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"supply "</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token keyword"><span class="token keyword">return</span></span> <span class="token string"><span class="token string">"Значение"</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Якщо ми виконаємо цей код, то побачимо, що створення <code class=" language-none">CompletableFuture</code>передбачає запуск і всього ланцюжка. Тому при певній схожості зі SteamAPI з Java8 у цьому відмінність цих підходів. Наприклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">List</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> array <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Arrays</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">asList</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"one"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token string"><span class="token string">"two"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">Stream</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> stringStream <span class="token operator"><span class="token operator">=</span></span> array<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">stream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">map</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>value <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Executed"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">return</span></span> value<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">toUpperCase</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Це приклад Java 8 Stream Api (докладніше можна з ним ознайомитися тут " <a href="https://annimon.com/article/2778" target="_blank" rel="nofollow">Посібник з Java 8 Stream API в картинках і прикладах</a> "). Якщо запустити цей код, <code class=" language-none">Executed</code>не з'явиться. Тобто при створенні стриму Java стрім не запускається відразу, а чекає, коли з нього захочуть значення. А ось <code class=" language-none">CompletableFuture</code>запускає ланцюжок на виконання одразу, не чекаючи на те, що в нього попросять пораховане значення. Вважаю важливим це розуміти. Отже, ми маємо CompletableFuture. Як же ми можемо скласти ланцюжок і які ми маємо кошти? Згадаймо про функціональні інтерфейси, про які ми писали раніше. 
<ul>
 <li>Ми маємо функцію ( <code class=" language-none">Function</code>), яка приймає А і повертає Б. Має єдиний метод — <code class=" language-none">apply</code>(застосувати).</li>
 <li>У нас є споживач ( <code class=" language-none">Consumer</code>), який приймає А і нічого не повертає (Void). Має єдиний метод – <code class=" language-none">accept</code>(прийняти).</li>
 <li>У нас є код, що запускається в потоці <code class=" language-none">Runnable</code>, який не приймає і не повертає. Має єдиний метод <code class=" language-none">run</code>(запустити).</li>
</ul>Друге, що треба пам'ятати, що <code class=" language-none">CompletalbeFuture</code>у своїй роботі використовує <code class=" language-none">Runnable</code>, споживачів та функції. Враховуючи це, ви завжди зможете згадати, що <code class=" language-none">CompletableFuture</code>можна робити так: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">Exception</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">AtomicLong</span></span> longValue <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">AtomicLong</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> longValue<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">set</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Date</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getTime</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">Function</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Long</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Date</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> dateConverter <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>longvalue<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Date</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>longvalue<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">Consumer</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Date</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> printer <span class="token operator"><span class="token operator">=</span></span> date <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>date<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">flush</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token comment"><span class="token comment">// CompletableFuture computation</span></span>
        <span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">runAsync</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span>
                         <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">thenApply</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>v<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> longValue<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">get</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
                         <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">thenApply</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>dateConverter<span class="token punctuation"><span class="token punctuation">)</span></span>
                         <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">thenAccept</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>printer<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> У методів <code class=" language-none">thenRun</code>, <code class=" language-none">thenApply</code>і <code class=" language-none">thenAccept</code>є версії <code class=" language-none">Async</code>. Це означає, що ці стадії будуть виконані у новому потоці. Його буде взято з особливого пулу, тому заздалегідь невідомо, який потік буде, новий чи колишній. Все залежить від того, наскільки важкі завдання. Крім цих методів, є ще три цікаві можливості. Для наочності уявімо, що у нас є якийсь сервіс, який отримує якесь повідомлення звідкись і на це потрібен час: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">NewsService</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">String</span></span> <span class="token function"><span class="token function">getMessage</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">3000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token keyword"><span class="token keyword">return</span></span> <span class="token string"><span class="token string">"Message"</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token keyword"><span class="token keyword">throw</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">IllegalStateException</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>e<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Тепер, давайте подивимося на інші можливості, які надає <code class=" language-none">CompletableFuture</code>. Ми можемо поєднувати результат <code class=" language-none">CompletableFuture</code>з результатом іншого <code class=" language-none">CompletableFuture</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Supplier</span></span> newsSupplier <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token class-name"><span class="token class-name">NewsService</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getMessage</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> reader <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">supplyAsync</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>newsSupplier<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">completedFuture</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"!!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
				 <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">thenCombine</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>reader<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>a<span class="token punctuation"><span class="token punctuation">,</span></span> b<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> b <span class="token operator"><span class="token operator">+</span></span> a<span class="token punctuation"><span class="token punctuation">)</span></span>
				 <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">thenAccept</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>result <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>result<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
				 <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">get</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Тут варто звернути увагу, що за замовчуванням потоки будуть демон-потоками, тому для наочності ми використовуємо <code class=" language-none">get</code>для того, щоб дочекатися результату. А ще ми можемо не тільки об'єднати (combine), але й повертати <code class=" language-none">CompletableFuture</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">completedFuture</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">2L</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
				<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">thenCompose</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>val<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">completedFuture</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>val <span class="token operator"><span class="token operator">+</span></span> <span class="token number"><span class="token number">2</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
                               <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">thenAccept</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>result <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>result<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Тут хочеться відзначити, що для стислості використаний метод <code class=" language-none">CompletableFuture.completedFuture</code>. Даний метод не створює новий потік, тому решта ланцюжка буде виконана в тому ж потоці, в якому був викликаний <code class=" language-none">completedFuture</code>. Також є метод <code class=" language-none">thenAcceptBoth</code>. Він дуже схожий на <code class=" language-none">accept</code>, але якщо <code class=" language-none">thenAccept</code>приймає <code class=" language-none">consumer</code>, то <code class=" language-none">thenAcceptBoth</code>приймає на вхід ще один <code class=" language-none">CompletableStage</code>+ <code class=" language-none">BiConsumer</code>, тобто <code class=" language-none">consumer</code>який на вхід приймає 2 джерела, а не один. Є ще цікава можливість зі словом <code class=" language-none">Either</code>: <img data-max-width="800" data-id="36a07217-c968-48f8-8ef6-d82b0c09bf4e" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина IV - Callable, Future та друзі - 3" src="https://cdn.javarush.com/images/article/36a07217-c968-48f8-8ef6-d82b0c09bf4e/800.jpeg" style="width: 800px;">Дані методи приймають альтернативний <code class=" language-none">CompletableStage</code>і будуть виконані на тому <code class=" language-none">CompletableStage</code>, який першим виконається. І закінчити цей огляд хочеться ще однією цікавою можливістю <code class=" language-none">CompletableFuture</code>обробкою помилок. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">CompletableFuture</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">completedFuture</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">2L</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
				 <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">thenApply</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>a<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
					<span class="token keyword"><span class="token keyword">throw</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">IllegalStateException</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"error"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
				 <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">thenApply</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>a<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token number"><span class="token number">3L</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
				 <span class="token comment"><span class="token comment">//.exceptionally(ex -&gt; 0L)</span></span>
				 <span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">thenAccept</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>val <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>val<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Цей код нічого не зробить, т.к. впаде виняток і нічого не буде. Але якщо ми розкоментуємо <code class=" language-none">exceptionally</code>, то визначимо поведінку. На тему <code class=" language-none">CompletableFuture</code>раджу також подивитись наступне відео: 
<ul>
 <li><a href="https://www.youtube.com/watch?v=hqR41XVx3kM" target="_blank" rel="nofollow">Досвідчена Future. Хочеться взяти та застосувати (2015)</a></li>
 <li><a href="https://www.youtube.com/watch?v=-MBPQ7NIL_Y" target="_blank" rel="nofollow">CompletableFuture in Java 8;</a></li>
</ul>На мою скромну думку, дані відео – одні з найнаочніших на просторах інтернету. З них має бути зрозумілим, як це все працює, який у нас є арсенал і навіщо це все потрібно. <a href="https://codegym.cc/welcome" target="_blank"><img id="click_banner1_articles" data-max-width="1024" data-id="d1910aa2-354f-448c-b80a-979599ad53c3" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина IV - Callable, Future та друзі - 4" src="https://cdn.javarush.com/images/article/d1910aa2-354f-448c-b80a-979599ad53c3/1024.jpeg" style="width: 1024px;"></a>
<h2>Висновок</h2>Сподіваюся тепер стало зрозуміло, як можна використовувати потоки для отримання обчислень після того, як вони будуть обчислені. Додатковий матеріал: 
<ul>
 <li><a href="https://kurspc.com.ua/node/424" target="_blank" rel="nofollow">Пишемо асинхронний код із CompletableFuture</a></li>
 <li><a href="http://millross-consultants.com/completion-stage-future-introduction.html" target="_blank" rel="nofollow">Introduction to CompletionStage and CompletableFuture</a></li>
 <li><a href="https://vertex-academy.com/tutorials/ru/java-8-completablefuture-part-2/" target="_blank" rel="nofollow">Java 8 CompletableFuture. Частина 2</a></li>
 <li><a href="https://www.baeldung.com/java-completablefuture" target="_blank" rel="nofollow">Guide To CompletableFuture</a></li>
</ul>#Viacheslav 
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <th>Що ще почитати:</th>
   </tr>
   <tr>
    <td><a href="https://codegym.cc/groups/posts/2047-threadom-java-ne-isportishjh--chastjh-i---potoki" target="_blank">Thread'ом Java не зіпсуєш: Частина I - потоки </a><br><a href="https://codegym.cc/groups/posts/2048-threadom-java-ne-isportishjh--chastjh-ii---sinkhronizacija" target="_blank">Thread'ом Java не зіпсуєш: Частина II - синхронізація </a><br><a href="https://codegym.cc/groups/posts/2060-threadom-java-ne-isportishjh--chastjh-iii---vzaimodeystvie" target="_blank">Thread'ом Java не зіпсуєш : Частина III - взаємодія </a><br><a href="https://codegym.cc/groups/posts/2078-threadom-java-ne-isportishjh--chastjh-v---executor-threadpool-fork-join-pool" target="_blank">Thread'ом Java не зіпсуєш: Частина V - Executor, ThreadPool, Fork Join </a><br><a href="https://codegym.cc/groups/posts/2111-threadom-java-ne-isportishjh--chastjh-vi---k-barjheru" target="_blank">Thread Тому Java не зіпсуєш: Частина VI - До бар'єру!</a></td>
   </tr>
  </tbody>
 </table>
</div>