Thread'ом Java не зіпсуєш: Частина V - Executor, ThreadPool, Fork Join
<p>----------------------------------------</p>
Отже, ми знаємо, що в Java є потоки, про що можна прочитати в огляді " ". Давайте ще раз подивимося на типовий код: Як ми бачимо, код для запуску завдання досить типовий, але на кожен новий запуск нам його доведеться повторювати. Одне з ріш
<p>----------------------------------------</p>
<h2>Вступ</h2>Отже, ми знаємо, що в Java є потоки, про що можна прочитати в огляді " <a href="https://codegym.cc/groups/posts/2047-threadom-java-ne-isportishjh--chastjh-i---potoki" target="_blank" rel="nofollow">Thread'ом Java не зіпсуєш: Частина I - потоки</a> ". <img data-max-width="800" data-id="02e6f204-92ca-4955-bcbd-f1e0d387b25f" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина V - Executor, ThreadPool, Fork Join - 1" src="https://cdn.javarush.com/images/article/02e6f204-92ca-4955-bcbd-f1e0d387b25f/800.jpeg" style="width: 800px;">Давайте ще раз подивимося на типовий код: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">Exception</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Task executed"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Thread</span></span> thread <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як ми бачимо, код для запуску завдання досить типовий, але на кожен новий запуск нам його доведеться повторювати. Одне з рішень - винести його в окремий метод, наприклад <code class=" language-none">execute(Runnable runnable)</code>. Але розробники Java за нас вже потурбувалися і вигадали інтерфейс <code class=" language-none">Executor</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">Exception</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Task executed"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Executor</span></span> executor <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>runnable<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>runnable<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	executor<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">execute</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як видно, код став лаконічнішим і дозволив нам просто написати код із запуску <code class=" language-none">Runnable</code>в потоці. Здорово, чи не так? Але це лише початок: <img data-max-width="512" data-id="fe98eee4-5064-4626-bc15-535a728659ca" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина V - Executor, ThreadPool, Fork Join - 2" src="https://cdn.javarush.com/images/article/fe98eee4-5064-4626-bc15-535a728659ca/512.jpeg" style="width: 512px;">
<center>
 <p><em><small>https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Executor.html</small></em></p>
</center>Як видно, інтерфейс <code class=" language-none">Executor</code>має інтерфейс-спадкоємець <code class=" language-none">ExecutorService</code>. У JavaDoc даного інтерфейсу сказано, що <code class=" language-none">ExecutorService</code>є описом особливого <code class=" language-none">Executor</code>'а, який надає методи зупинення роботи <code class=" language-none">Executor</code>'а і дозволяє отримати <code class=" language-none">java.util.concurrent.Future</code>, щоб відстежувати процес виконання. Раніше, в " <a href="https://codegym.cc/groups/posts/2065-threadom-java-ne-isportishjh--chastjh-iv---callable-future-i-druzjhja" target="_blank" rel="nofollow">Thread'ом Java не зіпсуєш: Частина IV - Callable, Future і друзі</a> " ми вже коротко розглянули можливості <code class=" language-none">Future</code>. Хто забув чи не читав - раджу освіжити у пам'яті ;) Що ще цікавого в JavaDoc написано? Що у нас є спеціальна фабрика <code class=" language-none">java.util.concurrent.Executors</code>, яка дозволяє створювати доступні за замовчуванням реалізації <code class=" language-none">ExecutorService</code>. 
<h2>ExecutorService</h2>Ще раз згадаємо. У нас є <code class=" language-none">Executor</code>для execute (тобто виконання) якогось завдання в потоці, коли реалізація створення потоку прихована від нас. У нас є <code class=" language-none">ExecutorService</code>особливий <code class=" language-none">Executor</code>, який має набір можливостей з управління ходом виконання. І у нас є фабрика <code class=" language-none">Executors</code>, яка дозволяє створювати <code class=" language-none">ExecutorService</code>. Давайте тепер це зробимо самі: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">ExecutionException</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Callable</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">ExecutorService</span></span> service <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Executors</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">newFixedThreadPool</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">2</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> i <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">5</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token class-name"><span class="token class-name">Future</span></span> result <span class="token operator"><span class="token operator">=</span></span> service<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">submit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>result<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">get</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
	service<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">shutdown</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як бачимо, ми вказали фіксований пул потоків ( <code class=" language-none">Fixed Thread Pool</code>) розміром 2. Після цього ми по черзі відправляємо в пул завдання. Кожне завдання повертає рядок ( <code class=" language-none">String</code>), який містить ім'я потоку ( <code class=" language-none">currentThread().getName()</code>). Важливо в самому кінці виконати shutdown для <code class=" language-none">ExecutorService</code>, тому що в іншому випадку наша програма не завершиться. У фабриці <code class=" language-none">Executors</code>є інші фабричні методи. Наприклад, ми можемо створити пул всього з одного потоку <code class=" language-none">newSingleThreadExecutor</code>або пул з кешуванням <code class=" language-none">newCachedThreadPool</code>, коли потоки будуть забиратися з пулу, якщо вони простоюють 1 хвабону. Насправді, за цими <code class=" language-none">ExecutorService</code>ховається <strong>блокуюча черга</strong> , в яку поміщаються завдання і з якої виконуються ці завдання. Детальніше про блокуючі черги можна переглянути у відео "<a href="https://www.youtube.com/watch?v=nUYOGkh9XqE" target="_blank" rel="nofollow">Блокуюча черга - Collections #5 - Advanced Java</a> ". А також можна прочитати огляд " <a href="http://java-online.ru/concurrent-queue-block.xhtml" target="_blank" rel="nofollow">Блокуючі черги пакета concurrent</a> " і відповідь на питання " <a href="https://stackoverflow.com/questions/35967792/when-to-prefer-linkedblockingqueue-over-arrayblockingqueue" target="_blank" rel="nofollow">When to prefer LinkedBlockingQueue over ArrayBlockingQueue? </a>". Супер спрощено - <code class=" language-none">BlockingQueue</code>(блокуюча черга) блокує потік, у двох випадках: 
<ul>
 <li>потік намагається отримати елементи з порожньої черги</li>
 <li>потік намагається покласти елементи на повну чергу</li>
</ul>Якщо подивитися на реалізацію фабричних методів, ми побачимо, як вони влаштовані. Наприклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">ExecutorService</span></span> <span class="token function"><span class="token function">newFixedThreadPool</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> nThreads<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">return</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ThreadPoolExecutor</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>nThreads<span class="token punctuation"><span class="token punctuation">,</span></span> nThreads<span class="token punctuation"><span class="token punctuation">,</span></span>
                                      <span class="token number"><span class="token number">0L</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>MILLISECONDS<span class="token punctuation"><span class="token punctuation">,</span></span>
                                      <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">LinkedBlockingQueue</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Runnable</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> або 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">ExecutorService</span></span> <span class="token function"><span class="token function">newCachedThreadPool</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">return</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ThreadPoolExecutor</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Integer</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>MAX_VALUE<span class="token punctuation"><span class="token punctuation">,</span></span>
                                      <span class="token number"><span class="token number">60L</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>SECONDS<span class="token punctuation"><span class="token punctuation">,</span></span>
                                      <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">SynchronousQueue</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Runnable</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як бачимо, всередині фабричних методів створюються реалізації <code class=" language-none">ExecutorService</code>. І в основному це <code class=" language-none">ThreadPoolExecutor</code>. Змінюються лише атрибути, які впливають на роботу. <img data-max-width="800" data-id="decabcf3-8341-429b-9266-a262f8a4152b" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина V - Executor, ThreadPool, Fork Join - 3" src="https://cdn.javarush.com/images/article/decabcf3-8341-429b-9266-a262f8a4152b/800.jpeg" style="width: 800px;">
<center>
 <p><em><small>https://en.wikipedia.org/wiki/Thread_pool#/media/File:Thread_pool.svg</small></em></p>
</center>
<h2>ThreadPoolExecutor</h2>Як ми раніше побачабо, усередині фабричних методів переважно створюється <code class=" language-none">ThreadPoolExecutor</code>. На функціональність впливає те, які значення передані як максимум і мінімум потоків, а також яка черга використовується. А використовуватись може будь-яка реалізація інтерфейсу <code class=" language-none">java.util.concurrent.BlockingQueue</code>. Говорячи про <code class=" language-none">ThreadPoolExecutor</code>'ах, варто відзначити цікаві особливості при роботі. Наприклад, не можна посилати завдання у <code class=" language-none">ThreadPoolExecutor</code>, якщо там немає місця: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">ExecutionException</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">int</span></span> threadBound <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">2</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">ThreadPoolExecutor</span></span> threadPoolExecutor <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ThreadPoolExecutor</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> threadBound<span class="token punctuation"><span class="token punctuation">,</span></span>
            <span class="token number"><span class="token number">0L</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>SECONDS<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">SynchronousQueue</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Callable</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">1000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token keyword"><span class="token keyword">return</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> i <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i <span class="token operator"><span class="token operator">&lt;</span></span> threadBound <span class="token operator"><span class="token operator">+</span></span> <span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		threadPoolExecutor<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">submit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
	threadPoolExecutor<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">shutdown</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Цей код впаде з помилкою: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Task</span></span> <span class="token class-name"><span class="token namespace"></span><span class="token class-name"><span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>FutureTask</span></span><span class="token annotation punctuation"><span class="token annotation punctuation">@7cca494b</span></span> rejected from <span class="token class-name"><span class="token namespace"></span><span class="token class-name"><span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>ThreadPoolExecutor</span></span><span class="token annotation punctuation"><span class="token annotation punctuation">@7ba4f24f</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token class-name"><span class="token class-name">Running</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> pool size <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">2</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> active threads <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">2</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> queued tasks <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> completed tasks <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">]</span></span></code></pre> Тобто <code class=" language-none">task</code>не можна засабити, т.к. <code class=" language-none">SynchronousQueue</code>влаштована так, що фактично складається з одного елемента та не дозволяє покласти туди більше. Як бачимо, <code class=" language-none">queued tasks</code>тут 0, й у немає нічого дивного, т.к. це специфіка <code class=" language-none">SynchronousQueue</code>- це черга в один елемент, яка завжди порожня. (!) Коли один потік кладе в чергу елемент, він чекатиме, доки інший потік не забере елемент із черги. Тому ми можемо замінити на <code class=" language-none">new LinkedBlockingQueue&lt;&gt;(1)</code>і в помилці зміниться те, що буде вказано <code class=" language-none">queued tasks = 1</code>. Т.к. Насамперед один елемент, то другий ми вже покласти не можемо. І впадемо на цьому. Продовжуючи тему черги, варто зазначити, що клас <code class=" language-none">ThreadPoolExecutor</code>має додаткові методи обслуговування черги. Наприклад, метод<code class=" language-none">threadPoolExecutor.purge()</code>видалить із черги всі скасовані завдання, щоб звільнити місце у черзі. Ще однією цікавою функцією, пов'язаною з чергою, є обробник неприйнятих завдань: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">ThreadPoolExecutor</span></span> threadPoolExecutor <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ThreadPoolExecutor</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">,</span></span>
            <span class="token number"><span class="token number">0L</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>SECONDS<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">SynchronousQueue</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Callable</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	threadPoolExecutor<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">setRejectedExecutionHandler</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>runnable<span class="token punctuation"><span class="token punctuation">,</span></span> executor<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Rejected"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> i <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">5</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		threadPoolExecutor<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">submit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
	threadPoolExecutor<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">shutdown</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Для прикладу обробник просто виводить слово <code class=" language-none">Rejected</code>на кожну відмову приймати завдання в чергу. Зручно, чи не так? Крім того, <code class=" language-none">ThreadPoolExecutor</code>має цікавого спадкоємця - <code class=" language-none">ScheduledThreadPoolExecutor</code>, Який є <code class=" language-none">ScheduledExecutorService</code>. Він надає можливість виконувати завдання за таймером. 
<h2>ScheduledExecutorService</h2><code class=" language-none">ExecutorService</code>типу <code class=" language-none">ScheduledExecutorService</code>дозволяють запускати завдання за розкладом (schedule). Подивимося на приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">ScheduledExecutorService</span></span> scheduledExecutorService <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Executors</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">newScheduledThreadPool</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">4</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Callable</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token keyword"><span class="token keyword">return</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	scheduledExecutorService<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">schedule</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>MINUTES<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	scheduledExecutorService<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">shutdown</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Тут все просто. Вирушають завдання, отримуємо "заплановане завдання" <code class=" language-none">java.util.concurrent.ScheduledFuture</code>. З розкладом може бути корисним і наступний випадок: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">ScheduledExecutorService</span></span> scheduledExecutorService <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Executors</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">newScheduledThreadPool</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">4</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
scheduledExecutorService<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">scheduleAtFixedRate</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token number"><span class="token number">2</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>SECONDS<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Тут ми відправляємо <code class=" language-none">Runnable</code>завдання на виконання з фіксованою частотою (Fixed Rate) із певною затримкою. У цьому випадку через 1 секунду кожні 2 секунди почати виконувати завдання. Є схожий варіант: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java">scheduledExecutorService<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">scheduleWithFixedDelay</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token number"><span class="token number">2</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>SECONDS<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Але тут завдання виконуються із заданим проміжком МІЖ виконанням різних завдань. Тобто завдання <code class=" language-none">task</code>буде виконано за 1 секунду. Далі, коли вона буде завершена, пройде 2 секунди, і тоді нове завдання task буде запущено. На цю тему можна прочитати такі матеріали: 
<ul>
 <li><a href="https://allegro.tech/2015/05/thread-pools.html" target="_blank" rel="nofollow">An introduction to thread pools</a></li>
 <li><a href="https://www.baeldung.com/thread-pool-java-and-guava" target="_blank" rel="nofollow">Introduction to Thread Pools</a></li>
 <li><a href="https://10kloc.wordpress.com/2013/12/24/cancelling-tasks-in-executors/" target="_blank" rel="nofollow">Java Multithreading Steeplechase: Cancelling Tasks In Executors</a></li>
 <li><a href="https://zeroturnaround.com/rebellabs/fixedthreadpool-cachedthreadpool-or-forkjoinpool-picking-correct-java-executors-for-background-tasks" target="_blank" rel="nofollow">Picking correct Java executors for background tasks</a></li>
</ul><img data-max-width="800" data-id="d4ef6ba2-470d-4778-a638-56f0df3150eb" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина V - Executor, ThreadPool, Fork Join - 4" src="https://cdn.javarush.com/images/article/d4ef6ba2-470d-4778-a638-56f0df3150eb/800.jpeg" style="width: 800px;">
<center>
 <p><em><small>https://dzone.com/articles/diving-into-java-8s-newworkstealingpools</small></em></p>
</center>
<h2>WorkStealingPool</h2>Крім зазначених вище пулів потоків є ще один. Можна сказати, що він трохи особливий. Ім'я йому – Work Stealing Pool. Якщо коротко, то Work Stealing — це такий алгоритм роботи, при якому потоки, що простоюють, починають забирати завдання інших потоків або завдання із загальної черги. Подивимося на приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Object</span></span> lock <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Object</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">ExecutorService</span></span> executorService <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Executors</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">newCachedThreadPool</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Callable</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">wait</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">2000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Finished"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token keyword"><span class="token keyword">return</span></span> <span class="token string"><span class="token string">"result"</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> i <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">5</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		executorService<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">submit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
	executorService<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">shutdown</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Якщо ми запустимо цей код, то <code class=" language-none">ExecutorService</code>створить 5 потоків, т.к. кожен потік буде вставати у wait чергу по локу об'єкта <code class=" language-none">lock</code>. Про монітори і локи по ньому ми вже раніше розбиралися в " <a href="https://codegym.cc/groups/posts/2048-threadom-java-ne-isportishjh--chastjh-ii---sinkhronizacija" target="_blank" rel="nofollow">Thread'ом Java не зіпсуєш: Частина II - синхронізація</a> ". А тепер ми замінимо <code class=" language-none">Executors.newCachedThreadPool</code>на <code class=" language-none">Executors.newWorkStealingPool()</code>. Що зміниться? Ми побачимо, що наші завдання виконуються не 5 потоків, а менше. Помнете, що <code class=" language-none">cachedThreadPool</code>створював на кожне завдання свій потік? Тому що <code class=" language-none">wait</code>блокував потік, а наступні завдання хотіли виконуватись і в пулі для них створювалися нові потоки. У випадку з <code class=" language-none">StealingPool</code>потоками не вічно простоюватимуть в <code class=" language-none">wait</code>, вони почнуть виконувати сусідні завдання. Чим так відрізняється від решти тредпулів цей <code class=" language-none">WorkStealingPool</code>? Тим, що в ньому живе насправді чарівний<code class=" language-none">ForkJoinPool</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">ExecutorService</span></span> <span class="token function"><span class="token function">newWorkStealingPool</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">return</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ForkJoinPool</span></span>
            <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Runtime</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getRuntime</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">availableProcessors</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">,</span></span>
             <span class="token class-name"><span class="token class-name">ForkJoinPool</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>defaultForkJoinWorkerThreadFactory<span class="token punctuation"><span class="token punctuation">,</span></span>
             <span class="token keyword"><span class="token keyword">null</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Насправді є ще одна відмінність. Потоки, які створюються за <code class=" language-none">ForkJoinPool</code>умовчанням є демон потоками, на відміну від потоків, створених через звичайний <code class=" language-none">ThreadPool</code>. Взагалі варто пам'ятати про демон-потоки, т.к. наприклад при <code class=" language-none">CompletableFuture</code>теж використовуються демон-потоки, якщо не вказати свою <code class=" language-none">ThreadFactory</code>, яка створюватиме не демон-потоки. Ось такі сюрпризи можуть чекати в несподіваному місці!) 
<h2>Fork/Join Pool</h2>У цій частині ми поговоримо про той <code class=" language-none">ForkJoinPool</code>(його ще називають fork/join framework), який живе "під капотом" у <code class=" language-none">WorkStealingPool</code>. Взагалі, Fork Join Framework з'явився ще Java 1.7. І нехай уже Java 11 надворі, але згадати все одно варто. Не найпоширеніша задача, але досить цікава. На просторах мережі є хороший огляд на цю тему: " <a href="https://habr.com/post/128985/" target="_blank" rel="nofollow">Fork/Join Framework у Java 7</a> ". <code class=" language-none">Fork/JoinPool</code>оперує у роботі таким поняттям як <code class=" language-none">java.util.concurrent.RecursiveTask</code>. Також є аналог - <code class=" language-none">java.util.concurrent.RecursiveAction</code>. RecursiveAction не повертає результату. У такий спосіб <code class=" language-none">RecursiveTask</code>схожий на <code class=" language-none">Callable</code>, а <code class=" language-none">RecursiveAction</code>схожий на <code class=" language-none">Runnable</code>. Ну і дивлячись на назву ми бачимо два ключові методи - <code class=" language-none">fork</code>і <code class=" language-none">join</code>. Метод <code class=" language-none">fork</code>запускає асинхронно в окремому потоці певне завдання. А метод<code class=" language-none">join</code>дозволяє дочекатися завершення виконання роботи. Існує кілька способів використання: <img data-max-width="800" data-id="d3a97020-34fd-44cf-b0a2-bf85b9a18fe5" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина V - Executor, ThreadPool, Fork Join - 5" src="https://cdn.javarush.com/images/article/d3a97020-34fd-44cf-b0a2-bf85b9a18fe5/800.jpeg" style="width: 800px;">Даний малюнок - це частина слайду доповіді Олексія Шипільова " <a href="https://shipilev.net/talks/j1-April2012-forkjoin.pdf" target="_blank" rel="nofollow">Fork/Join: реалізація, використання, продуктивність</a> ". Щоб стало зрозуміліше, варто подивитися його доповідь на JEE CONF: " <a href="https://www.youtube.com/watch?v=_2ciDWeeXJQ" target="_blank" rel="nofollow">Fork Join особливості реалізації</a> ". <a href="https://codegym.cc/welcome" target="_blank"><img id="click_banner1_articles" data-max-width="1024" data-id="fbb010e6-6bcf-4581-9776-7b8a7ac1473b" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина V - Executor, ThreadPool, Fork Join - 6" src="https://cdn.javarush.com/images/article/fbb010e6-6bcf-4581-9776-7b8a7ac1473b/1024.jpeg" style="width: 1024px;"></a>
<h2>Підбиття підсумків</h2>Отож ми й закінчабо чергову частину огляду. Ми розібралися, що спочатку вигадали <code class=" language-none">Executor</code>для виконання потоків. Потім вирішабо продовжити ідею і вигадали <code class=" language-none">ExecutorService</code>. <code class=" language-none">ExecutorService</code>дозволяє відправляти завдання на виконання за допомогою <code class=" language-none">submit</code>та <code class=" language-none">invoke</code>, а також керувати сервісом, вимикаючи його. Т.к. <code class=" language-none">ExecutorService</code>'у потрібні реалізації, написали клас із фабричними методами та назвали його <code class=" language-none">Executors</code>. Він дозволяє створювати пули потоків <code class=" language-none">ThreadPoolExecutor</code>. При цьому існують такі пули потоків, які дозволяють ще й вказати розклад для виконання, а за <code class=" language-none">WorkStealingPool</code>ховається <code class=" language-none">ForkJoinPool</code>. Сподіваюся, Вам було не тільки цікаво вище написане, але й зрозуміло) Завжди радий пропозиціям та зауваженням. #Viacheslav
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <th>Що ще почитати:</th>
   </tr>
   <tr>
    <td><a href="https://codegym.cc/groups/posts/2047-threadom-java-ne-isportishjh--chastjh-i---potoki" target="_blank">Thread'ом Java не зіпсуєш: Частина I - потоки </a><br><a href="https://codegym.cc/groups/posts/2048-threadom-java-ne-isportishjh--chastjh-ii---sinkhronizacija" target="_blank">Thread'ом Java не зіпсуєш: Частина II - синхронізація </a><br><a href="https://codegym.cc/groups/posts/2060-threadom-java-ne-isportishjh--chastjh-iii---vzaimodeystvie" target="_blank">Thread'ом Java не зіпсуєш : Частина III - взаємодія </a><br><a href="https://codegym.cc/groups/posts/2065-threadom-java-ne-isportishjh--chastjh-iv---callable-future-i-druzjhja" target="_blank">Thread'ом Java не зіпсуєш : Частина IV - Callable, Future та друзі </a><br><a href="https://codegym.cc/groups/posts/2111-threadom-java-ne-isportishjh--chastjh-vi---k-barjheru" target="_blank">Thread' ом Java не зіпсуєш: Частина VI - До бар'єру!</a></td>
   </tr>
  </tbody>
 </table>
</div>