Взаємне блокування (deadlock) в Java та методи боротьби з нею
<p>----------------------------------------</p>
Під час розробки многопоточных додатків часто виникає дилема: що важливіше надійність чи працездатність докладання. Наприклад, ми використовуємо синхронізацію для потокової безпеки (thread safety), при цьому у випадку неправильного порядку 
<p>----------------------------------------</p>
Під час розробки многопоточных додатків часто виникає дилема: що важливіше надійність чи працездатність докладання. Наприклад, ми використовуємо синхронізацію для потокової безпеки (thread safety), при цьому у випадку неправильного порядку синхронізації ми можемо викликати взаємне блокування. Також ми використовуємо пули потоків і семафори для обмеження споживання ресурсів, при цьому помилка в такому дизайні може призвести до взаємного блокування внаслідок нестачі ресурсів. У цій статті ми поговоримо про те, як уникати взаємного блокування, а також інших проблем у працездатності програми. Також ми розглянемо, як може додаток бути написано таким чином, щоб мати можливість відновиться у випадку взаємного блокування. <img data-id="6cbe7330-1440-40f5-9b10-e7e18555c4e0" data-max-width="850" alt="Взаємне блокування (deadlock) в Java та методи боротьби з нею." src="https://cdn.javarush.com/images/article/6cbe7330-1440-40f5-9b10-e7e18555c4e0/800.jpeg" style="width: 850px;">Взаємне блокування - це ситуація в якій, два або більше процесу займаючи деякі ресурси, намагаються отримати деякі інші ресурси, зайняті іншими процесами і жоден з процесів не може зайняти необхідний їм ресурс, і відповідно звільнити займаний. Дане визначення надто загальне, тому складно для сприйняття, для кращого розуміння ми розглянемо типи взаємних блокувань на прикладах. 
<h2>Взаємне блокування порядку синхронізації</h2>Розглянемо таке завдання: необхідно написати метод, який здійснює транзакцію переказу деякої кількості грошей з одного рахунку на інший. Рішення може мати такий вигляд: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">transferMoney</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Account</span></span> fromAccount<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Account</span></span> toAccount<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Amount</span></span> amount<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InsufficientFundsException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>fromAccount<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>toAccount<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>fromAccount<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getBalance</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">compareTo</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>amount<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
				<span class="token keyword"><span class="token keyword">throw</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">InsufficientFundsException</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token keyword"><span class="token keyword">else</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
				fromAccount<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">debit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>amount<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
				toAccount<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">credit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>amount<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token punctuation"><span class="token punctuation">}</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> На перший погляд, цей код синхронізований цілком нормально, ми маємо атомарну операцію перевірки та зміни стану рахунку-джерела та зміну рахунку-отримувача. Проте, за цієї стратегії синхронізації може виникнути ситуація взаємної блокування. Розгляньмо приклад того, як це відбувається. Необхідно зробити дві транзакції: з рахунку на рахунок B переказати x грошей, а з рахунку на рахунок A – y. Найчастіше ця ситуація не викличе взаємного блокування, однак, при невдалому збігу обставин, транзакція 1 займе монітор рахунку A, транзакція 2 займе монітор рахунку B. Результат - взаємне блокування: транзакція 1 чекає, поки транзакція 2 звільнить монітор 2 має отримати доступ до монітора A, зайнятого транзакцією 1. Одна з великих проблем із взаємними блокуваннями – що їх нелегко знайти під час тестування. Навіть у ситуації, описаній у прикладі, потоки можуть не заблокуватися, тобто дана ситуація не буде постійно відтворюватися, що значно ускладнює діагностику. Загалом описана проблема недетермінованості є типовою для багатопоточності (хоча від цього не легше). Тому у підвищенні якості багатопотокових додатків важливу роль відіграє code review, оскільки він дозволяє виявити помилки, які проблематично відтворити під час тестування. Це, звичайно, не означає, що додаток не треба тестувати, просто про code review теж не треба забувати. Що потрібно зробити, щоб цей код не призводив до взаємного блокування? Це блокування викликане тим, що синхронізація рахунків може відбуватися в різному порядку. Відповідно, якщо ввести деякий порядок на рахунках (це деяке правило, що дозволяє сказати, що рахунок A менший за рахунок B), то проблема буде вирішена. Як це зробити? По-перше, якщо рахунки мають якийсь унікальний ідентифікатор (наприклад, номер рахунку) чисельний, малий або ще якийсь із природним поняттям порядку (рядки можна порівнювати в лексикографічному порядку, то можемо вважати, що нам пощастило, і ми завжди можемо спочатку займати монітор меншого рахунку, та був більшого (чи навпаки). 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">doTransfer</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Account</span></span> fromAcct<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Account</span></span> toAcct<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">DollarAmount</span></span> amount<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InsufficientFundsException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getBalance</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">compareTo</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>amount<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
		<span class="token keyword"><span class="token keyword">throw</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">InsufficientFundsException</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">else</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		fromAcct<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">debit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>amount<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		toAcct<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">credit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>amount<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">transferMoney</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Account</span></span> fromAcct<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Account</span></span> toAcct<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">DollarAmount</span></span> amount<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InsufficientFundsException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">int</span></span> fromId<span class="token operator"><span class="token operator">=</span></span> fromAcct<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getId</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">int</span></span> toId <span class="token operator"><span class="token operator">=</span></span> fromAcct<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getId</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>fromId <span class="token operator"><span class="token operator">&lt;</span></span> toId<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>toAcct<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
				<span class="token function"><span class="token function">doTransfer</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">,</span></span> toAcct<span class="token punctuation"><span class="token punctuation">,</span></span> amount<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">}</span></span>
			<span class="token punctuation"><span class="token punctuation">}</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">else</span></span>  <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>toAcct<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
				<span class="token function"><span class="token function">doTransfer</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">,</span></span> toAcct<span class="token punctuation"><span class="token punctuation">,</span></span> amount<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">}</span></span>
			<span class="token punctuation"><span class="token punctuation">}</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Другий варіант, якщо такого ідентифікатора у нас немає, доведеться його придумати самим. Ми можемо в першому наближенні порівнювати об'єкти за хеш-кодом. Швидше за все, вони відрізнятимуться. Але що робити, якщо вони все ж таки виявляться однаковими? Тоді доведеться додати ще один об'єкт для синхронізації. Це може виглядати дещо витонченим, але що вдієш. До того ж, третій об'єкт використовуватиметься досить рідко. Результат буде виглядати так: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Object</span></span> tieLock <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Object</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">doTransfer</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Account</span></span> fromAcct<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Account</span></span> toAcct<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">DollarAmount</span></span> amount<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InsufficientFundsException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getBalance</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">compareTo</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>amount<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
		<span class="token keyword"><span class="token keyword">throw</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">InsufficientFundsException</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">else</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		fromAcct<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">debit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>amount<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		toAcct<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">credit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>amount<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">transferMoney</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Account</span></span> fromAcct<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Account</span></span> toAcct<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">DollarAmount</span></span> amount<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InsufficientFundsException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">int</span></span> fromHash <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">identityHashCode</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">int</span></span> toHash <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">identityHashCode</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>toAcct<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>fromHash <span class="token operator"><span class="token operator">&lt;</span></span> toHash<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>toAcct<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
				<span class="token function"><span class="token function">doTransfer</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">,</span></span> toAcct<span class="token punctuation"><span class="token punctuation">,</span></span> amount<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token punctuation"><span class="token punctuation">}</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">else</span></span> <span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>fromHash <span class="token operator"><span class="token operator">&gt;</span></span> toHash<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>toAcct<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
				<span class="token function"><span class="token function">doTransfer</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">,</span></span> toAcct<span class="token punctuation"><span class="token punctuation">,</span></span> amount<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token punctuation"><span class="token punctuation">}</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">else</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>tieLock<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
				<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>toAcct<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
					<span class="token function"><span class="token function">doTransfer</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>fromAcct<span class="token punctuation"><span class="token punctuation">,</span></span> toAcct<span class="token punctuation"><span class="token punctuation">,</span></span> amount<span class="token punctuation"><span class="token punctuation">)</span></span>
				<span class="token punctuation"><span class="token punctuation">}</span></span>
			<span class="token punctuation"><span class="token punctuation">}</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre>
<h2>Взаємне блокування між об'єктами</h2>Описані умови блокування є найпростішим за діагностикою випадком взаємного блокування. Найчастіше в багатопотокових додатках різні об'єкти намагаються отримати доступ до тих самих синхронізованих блоків. При цьому може виникнути взаємне блокування. Розглянемо наступний приклад: програма для диспетчера польотів. Літаки повідомляють диспетчеру, коли вони прибули на місце призначення та вимагають дозволу на посадку. Диспетчер зберігає всю інформацію про літаки, що летять у його напрямку, і може будувати їхнє положення на карті. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Plane</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Point</span></span> location<span class="token punctuation"><span class="token punctuation">,</span></span> destination<span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Dispatcher</span></span> dispatcher<span class="token punctuation"><span class="token punctuation">;</span></span>

	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Plane</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Dispatcher</span></span> dispatcher<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>dispatcher <span class="token operator"><span class="token operator">=</span></span> dispatcher<span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token class-name"><span class="token class-name">Point</span></span> <span class="token function"><span class="token function">getLocation</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">return</span></span> location<span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">setLocation</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Point</span></span> location<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>location <span class="token operator"><span class="token operator">=</span></span> location<span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>location<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">equals</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>destination<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
		dispatcher<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">requestLanding</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>

<span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Dispatcher</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Set</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Plane</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> planes<span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Set</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Plane</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> planesPendingLanding<span class="token punctuation"><span class="token punctuation">;</span></span>

	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Dispatcher</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		planes <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">HashSet</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Plane</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		planesPendingLanding <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">HashSet</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Plane</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">requestLanding</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Plane</span></span> plane<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		planesPendingLanding<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">add</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>plane<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token class-name"><span class="token class-name">Image</span></span> <span class="token function"><span class="token function">getMap</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token class-name"><span class="token class-name">Image</span></span> image <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Image</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Plane</span></span> plane <span class="token operator"><span class="token operator">:</span></span> planes<span class="token punctuation"><span class="token punctuation">)</span></span>
			image<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">drawMarker</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>plane<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getLocation</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token keyword"><span class="token keyword">return</span></span> image<span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Зрозуміти, що в цьому коді є помилка, яка може призвести до взаємного блокування складніше, ніж у попередньому. На перший погляд у ньому немає повторних синхронізацій, проте це не так. Ви, напевно, вже помітабо, що методи <code class=" language-none">setLocation</code>класу <code class=" language-none">Plane</code>і <code class=" language-none">getMap</code>класу <code class=" language-none">Dispatcher</code>є синхронізованими і викликають у собі синхронізовані методи інших класів. Це загалом погана практика. Про те, як це можна виправити, йтиметься у наступному розділі. В результаті, якщо літак прибуває на місце, в той же момент, як хтось вирішує отримати карту, може виникнути взаємне блокування. Тобто, будуть викликані методи, <code class=" language-none">getMap</code>і <code class=" language-none">setLocation</code>які займуть монітори екземплярів <code class=" language-none">Dispatcher</code>і <code class=" language-none">Plane</code>відповідно. Потім метод <code class=" language-none">getMap</code>викличе <code class=" language-none">plane.getLocation</code>(зокрема для примірника<code class=" language-none">Plane</code>, який на даний момент зайнятий), який чекатиме на звільнення монітора для кожного з екземплярів <code class=" language-none">Plane</code>. У той же час у методі <code class=" language-none">setLocation</code>буде викликано <code class=" language-none">dispatcher.requestLanding</code>, при цьому монітор екземпляра <code class=" language-none">Dispatcher</code>залишається зайнятим малюванням картки. Результат – взаємне блокування. 
<h2>Відкриті дзвінки</h2>З метою не допускати ситуацій, на кшталт описаної в попередньому розділі, рекомендується використовувати відкриті виклики до методів інших об'єктів. Тобто викликати методи інших об'єктів поза синхронізованим блоком. Якщо із застосуванням принципу відкритих викликів переписати методи <code class=" language-none">setLocation</code>та <code class=" language-none">getMap</code>можливість взаємного блокування буде усунуто. Виглядатиме це, наприклад, так: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">setLocation</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Point</span></span> location<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">boolean</span></span> reachedDestination<span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">synchronized</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>location <span class="token operator"><span class="token operator">=</span></span> location<span class="token punctuation"><span class="token punctuation">;</span></span>
		reachedDestination <span class="token operator"><span class="token operator">=</span></span> location<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">equals</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>destination<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>reachedDestination<span class="token punctuation"><span class="token punctuation">)</span></span>
		dispatcher<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">requestLanding</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>
………………………………………………………………………………
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Image</span></span> <span class="token function"><span class="token function">getMap</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Set</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Plane</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> copy<span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">synchronized</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
		copy <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">HashSet</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Plane</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span> planes<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token class-name"><span class="token class-name">Image</span></span> image <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Image</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Plane</span></span> plane <span class="token operator"><span class="token operator">:</span></span> copy<span class="token punctuation"><span class="token punctuation">)</span></span>
		image<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">drawMarker</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>plane<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getLocation</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">return</span></span> image<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre>
<h2>Ресурсне взаємне блокування</h2>Взаємні блокування можуть виникати так само при спробі отримати доступ до деяких ресурсів, які можуть використовувати одночасно лише один потік. Прикладом може бути пул з'єднань з базами даних. Якщо деяким потокам необхідний доступ одночасно до двох з'єднань, і вони отримують цей доступ у різному порядку, це може призвести до взаємного блокування. Принципово, що такого роду блокування ні чим не відрізняються від блокувань порядку синхронізації, крім того, що виникають не при спробі виконати певний код, а при спробі отримати доступ до ресурсів. 
<h2>Як уникати взаємних блокувань?</h2>Безумовно, якщо код написаний без будь-яких помилок (приклади яких ми бачабо у попередніх розділах), то взаємних блокувань у ньому не буде. Але хто може доручитись, що його код написаний без помилок? Безумовно, тестування допомагає виявити значну частину помилок, але, як ми вже бачабо раніше, помилки в багатопотоковому коді нелегко діагностувати і навіть після тестування не можна бути впевненим у відсутності ситуацій взаємних блокувань. Чи можемо ми перестрахуватися від блокувань? Відповідь – так. Подібні техніки використовуються в двигунах баз даних, яким часто потрібно відновлюватися після взаємних блокувань (пов'язаних з механізмом транзакцій в БД). Інтерфейс <code class=" language-none">Lock</code>та його реалізації доступні в пакеті <code class=" language-none">java.util.concurrent.locks</code>дозволяють спробувати зайняти монітор, пов'язаний з екземпляром даного класу методом<code class=" language-none">tryLock</code>(повертає true, якщо вдалося зайняти монітор). Нехай у нас є пара об'єктів реалізують інтерфейс <code class=" language-none">Lock</code>і нам потрібно зайняти їх монітори так, щоб уникнути взаємного блокування. Реалізувати це можна так: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">twoLocks</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Lock</span></span> <span class="token class-name"><span class="token class-name">A</span></span><span class="token punctuation"><span class="token punctuation">,</span></span>  <span class="token class-name"><span class="token class-name">Lock</span></span> <span class="token class-name"><span class="token class-name">B</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">while</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">if</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">A</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">tryLock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token keyword"><span class="token keyword">if</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">B</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">tryLock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
			<span class="token punctuation"><span class="token punctuation">{</span></span>
				<span class="token keyword"><span class="token keyword">try</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
					<span class="token comment"><span class="token comment">//do something</span></span>
				<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">finally</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
					<span class="token class-name"><span class="token class-name">B</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">unlock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
					<span class="token class-name"><span class="token class-name">A</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">unlock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
				<span class="token punctuation"><span class="token punctuation">}</span></span>
			<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">else</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
				<span class="token class-name"><span class="token class-name">A</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">unlock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token punctuation"><span class="token punctuation">}</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як видно в цій програмі, ми займаємо два монітори, при цьому, виключаючи можливість взаємного блокування. Зверніть увагу, блок <code class=" language-none">try- finally</code>необхідний, оскільки класи з пакету<code class=" language-none">java.util.concurrent.locks</code>автоматично не звільняють монітор, і якщо у процесі виконання вашого завдання виник якийсь виняток, то монітор зависне у заблокованому стані. Як діагностувати взаємне блокування? JVM дозволяє діагностувати взаємні блокування, відображаючи їх у дампах потоків. Такі дампи включають інформацію про те, у якому стані знаходиться потік. Якщо він заблокований, то дамп містить інформацію про монітор, звільнення якого очікує потік. Перш ніж вивести дамп потоків JVM переглядає граф очікуваних (зайнятих) моніторів, і якщо знаходить цикли - додає інформацію про взаємне блокування, вказуючи монітори, що беруть участь, і потоки. Дамп потоків із взаємним блокуванням виглядає так: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Found</span></span> one <span class="token class-name"><span class="token class-name">Java</span></span><span class="token operator"><span class="token operator">-</span></span>level deadlock<span class="token operator"><span class="token operator">:</span></span>
<span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">==</span></span><span class="token operator"><span class="token operator">=</span></span>
<span class="token string"><span class="token string">"ApplicationServerThread"</span></span><span class="token operator"><span class="token operator">:</span></span>
waiting <span class="token keyword"><span class="token keyword">to</span></span> <span class="token namespace"><span class="token namespace">lock</span></span> monitor <span class="token number"><span class="token number">0x0f0d80cc</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>a <span class="token class-name"><span class="token class-name">MyDBConnection</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">,</span></span>
which is held by <span class="token string"><span class="token string">"ApplicationServerThread"</span></span>
<span class="token string"><span class="token string">"ApplicationServerThread"</span></span><span class="token operator"><span class="token operator">:</span></span>
waiting <span class="token keyword"><span class="token keyword">to</span></span> <span class="token namespace"><span class="token namespace">lock</span></span> monitor <span class="token number"><span class="token number">0x0f0d8fed</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>a <span class="token class-name"><span class="token class-name">MyDBCallableStatement</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">,</span></span>
which is held by <span class="token string"><span class="token string">"ApplicationServerThread"</span></span>
<span class="token class-name"><span class="token class-name">Java</span></span> stack information <span class="token keyword"><span class="token keyword">for</span></span> the threads listed above<span class="token operator"><span class="token operator">:</span></span>
<span class="token string"><span class="token string">"ApplicationServerThread"</span></span><span class="token operator"><span class="token operator">:</span></span>
at <span class="token class-name"><span class="token class-name">MyDBConnection</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>remove_statement
<span class="token operator"><span class="token operator">-</span></span> waiting <span class="token keyword"><span class="token keyword">to</span></span> <span class="token namespace"><span class="token namespace">lock</span></span> <span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span>0x6f50f730<span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>a <span class="token class-name"><span class="token class-name">MyDBConnection</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
at <span class="token class-name"><span class="token class-name">MyDBStatement</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>close
<span class="token operator"><span class="token operator">-</span></span> locked <span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span>0x604ffbb0<span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>a <span class="token class-name"><span class="token class-name">MyDBCallableStatement</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>
<span class="token string"><span class="token string">"ApplicationServerThread"</span></span><span class="token operator"><span class="token operator">:</span></span>
at <span class="token class-name"><span class="token class-name">MyDBCallableStatement</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>sendBatch
<span class="token operator"><span class="token operator">-</span></span> waiting <span class="token keyword"><span class="token keyword">to</span></span> <span class="token namespace"><span class="token namespace">lock</span></span> <span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span>0x604ffbb0<span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>a <span class="token class-name"><span class="token class-name">MyDBCallableStatement</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
at <span class="token class-name"><span class="token class-name">MyDBConnection</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>commit
<span class="token operator"><span class="token operator">-</span></span> locked <span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span>0x6f50f730<span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>a <span class="token class-name"><span class="token class-name">MyDBConnection</span></span><span class="token punctuation"><span class="token punctuation">)</span></span></code></pre> Наведений вище дамп явно показує, що два потоки, що працюють із базою даних, заблокували один одного. Для того щоб діагностувати взаємні блокування за допомогою цієї особливості JVM потрібно розмістити виклики операції дампа потоків у різних місцях програми та провести тестування програми. Далі слід проаналізувати одержані логи. Якщо в них буде зазначено, що відбулося взаємне блокування, інформація з дампа допоможе виявити умови її виникнення. Загалом слід не допускати ситуацій, наведених у прикладах взаємних блокувань. У такому випадку додаток, швидше за все, працюватиме стабільно. Але не забувайте про тестування та код ревью. Це допоможе виявити неполадки, якщо вони все ж таки виникнуть. У випадку, якщо ви розробляєте систему, для якої критично відновлення полі взаємних блокувань, можна використовувати метод, описаний у розділі «Як уникати взаємних блокувань?». У цьому випадку може також виявитися корисним метод.<code class=" language-none">lockInterruptibly</code>інтерфейсу <code class=" language-none">Lock</code>з пакета <code class=" language-none">java.util.concurrent.locks</code>. Він дозволяє перервати потік монітор, що зайняв цим методом (і таким чином звільнити монітор).