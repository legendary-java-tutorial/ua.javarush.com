Thread'ом Java не зіпсуєш: Частина II - синхронізація
<p>----------------------------------------</p>
Отже, ми знаємо, що в Java є потоки, про що можна прочитати в огляді " ". Потоки потрібні, щоб виконувати роботу одночасно. Тому дуже ймовірно, що потоки якось взаємодіятимуть між собою. Давайте розберемося, як це відбувається і які базові 
<p>----------------------------------------</p>
<h2>Вступ</h2> Отже, ми знаємо, що в Java є потоки, про що можна прочитати в огляді " <a href="https://codegym.cc/groups/posts/2047-threadom-java-ne-isportishjh--chastjh-i---potoki" target="_blank" rel="nofollow">Thread'ом Java не зіпсуєш: Частина I - потоки</a> ". Потоки потрібні, щоб виконувати роботу одночасно. Тому дуже ймовірно, що потоки якось взаємодіятимуть між собою. Давайте розберемося, як це відбувається і які базові засоби управління ми маємо. <img data-max-width="800" data-id="d6076434-b756-40c7-b858-a8ef0c04ff4b" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 1" src="https://cdn.javarush.com/images/article/d6076434-b756-40c7-b858-a8ef0c04ff4b/800.jpeg" style="width: 800px;">
<h2>Yield</h2>Метод <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Thread.html#yield--" target="_blank" rel="nofollow">Thread.yield()</a> загадковий і рідко використовується. Існує багато варіацій його опису в Інтернеті. Аж до того, деякі пишуть про якусь чергу потоків, у якій потік переміститься вниз з урахуванням їх пріоритетів. Хтось пише, що потік змінить статус з running на runnable (хоча поділу на ці статуси немає, і Java їх не розрізняє). Але насправді все набагато невідоміше і в якомусь сенсі простіше. <img data-max-width="800" data-id="12b6080a-173b-4e6a-a3e6-47b3e08bf3dc" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 2" src="https://cdn.javarush.com/images/article/12b6080a-173b-4e6a-a3e6-47b3e08bf3dc/800.jpeg" style="width: 800px;">На тему документації методу <code class=" language-none">yield</code>є баг " <a href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6416721" target="_blank" rel="nofollow">JDK-6416721: (spec thread) Fix Thread.yield() javadoc</a> ". Якщо прочитати його, то зрозуміло, що насправді метод<code class=" language-none">yield</code>Лише передає деяку рекомендацію планувальнику потоків Java, що цьому потоку можна дати менше часу виконання. Але що буде насправді, чи планатор почує рекомендацію і що взагалі він робитиме — залежить від реалізації JVM та операційної системи. А може, і ще від якихось інших факторів. Вся плутанина склалася, швидше за все, через переосмислення багатопоточності у розвитку мови Java. Докладніше можна прочитати в огляді " <a href="https://www.baeldung.com/java-thread-yield" target="_blank" rel="nofollow">Brief Introduction to Java Thread.yield()</a> ". 
<h2>Sleep - Засипання потоку</h2>Потік у процесі виконання може засипати. Це найпростіший тип взаємодії коїться з іншими потоками. В операційній системі, на якій встановлена ​​віртуальна Java машина, де виконується Java код, є свій планувальник потоків, що називається Thread Scheduler. Саме він вирішує, який потік колись запускати. Програміст не може взаємодіяти з цим планувальником безпосередньо з Java коду, але він може через JVM попросити планувальник на якийсь час поставити потік на паузу, "приспати" його. Докладніше можна прочитати у статтях " <a href="https://www.javamex.com/tutorials/threads/sleep.shtml" target="_blank" rel="nofollow">Thread.sleep()</a> " і " <a href="https://www.j2eeonline.com/java-programmers-certification/module7/multithreading-theory.jsp" target="_blank" rel="nofollow">How Multithreading works</a> ". Більше того, можна дізнатися, як влаштовані потоки в Windows OS: " <a href="https://www.codeproject.com/Articles/662735/Internals-of-Windows-Thread" target="_blank" rel="nofollow">Internals of Windows Thread</a> ". А тепер побачимо це на власні очі. Збережемо у файл <code class=" language-none">HelloWorldApp.java</code>наступний код: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">HelloWorldApp</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                <span class="token keyword"><span class="token keyword">int</span></span> secToWait <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">1000</span></span> <span class="token operator"><span class="token operator">*</span></span> <span class="token number"><span class="token number">60</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>secToWait<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Waked up"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                e<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">printStackTrace</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">Thread</span></span> thread <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як видно, ми маємо деяке завдання (task), в якому виконується очікування в 60 секунд, після чого завершується програма. Виконуємо компіляцію <code class=" language-none">javac HelloWorldApp.java</code>та запуск <code class=" language-none">java HelloWorldApp</code>. Запуск краще виконати у окремому вікні. Наприклад, Windows це буде так: <code class=" language-none">start java HelloWorldApp</code>. За допомогою команди jps дізнаємося про PID процесу і відкриємо список потоків за допомогою <code class=" language-none">jvisualvm --openpid pidПроцесса</code>: <img data-max-width="800" data-id="d8198a66-0664-4140-8b61-9623d01250ab" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 3" src="https://cdn.javarush.com/images/article/d8198a66-0664-4140-8b61-9623d01250ab/800.jpeg" style="width: 800px;">Як видно, наш потік перейшов у статус Sleeping. Насправді, сон поточного потоку можна зробити красивіше: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>SECONDS<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">60</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Waked up"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	e<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">printStackTrace</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Ви напевно помітабо, що ми скрізь обробляємо <code class=" language-none">InterruptedException</code>? Давайте зрозуміємо, навіщо. 
<h2>Переривання потоку або Thread.interrupt</h2>Вся річ у тому, що поки потік чекає уві сні, хтось може захотіти перервати це очікування. На цей випадок ми опрацьовуємо такий виняток. Зроблено це після того, як метод <code class=" language-none">Thread.stop</code>оголосабо Deprecated, тобто. застарілим та небажаним до використання. Причиною тому було те, що за виклику методу <code class=" language-none">stop</code>потік просто "вбивався", що було дуже непередбачувано. Ми не могли знати, коли потік буде зупинено, не могли гарантувати консистентність даних. Уявіть, що ви пишете дані у файл, і тут потік знищують. Тому вирішабо, що логічніше потік не вбиватиме, а інформуватиме його про те, що йому слід перерватися. Як на це реагувати – справа самого потоку. Більш детально можна прочитати у Oracle у " <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/concurrency/threadPrimitiveDeprecation.html" target="_blank" rel="nofollow">Why is Thread.stop deprecated?</a> ". Подивимося на приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>SECONDS<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">60</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Interrupted"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Thread</span></span> thread <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">interrupt</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> У цьому прикладі ми не чекатимемо 60 секунд, а відразу надрукуємо 'Interrupted'. Все тому, що ми викликали у потоку метод <code class=" language-none">interrupt</code>. Цей метод виставляє "internal flag called interrupt status". Тобто кожен поток має внутрішній прапор, недоступний безпосередньо. Але ми маємо нативні методи для взаємодії з цим прапором. Але це єдиний спосіб. Потік може бути в процесі виконання, не чекати на щось, а просто виконувати дії. Але може передбачити, що його захочуть завершити у певний момент його роботи. Наприклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">while</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token operator"><span class="token operator">!</span></span><span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">isInterrupted</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token comment"><span class="token comment">//Do some work</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
		<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Finished"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Thread</span></span> thread <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">interrupt</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> У прикладі вище видно, що цикл <code class=" language-none">while</code>виконуватиметься доти, поки потік не перервуть зовні. Для прапора <strong>isinterrupted</strong> важливо знати те, що якщо ми зловабо <code class=" language-none">InterruptedException</code>, прапор <code class=" language-none">isInterrupted</code>скидається, і тоді <code class=" language-none">isInterrupted</code>буде повертати false. Є також статичний метод у класу Thread, який відноситься тільки до поточного потоку <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Thread.html#interrupted--" target="_blank" rel="nofollow">Thread.interrupted()</a> , але даний метод скидає значення прапора на false! Докладніше можна прочитати в розділі " <a href="https://www.oreilly.com/library/view/java-threads-second/1565924185/ch04s05.html" target="_blank" rel="nofollow">Thread Interruption</a> ". 
<h2>Join — Очікування завершення іншого потоку</h2>Найпростішим типом очікування є очікування завершення іншого потоку. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>SECONDS<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">5</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Interrupted"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Thread</span></span> thread <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">join</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Finished"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> У цьому прикладі новий потік спатиме 5 секунд. У той же час, головний потік main буде чекати, поки сплячий потік не прокинеться і не завершить свою роботу. Якщо подивитися через JVisualVM, стан потоку буде виглядати так: <img data-max-width="800" data-id="aea73753-db78-4fec-b749-3e6db829a134" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 4" src="https://cdn.javarush.com/images/article/aea73753-db78-4fec-b749-3e6db829a134/800.jpeg" style="width: 800px;">Завдяки засобам моніторингу можна побачити, що відбувається з потоком. Метод <code class=" language-none">join</code>досить простий, тому що є просто методом з кодом java, який виконує <code class=" language-none">wait</code>, поки потік, на якому він викликаний, живе. Як тільки потік вмирає (при завершенні), очікування переривається. Ось і вся магія методу <code class=" language-none">join</code>. Тому перейдемо до найцікавішого. 
<h2>Концепція Монітор</h2>Багатопоточність є таке поняття, як Monitor. Взагалі слово монітор з латинського перекладається як "наглядач" або "наглядач". У рамках цієї статті спробуємо згадати суть, а хто хоче - за подробицями прошу поринути у матеріал із посилань. Почнемо наш шлях зі специфікації мови Java, тобто з JLS: " <a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.1" target="_blank" rel="nofollow">17.1. Synchronization</a> ". Там сказано наступне: <img data-max-width="1024" data-id="82298e2f-5e85-482b-8cd8-bf663ba779c4" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 5" src="https://cdn.javarush.com/images/article/82298e2f-5e85-482b-8cd8-bf663ba779c4/1024.jpeg" style="width: 1024px;">Виходить, що з метою синхронізації між потоками Java використовує якийсь механізм, який називається "Монітор". З кожним об'єктом асоційований деякий монітор, а потоки можуть заблокувати його "lock" або розблокувати "unlock". Далі, знайдемо на сайті Oracle навчальний tutorial: " <a href="https://docs.oracle.com/javase/tutorial/essential/concurrency/locksync.html" target="_blank" rel="nofollow">Intrinsic Locks and Synchronization</a>У даному туторіалі говориться, що синхронізація в Java побудована навколо внутрішньої сутності (internal entity), відомої як intrinsic lock або monitor lock. Часто такий лок називають просто "монітор". Також ми знову бачимо, що кожен об'єкт у Java має асоційований з Далі важливо зрозуміти , яким чином об'єкт в Java може бути пов'язаний з <a href="https://www.logicbig.com/tutorials/core-java-tutorial/java-multi-threading/java-intrinsic-locks.html" target="_blank" rel="nofollow">монітором.У</a> кожного об'єкта в Java є заголовок (header) - свого роду внутрішні метадані, які недоступні програмісту з коду, але які потрібні віртуальній машині, щоб працювати з об'єктами правильно. <img data-max-width="512" data-id="e7dca828-f5f9-4bdd-8383-cb40f079e3f0" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 6" src="https://cdn.javarush.com/images/article/e7dca828-f5f9-4bdd-8383-cb40f079e3f0/512.jpeg" style="width: 512px;">
<center>
 <p><small><em>https://edu.netbeans.org/contrib/slides/java-overview-and-java-se6.pdf</em></small></p>
</center>Тут дуже стане в нагоді стаття з хабра: " <a href="https://m.habr.com/post/143237/" target="_blank" rel="nofollow">А як же все-таки працює багатопоточність? Частина I: синхронізація</a> ". До цієї статті варто додати опис із Summary блоку таска з багтекера JDK: " <a href="https://bugs.openjdk.java.net/browse/JDK-8183909" target="_blank" rel="nofollow">JDK-8183909</a> ". Можна також прочитати в " <a href="https://openjdk.java.net/jeps/8183909" target="_blank" rel="nofollow">JEP-8183909</a> " . Отже, Java з об'єктом асоційований монітор і потік виходить заблокувати цей потік або ще кажуть "отримати лок". Найпростіший приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">HelloWorld</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">Object</span></span> object <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Object</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">synchronized</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>object<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Hello World"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Отже, за допомогою ключового слова <code class=" language-none">synchronized</code>поточний потік (в якому виконуються ці рядки коду) намагається використовувати монітор, асоційований з об'єктом<code class=" language-none">object</code>і "отримати лок" або "захопити монітор" (другий варіант навіть краще). Якщо за монітор немає суперництва (тобто ніхто більше не хоче виконати synchronized за таким самим об'єктом), Java може спробувати виконати оптимізацію, звану "biased locking". У заголовку об'єкта Mark Word виставиться відповідний тег і запис про те, до якого потоку прив'язаний монітор. Це дозволяє скоротити накладні витрати під час захоплення монітора. Якщо монітор раніше був прив'язаний до іншого потоку, тоді такого блокування недостатньо. JVM перемикається на наступний тип блокування – basic locking. Вона використовує compare-and-swap (CAS) операції. При цьому в заголовку Mark Word вже зберігається не сам Mark Word, а посилання на його зберігання + змінюється тег, щоб JVM зрозуміла, що у нас використовується базове блокування. Якщо ж виникає суперництво (contention) за монітор кількох потоків (один захопив монітор, а другий чекає звільнення монітора), тоді тег у Mark Word змінюється, і Mark Word починає зберігатися посилання вже на монітор як об'єкт — деяку внутрішню сутність JVM. Як сказано в JEP, в такому випадку потрібно місце в Native Heap області пам'яті для зберігання цієї сутності. Посилання на місце зберігання цієї внутрішньої сутності буде знаходитися в Mark Word об'єкта. Таким чином, як бачимо, монітор — це справді механізм забезпечення синхронізації доступу кількох потоків до загальних ресурсів. Існує кілька реалізацій цього механізму, між якими перемикається JVM. Тому для простоти, говорячи про монітор, ми говоримо насправді про локи. а другий чекає звільнення монітора), тоді тег у Mark Word змінюється, і Mark Word починає зберігатися посилання вже на монітор як об'єкт — деяку внутрішню сутність JVM. Як сказано в JEP, в такому випадку потрібно місце в Native Heap області пам'яті для зберігання цієї сутності. Посилання на місце зберігання цієї внутрішньої сутності буде знаходитися в Mark Word об'єкта. Таким чином, як бачимо, монітор — це справді механізм забезпечення синхронізації доступу кількох потоків до загальних ресурсів. Існує кілька реалізацій цього механізму, між якими перемикається JVM. Тому для простоти, говорячи про монітор, ми говоримо насправді про локи. а другий чекає звільнення монітора), тоді тег у Mark Word змінюється, і Mark Word починає зберігатися посилання вже на монітор як об'єкт — деяку внутрішню сутність JVM. Як сказано в JEP, в такому випадку потрібно місце в Native Heap області пам'яті для зберігання цієї сутності. Посилання на місце зберігання цієї внутрішньої сутності буде знаходитися в Mark Word об'єкта. Таким чином, як бачимо, монітор — це справді механізм забезпечення синхронізації доступу кількох потоків до загальних ресурсів. Існує кілька реалізацій цього механізму, між якими перемикається JVM. Тому для простоти, говорячи про монітор, ми говоримо насправді про локи. у такому випадку потрібно місце в Native Heap області пам'яті для зберігання цієї сутності. Посилання на місце зберігання цієї внутрішньої сутності буде знаходитися в Mark Word об'єкта. Таким чином, як бачимо, монітор — це справді механізм забезпечення синхронізації доступу кількох потоків до загальних ресурсів. Існує кілька реалізацій цього механізму, між якими перемикається JVM. Тому для простоти, говорячи про монітор, ми говоримо насправді про локи. у такому випадку потрібно місце в Native Heap області пам'яті для зберігання цієї сутності. Посилання на місце зберігання цієї внутрішньої сутності буде знаходитися в Mark Word об'єкта. Таким чином, як бачимо, монітор — це справді механізм забезпечення синхронізації доступу кількох потоків до загальних ресурсів. Існує кілька реалізацій цього механізму, між якими перемикається JVM. Тому для простоти, говорячи про монітор, ми говоримо насправді про локи. між якими перемикається JVM. Тому для простоти, говорячи про монітор, ми говоримо насправді про локи. між якими перемикається JVM. Тому для простоти, говорячи про монітор, ми говоримо насправді про локи. <img data-max-width="800" data-id="b85a9a98-a848-4eef-b240-6d3060980d1e" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 7" src="https://cdn.javarush.com/images/article/b85a9a98-a848-4eef-b240-6d3060980d1e/800.jpeg" style="width: 800px;">
<h2>Synchronized та очікування по локу</h2>З поняттям монітора, як ми бачабо, тісно пов'язане поняття "блок синхронізації" (або як ще називають - критична секція). Погляньмо на приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Object</span></span> lock <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Object</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

	<span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>lock<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"thread"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

	<span class="token class-name"><span class="token class-name">Thread</span></span> th1 <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	th1<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>lock<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> i <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">8</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">1000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">print</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"  "</span></span> <span class="token operator"><span class="token operator">+</span></span> i<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
		<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">" ..."</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Тут головний потік спочатку відправляє завдання task в новий потік, а потім відразу ж захоплює лок і виконує з ним довгу операцію (8 секунд). Весь цей час task не може для свого виконання зайти в блок <code class=" language-none">synchronized</code>, т.к. лок вже зайнятий. Якщо потік не може отримати лок, він чекатиме цього біля монітора. Як тільки отримає – продовжить виконання. Коли потік виходить з під монітора, він звільняє лок. У JVisualVM це буде виглядати так: <img data-max-width="800" data-id="e3494727-ce3a-46f8-bdf9-baef35491b3c" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 8" src="https://cdn.javarush.com/images/article/e3494727-ce3a-46f8-bdf9-baef35491b3c/800.jpeg" style="width: 800px;">Як видно, статус JVisualVM називається "Monitor", тому що потік заблокований і не може зайняти монітор. У коді теж можна дізнатися про стан потоку, але назва цього стану не збігається з термінами JVisualVM, хоча вони і схожі. В даному випадку <code class=" language-none">th1.getState()</code>в циклі <code class=" language-none">for</code>повертатиме <span class="tetx-bold">BLOCKED</span>, т.к. поки виконується цикл, монітор <code class=" language-none">lock</code>зайнятий <code class=" language-none">main</code>потоком, а потік <code class=" language-none">th1</code>заблокований і не може продовжувати роботу, поки лок не повернуть. Крім блоків синхронізації, може бути синхронізований цілий метод. Наприклад, метод із класу <code class=" language-none">HashTable</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token keyword"><span class="token keyword">int</span></span> <span class="token function"><span class="token function">size</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">return</span></span> count<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> В одну одиницю часу цей метод виконуватиметься лише одним потоком. Але нам потрібний лок? Так, потрібний. У разі методів об'єкта локом виступатиме <code class=" language-none">this</code>. На цю тему є цікаве обговорення: " <a href="https://stackoverflow.com/questions/574240/is-there-an-advantage-to-use-a-synchronized-method-instead-of-a-synchronized-blo" target="_blank" rel="nofollow">Чи є можливе використання Synchronized Method instead of a Synchronized Block?</a> ". Якщо метод статичний, то локом буде <code class=" language-none">this</code>(т.к. для статичного методу може бути <code class=" language-none">this</code>), а об'єкт класу (Наприклад, <code class=" language-none">Integer.class</code>). <a href="https://codegym.cc/welcome" target="_blank"><img id="click_banner1_articles" data-max-width="1024" data-id="efa87787-1419-4c7b-9588-90e9aa7bff16" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 9" src="https://cdn.javarush.com/images/article/efa87787-1419-4c7b-9588-90e9aa7bff16/1024.jpeg" style="width: 1024px;"></a>
<h2>Wait та очікування по монітору. Методи notify і notifyAll</h2>Thread має ще один метод очікування, який при цьому пов'язаний з монітором. На відміну від <code class=" language-none">sleep</code>і <code class=" language-none">join</code>, його не можна просто так викликати. І звуть його <code class=" language-none">wait</code>. Виконується метод <code class=" language-none">wait</code>на об'єкті, на моніторі якого хочемо виконати очікування. Подивимося приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	    <span class="token class-name"><span class="token class-name">Object</span></span> lock <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Object</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	    <span class="token comment"><span class="token comment">// task будет ждать, пока его не оповестят через lock</span></span>
	    <span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	        <span class="token keyword"><span class="token keyword">synchronized</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>lock<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	            <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	                lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">wait</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	            <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	                <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"interrupted"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	            <span class="token punctuation"><span class="token punctuation">}</span></span>
	        <span class="token punctuation"><span class="token punctuation">}</span></span>
	        <span class="token comment"><span class="token comment">// После оповещения нас мы будем ждать, пока сможем взять лок</span></span>
	        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"thread"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	    <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	    <span class="token class-name"><span class="token class-name">Thread</span></span> taskThread <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	    taskThread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token comment"><span class="token comment">// Ждём и после этого забираем себе лок, оповещаем и отдаём лок</span></span>
	    <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">3000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	    <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"main"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	    <span class="token keyword"><span class="token keyword">synchronized</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>lock<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	        lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">notify</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> У JVisualVM це буде виглядати так: <img data-max-width="800" data-id="4968dab6-3f7a-4d6e-8ec2-0afed15736a0" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 10" src="https://cdn.javarush.com/images/article/4968dab6-3f7a-4d6e-8ec2-0afed15736a0/800.jpeg" style="width: 800px;">Щоб розібратися, як це працює, слід згадати, що методи <code class=" language-none">wait</code>і <code class=" language-none">notify</code>відносяться до <code class=" language-none">java.lang.Object</code>. Здається дивним, що методи, які стосуються потоків, перебувають у класі <code class=" language-none">Object</code>. Але тут і криється відповідь. Як ми пам'ятаємо, кожен об'єкт Java має заголовок. У заголовку міститься різна службова інформація, у тому числі інформація про монітор - дані про стан блокування. І як ми пам'ятаємо, кожен об'єкт (тобто кожен instance) має асоціацію із внутрішньою сутністю JVM, яка називається локом (intrinsic lock), який так само називають монітором. У прикладі вище в задачі task описано, що ми входимо в блок синхронізації монітора, асоційованого з <code class=" language-none">lock</code>. Якщо вдається отримати лок на цьому моніторі, то виконується<code class=" language-none">wait</code>. Потік, що виконує цей task, звільнятиме монітор <code class=" language-none">lock</code>, але ставатиме в чергу потоків, що очікують сповіщення по монітору <code class=" language-none">lock</code>. Ця черга потоків називається WAIT-SET, що правильно відображає суть. Це скоріше набір, а не черга. Потік <code class=" language-none">main</code>створює новий потік із завданням task, запускає його та чекає 3 секунди. Це дозволяє з великою ймовірністю нового потоку захопити лок перш, ніж потік <code class=" language-none">main</code>, і встати в чергу по монітору. Після чого потік <code class=" language-none">main</code>сам входить у блок синхронізації <code class=" language-none">lock</code>і виконує повідомлення потоку по монітору. Після того, як повідомлення надіслано, потік <code class=" language-none">main</code>звільняє монітор <code class=" language-none">lock</code>, а новий потік (який раніше чекав), дочекавшись звільнення монітора<code class=" language-none">lock</code>, продовжує виконання. Існує можливість надіслати повідомлення лише одному з потоків ( <code class=" language-none">notify</code>) або відразу всім потокам із черги ( <code class=" language-none">notifyAll</code>). Докладніше можна прочитати в " <a href="https://www.geeksforgeeks.org/difference-notify-notifyall-java/" target="_blank" rel="nofollow">Difference between notify() and notifyAll() in Java</a> ". Важливо, що порядок повідомлення залежить від JVM. Докладніше можна прочитати в " <a href="https://stackoverflow.com/questions/17063426/how-to-solve-starvation-with-notify-and-notifyall" target="_blank" rel="nofollow">How to solve starvation with notify and notifyall?</a> ". Синхронізацію можна виконувати без вказівки об'єкта. Це можна зробити, коли синхронізовано не окрему ділянку коду, а цілий метод. Наприклад, для статичних методів локом буде об'єкт класу (отриманий через <code class=" language-none">.class</code>): 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">printA</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"A"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">printB</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">synchronized</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">HelloWorld</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"B"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> З точки зору використання локів обидва методи однакові. Якщо метод не статичний, то синхронізація виконуватиметься за поточним <code class=" language-none">instance</code>, тобто <code class=" language-none">this</code>. До речі, ми говорабо, що за допомогою методу <code class=" language-none">getState</code>можна отримати статус потоку. Так от потік, який стає в чергу по монітору, статус буде WAITING або TIMED_WAITING, якщо в методі <code class=" language-none">wait</code>було вказано обмеження часу очікування. <img data-max-width="800" data-id="cda1e7a1-bdf1-4ff8-8a0b-250a0ccfb52e" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 11" src="https://cdn.javarush.com/images/article/cda1e7a1-bdf1-4ff8-8a0b-250a0ccfb52e/800.jpeg" style="width: 800px;">
<h2>Життєвий цикл потоку</h2>Як ми бачабо, потік у процесі життя змінює свій статус. Насправді ці зміни і є життєвим циклом потоку. Коли потік створений, він має статус NEW. У такому положенні він ще не запущений і планувальник потоків Java (Thread Scheduler) ще не знає нічого про новий потік. Для того, щоб дізнатися про потік планувальник потоків, необхідно викликати метод <code class=" language-none">thread.start()</code>. Тоді потік перейде у стан RUNNABLE. В інтернеті є багато неправильних схем, де поділяють стани Runnable та Running. Але це помилка, т.к. Java не відрізняє статус "готовий до роботи" та "працює (виконується)". Коли потік живий, але не активний (не Runnable), він знаходиться в одному з двох станів: 
<ul>
 <li>BLOCKED - очікує заходу в захищену (protected) секцію, тобто. у <code class=" language-none">synchonized</code>блок.</li>
 <li>WAITING - очікує інший потік за умовою. Якщо умова виконується, планувальник потоків запускає потік.</li>
</ul>Якщо потік очікує за часом, він перебуває у статусі TIMED_WAITING. Якщо потік більше не виконується (завершився успішно або з exception), він переходить у статус TERMINATED. Щоб дізнатися про стан потоку (його state), використовується метод <code class=" language-none">getState</code>. У потоків також є метод <code class=" language-none">isAlive</code>, який повертає true, якщо потік не Terminated. 
<h2>LockSupport та паркування потоків</h2>Починаючи з Java 1.6, з'явився цікавий механізм, званий <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/LockSupport.html" target="_blank" rel="nofollow">LockSupport</a> . <img data-max-width="800" data-id="001421d4-934e-4669-9831-0d2c3e714a27" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 12" src="https://cdn.javarush.com/images/article/001421d4-934e-4669-9831-0d2c3e714a27/800.jpeg" style="width: 800px;">Даний клас асоціює з кожним потоком, що його використовує, "permit" або дозвіл. Виклик методу <code class=" language-none">park</code>повертається негайно, якщо permit доступний, займаючи цей самий permit у процесі виклику. Інакше він блокується. Виклик методу <code class=" language-none">unpark</code>робить доступ доступним, якщо він ще недоступний. Permit є всього 1. У Java API <code class=" language-none">LockSupport</code>посилаються на якийсь <code class=" language-none">Semaphore</code>. Давайте подивимося на простий приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Semaphore</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">HelloWorldApp</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">Semaphore</span></span> semaphore <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Semaphore</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            semaphore<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">acquire</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token comment"><span class="token comment">// Просим разрешение и ждём, пока не получим его</span></span>
            e<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">printStackTrace</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Hello, World!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Цей код буде вічно чекати, тому що в семафорі зараз 0 permit. А коли в коді викликається <code class=" language-none">acquire</code>(тобто запитати дозвіл), то потік чекає, поки дозвіл не отримає. Оскільки ми чекаємо, то повинні обробити <code class=" language-none">InterruptedException</code>. Цікаво, що семафор реалізує окремий стан потоку. Якщо ми подивимося в JVisualVM, то побачимо, що у нас стан не Wait, а Park. <img data-max-width="800" data-id="27894d03-baf4-4321-8e3b-4c7002a8a1e4" class="img-fluid" alt="Thread'ом Java не зіпсуєш: Частина II - синхронізація - 13" src="https://cdn.javarush.com/images/article/27894d03-baf4-4321-8e3b-4c7002a8a1e4/800.jpeg" style="width: 800px;">Подивимося ще один приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token comment"><span class="token comment">//Запаркуем текущий поток</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>err<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Will be Parked"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token class-name"><span class="token class-name">LockSupport</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">park</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token comment"><span class="token comment">// Как только нас распаркуют - начнём действовать</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>err<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Unparked"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">Thread</span></span> th <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        th<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">2000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>err<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Thread state: "</span></span> <span class="token operator"><span class="token operator">+</span></span> th<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getState</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

        <span class="token class-name"><span class="token class-name">LockSupport</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">unpark</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>th<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">2000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Статус потоку буде WAITING, але JVisualVM відрізняється <code class=" language-none">wait</code>від <code class=" language-none">synchronized</code>і <code class=" language-none">park</code>від <code class=" language-none">LockSupport</code>. Чому такий важливий цей <code class=" language-none">LockSupport</code>? Звернемося знову до Java API і подивимося про <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Thread.State.html#WAITING" target="_blank" rel="nofollow">Thread State WAITING</a> . Як бачимо, до нього можна потрапити лише трьома способами. 2 способи - це <code class=" language-none">wait</code>і <code class=" language-none">join</code>. А третій – це <code class=" language-none">LockSupport</code>. Локи в Java побудовані також <code class=" language-none">LockSupport</code>і представляють більш високорівневі інструменти. Спробуємо скористатися таким. Подивимося, наприклад, на <code class=" language-none">ReentrantLock</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span>locks<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Lock</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span>locks<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">ReentrantLock</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">HelloWorld</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">Lock</span></span> lock <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ReentrantLock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">Runnable</span></span> task <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">-&gt;</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">lock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Thread"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">unlock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">lock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

        <span class="token class-name"><span class="token class-name">Thread</span></span> th <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>task<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        th<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"main"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">2000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">unlock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як і в попередніх прикладах, тут все просто. <code class=" language-none">lock</code>очікує, доки хтось звільнить ресурс. Якщо подивитися в JVisualVM, ми побачимо, що новий потік буде запаркований доти, доки <code class=" language-none">main</code>потік не віддасть йому лок. Докладніше про локи можна прочитати тут: " <a href="https://tproger.ru/translations/java8-concurrency-tutorial-2/" target="_blank" rel="nofollow">Многопоточне програмування в Java 8. Частина друга. Синхронізація доступу до змінних об'єктів</a> " та " <a href="https://javadevblog.com/java-lock-teoriya-i-primer-ispol-zovaniya-concurrency-lock.html" target="_blank" rel="nofollow">Java Lock API. Теорія та приклад використання</a> ". Щоб краще зрозуміти реалізацію локів, корисно прочитати про Phazer в огляді " <a href="https://metanit.com/java/tutorial/8.8.php" target="_blank" rel="nofollow">Клас Phaser</a> ". А говорячи про різні синхронізатори, обов'язкова до прочитання стаття на хабрі " <a href="https://habr.com/post/277669/" target="_blank" rel="nofollow">Довідник із синхронізаторів java.util.concurrent.*</a> ". 
<h2>Разом</h2>У цьому огляді ми розглянули основні способи взаємодії потоків Java. Додатковий матеріал: 
<ul>
 <li><a href="https://www.programcreek.com/2011/12/monitors-java-synchronization-mechanism/" target="_blank" rel="nofollow">Monitors – The Basic Idea of ​​Java Synchronization</a></li>
 <li><a href="https://habr.com/post/277669/" target="_blank" rel="nofollow">Довідник із синхронізаторів java.util.concurrent.*</a></li>
 <li><a href="https://jsehelper.blogspot.com/2016/01/multithreading-1.html" target="_blank" rel="nofollow">Відповіді на запитання щодо multithreading на співбесіді</a></li>
</ul>#Viacheslav 
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <th>Що ще почитати:</th>
   </tr>
   <tr>
    <td><a href="https://codegym.cc/groups/posts/2047-threadom-java-ne-isportishjh--chastjh-i---potoki" target="_blank">Thread'ом Java не зіпсуєш: Частина I - потоки </a><br><a href="https://codegym.cc/groups/posts/2060-threadom-java-ne-isportishjh--chastjh-iii---vzaimodeystvie" target="_blank">Thread'ом Java не зіпсуєш: Частина III - взаємодія <br></a><a href="https://codegym.cc/groups/posts/2065-threadom-java-ne-isportishjh--chastjh-iv---callable-future-i-druzjhja" target="_blank">Thread'ом Java не зіпсуєш: Частина IV - Callable, Future та друзі </a><br><a href="https://codegym.cc/groups/posts/2078-threadom-java-ne-isportishjh--chastjh-v---executor-threadpool-fork-join-pool" target="_blank">Thread'ом Java не зіпсуєш: Частина V - Executor, ThreadPool , Fork Join </a><br><a href="https://codegym.cc/groups/posts/2111-threadom-java-ne-isportishjh--chastjh-vi---k-barjheru" target="_blank">Thread'ом Java не зіпсуєш: Частина VI - До бар'єру!</a></td>
   </tr>
  </tbody>
 </table>
</div>