Синхронізація потоків, блокування об'єкта та блокування класу
<p>----------------------------------------</p>
Java підтримує кілька потоків для виконання. Це може призвести до того, що два або більше потоків отримають доступ до одного і того ж поля або об'єкта. Синхронізація це процес, який дозволяє виконувати всі паралельні потоки у програмі синхр
<p>----------------------------------------</p>
<img data-id="e210b671-ad70-46b0-8e5d-30dc14a2513e" data-max-width="850" alt="Синхронізація потоків, блокування об'єкта та блокування класу - 1" src="https://cdn.javarush.com/images/article/e210b671-ad70-46b0-8e5d-30dc14a2513e/800.jpeg" style="width: 850px;"><em>Синхронізація відноситься до багатопоточності. Синхронізований блок коду може бути виконаний лише одним потоком одночасно. </em> Java підтримує кілька потоків для виконання. Це може призвести до того, що два або більше потоків отримають доступ до одного і того ж поля або об'єкта. Синхронізація це процес, який дозволяє виконувати всі паралельні потоки у програмі синхронно. Синхронізація дозволяє уникнути помилок узгодженості пам'яті, викликаних через непослідовний доступ до спільної пам'яті. Коли метод оголошений як синхронізований, нитка тримає монітор для об'єкта, метод якого виконується. Якщо інший потік виконує синхронізований метод, ваш потік заблокується, поки інший потік не відпустить монітор. Синхронізація досягається у Java використанням зарезервованого слова<code class=" language-none">synchronized</code>. <strong>Ви можете використовувати його у своїх класах, визначаючи синхронізовані методи або блоки. Ви не зможете використовувати <code class=" language-none">synchronized</code>у змінних чи атрибутах у визначенні класу.</strong>
<h2>Блокування на рівні об'єкту</h2>Це механізм синхронізації не статичного методу або статичного блоку коду, такий, що тільки один потік зможе виконати даний блок або метод на даному екземплярі класу. Це потрібно робити завжди, коли потрібно зробити дані на рівні екземпляра потокобезпечними. Приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">DemoClass</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">demoMethod</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span><span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> або 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">DemoClass</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">demoMethod</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>        <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token comment"><span class="token comment">//other thread safe code</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> або 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">DemoClass</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">Object</span></span> lock <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Object</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">demoMethod</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>lock<span class="token punctuation"><span class="token punctuation">)</span></span>        <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token comment"><span class="token comment">//other thread safe code</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre>
<h2>Блокування на рівні класу</h2>Запобігає можливості кільком потокам увійти до синхронізованого блоку під час виконання в будь-якому з доступних екземплярів класу. Це означає, що якщо під час виконання програми є 100 екземплярів класу <code class=" language-none">DemoClass</code>, то тільки один потік у цей час зможе виконати <code class=" language-none">demoMethod()</code>в будь-якому випадку, і всі інші випадки будуть заблоковані для інших потоків. Це необхідно, коли потрібно зробити статичні дані потокобезпечними. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">DemoClass</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">demoMethod</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span><span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> або 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">DemoClass</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">demoMethod</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">DemoClass</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>        <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token comment"><span class="token comment">//other thread safe code</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> або 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">DemoClass</span></span>
<span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">Object</span></span> lock <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Object</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">demoMethod</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>lock<span class="token punctuation"><span class="token punctuation">)</span></span>        <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token comment"><span class="token comment">//other thread safe code</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre>
<h2>Деякі важливі зауваження</h2>
<ol>
 <li>Синхронізація Java гарантує, що жодні два потоки не зможуть виконати синхронізований метод одночасно або паралельно.</li>
 <br>
 <li><code class=" language-none"><strong>synchronized</strong></code>можна використовувати лише з методами та блоками коду. Ці методи або блоки можуть бути статичними або нестатичні.</li>
 <br>
 <li>коли якийсь потік входить у синхронізований метод або блок він набуває блокування і щоразу, коли потік виходить із синхронізованого методу або блоку JVM знімає блокування. Блокування знімається, навіть якщо нитка залишає синхронізований метод після завершення через будь-які помилки або винятки.</li>
 <br>
 <li><code class=" language-none"><strong>synchronized</strong></code>Java <a href="https://ru.wikipedia.org/wiki/%D0%A0%D0%B5%D0%B5%D0%BD%D1%82%D0%B5%D1%80%D0%B0%D0%B1%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C" rel="nofollow" target="_blank">рентерабельна</a> це означає, що якщо синхронізований метод викликає інший синхронізований метод, який вимагає такий же замок, то поточний потік, який тримає замок може увійти в цей метод не купуючи замок.</li>
 <br>
 <li>Синхронізація в Java буде кидати <code class=" language-none">NullPointerException</code>, якщо об'єкт використовується в синхронізованому блоці null. Наприклад, у наведеному вище прикладі коду, якщо замок ініціалізується як <code class=" language-none">null</code>, синхронізований (lock) кине <code class=" language-none">NullPointerException</code>.</li>
 <br>
 <li>Синхронізовані методи Java вносять додаткові витрати на продуктивність вашої програми. Тому використовуйте синхронізацію, коли вона абсолютно необхідна. Крім того, розгляньте питання про використання синхронізованих блоків коду для синхронізації лише критичних секцій коду.</li>
 <br>
 <li>Цілком можливо, що статичний і не статичний синхронізовані методи можуть працювати одночасно або паралельно, тому що вони захоплюють замок на інший об'єкт.</li>
 <br>
 <li>Відповідно до специфікації мови, ви не можете використовувати <code class=" language-none"><strong>synchronized</strong></code>в конструкторі це призведе до помилки компіляції.</li>
 <br>
 <li>Не синхронізуйте по не фінальному (no final) полю, тому що посилання на не фінальне поле може змінитися в будь-який час, а потім інший потік може отримати синхронізацію на різних об'єктах і вже не буде жодної синхронізації взагалі. Найкраще використовувати клас <code class=" language-none">String</code>, який вже незмінний та фінальний.</li>
 <br>
</ol><em>Удачі у навчанні!! </em> <em>Оригінал: <a href="https://howtodoinjava.com/java/multi-threading/object-vs-class-level-locking/" rel="nofollow" target="_blank">Object level lock vs Class level lock in Java</a></em>