Створення системи моніторингу цін на авіаквитки: покрокове керівництво [Частина 2]
<p>----------------------------------------</p>
Потрібно зберігати стан передплат на стороні програми, щоб знати, кому надсилати повідомлення про зниження ціни. Для цього я вибрав об'єкт з усіма необхідними даними, які потрібні Subscription. Скористаємося анотаціями (java persistence api
<p>----------------------------------------</p>
<a href="https://codegym.cc/groups/posts/2400-sozdanie-sistemih-monitoringa-cen-na-aviabiletih-poshagovoe-rukovodstvo" target="_blank">Створення системи моніторингу цін на авіаквитки: покрокове керівництво [Частина 1]</a>
<h3>Зміст</h3>
<ul>
 <li><a href="https://codegym.cc/groups/posts/2401#topic1">Налаштовуємо H2 базу даних та створюємо Subscription сутність. Шар Repository</a></li>
 <li><a href="https://codegym.cc/groups/posts/2401#topic2">EmailNofiticationService: пишемо сервіс відправки електронних листів</a></li>
 <li><a href="https://codegym.cc/groups/posts/2401#topic3">FlightPriceService — зв'язок сервісів клієнта із сервісами програми</a></li>
 <li><a href="https://codegym.cc/groups/posts/2401#topic4">Створюємо SubscriptionService та CRUD операції в ньому</a></li>
 <li><a href="https://codegym.cc/groups/posts/2401#topic5">Пишемо Spring Scheduler для перевірки стану квитків</a></li>
 <li><a href="https://codegym.cc/groups/posts/2401#topic6">Додаємо Swagger та Swagger UI у додаток</a></li>
</ul><img data-id="45741987-9a24-4e76-be92-dcc8cc158a94" data-max-width="850" alt="Створення системи моніторингу цін на авіаквитки: покрокове керівництво [Частина 2] - 1" src="https://cdn.javarush.com/images/article/45741987-9a24-4e76-be92-dcc8cc158a94/800.jpeg" style="width: 850px;">
<h2 id="topic1">Налаштовуємо H2 базу даних та створюємо Subscription сутність. Шар Repository</h2>Потрібно зберігати стан передплат на стороні програми, щоб знати, кому надсилати повідомлення про зниження ціни. Для цього я вибрав об'єкт з усіма необхідними даними, які потрібні Subscription. Скористаємося анотаціями <a href="https://ru.wikipedia.org/wiki/Java_Persistence_API" rel="nofollow" target="_blank">JPA</a> (java persistence api), отримаємо: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Column</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Entity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">GeneratedValue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Id</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"subscription"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Subscription</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Id</span>
   <span class="token annotation punctuation">@GeneratedValue</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"email"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"country"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> country<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"currency"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> currency<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"locale"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> locale<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"origin_place"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> originPlace<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"destination_place"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> destinationPlace<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"outbound_partial_date"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">LocalDate</span> outboundPartialDate<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"inbound_partial_date"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">LocalDate</span> inboundPartialDate<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"min_price"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> minPrice<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> де ми вказали вже відому нам @Data. Крім неї є нові: 
<ul>
 <li>@Entity - анотація з JPA, яка говорить, що це буде сутність з бази даних;</li>
 <li>@Table(name = "subscription") - також з JPA, яка визначає, з якою таблицею з'єднуватиметься ця сутність.</li>
</ul>Далі потрібно налаштувати H2 на проекті. На щастя, залежність вже маємо: нам потрібно написати простенький скрипт для створення таблиці і додати налаштування в application.properties файлі. <a href="https://www.baeldung.com/spring-boot-h2-database" rel="nofollow" target="_blank">Повний опис як додати H2</a> . 
<div class="table-container">
 <table class="table table--striped">
  <tbody>
   <tr>
    <td>
     <p>Витримка з книги Spring in Action 5th edition: <br><em>schema.sql — якщо файл намічений schema.sql у вікні application's classpath, тоді SQL в цьому файлі буде executed against the database when the application starts.</em></p></td>
   </tr>
  </tbody>
 </table>
</div>Spring Boot зрозуміє, що файл з ім'ям schema.sql у правильному місці означатиме, що він потрібен для бази даних. Як файл зі схемою БД помістимо його в корінь <strong>main/resources</strong> : <strong>schema.sql</strong>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">DROP TABLE IF <span class="token class-name">EXISTS</span> subscription<span class="token punctuation">;</span>

CREATE <span class="token class-name">TABLE</span> subscription <span class="token punctuation">(</span>
   id INT AUTO_INCREMENT <span class="token class-name">PRIMARY</span> KEY<span class="token punctuation">,</span>
   email <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
   country <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
   currency <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
   locale <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
   origin_place <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
   destination_place <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
   outbound_partial_date DATE <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
   min_price INT<span class="token punctuation">,</span>
   inbound_partial_date DATE
<span class="token punctuation">)</span></code></pre> Далі з гайду, який я привів вище, беремо такі налаштування: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"># H2
spring<span class="token punctuation">.</span>h2<span class="token punctuation">.</span>console<span class="token punctuation">.</span>enabled<span class="token operator">=</span><span class="token boolean">true</span>
spring<span class="token punctuation">.</span>h2<span class="token punctuation">.</span>console<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>web<span class="token operator">-</span>allow<span class="token operator">-</span>others<span class="token operator">=</span><span class="token boolean">true</span>
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>url<span class="token operator">=</span>jdbc<span class="token operator">:</span>h2<span class="token operator">:</span>mem<span class="token operator">:</span>subscriptiondb
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>driverClassName<span class="token operator">=</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>h2<span class="token punctuation">.</span></span>Driver</span>
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>username<span class="token operator">=</span>flights
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>password<span class="token operator">=</span>flights
spring<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span>database<span class="token operator">-</span>platform<span class="token operator">=</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>dialect<span class="token punctuation">.</span></span>H2Dialect</span></code></pre> Додамо SubscriptionRespository - інтерфейс, за допомогою якого буде спілкуватися з базою даних з Java-коду. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Subscription</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">JpaRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Repository</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubscriptionRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Subscription</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Subscription</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByEmail</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> З Spring Data цього цілком достатньо. JpaRepository має набір необхідних методів нашої роботи. Метод findByEmail(String email) створений як додатковий, який потрібний крім стандартного набору. Принадність Spring Data в тому, що правильно написаного імені способу вистачає, щоб Spring вже сам все зробив без нашої реалізації. Анотація @Repository потрібна для того, щоб потім можна було ін'єктувати цей інтерфейс в інші класи. І все…) Ось так просто працювати зі Spring Data. 
<h2 id="topic2">EmailNofiticationService: пишемо сервіс відправки електронних листів</h2>Щоб передплатники отримували повідомлення, потрібно додати надсилання листів на пошту. Тут можна вибрати інший шлях, наприклад, відправку через месенджери. З досвіду використання пошти gmail для надсилання повідомлень скажу, що потрібно зробити ще додаткове налаштування в акаунті і відключити подвійну авторизацію, щоб все працювало нормально. <a href="https://stackoverflow.com/questions/35347269/javax-mail-authenticationfailedexception-535-5-7-8-username-and-password-not-ac/45212730#45212730" rel="nofollow" target="_blank">Ось гарне рішення</a> . Якщо працюєш зі Spring Boot, велика ймовірність, що із завданням, яке потрібно реалізувати, вже вирішабо і можна скористатися цим. Зокрема, Spring boot starter mail. Залежність вже додали ще під час створення проекту, тому додаємо необхідні налаштування до application.properties <a href="https://www.mkyong.com/spring-boot/spring-boot-how-to-send-email-via-smtp/" rel="nofollow" target="_blank">як зазначено у статті</a> . 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"># <span class="token class-name">Spring</span> <span class="token class-name">Mail</span>
spring<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>host<span class="token operator">=</span>smtp<span class="token punctuation">.</span>gmail<span class="token punctuation">.</span>com
spring<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">587</span>
spring<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>username<span class="token operator">=</span>IMAIL
spring<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>password<span class="token operator">=</span>PASSWORD

# <span class="token class-name">Other</span> properties
spring<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>smtp<span class="token punctuation">.</span>auth<span class="token operator">=</span><span class="token boolean">true</span>
spring<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>smtp<span class="token punctuation">.</span>connectiontimeout<span class="token operator">=</span><span class="token number">5000</span>
spring<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>smtp<span class="token punctuation">.</span>timeout<span class="token operator">=</span><span class="token number">5000</span>
spring<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>smtp<span class="token punctuation">.</span>writetimeout<span class="token operator">=</span><span class="token number">5000</span>

# TLS <span class="token punctuation">,</span> port <span class="token number">587</span>
spring<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>smtp<span class="token punctuation">.</span>starttls<span class="token punctuation">.</span>enable<span class="token operator">=</span><span class="token boolean">true</span></code></pre> та власне сервіс. Потрібно надсилати повідомлення про реєстрацію підписки та про зменшення ціни на переліт: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Subscription</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Sends email notification.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">EmailNotifierService</span> <span class="token punctuation">{</span>

   <span class="token comment">/**
    * Notifies subscriber, that the minPrice has decreased.
    *
    * @param subscription the {@link Subscription} object.
    * @param oldMinPrice minPrice before recount.
    * @param newMinPrice minPrice after recount.
    */</span>
   <span class="token keyword">void</span> <span class="token function">notifySubscriber</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> subscription<span class="token punctuation">,</span> <span class="token class-name">Integer</span> oldMinPrice<span class="token punctuation">,</span> <span class="token class-name">Integer</span> newMinPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * Notifies subscriber, that subscription has added.
    *
    * @param subscription the {@link Subscription} object.
    */</span>
   <span class="token keyword">void</span> <span class="token function">notifyAddingSubscription</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> та реалізація: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Subscription</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">EmailNotifierService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>mail<span class="token punctuation">.</span></span><span class="token class-name">SimpleMailMessage</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>javamail<span class="token punctuation">.</span></span><span class="token class-name">JavaMailSender</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token comment">/**
* {@inheritDoc}
*/</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmailNotifierServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">EmailNotifierService</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">JavaMailSender</span> javaMailSender<span class="token punctuation">;</span>

   <span class="token comment">/**
    * {@inheritDoc}
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifySubscriber</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> subscription<span class="token punctuation">,</span> <span class="token class-name">Integer</span> oldMinPrice<span class="token punctuation">,</span> <span class="token class-name">Integer</span> newMinPrice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"method notifySubscriber STARTED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">SimpleMailMessage</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleMailMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       msg<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>subscription<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       msg<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">"Flights Monitoring Service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       msg<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Hello, dear! \n "</span>
               <span class="token operator">+</span> <span class="token string">"the price for your flight has decreased \n"</span>
               <span class="token operator">+</span> <span class="token string">"Old min price = %s,\n new min price = %s,\n Subscription details = %s"</span><span class="token punctuation">,</span> oldMinPrice<span class="token punctuation">,</span> newMinPrice<span class="token punctuation">,</span> subscription<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       javaMailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
       log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"method notifySubscriber FINISHED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * {@inheritDoc}
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyAddingSubscription</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> subscription<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"method notifyAddingSubscription STARTED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">SimpleMailMessage</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleMailMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       msg<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>subscription<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       msg<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">"Flights Monitoring Service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       msg<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Hello, dear! \n "</span>
               <span class="token operator">+</span> <span class="token string">"Subscription has been successfully added. \n"</span>
               <span class="token operator">+</span> <span class="token string">"Subscription details = %s"</span><span class="token punctuation">,</span> subscription<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       javaMailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
       log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"method notifyAddingSubscription FINISHED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="topic3">FlightPriceService — зв'язок сервісів клієнта із сервісами програми</h2>Щоб зв'язати роботу нашого FlightPricesClient та сервісу для обробки підписок, потрібно створити сервіс, який на підставі Subscription об'єкта видаватиме повну інформацію про рейс з мінімальною вартістю. Для цього є FlightPriceService: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>client<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">FlightPricesDto</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Subscription</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Service, for getting details based on {@link Subscription} object.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FlightPriceService</span> <span class="token punctuation">{</span>

   <span class="token comment">/**
    * Finds minPrice based on {@link Subscription}.
    *
    * @param flightPricesDto provided {@link FlightPricesDto} object.
    * @return
    */</span>
   <span class="token class-name">Integer</span> <span class="token function">findMinPrice</span><span class="token punctuation">(</span><span class="token class-name">FlightPricesDto</span> flightPricesDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * Finds all the flight data related to {@link Subscription} object.
    *
    * @param subscription provided {@link Subscription} object
    * @return {@link FlightPricesDto} with all the data related to flight specific in {@link Subscription}.
    */</span>
   <span class="token class-name">FlightPricesDto</span> <span class="token function">findFlightPrice</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> та реалізація: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>client<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">FlightPricesDto</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">FlightPricesClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Subscription</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">FlightPriceService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token comment">/**
* {@inheritDoc}
*/</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlightPriceServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">FlightPriceService</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">FlightPricesClient</span> flightPricesClient<span class="token punctuation">;</span>

   <span class="token comment">/**
    * {@inheritDoc}
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">findMinPrice</span><span class="token punctuation">(</span><span class="token class-name">FlightPricesDto</span> flightPricesDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> flightPricesDto<span class="token punctuation">.</span><span class="token function">getQuotas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMinPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * {@inheritDoc}
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">FlightPricesDto</span> <span class="token function">findFlightPrice</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> subscription<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>subscription<span class="token punctuation">.</span><span class="token function">getInboundPartialDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> flightPricesClient
                   <span class="token punctuation">.</span><span class="token function">browseQuotes</span><span class="token punctuation">(</span>subscription<span class="token punctuation">.</span><span class="token function">getCountry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subscription<span class="token punctuation">.</span><span class="token function">getCurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subscription<span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           subscription<span class="token punctuation">.</span><span class="token function">getOriginPlace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subscription<span class="token punctuation">.</span><span class="token function">getDestinationPlace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           subscription<span class="token punctuation">.</span><span class="token function">getOutboundPartialDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> flightPricesClient
                   <span class="token punctuation">.</span><span class="token function">browseQuotes</span><span class="token punctuation">(</span>subscription<span class="token punctuation">.</span><span class="token function">getCountry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subscription<span class="token punctuation">.</span><span class="token function">getCurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subscription<span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           subscription<span class="token punctuation">.</span><span class="token function">getOriginPlace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subscription<span class="token punctuation">.</span><span class="token function">getDestinationPlace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           subscription<span class="token punctuation">.</span><span class="token function">getOutboundPartialDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subscription<span class="token punctuation">.</span><span class="token function">getInboundPartialDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Тут ми маємо два методи: один повертає повну інформацію про політ з мінімальною ціною, а інший приймає цю інформацію та видає значення мінімальної ціни. Це можна було б робити щоразу і з результатом, але я вважаю, що так зручніше використати. 
<h2 id="topic4">Створюємо SubscriptionService та CRUD операції в ньому</h2>Для повного керування підписками необхідно створити сервіс із CRUD операціями. CRUD розшифровується як create, read, update, delete. Тобто потрібно вміти створювати передплату, рахувати її за ID, відредагувати та видалити. З однією лише різницею, що отримувати підписки будемо не по ID, а по email, тому що нам потрібно саме це. Адже навіщо нам підписки по незрозумілому ID, а ось усі підписки користувача його поштою реально потрібні. Отже SubscriptionService: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Subscription</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>rest<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SubscriptionCreateDto</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>rest<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SubscriptionDto</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>rest<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SubscriptionUpdateDto</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Manipulates with  subscriptions.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubscriptionService</span> <span class="token punctuation">{</span>

   <span class="token comment">/**
    * Add new subscription.
    * @param dto the dto of the subscription.
    */</span>
   <span class="token class-name">SubscriptionDto</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">SubscriptionCreateDto</span> dto<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * Get all subscription based on email.
    *
    * @param email provided email;
    * @return the collection of the {@link SubscriptionDto} objects.
    */</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SubscriptionDto</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByEmail</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * Remove subscription based on it ID
    *
    * @param subscriptionId the ID of the {@link Subscription}.
    */</span>
   <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Long</span> subscriptionId<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * Update subscription based on ID
    *
    *
    * @param subscriptionId the ID of the subscription to be updated.
    * @param dto the data to be updated.
    * @return updated {@link SubscriptionDto}.
    */</span>
   <span class="token class-name">SubscriptionDto</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Long</span> subscriptionId<span class="token punctuation">,</span> <span class="token class-name">SubscriptionUpdateDto</span> dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> У аргументах можна помітити три нові DTO об'єкти: 
<ul>
 <li>SubscriptionDto містить всю інформацію для показу;</li>
 <li>SubscriptionCreateDto - дані для створення підписки;</li>
 <li>SubscriptionUpdateDto — дані, які можна оновлювати у передплаті.</li>
</ul>У Create, Update DTO не потрапабо такі поля як ID, minPrice, тому що користувач має доступ до них тільки на читання. ID визначає базу даних, а minPrice отримуємо від запиту на Skyscanner API. І реалізація цього сервісу, SubscriptionServiceImpl: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>client<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">FlightPricesDto</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">SubscriptionRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Subscription</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>rest<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SubscriptionCreateDto</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>rest<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SubscriptionDto</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>rest<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SubscriptionUpdateDto</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">EmailNotifierService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">FlightPriceService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SubscriptionService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>domain<span class="token punctuation">.</span></span><span class="token class-name">Example</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token comment">/**
* {@inheritDoc}
*/</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubscriptionServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SubscriptionService</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">SubscriptionRepository</span> subscriptionRepository<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">FlightPriceService</span> flightPriceService<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">EmailNotifierService</span> emailNotifierService<span class="token punctuation">;</span>

   <span class="token comment">/**
    * {@inheritDoc}
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">SubscriptionDto</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">SubscriptionCreateDto</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Subscription</span> subscription <span class="token operator">=</span> <span class="token function">toEntity</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Subscription</span><span class="token punctuation">&gt;</span></span> one <span class="token operator">=</span> subscriptionRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token class-name">Example</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span>one<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"The same subscription has been found for Subscription={}"</span><span class="token punctuation">,</span> subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">Subscription</span> fromDatabase <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">FlightPricesDto</span> flightPriceResponse <span class="token operator">=</span> flightPriceService<span class="token punctuation">.</span><span class="token function">findFlightPrice</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
           subscription<span class="token punctuation">.</span><span class="token function">setMinPrice</span><span class="token punctuation">(</span>flightPriceService<span class="token punctuation">.</span><span class="token function">findMinPrice</span><span class="token punctuation">(</span>flightPriceResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> <span class="token function">toDto</span><span class="token punctuation">(</span>fromDatabase<span class="token punctuation">,</span> flightPriceResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token class-name">FlightPricesDto</span> flightPriceResponse <span class="token operator">=</span> flightPriceService<span class="token punctuation">.</span><span class="token function">findFlightPrice</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
           subscription<span class="token punctuation">.</span><span class="token function">setMinPrice</span><span class="token punctuation">(</span>flightPriceService<span class="token punctuation">.</span><span class="token function">findMinPrice</span><span class="token punctuation">(</span>flightPriceResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">Subscription</span> saved <span class="token operator">=</span> subscriptionRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
           log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Added new subscription={}"</span><span class="token punctuation">,</span> saved<span class="token punctuation">)</span><span class="token punctuation">;</span>
           emailNotifierService<span class="token punctuation">.</span><span class="token function">notifyAddingSubscription</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> <span class="token function">toDto</span><span class="token punctuation">(</span>saved<span class="token punctuation">,</span> flightPriceResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * {@inheritDoc}
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SubscriptionDto</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByEmail</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> subscriptionRepository<span class="token punctuation">.</span><span class="token function">findByEmail</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>subscription <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                   <span class="token class-name">FlightPricesDto</span> flightPriceResponse <span class="token operator">=</span> flightPriceService<span class="token punctuation">.</span><span class="token function">findFlightPrice</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">if</span> <span class="token punctuation">(</span>subscription<span class="token punctuation">.</span><span class="token function">getMinPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> flightPriceService<span class="token punctuation">.</span><span class="token function">findMinPrice</span><span class="token punctuation">(</span>flightPriceResponse<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       subscription<span class="token punctuation">.</span><span class="token function">setMinPrice</span><span class="token punctuation">(</span>flightPriceService<span class="token punctuation">.</span><span class="token function">findMinPrice</span><span class="token punctuation">(</span>flightPriceResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                       subscriptionRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">}</span>
                   <span class="token keyword">return</span> <span class="token function">toDto</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> flightPriceResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * {@inheritDoc}
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Long</span> subscriptionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       subscriptionRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>subscriptionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * {@inheritDoc}
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">SubscriptionDto</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Long</span> subscriptionId<span class="token punctuation">,</span> <span class="token class-name">SubscriptionUpdateDto</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Subscription</span> subscription <span class="token operator">=</span> subscriptionRepository<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>subscriptionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setDestinationPlace</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getDestinationPlace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setOriginPlace</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getOriginPlace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setLocale</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setCurrency</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getCurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setCountry</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getCountry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setOutboundPartialDate</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getOutboundPartialDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setInboundPartialDate</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getInboundPartialDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">FlightPricesDto</span> flightPriceResponse <span class="token operator">=</span> flightPriceService<span class="token punctuation">.</span><span class="token function">findFlightPrice</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setMinPrice</span><span class="token punctuation">(</span>flightPriceService<span class="token punctuation">.</span><span class="token function">findMinPrice</span><span class="token punctuation">(</span>flightPriceResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token function">toDto</span><span class="token punctuation">(</span>subscriptionRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">,</span> flightPriceResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token class-name">Subscription</span> <span class="token function">toEntity</span><span class="token punctuation">(</span><span class="token class-name">SubscriptionCreateDto</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Subscription</span> subscription <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setCountry</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getCountry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setCurrency</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getCurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setDestinationPlace</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getDestinationPlace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setInboundPartialDate</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getInboundPartialDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setOutboundPartialDate</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getOutboundPartialDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setLocale</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setOriginPlace</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getOriginPlace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       subscription<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">return</span> subscription<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token class-name">SubscriptionDto</span> <span class="token function">toDto</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> entity<span class="token punctuation">,</span> <span class="token class-name">FlightPricesDto</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">SubscriptionDto</span> dto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubscriptionDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dto<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dto<span class="token punctuation">.</span><span class="token function">setCountry</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getCountry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dto<span class="token punctuation">.</span><span class="token function">setCurrency</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getCurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dto<span class="token punctuation">.</span><span class="token function">setLocale</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dto<span class="token punctuation">.</span><span class="token function">setOriginPlace</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getOriginPlace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dto<span class="token punctuation">.</span><span class="token function">setDestinationPlace</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getDestinationPlace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dto<span class="token punctuation">.</span><span class="token function">setOutboundPartialDate</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getOutboundPartialDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dto<span class="token punctuation">.</span><span class="token function">setInboundPartialDate</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getInboundPartialDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dto<span class="token punctuation">.</span><span class="token function">setMinPrice</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getMinPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dto<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       dto<span class="token punctuation">.</span><span class="token function">setFlightPricesDto</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> dto<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="topic5">Пишемо Spring Scheduler для перевірки стану квитків</h2>Щоб знати, чи змінилася ціна на авіаквитки, потрібно час від часу проводити запити щодо створених передплат і перевіряти зі збереженим станом мінімальної ціни, яка лежить у базі даних. Для цього є Spring Scheduler, який допоможе нам з цим. Ось <a href="https://spring.io/guides/gs/scheduling-tasks/" rel="nofollow" target="_blank">чудовий опис</a> . Як і все у Spring, не потрібно багато дій: 
<ul>
 <li>
  <p>Додаємо інструкцію @EnableScheduling;</p></li>
 <li>
  <p>Створюємо SchedulerTasks об'єкт і поміщаємо його в Application Context</p>
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">RecountMinPriceService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Scheduled</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SchedulerTasks</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">RecountMinPriceService</span> recountMinPriceService<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> TEN_MINUTES <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>fixedRate <span class="token operator">=</span> TEN_MINUTES<span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recountMinPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"recount minPrice Started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       recountMinPriceService<span class="token punctuation">.</span><span class="token function">recount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"recount minPrice finished"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></li>
 <li>
  <p>Пишемо RecountMinPriceService, який виконуватиме всю логіку:</p>
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token comment">/**
* Recounts minPrice for all the subscriptions.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RecountMinPriceService</span> <span class="token punctuation">{</span>

   <span class="token comment">/**
    * Recounts minPrice for all the subscriptions.
    */</span>
   <span class="token keyword">void</span> <span class="token function">recount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
  <p>та реалізація:</p>
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>client<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">FlightPricesDto</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">SubscriptionRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">EmailNotifierService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">FlightPriceService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>romankh3<span class="token punctuation">.</span>flightsmonitoring<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">RecountMinPriceService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token comment">/**
* {@inheritDoc}
*/</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RecountMinPriceServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">RecountMinPriceService</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">SubscriptionRepository</span> subscriptionRepository<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">FlightPriceService</span> flightPriceService<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">EmailNotifierService</span> emailNotifierService<span class="token punctuation">;</span>

   <span class="token comment">//todo add async</span>
   <span class="token comment">/**
    * {@inheritDoc}
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       subscriptionRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>subscription <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
           <span class="token keyword">if</span><span class="token punctuation">(</span>subscription<span class="token punctuation">.</span><span class="token function">getOutboundPartialDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">minusDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">FlightPricesDto</span> flightPricesDto <span class="token operator">=</span> flightPriceService<span class="token punctuation">.</span><span class="token function">findFlightPrice</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">Integer</span> newNumPrice <span class="token operator">=</span> flightPriceService<span class="token punctuation">.</span><span class="token function">findMinPrice</span><span class="token punctuation">(</span>flightPricesDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>subscription<span class="token punctuation">.</span><span class="token function">getMinPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> newNumPrice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   emailNotifierService<span class="token punctuation">.</span><span class="token function">notifySubscriber</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> subscription<span class="token punctuation">.</span><span class="token function">getMinPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newNumPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   subscription<span class="token punctuation">.</span><span class="token function">setMinPrice</span><span class="token punctuation">(</span>newNumPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   subscriptionRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               subscriptionRepository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></li>
</ul>і все можна використовувати. Тепер кожні 30 хвабон (ця цифра задана в SchedulerTasks) відбуватиметься перерахунок minPrice без нашої участі. Якщо ціна стане меншою, повідомлення буде надіслано користувачу та збережено у базі даних. Це буде відбуватися daemon потоком. <a href="https://codegym.cc/welcome" target="_blank"><img id="click_banner1_articles" data-max-width="1024" data-id="a4c4b4c3-dd20-4f7f-8e44-bae3991aa9d0" class="img-fluid" alt="Створення системи моніторингу цін на авіаквитки: покрокове керівництво [Частина 2] - 2" src="https://cdn.javarush.com/images/article/a4c4b4c3-dd20-4f7f-8e44-bae3991aa9d0/1024.jpeg" style="width: 1024px;"></a>
<h2 id="topic6">Додаємо Swagger та Swagger UI у додаток</h2>Перш ніж написати контролери, додамо Swagger та Swagger UI. <a href="https://www.baeldung.com/swagger-2-documentation-for-spring-rest-api" rel="nofollow" target="_blank">Чудова стаття</a> на цю тему. 
<div class="table-container">
 <table class="table table--striped">
  <tbody>
   <tr>
    <td>
     <p>Swagger – це програмне середовище з відкритим вихідним кодом, що спирається на велику екосистему інструментів, яка допомагає розробникам проектувати, створювати, документувати та використовувати веб-сервіси RESTful.</p></td>
   </tr>
  </tbody>
 </table>
</div>Swagger UI надає веб-сторінку з інформацією про REST API, щоб показати, які запити, які дані приймає, а які повертає. Додати описи до полів, показати приклади полів, які очікує на додаток. Також за допомогою Swagger UI можна надсилати запити до програми без допомоги сторонніх інструментів. Це важлива частина, оскільки жодного front-end не передбачається. Розібралися для чого, тепер як це додати: 
<ul>
 <li>
  <p>додаємо дві залежності в pom.xml</p>
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>io<span class="token punctuation">.</span>springfox<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
     <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>springfox<span class="token operator">-</span>swagger2<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.9</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>io<span class="token punctuation">.</span>springfox<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>springfox<span class="token operator">-</span>swagger<span class="token operator">-</span>ui<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.9</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span></code></pre></li>
 <li>
  <p>Новий клас для конфігурації SwaggerConfig, з параметрами того, що буде відображатися на UI (user interface).</p>
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">PathSelectors</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">RequestHandlerSelectors</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>spi<span class="token punctuation">.</span></span><span class="token class-name">DocumentationType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>web<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span></span><span class="token class-name">Docket</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>swagger2<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">EnableSwagger2</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableSwagger2</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwaggerConfig</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> <span class="token class-name">Docket</span> <span class="token function">api</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Docket</span><span class="token punctuation">(</span><span class="token class-name">DocumentationType</span><span class="token punctuation">.</span>SWAGGER_2<span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">apis</span><span class="token punctuation">(</span><span class="token class-name">RequestHandlerSelectors</span><span class="token punctuation">.</span><span class="token function">basePackage</span><span class="token punctuation">(</span><span class="token string">"com.github.romankh3.flightsmonitoring.rest.controller"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token class-name">PathSelectors</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></li>
</ul>І все: тепер при запуску програми, якщо перейти за посиланням <strong>swagger-ui.html</strong> , буде видно всю інформацію про контролерів. Так як жодного фронтенду в додатку немає, при попаданні на головну сторінку буде помилка. Додамо редирект із головної сторінки на Swagger UI. Для цього ye;ty ще один клас конфігурації WebConfig: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ViewControllerRegistry</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebMvcConfigurer</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Web configuration class.
*/</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addViewControllers</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">"redirect:/swagger-ui.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><a href="https://codegym.cc/groups/posts/2402-sozdanie-sistemih-monitoringa-cen-na-aviabiletih-poshagovoe-rukovodstvo-chastjh-3" target="_blank">Створення системи моніторингу цін на авіаквитки: покрокове керівництво [Частина 3]</a>