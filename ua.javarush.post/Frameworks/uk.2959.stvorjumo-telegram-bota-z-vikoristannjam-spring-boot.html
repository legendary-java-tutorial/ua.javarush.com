Створюємо телеграм-бота з використанням Spring Boot
<p>----------------------------------------</p>
Всім привіт! В якийсь момент навчання вам хочеться перейти від вирішення завдань до створення реальних проектів, які ляжуть в основу вашого портфоліо. Коли я починав навчатися на стажуванні (яке я всім дуже рекомендую), на фрілансі надійшла
<p>----------------------------------------</p>
Всім привіт! В якийсь момент навчання вам хочеться перейти від вирішення завдань до створення реальних проектів, які ляжуть в основу вашого портфоліо. Коли я починав навчатися на стажуванні (яке я всім дуже рекомендую), на фрілансі надійшла пропозиція написати телеграм-бота. Зважаючи на свої малі знання написав досить простого бота ( <a href="https://github.com/whiskels/TelegramNotifierBot/tree/635f2993b9c7a6de654abd5c1958294a03ab4360" target="_blank" rel="nofollow">останній коміт до міграції на Spring</a> ), який містив у собі три нитки:
<ul>
 <li>нитка прийому повідомлень;</li>
 <li>нитка відправлення повідомлень;</li>
 <li>нитку планування подій (в ній перевірялася наявність запланованих повідомлень та оновлення кешованих даних з JSON).</li>
</ul>При написанні цього функціоналу багато в чому спирався на<a href="https://habr.com/ru/post/476306/" target="_blank" rel="nofollow"> цю статтю</a> . Все цілком непогано працювало, але чим глибше я поринав у Spring, тим сильніше мені хотілося все відрефакторити з метою зменшення зв'язності програми та покращення якості коду. Ще SonarLint (плагін для автоматичної перевірки якості коду) весь час намагався мене переконати, що нескінченні цикли while мати не дуже добре. Якоїсь миті я зважився і все переписав, а тепер хочу поділитися отриманими в процесі рефакторингу знаннями з вами. Почнемо з основ, а конкретніше - з <a href="https://github.com/rubenlagus/TelegramBots/tree/master/telegrambots-spring-boot-starter" target="_blank" rel="nofollow">TelegramBots-Spring-Boot-Starter </a> <strong>Отже, поїхали!</strong> Створимо бота, який вітатиметься у відповідь на будь-яке повідомлення. Для початку нам необхідно створити новий проект Maven. Додамо необхідні залежності до pom.xml. Додаємо в properties версії Java та TelegramBots-Spring-Boot-Starter. І прописуємо dependencies - тут у нас буде вже згаданий вище TelegramBots-Spring-Boot-Starter <s>і Telegram API</s> : <img width="800" height="500" data-id="71b67dfa-a0a0-4feb-840b-470a8aed0d42" alt="Створюємо телеграм бота з використанням Spring Boot - 1" src="https://cdn.javarush.com/images/article/71b67dfa-a0a0-4feb-840b-470a8aed0d42/1080.jpeg">Бібліотека TelegramBots-Spring-Boot-Starter включає Spring Boot і Telegram API. Її використання дозволяє нам простим чином оголосити бота в нашому коді, а Spring сам створить Bean і активує бота. Якщо вам цікаво, що відбувається під капотом у цей момент, то подивіться вихідні бібліотеки (в середовищі розробки або на <a href="https://github.com/rubenlagus/TelegramBots/tree/master/telegrambots-spring-boot-starter" target="_blank" rel="nofollow">гітхабі</a> ). Також додаємо параметри компіляції:<img width="800" height="500" data-id="ef34cc48-d1ff-4e80-af88-b83a617dd053" alt="Створюємо телеграм бота з використанням Spring Boot - 2" src="https://cdn.javarush.com/images/article/ef34cc48-d1ff-4e80-af88-b83a617dd053/1080.jpeg"> <span>Не забудьте після заповнення pom оновити усі залежності! </span> Створимо два класи - App і Bot, а також файл application.yaml у папці resources. Структура мого проекту виглядає так: <img width="800" height="500" data-id="8e378f74-d7f1-41ba-ac09-62f4898d6ba8" alt="Створюємо телеграм бота з використанням Spring Boot - 3" src="https://cdn.javarush.com/images/article/8e378f74-d7f1-41ba-ac09-62f4898d6ba8/1080.jpeg">На даному етапі додамо в application.yaml credentials нашого бота: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java">bot<span class="token operator">:</span>
  name<span class="token operator">:</span> <span class="token class-name">CodeGymTelegramBot</span>
  token<span class="token operator">:</span> <span class="token number">22313424</span><span class="token operator">:</span><span class="token class-name">AAF4gck4D8gDhq68E7k0UH8vlyQADhxQhYo</span></code></pre> Ієрархічний запис дозволяє нам уникнути повторення (bot.name, bot.token) та підвищити читаність. Якщо у вас ще не створений бот, то завести його можна, дотримуючись <a href="https://core.telegram.org/bots" target="_blank" rel="nofollow">офіційної інструкції</a> . Якщо ви не хочете світити креденшли до бота в application.yaml (що правильно) - використовуйте змінні оточення при депло: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java">bot<span class="token operator">:</span>
  name<span class="token operator">:</span> $<span class="token punctuation">{</span>BOT_NAME<span class="token punctuation">}</span>
  token<span class="token operator">:</span> $<span class="token punctuation">{</span>BOT_TOKEN<span class="token punctuation">}</span></code></pre> Заповнюємо клас Bot: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>bots<span class="token punctuation">.</span></span><span class="token class-name">TelegramLongPollingBot</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>methods<span class="token punctuation">.</span>send<span class="token punctuation">.</span></span><span class="token class-name">SendMessage</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Update</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span></span><span class="token class-name">TelegramApiException</span><span class="token punctuation">;</span>

<span class="token comment">// Аннотация @Component необходима, чтобы наш класс распознавался Spring, як полноправный Bean</span>
<span class="token annotation punctuation">@Component</span>
<span class="token comment">// Наследуемся от TelegramLongPollingBot - абстрактного класса Telegram API</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Bot</span> <span class="token keyword">extends</span> <span class="token class-name">TelegramLongPollingBot</span> <span class="token punctuation">{</span>
    <span class="token comment">// Аннотация @Value позволяет задавать значення полю путем считывания из application.yaml</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${bot.name}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> botUsername<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${bot.token}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> botToken<span class="token punctuation">;</span>

    <span class="token comment">/* Перегружаем метод интерфейса LongPollingBot
    Теперь при получении повідомлення наш бот будет отвечать сообщением Hi!
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onUpdateReceived</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setChatId</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Hi!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TelegramApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Геттеры, которые необходимы для наследования от TelegramLongPollingBot</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getBotUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> botUsername<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getBotToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> botToken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Заповнюємо клас App: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span></span><span class="token class-name">ApiContextInitializer</span><span class="token punctuation">;</span>

<span class="token comment">// Аннотация, которая объединяет в себя @Configuration, @EnableAutoConfiguration, @ComponentScan</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Здесь код написан по заветам</span>
        <span class="token comment">// https://github.com/rubenlagus/TelegramBots/tree/master/telegrambots-spring-boot-starter</span>
        <span class="token class-name">ApiContextInitializer</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">App</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Якщо ми все зробабо правильно, можна запустити main і привітатися з нашим ботом. <img width="800" height="500" data-id="61161b78-a249-4313-a6d4-9b1acec73c82" alt="Створюємо телеграм бота з використанням Spring Boot - 4" src="https://cdn.javarush.com/images/article/61161b78-a249-4313-a6d4-9b1acec73c82/1080.jpeg">Готово! Ми успішно написали та запустабо телеграм бота, який на кожне вхідне повідомлення вітається. Якщо вам була корисна ця стаття, то найкращою подякою буде, якщо ви загляньте в <a href="https://github.com/whiskels/TelegramNotifierBot" target="_blank" rel="nofollow">мій репозиторій</a> і поставите зірочку. Там же ви знайдете мою версію телеграм-бота, який має багато цікавих особливостей:
<ul>
 <li>зберігання користувачів у базі Postgres;</li>
 <li>авторизацію доступу до команд на основі ролей користувача;</li>
 <li>використання кастомних анотацій @BotCommand та @RequiredRoles для створення обробників повідомлень та перевірки прав користувача;</li>
 <li>підтримка створення графіка повідомлень.</li>
</ul>Якщо щось із цього функціоналу вас зацікавило — пишіть у коментарі, і я спробую або відповісти, або написати розгорнуту статтю про те, як його відтворити. PS Це моя перша стаття на CodeGym, і мені хотілося б поринути в нетрі Spring JPA і анотації @ Scheduled, але для початку мені здалося, що варто написати цей посібник про те, як взагалі підняти бота з використанням Spring Boot. <a href="https://codegym.cc/groups/posts/2967-sozdaem-telegram-bota-s-ispoljhzovaniem-spring-boot-pt3-quiz-bot" target="_blank" rel="nofollow">По ботах вже написано кілька статей, </a><a href="https://codegym.cc/groups/posts/2966-sozdaem-telegram-bota-s-ispoljhzovaniem-spring-boot-pt2-quiz-bot" target="_blank" rel="nofollow">але</a> пошук не видав подібного гайда, так що я вирішив заповнити цю нішу :) Також хотілося б відзначити Miroha - дякую за ідею UpdateHandler'ов, потяг її собі :) <a href="https://codegym.cc/groups/posts/2967-sozdaem-telegram-bota-s-ispoljhzovaniem-spring-boot-pt3-quiz-bot" target="_blank" rel="nofollow"></a>