Додаємо можливість передплатити групу статей. (Частина 2) - "Java-проект від А до Я"
<p>----------------------------------------</p>
Всім привіт! Продовжуємо роботу над завданням, яке ми розпочали . Тепер нам потрібно додати команду, щоб ми могли передплатити якусь групу статей з JavaRush. Як це зробити? Ітимемо за найпростішим сценарієм, який я придумав. Так як доступ у
<p>----------------------------------------</p>
Всім привіт! Продовжуємо роботу над завданням, яке ми розпочали <a href="https://codegym.cc/groups/posts/3300-java-proekt-ot-a-do-ja-dobavljaem-vozmozhnostjh-podpisatjhsja-na-gruppu-statey-chastjh-1" target="_blank">минулого тижня</a> .<img data-max-width="800" data-id="ab3fecb4-a09f-45cb-b470-bc8ea59e5de9" alt="&quot;Java-проект від А до Я&quot;: Додаємо можливість передплатити групу статей.  Частина 2 - 1" src="https://cdn.javarush.com/images/article/ab3fecb4-a09f-45cb-b470-bc8ea59e5de9/800.jpeg" style="width: 800px;">
<h2>Реалізуємо JRTB-5</h2>Тепер нам потрібно додати команду, щоб ми могли передплатити якусь групу статей з CodeGym. Як це зробити? Ітимемо за найпростішим сценарієм, який я придумав. Так як доступ у нас по ID групи, нам потрібно, щоб його користувач передав. Для цього користувач вводитиме команду <span class="text-bold">/addGroupSub</span> GROUP_ID, яка буде працювати за одним із двох варіантів: якщо приходить тільки сама команда: <span class="text-bold">/addGroupSub</span> , у відповідь передається список усіх груп та їх ID-шники. Тоді користувач зможе вибрати потрібний ID групи і скласти другий варіант запиту в цій команді: <span class="text-bold">/addGroupSub</span>GROUP_ID - і тоді вже буде запис цієї групи з цим користувачем. Думаю, у майбутньому можна буде зробити й краще. Наша мета — показати саме розробку, а не супер крутий user experience (соромно сказати, але я не знаю терміну російською, яка б означала це). Щоб правильно додати функціональність, яка йде крізь усі програми (у нашому випадку - від клієнта телеграм-бота до бази даних), потрібно починати з якогось кінця. Робитимемо це з боку БД.
<h2>Додаємо нову міграцію до БД</h2>Перше, що потрібно зробити, - додати нову міграцію бази даних і можливість зберігати дані про підписку користувачів на групи в JR. Щоб згадати, як це має бути, поверніться до статті “ <a href="https://codegym.cc/groups/posts/3170-java-proekt-ot-a-do-ja-planirovanie-proekta-semjh-raz-otmerjh--odin-raz-otrezhjh" target="_blank">Планування проекту: сім разів відміряй</a> ”. Там на другому фото намальовано приблизну схему БД. Нам потрібно додати таблицю для збереження інформації групи:
<ul>
 <li>ID групи у CodeGym буде і нашим ID. Ми довіряємо їм і вважаємо, що ці ID є унікальними;</li>
 <li>title – у наших картинках це було name – неформальна назва групи; тобто те, що бачимо на сайті CodeGym;</li>
 <li>last_article_id – а це цікаве поле. Воно буде зберігати останній ID-шник статті у цій групі, яку бот вже надіслав своїм передплатникам. За допомогою цього поля працюватиме механізм пошуку нових статей. Новим передплатникам не будуть надходити статті, опубліковані до того, як користувач підписався: лише ті, що вийшли після підписки на групу.</li>
</ul>Також у нас буде зв'язок many-to-many між таблицею груп та користувачів, тому що у кожного користувача може бути багато підписок на групи (one-to-many), і у кожної підписки на групу може бути багато користувачів (one-to- багато, тільки з іншого боку). Виходить, що це буде наш many-to-many. У кого це викликає питання, перегляньте статті за бази даних. Так, скоро планую створити пост у Телеграм-каналі, де зберу докупи всі статті з БД. Ось як виглядатиме наша друга міграція БД. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">V00002__created_groupsub_many_to_many</span><span class="token punctuation">.</span>sql<span class="token operator">:</span>

<span class="token operator">--</span> add PRIMARY KEY FOR tg_user
ALTER TABLE tg_user ADD <span class="token class-name">PRIMARY</span> KEY <span class="token punctuation">(</span>chat_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">--</span> ensure that the tables <span class="token keyword">with</span> <span class="token namespace">these</span> names are removed before creating a <span class="token keyword">new</span> one<span class="token punctuation">.</span>
DROP TABLE IF <span class="token class-name">EXISTS</span> group_sub<span class="token punctuation">;</span>
DROP TABLE IF <span class="token class-name">EXISTS</span> group_x_user<span class="token punctuation">;</span>

CREATE <span class="token class-name">TABLE</span> group_sub <span class="token punctuation">(</span>
   id INT<span class="token punctuation">,</span>
   title <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   last_article_id INT<span class="token punctuation">,</span>
   <span class="token class-name">PRIMARY</span> KEY <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE <span class="token class-name">TABLE</span> group_x_user <span class="token punctuation">(</span>
   group_sub_id INT <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
   user_id <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
   <span class="token class-name">FOREIGN</span> KEY <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token class-name">REFERENCES</span> <span class="token function">tg_user</span><span class="token punctuation">(</span>chat_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token class-name">FOREIGN</span> KEY <span class="token punctuation">(</span>group_sub_id<span class="token punctuation">)</span> <span class="token class-name">REFERENCES</span> <span class="token function">group_sub</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token function">UNIQUE</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> group_sub_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Спочатку я змінюю стару таблицю — додаю їй первинний ключ. Я якось це змарнував того разу, але тепер мені MySQL не давав можливість додати FOREIGN KEY для таблиці gorup_x_user, і я в рамках цієї міграції оновив базу даних. Зверніть увагу на важливий аспект. Зміну БД потрібно робити саме так — у новій міграції все те, що потрібно, але ніяк не шляхом оновлення вже випущеної міграції. Так, у нашому випадку нічого не сталося б, оскільки це тестовий проект і ми знаємо, що він розгортається тільки в одному місці, але це був би неправильний підхід. Адже ми хочемо, щоб усе було правильно. Далі йде видалення таблиць перед їх створенням. Навіщо це? Щоб якби за якоюсь випадковістю таблиці з такими іменами були в БД, міграція не впала б і відпрацювала саме так, як і очікується. І далі додаємо дві таблиці. Усі як і хотіли. Тепер потрібно запустити нашу програму. Якщо все запуститься і не зламається, то міграція записана. А щоб це перевірити ще раз, йдемо в базу даних переконатися, що: а) такі таблиці з'явабося; б) є ​​новий запис у технічній таблиці flyway. У цьому роботу з міграцією закінчено, переходимо до репозиторіям.
<h2>Додаємо шар репозиторію</h2>Завдяки Spring Boot Data тут все дуже просто: нам потрібно додати сутність GroupSub, трохи оновити TelegramUser і додати майже порожній GroupSubRepository: GroupSub entity додаємо в той же пакет, що і TelegramUser: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">EqualsAndHashCode</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Objects</span><span class="token punctuation">.</span>isNull<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"group_sub"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EqualsAndHashCode</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GroupSub</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Id</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"title"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"last_article_id"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> lastArticleId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span>EAGER<span class="token punctuation">)</span>
   <span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>
           name <span class="token operator">=</span> <span class="token string">"group_x_user"</span><span class="token punctuation">,</span>
           joinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"group_sub_id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           inverseJoinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"user_id"</span><span class="token punctuation">)</span>
   <span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> users<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token class-name">TelegramUser</span> telegramUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNull</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       users<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> З того, що варто відзначити, у нас є додаткове поле users, яке міститиме колекцію всіх користувачів, підписаних на групу. І дві інструкції - ManyToMany і JoinTable - саме для цього нам і потрібні. Таке за змістом поле потрібно додати і до TelegramUser: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">"users"</span><span class="token punctuation">,</span> fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span>EAGER<span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GroupSub</span><span class="token punctuation">&gt;</span></span> groupSubs<span class="token punctuation">;</span></code></pre> Це поле використовує джоїни, написані в GroupSub сутності. І, власне, наш клас репозиторій для GroupSub — <span class="code">GroupSubRepository</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">GroupSub</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">JpaRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Repository</span><span class="token punctuation">;</span>

<span class="token comment">/**
* {@link Repository} for {@link GroupSub} entity.
*/</span>
<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GroupSubRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GroupSub</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span></code></pre> На цьому етапі нам не потрібні додаткові методи: тих, що реалізовані в предку JpaRepository, нам вистачає. Напишемо тест в TelegramUserRepositoryIT, який перевірятиме, що наша багато-багато працює. Ідея тесту полягає в тому, що ми додамо до бази даних 5 груп підписок на одного користувача через sql скрипт, отримаємо цього користувача за його ID та перевіримо, що нам прийшли саме ті групи і саме з такими значеннями. Як це зробити? У дані можна зашити лічильник, яким потім пройдемо і перевіримо. Ось скрипт fiveGroupSubsForUser.sql: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">INSERT INTO tg_user VALUES <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

INSERT INTO group_sub VALUES
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'g1'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'g2'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'g3'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'g4'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'g5'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

INSERT INTO group_x_user VALUES
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> І сам тест: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Sql</span><span class="token punctuation">(</span>scripts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"/sql/clearDbs.sql"</span><span class="token punctuation">,</span> <span class="token string">"/sql/fiveGroupSubsForUser.sql"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldProperlyGetAllGroupSubsForUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//when</span>
   <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> userFromDB <span class="token operator">=</span> telegramUserRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//then</span>
   <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>userFromDB<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GroupSub</span><span class="token punctuation">&gt;</span></span> groupSubs <span class="token operator">=</span> userFromDB<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGroupSubs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> groupSubs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"g%s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> groupSubs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> groupSubs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> groupSubs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastArticleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Тепер додамо такий самий за змістом тест для GroupSub сутності. Для цього створимо тестовий клас <span class="code">groupSubRepositoryIT</span> у тому ж пакеті, що і <span class="code">groupSubRepositoryIT</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">GroupSub</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Assertions</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">AutoConfigureTestDatabase</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span><span class="token class-name">DataJpaTest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ActiveProfiles</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">Sql</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">AutoConfigureTestDatabase<span class="token punctuation">.</span>Replace</span><span class="token punctuation">.</span>NONE<span class="token punctuation">;</span>

<span class="token comment">/**
* Integration-level testing for {@link GroupSubRepository}.
*/</span>
<span class="token annotation punctuation">@ActiveProfiles</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DataJpaTest</span>
<span class="token annotation punctuation">@AutoConfigureTestDatabase</span><span class="token punctuation">(</span>replace <span class="token operator">=</span> NONE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GroupSubRepositoryIT</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">GroupSubRepository</span> groupSubRepository<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Sql</span><span class="token punctuation">(</span>scripts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"/sql/clearDbs.sql"</span><span class="token punctuation">,</span> <span class="token string">"/sql/fiveUsersForGroupSub.sql"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldProperlyGetAllUsersForGroupSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//when</span>
       <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GroupSub</span><span class="token punctuation">&gt;</span></span> groupSubFromDB <span class="token operator">=</span> groupSubRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>groupSubFromDB<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> groupSubFromDB<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> groupSubFromDB<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>users<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> users<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> І відсутній скрипт fiveUsersForGroupSub.sql: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">INSERT INTO tg_user VALUES
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

INSERT INTO group_sub VALUES <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'g1'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

INSERT INTO group_x_user VALUES
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> У цьому частину роботи з репозиторієм вважатимуться закінченою. Тепер напишемо шар сервісів.
<h2>Пишемо GroupSubService</h2>На даному етапі для роботи з групами передплат нам потрібно лише вміти зберігати їх, тому жодних проблем: створюємо сервіс GroupSubService та його реалізацію GroupSubServiceImpl у пакеті, де є й інші сервіси — service: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>codegymclient<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">GroupDiscussionInfo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">GroupSub</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Service for manipulating with {@link GroupSub}.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GroupSubService</span> <span class="token punctuation">{</span>

   <span class="token class-name">GroupSub</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">String</span> chatId<span class="token punctuation">,</span> <span class="token class-name">GroupDiscussionInfo</span> groupDiscussionInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> І його реалізацію: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>codegymclient<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">GroupDiscussionInfo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">GroupSubRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">GroupSub</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>rs<span class="token punctuation">.</span></span><span class="token class-name">NotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GroupSubServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GroupSubService</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">GroupSubRepository</span> groupSubRepository<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">public</span> <span class="token class-name">GroupSubServiceImpl</span><span class="token punctuation">(</span><span class="token class-name">GroupSubRepository</span> groupSubRepository<span class="token punctuation">,</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>groupSubRepository <span class="token operator">=</span> groupSubRepository<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>telegramUserService <span class="token operator">=</span> telegramUserService<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">GroupSub</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">String</span> chatId<span class="token punctuation">,</span> <span class="token class-name">GroupDiscussionInfo</span> groupDiscussionInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">TelegramUser</span> telegramUser <span class="token operator">=</span> telegramUserService<span class="token punctuation">.</span><span class="token function">findByChatId</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token class-name">NotFoundException</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//TODO add exception handling</span>
       <span class="token class-name">GroupSub</span> groupSub<span class="token punctuation">;</span>
       <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GroupSub</span><span class="token punctuation">&gt;</span></span> groupSubFromDB <span class="token operator">=</span> groupSubRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>groupSubFromDB<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           groupSub <span class="token operator">=</span> groupSubFromDB<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> first <span class="token operator">=</span> groupSub<span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> it<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span><span class="token punctuation">(</span>first<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               groupSub<span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           groupSub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           groupSub<span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
           groupSub<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           groupSub<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> groupSubRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>groupSub<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Щоб Spring Data запрацювала правильно і створився запис many-to-many, нам потрібно для групи підписки, яку ми створюємо, дістати з нашого БД користувача і додати його в об'єкт GroupSub. Тим самим, коли ми передамо на збереження цю передплату, буде створено ще й зв'язок через таблицю group_x_user. Можливо ситуація, коли вже створено таку групу передплати і треба легко додати до неї ще одного користувача. Для цього ми спочатку отримуємо за ID групи з БД, і якщо запис є, працюємо з ним, якщо ні – створюємо новий. Важливо, що для роботи з TelegramUser ми використовуємо TelegramUserService, щоб дотримуватися останнього з принципів SOLID. На даний момент, якщо ми не знаходимо запису за ID, я просто викидаю виняток. Воно ніяк зараз не обробляється: ми це зробимо вже наприкінці перед MVP. Напишемо два юніт-тести на клас<span class="code">GroupSubServiceTest</span> . Які нам потрібні? Я хочу бути впевненим, що GroupSubRepository викликає метод save і буде передана GroupSub сутність з одним єдиним користувачем — тим, що поверне нам TelegramUserService за наданим ID. І другий варіант, коли група з таким ID вже є в БД і вже ця група має один користувач, і потрібно перевірити, що до цієї групи буде додано ще один користувач і цей об'єкт збережений. Ось реалізація: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>codegymclient<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">GroupDiscussionInfo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">GroupSubRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">GroupSub</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">BeforeEach</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DisplayName</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>mockito<span class="token punctuation">.</span></span><span class="token class-name">Mockito</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"Unit-level testing for GroupSubService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GroupSubServiceTest</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">GroupSubService</span> groupSubService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">GroupSubRepository</span> groupSubRepository<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">TelegramUser</span> newUser<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> CHAT_ID <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@BeforeEach</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">TelegramUserService</span> telegramUserService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">TelegramUserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupSubRepository <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">GroupSubRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupSubService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupSubServiceImpl</span><span class="token punctuation">(</span>groupSubRepository<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">;</span>

       newUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       newUser<span class="token punctuation">.</span><span class="token function">setActive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       newUser<span class="token punctuation">.</span><span class="token function">setChatId</span><span class="token punctuation">(</span>CHAT_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>telegramUserService<span class="token punctuation">.</span><span class="token function">findByChatId</span><span class="token punctuation">(</span>CHAT_ID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>newUser<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldProperlySaveGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//given</span>

       <span class="token class-name">GroupDiscussionInfo</span> groupDiscussionInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupDiscussionInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"g1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">GroupSub</span> expectedGroupSub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       expectedGroupSub<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       expectedGroupSub<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       expectedGroupSub<span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span>newUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//when</span>
       groupSubService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>CHAT_ID<span class="token punctuation">,</span> groupDiscussionInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>groupSubRepository<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>expectedGroupSub<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldProperlyAddUserToExistingGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//given</span>
       <span class="token class-name">TelegramUser</span> oldTelegramUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       oldTelegramUser<span class="token punctuation">.</span><span class="token function">setChatId</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       oldTelegramUser<span class="token punctuation">.</span><span class="token function">setActive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">GroupDiscussionInfo</span> groupDiscussionInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupDiscussionInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"g1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">GroupSub</span> groupFromDB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupFromDB<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupFromDB<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupFromDB<span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span>oldTelegramUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>groupSubRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>groupFromDB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">GroupSub</span> expectedGroupSub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       expectedGroupSub<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       expectedGroupSub<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       expectedGroupSub<span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span>oldTelegramUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
       expectedGroupSub<span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span>newUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//when</span>
       groupSubService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>CHAT_ID<span class="token punctuation">,</span> groupDiscussionInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>groupSubRepository<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>groupDiscussionInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>groupSubRepository<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>expectedGroupSub<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre> Додав тут ще метод <span class="code">init()</span> з інструкцією BeforeEach. Таким чином, зазвичай створюють метод, який буде виконуватися перед запуском кожного тесту, і в нього можна винести загальну логіку для всіх тестів. У нашому випадку замокати TelegramUserService потрібно однаково для всіх тестів цього класу, тому розумно перенести цю логіку в загальний метод. Тут використовується дві конструкції з мокіто:
<ul>
 <li>
  <p><span class="code">Mockito.when(o1.m1(a1)).thenReturn(o2)</span> — в ній говоримо, що коли в об'єкті <span class="code">o1</span> буде викликаний метод <span class="code">m1</span> з аргументом <span class="code">a1</span> , метод поверне об'єкт <span class="code">o2</span> . Це чи не найголовніша функціональність мокито – змусити моковий об'єкт повертати саме те, що нам потрібно;</p></li>
 <li>
  <p><span class="code">Mockito.verify(o1).m1(a1)</span> - який перевіряє, що в об'єкті <span class="code">o1</span> був викликаний метод <span class="code">m1</span> з аргументом <span class="code">a1</span> . Можна було, звичайно, скористатися об'єктом методу save, що повертається, але я вирішив зробити трохи складніше, показавши ще один з можливих способів. Коли він може бути корисним? У випадках, коли методи мокових класів повертають void. Тоді без Mockito.verify справи не буде)))</p></li>
</ul>Продовжуємо дотримуватись ідеї, що тести писати потрібно, і писати їх потрібно багато. Наступний етап – робота з командою телеграм-бота.
<h2>Створюємо команду /addGroupSub</h2>Тут потрібно виконати наступну логіку: якщо нам приходить просто команда, без будь-якого контексту, ми допомагаємо користувачеві та передаємо йому список усіх груп з їхніми ID-шниками, щоб він зміг передати потрібну інформацію. А якщо користувач передає боту команду ще з якимось словом (словами) — знайти групу з таким ID або написати, що такої групи немає. Додамо нове значення в нашому єнамі - CommandName: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token function">ADD_GROUP_SUB</span><span class="token punctuation">(</span><span class="token string">"/addgroupsub"</span><span class="token punctuation">)</span></code></pre> Рухаємося далі від БД до телеграм-бота – створюємо клас <span class="code">AddGroupSubCommand</span> у пакеті command: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>codegymclient<span class="token punctuation">.</span></span><span class="token class-name">CodeGymGroupClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>codegymclient<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">GroupDiscussionInfo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>codegymclient<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">GroupRequestArgs</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">GroupSub</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">GroupSubService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Update</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">CommandName</span><span class="token punctuation">.</span>ADD_GROUP_SUB<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">CommandUtils</span><span class="token punctuation">.</span>getChatId<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">CommandUtils</span><span class="token punctuation">.</span>getMessage<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Objects</span><span class="token punctuation">.</span>isNull<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span>SPACE<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span>isNumeric<span class="token punctuation">;</span>

<span class="token comment">/**
* Add Group subscription {@link Command}.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddGroupSubCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CodeGymGroupClient</span> codeGymGroupClient<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">GroupSubService</span> groupSubService<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">AddGroupSubCommand</span><span class="token punctuation">(</span><span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">,</span> <span class="token class-name">CodeGymGroupClient</span> codeGymGroupClient<span class="token punctuation">,</span>
                             <span class="token class-name">GroupSubService</span> groupSubService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sendBotMessageService <span class="token operator">=</span> sendBotMessageService<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>codeGymGroupClient <span class="token operator">=</span> codeGymGroupClient<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>groupSubService <span class="token operator">=</span> groupSubService<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMessage</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>ADD_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">sendGroupIdList</span><span class="token punctuation">(</span><span class="token function">getChatId</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token class-name">String</span> groupId <span class="token operator">=</span> <span class="token function">getMessage</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>SPACE<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> chatId <span class="token operator">=</span> <span class="token function">getChatId</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNumeric</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token class-name">GroupDiscussionInfo</span> groupById <span class="token operator">=</span> codeGymGroupClient<span class="token punctuation">.</span><span class="token function">getGroupById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNull</span><span class="token punctuation">(</span>groupById<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token function">sendGroupNotFound</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token class-name">GroupSub</span> savedGroupSub <span class="token operator">=</span> groupSubService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> groupById<span class="token punctuation">)</span><span class="token punctuation">;</span>
           sendBotMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> <span class="token string">"Подписал на группу "</span> <span class="token operator">+</span> savedGroupSub<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token function">sendGroupNotFound</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendGroupNotFound</span><span class="token punctuation">(</span><span class="token class-name">String</span> chatId<span class="token punctuation">,</span> <span class="token class-name">String</span> groupId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> groupNotFoundMessage <span class="token operator">=</span> <span class="token string">"Нет группы с ID = \"%s\""</span><span class="token punctuation">;</span>
       sendBotMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>groupNotFoundMessage<span class="token punctuation">,</span> groupId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendGroupIdList</span><span class="token punctuation">(</span><span class="token class-name">String</span> chatId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> groupIds <span class="token operator">=</span> codeGymGroupClient<span class="token punctuation">.</span><span class="token function">getGroupList</span><span class="token punctuation">(</span><span class="token class-name">GroupRequestArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>group <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s - %s \n"</span><span class="token punctuation">,</span> group<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> group<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"Щобы подписаться на группу - передай комадну вместе с ID группы. \n"</span> <span class="token operator">+</span>
               <span class="token string">"Например: /addGroupSub 16. \n\n"</span> <span class="token operator">+</span>
               <span class="token string">"я подготовил список всех групп - выберай якую хочешь :) \n\n"</span> <span class="token operator">+</span>
               <span class="token string">"ім'я группы - ID группы \n\n"</span> <span class="token operator">+</span>
               <span class="token string">"%s"</span><span class="token punctuation">;</span>

       sendBotMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> groupIds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> У цьому класі використовується метод <span class="code">isNumeric</span> з apache-commons бібліотеки, тому додамо її до нашого пам'ятника: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>commons<span class="token operator">-</span>lang3<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span></code></pre> І в блок properties: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token generics"><span class="token punctuation">&lt;</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">3.11</span><span class="token operator">&lt;</span><span class="token operator">/</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>version<span class="token operator">&gt;</span></code></pre> Уся ця логіка перебуває у класі. Прочитайте її уважно. Будуть запитання/пропозиції – пишіть у коментарях. Після цього потрібно додати команду в CommandContainer до нашої карти команд: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ADD_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AddGroupSubCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> codeGymGroupClient<span class="token punctuation">,</span> groupSubService<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre> І все для цієї команди. Хочеться перевірити цю функціональність, але поки що реально можна подивитися тільки в БД. У третій частині я додам зміни з JRTB-6, щоб ми могли переглянути список груп, на які користувач підписав. Тепер добре б це все перевірити. Для цього виконаємо всі дії у Телеграмі та перевірити у базі даних. Так як у нас написані тести, все має бути чудово. Стаття вже й так вийшла чимала, тому тест для AddGroupSubCommand напишемо пізніше, а код додамо TODO, щоб не забути.
<h2>Висновки</h2>У цій статті ми розглянули роботу додавання функціональності через всю програму, починаючи від бази даних і закінчуючи роботою з клієнтом, який користується ботом. Зазвичай такі завдання допомагають розібратися у проекті, зрозуміти його суть. Зрозуміти, як він влаштований. Зараз теми йдуть непрості, тож не соромтеся: пишіть свої запитання у коментарях, а я постараюся на них відповісти. Подобається проект? Ставте йому зірку <a href="https://github.com/codegymcommunity" rel="nofollow" target="_blank">на гітхабі</a> : таким чином буде зрозуміло, що проектом цікавляться, і я задоволений. Як то кажуть, майстру завжди приємно, коли його роботу цінують. Код буде містити всі три частини STEP_6 і буде доступний раніше цієї статті. Як дізнатися про нього? Легко приєднатися до <a href="https://t.me/joinchat/SpqRPBFo_sM6qm05" rel="nofollow" target="_blank">телеграм-каналу</a>, де я публікую всю інформацію про свої статті про телеграм-бот. Дякую за прочитання! Частина 3 вже <a href="https://codegym.cc/groups/posts/3314-java-proekt-ot-a-do-ja-dobavljaem-vozmozhnostjh-podpisatjhsja-na-gruppu-statey-chastjh-3" target="_blank">тут</a> .<a href="https://codegym.cc/login/signup" target="_blank"><img id="click_banner1_articles" data-max-width="1080" data-id="5736eb4b-2b1c-4ab6-b4cc-b9e2d1cef628" alt="&quot;Java-проект від А до Я&quot;: Додаємо можливість передплатити групу статей.  Частина 2 - 2" src="https://cdn.javarush.com/images/article/5736eb4b-2b1c-4ab6-b4cc-b9e2d1cef628/1080.jpeg" style="width: 1080px;"></a>
<h4><a href="https://codegym.cc/groups/posts/2935-java-proekt-ot-a-do-ja-pishem-realjhnihy-proekt-dlja-portfolio#articles" target="_blank">Список всіх матеріалів серії на початку цієї статті.</a></h4>