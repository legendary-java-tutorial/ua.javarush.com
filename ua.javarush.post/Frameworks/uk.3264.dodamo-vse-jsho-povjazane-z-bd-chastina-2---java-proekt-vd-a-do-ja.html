Додаємо все, що пов'язане із БД. (Частина 2) - "Java-проект від А до Я"
<p>----------------------------------------</p>
Всім привіт. Нагадаю: ми додавали Flyway. Продовжимо. Наступний етап – налаштування роботи з базою даних у основного docker-compose.yml. Додамо БД у docker-compose файл: Я додав ще такий рядок у наш додаток: Це означає, що перед запуском пр
<p>----------------------------------------</p>
Всім привіт. Нагадаю: <a href="https://codegym.cc/groups/posts/3262-java-proekt-ot-a-do-ja-dobavljaem-vse-chto-svjazano-s-bd-chastjh-1" target="_blank">у першій частині</a> ми додавали Flyway. Продовжимо.
<h2>Додавання бази даних до docker-compose.yml</h2>Наступний етап – налаштування роботи з базою даних у основного docker-compose.yml. Додамо БД у docker-compose файл: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">version<span class="token operator">:</span> <span class="token string">'3.1'</span>

services<span class="token operator">:</span>
 jrtb<span class="token operator">-</span>bot<span class="token operator">:</span>
   depends_on<span class="token operator">:</span>
     <span class="token operator">-</span> jrtb<span class="token operator">-</span>db
   build<span class="token operator">:</span>
     context<span class="token operator">:</span> <span class="token punctuation">.</span>
   environment<span class="token operator">:</span>
     BOT_NAME<span class="token operator">:</span> $<span class="token punctuation">{</span>BOT_NAME<span class="token punctuation">}</span>
     BOT_TOKEN<span class="token operator">:</span> $<span class="token punctuation">{</span>BOT_TOKEN<span class="token punctuation">}</span>
     BOT_DB_USERNAME<span class="token operator">:</span> $<span class="token punctuation">{</span>BOT_DB_USERNAME<span class="token punctuation">}</span>
     BOT_DB_PASSWORD<span class="token operator">:</span> $<span class="token punctuation">{</span>BOT_DB_PASSWORD<span class="token punctuation">}</span>
   restart<span class="token operator">:</span> always
 jrtb<span class="token operator">-</span>db<span class="token operator">:</span>
   image<span class="token operator">:</span> mysql<span class="token operator">:</span><span class="token number">5.7</span>
   restart<span class="token operator">:</span> always
   environment<span class="token operator">:</span>
     MYSQL_USER<span class="token operator">:</span> $<span class="token punctuation">{</span>BOT_DB_USERNAME<span class="token punctuation">}</span>
     MYSQL_PASSWORD<span class="token operator">:</span> $<span class="token punctuation">{</span>BOT_DB_PASSWORD<span class="token punctuation">}</span>
     MYSQL_DATABASE<span class="token operator">:</span> <span class="token string">'jrtb_db'</span>
     MYSQL_ROOT_PASSWORD<span class="token operator">:</span> <span class="token string">'root'</span>
   ports<span class="token operator">:</span>
     <span class="token operator">-</span> <span class="token string">'3306:3306'</span>
   expose<span class="token operator">:</span>
     <span class="token operator">-</span> <span class="token string">'3306'</span></code></pre> Я додав ще такий рядок у наш додаток: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java">depends_on<span class="token operator">:</span>
 <span class="token operator">-</span> jrtb<span class="token operator">-</span>db</code></pre> Це означає, що перед запуском програми ми очікуємо, що запуститься база даних. Далі можна помітити додавання ще двох змінних, які нам потрібні для роботи з БД: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java">$<span class="token punctuation">{</span>BOT_DB_USERNAME<span class="token punctuation">}</span>
$<span class="token punctuation">{</span>BOT_DB_PASSWORD<span class="token punctuation">}</span></code></pre> Їх ми отримаємо в docker-compose так само, як і для телеграм-бота через змінні оточення. Зробив я це для того, щоб ми мали лише одне місце, де ми виставляємо значення імені користувача БД та його пароль. Ми передаємо їх у докер образ нашого додатка та у докер контейнер нашої бази даних. Далі потрібно оновити Dockerfile, щоб навчити наш SpringBoot приймати змінні для бази даних. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">FROM adoptopenjdk<span class="token operator">/</span>openjdk11<span class="token operator">:</span>ubi
<span class="token class-name">ARG</span> JAR_FILE<span class="token operator">=</span>target<span class="token comment">/*.jar
ENV BOT_NAME=test.codegym_community_bot
ENV BOT_TOKEN=1375780501:AAE4A6Rz0BSnIGzeu896OjQnjzsMEG6_uso
ENV BOT_DB_USERNAME=jrtb_db_user
ENV BOT_DB_PASSWORD=jrtb_db_password
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java","-Dspring.datasource.password=${BOT_DB_PASSWORD}", "-Dbot.username=${BOT_NAME}", "-Dbot.token=${BOT_TOKEN}", "-Dspring.datasource.username=${BOT_DB_USERNAME}", "-jar", "app.jar"]</span></code></pre> Тепер додаємо змінні бази даних до Dockerfile: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token class-name">ENV</span> BOT_DB_USERNAME<span class="token operator">=</span>jrtb_db_user
<span class="token class-name">ENV</span> BOT_DB_PASSWORD<span class="token operator">=</span>jrtb_db_password</code></pre> Значення змінних будуть інші. Ті, які ми передамо в Dockerfile, проте вимагають дати значення за замовчуванням, тому я і ввів якісь. Розширюємо останній рядок двома елементами, за допомогою яких ми передамо в запуск програми ім'я користувача ДБ та його пароль: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token string">"-Dspring.datasource.password=${BOT_DB_PASSWORD}"</span><span class="token punctuation">,</span> <span class="token string">"-Dbot.username=${BOT_NAME}"</span></code></pre><span class="text-bold">Останній рядок у Dockerfile (який починається з ENTRYPOINT) повинен бути без перенесення елементів. Якщо зробити перенесення, цей код працювати не буде. </span> Останній крок — оновити файл <span class="text-bold">start.sh</span> , щоб передавати змінні для бази даних. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">#<span class="token operator">!</span><span class="token operator">/</span>bin<span class="token operator">/</span>bash

# <span class="token class-name">Pull</span> <span class="token keyword">new</span> changes
git pull

# <span class="token class-name">Prepare</span> <span class="token class-name">Jar</span>
mvn clean
mvn <span class="token keyword">package</span>

# <span class="token class-name">Ensure</span><span class="token punctuation">,</span> that docker<span class="token operator">-</span>compose stopped
docker<span class="token operator">-</span>compose stop

# <span class="token class-name">Add</span> environment variables
export BOT_NAME<span class="token operator">=</span>$<span class="token number">1</span>
export BOT_TOKEN<span class="token operator">=</span>$<span class="token number">2</span>
export BOT_DB_USERNAME<span class="token operator">=</span><span class="token string">'prod_jrtb_db_user'</span>
export BOT_DB_PASSWORD<span class="token operator">=</span><span class="token string">'Pap9L9VVUkNYj99GCUCC3mJkb'</span>

# <span class="token class-name">Start</span> <span class="token keyword">new</span> deployment
docker<span class="token operator">-</span>compose up <span class="token operator">--</span>build <span class="token operator">-</span>d</code></pre> Ми вже вміємо додавати змінні середовища, перш ніж запустити docker-compose. Для цього просто потрібно виконати export var_name=var_value. Тому додаємо всього два рядки: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java">export BOT_DB_USERNAME<span class="token operator">=</span><span class="token string">'prod_jrtb_db_user'</span>
export BOT_DB_PASSWORD<span class="token operator">=</span><span class="token string">'Pap9L9VVUkNYj99GCUCC3mJkb'</span></code></pre> Саме тут ми задаємо ім'я користувача БД та його пароль. Звичайно, можна було б ці змінні передавати при запуску баш скрипта, як ми це робимо для ім'я та токена бота. Але мені здається, що це зайве. Щоб реально отримати доступ до бази даних, потрібно знати IP-сервера, на якому буде розгорнута БД, і бути в списку дозволених IP-адреса для запиту. Як на мене, цього вже й так достатньо. Основу закладено: тепер можна займатися більш зрозумілими для розробника речами — писати код. До цього ми займалися тим, що роблять DevOps інженери – налаштовували оточення.
<h2>Додаємо Repository шар</h2>Зазвичай у додатку є три шари:
<ol>
 <li><span class="text-bold">Контролери</span> - точки входу до програми.</li>
 <li><span class="text-bold">Сервіси</span> – місце роботи бізнес-логіки. Це вже частково є: SendMessageService — явний представник бізнес-логіки.</li>
 <li><span class="text-bold">Репозиторії</span> – місце роботи з базою даних. У нашому випадку це телеграм-бот.</li>
</ol>Ось зараз додаватимемо третій шар — репозиторії. Тут ми будемо використовувати проект із екосистеми Spring - Spring Data. Почитати про те, що це таке, можна <a href="https://habr.com/ru/post/435114/" rel="nofollow" target="_blank">в цій статті на Хабрі</a> . Нам потрібно знати та розуміти кілька моментів:
<ol>
 <li>У нас не буде роботи з JDBC: ми працюватимемо одразу з вищими абстракціями. Тобто зберігати об'єкти POJO, які відповідають таблицям у базі даних. Такі класи ми називатимемо <span class="text-bold">entity</span> , оскільки вони називаються офіційно в <span class="text-bold">Java Persistence API</span> (це загальний набір інтерфейсів для БД через ORM, тобто абстракція над роботою з JDBC). У нас буде клас entity, який ми зберігатимемо в БД, і вони запишуться саме в таблицю, яка нам потрібна. Такі ж об'єкти ми отримуватимемо при пошуку в базі даних.</li>
 <li>Spring Data пропонує використовувати їх набір інтерфейсів: <span class="text-bold">JpaRepository</span> , <span class="text-bold">CrudRepository</span> , etc... Є й інші інтерфейси: повний перелік можна знайти <a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/repository/Repository.html" rel="nofollow" target="_blank">тут</a> . Принадність полягає в тому, що можна використовувати їх методи, не реалізовуючи їх(!). Більше того, є певний шаблон, за допомогою якого можна писати в інтерфейсі нові методи, і вони будуть реалізовані автоматично.</li>
 <li>Spring полегшує нашу розробку як може. Для цього нам потрібно створити свій інтерфейс і успадковуватись від вищеописаних. А щоб Spring знав, що йому потрібно використовувати цей інтерфейс, додати інструкцію Repository.</li>
 <li>Якщо нам потрібно буде написати метод для роботи з базою даних, якого немає, то це також не проблема — напишемо. Покажу, що та як там робити.</li>
</ol>У рамках цієї статті ми проведемо роботу з додаванням по всьому шляху TelegramUser та покажемо на його прикладі цю частину. Решту вже розширюватимемо на інших завданнях. Тобто при виконанні команди /start ми будемо записувати до бази даних нашого користувача active = true. Це означатиме, що користувач користується роботом. Якщо користувач вже є у БД, оновлюватимемо поле active = true. При виконанні команди /stop ми не видалятимемо користувача, а тільки оновимо поле active на значення false, щоб якщо користувач знову захоче використовувати бота, він міг його запустити і продовжити з того моменту, де зупинився. А щоб при тестуванні було видно, що відбувається, ми створимо команду /stat: вона відображатиме кількість активних користувачів. Створюємо <span class="text-bold">репозиторію</span>пакет поруч із пакетами bot, command, service. У цьому пакеті створюємо ще один <span class="text-bold">entity</span> . У пакеті entity створюємо клас TelegramUser: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Column</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Entity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Telegram User entity.
*/</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"tg_user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TelegramUser</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Id</span>
   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"chat_id"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> chatId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"active"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> active<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Тут видно, що у нас усі анотації з javax.persistence пакету. Це загальні інструкції, які використовуються для всіх реалізацій ORM. За замовчуванням Spring Data Jpa використовується Hibernate, хоча можна використовувати й інші реалізації. Ось перелік анотацій, які ми використовуємо:
<ul>
 <li><span class="text-bold">Entity</span> - говорить про те, що це сутність для роботи з БД;</li>
 <li><span class="text-bold">Table</span> – тут ми визначаємо ім'я таблиці;</li>
 <li><span class="text-bold">Id</span> - анотація говорить, яке поле буде Primary Key у таблиці;</li>
 <li><span class="text-bold">Column</span> - визначаємо ім'я поля таблиці.</li>
</ul>Далі створюємо інтерфейс для роботи з базою даних. Зазвичай імена таких інтерфейсів пишуться за шаблоном — EntiryNameRepository. У нас буде TelegramuserRepository: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">JpaRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Repository</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
* {@link Repository} for handling with {@link TelegramUser} entity.
*/</span>
<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TelegramUserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAllByActiveTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Тут видно, як я додав метод <span class="code">findAllByActiveTrue()</span> , який ніде не реалізую. Але це не завадить йому працювати. Spring Data зрозуміє, що потрібно отримати всі записи з таблиці tg_user, які мають поле <span class="text-bold">active = true</span> . Додаємо сервіс по роботі з сутністю TelegramUser (застосовуємо dependency inversion із SOLID у контексті того, що сервіси інших сутностей не можуть безпосередньо спілкуватися з репозиторієм іншої сутності – лише через сервіс тієї сутності). Створюємо в пакеті service TelegramUserService, в якому поки що буде кілька методів: зберегти користувача, отримати користувача за його ID та відобразити список активних користувачів. Спершу створюємо інтерфейс TelegramUserService: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>

<span class="token comment">/**
* {@link Service} for handling {@link TelegramUser} entity.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TelegramUserService</span> <span class="token punctuation">{</span>

   <span class="token comment">/**
    * Save provided {@link TelegramUser} entity.
    *
    * @param  telegramUser provided telegram user.
    */</span>
   <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">TelegramUser</span> telegramUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * Retrieve all active {@link TelegramUser}.
    *
    * @return the collection of the active {@link TelegramUser} objects.
    */</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">retrieveAllActiveUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * Find {@link TelegramUser} by chatId.
    *
    * @param chatId provided Chat ID
    * @return {@link TelegramUser} with provided chat ID or null otherwise.
    */</span>
   <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByChatId</span><span class="token punctuation">(</span><span class="token class-name">String</span> chatId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> І, власне, реалізація TelegramUserServiceImpl: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">TelegramUserRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Implementation of {@link TelegramUserService}.
*/</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TelegramUserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TelegramUserService</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TelegramUserRepository</span> telegramUserRepository<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">public</span> <span class="token class-name">TelegramUserServiceImpl</span><span class="token punctuation">(</span><span class="token class-name">TelegramUserRepository</span> telegramUserRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>telegramUserRepository <span class="token operator">=</span> telegramUserRepository<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">TelegramUser</span> telegramUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       telegramUserRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">retrieveAllActiveUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> telegramUserRepository<span class="token punctuation">.</span><span class="token function">findAllByActiveTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByChatId</span><span class="token punctuation">(</span><span class="token class-name">String</span> chatId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> telegramUserRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Тут слід зазначити, що ми використовуємо dependency injection (вводимо екземпляр класу) об'єкта TelegramuserRepository за допомогою інструкції <span class="text-bold">Autowired</span> , причому на конструкторі. Можна робити це і для змінної, але саме цей підхід рекомендує нам команда Spring Framework.
<h2>Додаємо статистику для бот</h2>Далі потрібно оновити команди /start та /stop. Коли використовується команда /start, потрібно зберегти в базі даних нового користувача і поставити йому active = true. А коли буде / stop, оновити дані користувача: встановити active = false. Поправимо клас <span class="code">StartCommand</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TelegramUserService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Update</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Start {@link Command}.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StartCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> START_MESSAGE <span class="token operator">=</span> <span class="token string">"Привет. Я Javarush Telegram Bot. Я помогу тебе быть в курсе последних "</span> <span class="token operator">+</span>
           <span class="token string">"статей тех авторов, котрые тебе интересны. Я еще маленький и только учусь."</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">StartCommand</span><span class="token punctuation">(</span><span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">,</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sendBotMessageService <span class="token operator">=</span> sendBotMessageService<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>telegramUserService <span class="token operator">=</span> telegramUserService<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> chatId <span class="token operator">=</span> update<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       telegramUserService<span class="token punctuation">.</span><span class="token function">findByChatId</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresentOrElse</span><span class="token punctuation">(</span>
               user <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                   user<span class="token punctuation">.</span><span class="token function">setActive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   telegramUserService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span><span class="token punctuation">,</span>
               <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                   <span class="token class-name">TelegramUser</span> telegramUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   telegramUser<span class="token punctuation">.</span><span class="token function">setActive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   telegramUser<span class="token punctuation">.</span><span class="token function">setChatId</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   telegramUserService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       sendBotMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> START_MESSAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Тут ми передаємо в конструктор ще й об'єкт TelegramuserService, за допомогою якого зберігатимемо нового користувача. Далі, використовуючи принади Optional у джаві, працює наступна логіка: якщо користувач у базі у нас є, просто робимо його активним, якщо ні – створюємо нового активного. StopCommand: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TelegramUserService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Update</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Stop {@link Command}.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StopCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> STOP_MESSAGE <span class="token operator">=</span> <span class="token string">"Деактивировал все ваши подписки \uD83D\uDE1F."</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">StopCommand</span><span class="token punctuation">(</span><span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">,</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sendBotMessageService <span class="token operator">=</span> sendBotMessageService<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>telegramUserService <span class="token operator">=</span> telegramUserService<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       sendBotMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP_MESSAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
       telegramUserService<span class="token punctuation">.</span><span class="token function">findByChatId</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                   it<span class="token punctuation">.</span><span class="token function">setActive</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   telegramUserService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> У StopCommand так само передаємо TelegramServiceTest. Додаткова логіка така: якщо ми маємо користувач з таким chat ID, ми його деактивуємо, тобто ставимо active = false. Як це побачити на власні очі? Зробимо нову команду /stat, яка відображатиме статистику бота. На цьому етапі це буде проста статистика, доступна всім користувачам. Надалі ми її обмежимо та зробимо доступ лише для адміністраторів. У статистиці буде один запис: кількість активних користувачів робота. Для цього додаємо значення <span class="code">STAT("/stat")</span> у CommandName. Далі створюємо <span class="code">StatCommand</span> клас: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TelegramUserService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Update</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Statistics {@link Command}.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> STAT_MESSAGE <span class="token operator">=</span> <span class="token string">"Javarush Telegram Bot использует %s человек."</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">public</span> <span class="token class-name">StatCommand</span><span class="token punctuation">(</span><span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">,</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sendBotMessageService <span class="token operator">=</span> sendBotMessageService<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>telegramUserService <span class="token operator">=</span> telegramUserService<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">int</span> activeUserCount <span class="token operator">=</span> telegramUserService<span class="token punctuation">.</span><span class="token function">retrieveAllActiveUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       sendBotMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>STAT_MESSAGE<span class="token punctuation">,</span> activeUserCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Тут все просто: ми отримуємо список всіх активних користувачів за допомогою методу <span class="code">retrieveAllActiveUsers</span> і отримуємо розмір колекції. Також тепер потрібно оновити класи по висхідній: <span class="code">CommandContainer</span> і <span class="code">Javarush TelegramBot</span> , щоб вони навчабося передавати потрібний нам новий сервіс. CommandContainer: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TelegramUserService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span></span><span class="token class-name">ImmutableMap</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">CommandName</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token comment">/**
* Container of the {@link Command}s, which are using for handling telegram commands.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommandContainer</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ImmutableMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Command</span><span class="token punctuation">&gt;</span></span> commandMap<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Command</span> unknownCommand<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">CommandContainer</span><span class="token punctuation">(</span><span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">,</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">)</span> <span class="token punctuation">{</span>

       commandMap <span class="token operator">=</span> <span class="token class-name">ImmutableMap</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Command</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>START<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StartCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>STOP<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StopCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>HELP<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HelpCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>NO<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NoCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>STAT<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StatCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       unknownCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnknownCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">Command</span> <span class="token function">retrieveCommand</span><span class="token punctuation">(</span><span class="token class-name">String</span> commandIdentifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> commandMap<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>commandIdentifier<span class="token punctuation">,</span> unknownCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre> Тут ми додали до карти нову команду та передали через конструктор TelegramUserService. А ось у самому роботі зміниться тільки конструктор: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">public</span> <span class="token class-name">JavarushTelegramBot</span><span class="token punctuation">(</span><span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>commandContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandContainer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SendBotMessageServiceImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Тепер ми передаємо у вигляді аргументу TelegramUserService, додаючи інструкцію Autowired. Це означає, що ми її отримаємо з Application Context. Також оновимо клас <span class="code">HelpCommand</span> , щоб у описі з'явилася ще й нова команда статистики.
<h2>Мануальне тестування</h2>Запустимо базу даних з docker-compose-test.yml та main метод у класі JavarushTelegramBotApplication. Далі пишемо набір команд:
<ul>
 <li>/stat - очікуємо, що з порожній базі даних людина, використовують цей бот, буде нуль;</li>
 <li>/start - запускаємо бота;</li>
 <li>/stat - тепер очікуємо, що робота буде використовувати 1 людина;</li>
 <li>/ stop - зупиняємо робота;</li>
 <li>/stat - очікуємо, що знову буде 0 людей використовувати.</li>
</ul><img data-max-width="512" data-id="c1faafce-8511-43df-90f1-7fd96427622c" alt="&quot;Java-проект від А до Я&quot;: Додаємо все, що пов'язане з БД.  Частина 2 - 2" src="https://cdn.javarush.com/images/article/c1faafce-8511-43df-90f1-7fd96427622c/512.jpeg" style="width: 512px;">Якщо у вас в результаті буде так само, можна сказати, що функціонал відпрацював правильно і справний бот. Якщо щось піде не так - не біда: перезапускаємо main метод у режимі дебага і проходимо чітко по всьому шляху, щоб знайти, в чому була помилка.
<h2>Пишемо та оновлюємо тести</h2>Оскільки ми змінабо конструктори, потрібно буде оновити тестові класи. У класі <span class="code">AbstractCommandTest</span> нам потрібно додати ще одне поле - замокний клас <span class="code">TelegramUserService</span> , який потрібен для трьох команд: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token keyword">protected</span> <span class="token class-name">TelegramUserService</span> telegramUserService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">TelegramUserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Далі в CommandContainer оновимо метод <span class="code">init()</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@BeforeEach</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">SendBotMessageService</span> sendBotMessageService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">TelegramUserService</span> telegramUserService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">TelegramUserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   commandContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandContainer</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> У StartCommand потрібно оновити <span class="code">getCommand()</span> метод: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Override</span>
<span class="token class-name">Command</span> <span class="token function">getCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StartCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Також і в StopCommand: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Override</span>
<span class="token class-name">Command</span> <span class="token function">getCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StopCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Далі підемо новими тестами. Створюємо типовий тест для <span class="code">StatCommand</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">CommandName</span><span class="token punctuation">.</span>STAT<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">StatCommand</span><span class="token punctuation">.</span>STAT_MESSAGE<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatCommandTest</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCommandTest</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token class-name">String</span> <span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> STAT<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token class-name">String</span> <span class="token function">getCommandMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>STAT_MESSAGE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token class-name">Command</span> <span class="token function">getCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StatCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Це із простого. Тепер поговоримо про те, як ми тестуватимемо роботу з базою даних. Все, що ми робабо раніше, це були юніт-тести. <em>В інтеграційному тесті перевіряється інтеграція між кількома частинами програми. Наприклад, програми та бази даних. </em> Тут все буде складніше, тому що для тестування нам потрібна база даних. Тому коли ми локально проганятимемо наші тести, у нас має бути запущена база даних з docker-compose-test.yml. Щоб прогнати цей тест, потрібно запустити все SpringBoot додаток. Для тестового класу є інструкція <span class="text-bold">SpringBootTest</span>, яка запустить програму. Але цей підхід нам не підійде, тому що при запуску програми запускатиметься і телеграм-бот. Але тут є протиріччя. Тести запускатимуться як локально у нас на машині, так і публічно, через GitHub Actions. Щоб тести пройшли із запуском усієї програми, ми повинні їх запускати з валідними даними по телеграм-боту: тобто, за його ім'ям та токеном… Тому у нас два варіанти:
<ol>
 <li>Таки зробити публічними ім'я та токен бота і сподіватися, що все буде добре, ніхто його не буде використовувати та заважати нам.</li>
 <li>Вигадати інший шлях.</li>
</ol>Я вибрав другий варіант. У тестуванні SpringBoot є інструкція <span class="text-bold">DataJpaTest</span> , яка створена, щоб при тестуванні бази даних ми використовували тільки потрібні нам класи і не чіпали інші. Але нам це підходить, тому що телеграм-бот зовсім не запускатиметься. Отже, не потрібно передавати йому валідне ім'я і токен!))) Отримаємо тест, в якому перевіримо, що методи, які Spring Data нам реалізує, працюють так, як ми очікуємо. Тут важливо зазначити, що ми за допомогою інструкції <span class="text-bold">@ActiveProfiles("test")</span>задаємо використання профілю test. А це нам і потрібно, щоб ми вважали правильні проперти для нашої бази даних. Добре мати підготовлену базу даних перед запуском наших тестів. Для цієї справи є такий підхід: додати до тесту анотація Sql та передати їй колекцію імен скриптів, які потрібно запустити перед початком тесту: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Sql</span><span class="token punctuation">(</span>scripts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"/sql/clearDbs.sql"</span><span class="token punctuation">,</span> <span class="token string">"/sql/telegram_users.sql"</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre> У нас вони лежатимуть на шляху ./src/test/resources/ + шлях, вказаний в анотації. Ось як вони виглядають: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">clearDbs<span class="token punctuation">.</span>sql<span class="token operator">:</span>
DELETE <span class="token class-name">FROM</span> tg_user<span class="token punctuation">;</span>

telegram_users<span class="token punctuation">.</span>sql<span class="token operator">:</span>
INSERT INTO tg_user VALUES <span class="token punctuation">(</span><span class="token string">"123456789"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO tg_user VALUES <span class="token punctuation">(</span><span class="token string">"123456788"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO tg_user VALUES <span class="token punctuation">(</span><span class="token string">"123456787"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO tg_user VALUES <span class="token punctuation">(</span><span class="token string">"123456786"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO tg_user VALUES <span class="token punctuation">(</span><span class="token string">"123456785"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO tg_user VALUES <span class="token punctuation">(</span><span class="token string">"123456784"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO tg_user VALUES <span class="token punctuation">(</span><span class="token string">"123456782"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO tg_user VALUES <span class="token punctuation">(</span><span class="token string">"123456781"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Ось як у результаті виглядатиме наш тест TelegramUserRepositoryIT (як бачите, і ім'я для інтеграційного тестування буде інше — додаємо не Test, а IT): 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Assertions</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">AutoConfigureTestDatabase</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span><span class="token class-name">DataJpaTest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ActiveProfiles</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">Sql</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">AutoConfigureTestDatabase<span class="token punctuation">.</span>Replace</span><span class="token punctuation">.</span>NONE<span class="token punctuation">;</span>

<span class="token comment">/**
* Integration-level testing for {@link TelegramUserRepository}.
*/</span>
<span class="token annotation punctuation">@ActiveProfiles</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DataJpaTest</span>
<span class="token annotation punctuation">@AutoConfigureTestDatabase</span><span class="token punctuation">(</span>replace <span class="token operator">=</span> NONE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TelegramUserRepositoryIT</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">TelegramUserRepository</span> telegramUserRepository<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Sql</span><span class="token punctuation">(</span>scripts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"/sql/clearDbs.sql"</span><span class="token punctuation">,</span> <span class="token string">"/sql/telegram_users.sql"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldProperlyFindAllActiveUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//when</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> telegramUserRepository<span class="token punctuation">.</span><span class="token function">findAllByActiveTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> users<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Sql</span><span class="token punctuation">(</span>scripts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"/sql/clearDbs.sql"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldProperlySaveTelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//given</span>
       <span class="token class-name">TelegramUser</span> telegramUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       telegramUser<span class="token punctuation">.</span><span class="token function">setChatId</span><span class="token punctuation">(</span><span class="token string">"1234567890"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       telegramUser<span class="token punctuation">.</span><span class="token function">setActive</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       telegramUserRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//when</span>
       <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> saved <span class="token operator">=</span> telegramUserRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>saved<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">,</span> saved<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Тести написали, але постає питання: а що буде із запуском нашого CI процесу на GitHub? Він же не матиме бази даних. На даний момент справді буде просто червоний білд. Для цього ми маємо GitHub actions, в якому ми можемо налаштувати запуск нашого білда. До запуску тестів потрібно додати запуск бази даних із потрібними налаштуваннями. Як виявилося, на просторах інтернету не так багато прикладів, тому раджу зберегти собі десь це. Оновимо файл .github/workflows/maven.yml: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"># <span class="token class-name">This</span> workflow will build a <span class="token class-name">Java</span> project <span class="token keyword">with</span> <span class="token class-name">Maven</span>
# <span class="token class-name">For</span> more information see<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>help<span class="token punctuation">.</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>actions<span class="token operator">/</span>language<span class="token operator">-</span>and<span class="token operator">-</span>framework<span class="token operator">-</span>guides<span class="token operator">/</span>building<span class="token operator">-</span>and<span class="token operator">-</span>testing<span class="token operator">-</span>java<span class="token operator">-</span><span class="token keyword">with</span><span class="token operator">-</span>maven

name<span class="token operator">:</span> <span class="token class-name">Java</span> CI <span class="token keyword">with</span> <span class="token class-name">Maven</span>

on<span class="token operator">:</span>
 push<span class="token operator">:</span>
   branches<span class="token operator">:</span> <span class="token punctuation">[</span> main <span class="token punctuation">]</span>
 pull_request<span class="token operator">:</span>
   branches<span class="token operator">:</span> <span class="token punctuation">[</span> main <span class="token punctuation">]</span>

jobs<span class="token operator">:</span>
 build<span class="token operator">:</span>
   runs<span class="token operator">-</span>on<span class="token operator">:</span> ubuntu<span class="token operator">-</span>latest
   steps<span class="token operator">:</span>
   <span class="token operator">-</span> <span class="token keyword">uses</span><span class="token operator">:</span> actions<span class="token operator">/</span>checkout<span class="token annotation punctuation">@v2</span>
   <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token class-name">Set</span> up <span class="token class-name">MySQL</span>
     <span class="token keyword">uses</span><span class="token operator">:</span> mirromutth<span class="token operator">/</span>mysql<span class="token operator">-</span>action<span class="token annotation punctuation">@v1.1</span>
     <span class="token keyword">with</span><span class="token operator">:</span>
       mysql version<span class="token operator">:</span> <span class="token string">'5.7'</span>
       mysql database<span class="token operator">:</span> <span class="token string">'dev_jrtb_db'</span>
       mysql root password<span class="token operator">:</span> <span class="token string">'root'</span>
       mysql user<span class="token operator">:</span> <span class="token string">'dev_jrtb_db_user'</span>
       mysql password<span class="token operator">:</span> <span class="token string">'dev_jrtb_db_password'</span>
   <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token class-name">Set</span> up JDK <span class="token number">1.11</span>
     <span class="token keyword">uses</span><span class="token operator">:</span> actions<span class="token operator">/</span>setup<span class="token operator">-</span>java<span class="token annotation punctuation">@v1</span>
     <span class="token keyword">with</span><span class="token operator">:</span>
       java<span class="token operator">-</span>version<span class="token operator">:</span> <span class="token number">1.11</span>
   <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token class-name">Build</span> <span class="token keyword">with</span> <span class="token class-name">Maven</span>
     run<span class="token operator">:</span> mvn <span class="token operator">-</span><span class="token class-name">B</span> <span class="token keyword">package</span> <span class="token operator">--</span>file pom<span class="token punctuation">.</span>xml</code></pre> Тепер тут є новий блок <span class="text-bold">Set up MySQL</span> . У ньому додаємо MySQL до нашого CI процесу, принагідно визначаючи потрібні для нас змінні. Тепер уже все, що хотіли ми додали. Останній етап – запушити зміни та подивитися, що білд пройде і буде зелений.
<h2>Оновлюємо документацію</h2>Оновимо версію проекту з 0.3.0-SNAPSHOT на 0.4.0-SNAPSHOT в pom.xml і додамо в RELEASE_NOTES також: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java">## <span class="token number">0.4</span><span class="token number">.0</span><span class="token operator">-</span>SNAPSHOT

<span class="token operator">*</span>   JRTB<span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span> added repository layer<span class="token punctuation">.</span></code></pre> Після цього створюємо комміт, пуш і пулл-реквест. І найголовніше – наш білд зелений!<img data-max-width="800" data-id="c8a36ec1-7e1a-4d2e-9af9-ae0b7efd71eb" alt="&quot;Java-проект від А до Я&quot;: Додаємо все, що пов'язане з БД.  Частина 2 - 3" src="https://cdn.javarush.com/images/article/c8a36ec1-7e1a-4d2e-9af9-ae0b7efd71eb/800.jpeg" style="width: 800px;">
<h3>Корисні посилання:</h3>
<ul>
 <li><a href="https://github.com/codegymcommunity/codegym-telegrambot" rel="nofollow" target="_blank">Репозиторій нашого телеграм-бота</a></li>
 <li><a href="https://t.me/romankh3/36" rel="nofollow" target="_blank">Пулл-реквест</a> з усіма змінами, описаними у статті</li>
 <li><a href="https://codegym.cc/groups/posts/3157-java-proekt-ot-a-do-ja-springboot--flyway" target="_blank">SpringBoot + Flyway</a> стаття</li>
 <li><a href="https://hub.docker.com/_/mysql" rel="nofollow" target="_blank">MySQL образ</a> з DockerHub</li>
 <li>Medium: <a href="https://medium.com/@chrischuck35/how-to-create-a-mysql-instance-with-docker-compose-1598f3cc1bee" rel="nofollow" target="_blank">Як створити MySql Instance with Docker Compose</a></li>
 <li>Habr: <a href="https://habr.com/ru/post/435114/" rel="nofollow" target="_blank">Spring Data Jpa</a></li>
 <li><a href="https://t.me/romankh3" rel="nofollow" target="_blank">Мій телеграм-канал</a></li>
</ul>Усі зміни можна побачити ось тут у створеному <a href="https://github.com/codegymcommunity/codegym-telegrambot/pull/20" rel="nofollow" target="_blank">пулл-реквесті</a> . Дякую всім за прочитання.
<h4><a href="https://codegym.cc/groups/posts/2935-java-proekt-ot-a-do-ja-pishem-realjhnihy-proekt-dlja-portfolio#articles" target="_blank">Список всіх матеріалів серії на початку цієї статті.</a></h4>