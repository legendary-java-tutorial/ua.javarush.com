JPA: Знайомство з технологією
<p>----------------------------------------</p>
Сучасний світ розробки сповнений різних специфікацій, покликаних спростити життя. Знаючи інструменти, можна вибрати відповідний. Не знаючи, можна ускладнити собі життя. Цей огляд відкриє завісу таємниці над поняттям JPA - Java Persistence A
<p>----------------------------------------</p>
Сучасний світ розробки сповнений різних специфікацій, покликаних спростити життя. Знаючи інструменти, можна вибрати відповідний. Не знаючи, можна ускладнити собі життя. Цей огляд відкриє завісу таємниці над поняттям JPA - Java Persistence API. Сподіваюся, після прочитання захочеться поринути у цей таємничий світ ще глибше. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="9feb3ae0-27de-4c4c-bfc7-3904f37679d8" data-max-width="279" alt="JPA: Знайомство з технологією - 1" src="https://cdn.javarush.com/images/article/9feb3ae0-27de-4c4c-bfc7-3904f37679d8/256.jpeg" style="width: 279px;">
 </div>
</div>
<ul>
 <li><a href="https://codegym.cc/groups/posts/2259#%D0%92%D1%81%D1%82%D1%83%D0%BF%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5">Вступ</a></li>
 <li><a href="https://codegym.cc/groups/posts/2259#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0">Створення проекту</a></li>
 <li><a href="https://codegym.cc/groups/posts/2259#%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-JPA">Додавання JPA</a></li>
 <li><a href="https://codegym.cc/groups/posts/2259#%D0%A1%D1%83%D1%89%D0%BD%D0%BE%D1%81%D1%82%D0%B8-(Entities)">Сутності (Entities)</a></li>
 <li><a href="https://codegym.cc/groups/posts/2259#Mapping">Mapping</a></li>
 <li><a href="https://codegym.cc/groups/posts/2259#JPQL">JPQL</a></li>
 <li><a href="https://codegym.cc/groups/posts/2259#Criteria-API">Criteria API</a></li>
 <li><a href="https://codegym.cc/groups/posts/2259#%D0%97%D0%B0%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5">Висновок</a></li>
</ul>
<h2 id="Вступление">Вступ</h2>Як ми знаємо, одне з основних завдань програм - зберігання та обробка даних. У давні часи люди зберігали дані просто у файлух. Але як тільки потрібний одночасний доступ на читання та редагування, коли з'являється навантаження (тобто одночасно надходить кілька звернень), зберігання даних просто у файлух стає проблемою. Докладніше про те, які проблеми вирішують БД і яким чином, раджу прочитати у статті " <a href="https://habr.com/ru/company/oleg-bunin/blog/358984/" target="_blank" rel="nofollow">Як влаштовані бази даних</a> ". Отже, наші дані ми вирішуємо зберігати у базі даних. З давніх-давен Java вміє працювати з базами даних за допомогою JDBC API (The Java Database Connectivity). Детальніше про JDBC можна прочитати тут: <a href="https://codegym.cc/groups/posts/2172-jdbc-ili-s-chego-vsje-nachinaetsja" target="_blank" rel="nofollow">JDBC або з чого все починається</a>Але час йшов і розробники щоразу стикалися з необхідністю писати однотипний і непотрібний "обслуговуючий" код (так званий Boilerplate code) для тривіальних операцій зі збереження Java об'єктів у БД і навпаки, створення Java об'єктів за даними з БД. І тоді для вирішення цих проблем на світ з'явилося таке поняття, як ORM.ORM <strong>- Object-Relational Mapping або в перекладі на російську об'єктно-реляційне відображення.Це</strong> технологія програмування, яка пов'язує бази даних з концепціями об'єктно-орієнтованих мов програмування. Java об'єктів та записів у БД: <img data-id="4b8f2fcd-2c48-497e-96a6-bf2100f93425" data-max-width="850" alt="JPA : Знайомство з технологією - 2" src="https://cdn.javarush.com/images/article/4b8f2fcd-2c48-497e-96a6-bf2100f93425/800.jpeg" style="width: 850px;">ORM — це по суті концепція у тому, що Java об'єкт можна як дані у БД (і навпаки). Вона знайшла втілення у вигляді специфікації JPA Java Persistence API. Специфікація - це вже опис Java API, який виражає цю концепцію. Специфікація розповідає, якими засобами ми маємо бути забезпечені (тобто через які інтерфейси ми зможемо працювати), щоб працювати за концепцією ORM. І як використати ці кошти. Реалізацію коштів специфікація не визначає. Це дозволяє використовувати для однієї специфікації різні реалізації. Можна спростити і сказати, що специфікація - це опис API. Текст специфікації JPA можна знайти на сайті Oracle: <a href="http://download.oracle.com/otn-pub/jcp/persistence-2_2-mrel-spec/JavaPersistence.pdf" target="_blank" rel="nofollow">JSR 338: JavaTM Persistence API</a>Отже, щоб використовувати JPA нам потрібна деяка реалізацію, за допомогою якої ми будемо користуватися технологією. Реалізації JPA ще називають JPA Provider. Однією з найпомітніших реалізацій JPA є Hibernate. Тому, пропоную її і <a href="http://hibernate.org/" target="_blank" rel="nofollow">розглянути</a> . 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="7e8c8a8a-d026-4b3d-95f3-e6b3a80334fa" data-max-width="261" alt="JPA : Знайомство з технологією - 3" src="https://cdn.javarush.com/images/article/7e8c8a8a-d026-4b3d-95f3-e6b3a80334fa/256.jpeg" style="width: 261px;">
 </div>
</div>
<h2 id="створення-проекта">Створення проекту</h2>Оскільки JPA - це про Java, то нам знадобиться Java проект. Ми могли б самі створити вручну структуру каталогів, самі додати потрібні бібліотеки. Але куди зручніше і правильніше використовувати системи автоматизації складання проектів (тобто по суті це просто програма, яка за нас керуватиме складання проектів. Створювати каталоги, підкладати в classpath потрібні бібліотеки тощо). Однією з таких систем є Gradle. Детальніше про Gradle можна прочитати тут: " <a href="https://codegym.cc/groups/posts/2126-kratkoe-znakomstvo-s-gradle" target="_blank" rel="nofollow">Коротке знайомство з Gradle</a> ". Як відомо, функціональність Gradle (тобто дії, які може зробити) реалізовані з допомогою різних Gradle Plugins. Скористаємося Gradle та плагіном " <a href="https://docs.gradle.org/current/userguide/build_init_plugin.html" target="_blank" rel="nofollow">Gradle Build Init Plugin'ом</a> ". Виконаємо команду: 
<pre class="line-numbers language-none" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-none">
gradle init --type java-application</code></pre> Gradle за нас зробить потрібну структуру каталогів, створить базовий декларативний опис проекту в білд-скрипті <code class=" language-none">build.gradle</code>. Отже, у нас з'явився додаток. Нам треба подумати, що ми хочемо описувати чи моделювати нашим додатком. Давайте скористаємося якимось засобом моделювання, наприклад: <a href="https://app.quickdatabasediagrams.com/#/" target="_blank" rel="nofollow">app.quickdatabasediagrams.com</a> <img data-id="695f9085-8069-4007-888d-c2a98b21f1f6" data-max-width="850" alt="JPA : Знайомство з технологією - 4" src="https://cdn.javarush.com/images/article/695f9085-8069-4007-888d-c2a98b21f1f6/800.jpeg" style="width: 850px;">Тут варто сказати, що те, що ми описали нашу "доменну модель". Домен - це деяка "предметна область". Взагалі, домен - це "володіння" латиною. У середні віки так називалися області, якими володіли королі чи феодали. А у французькій мові це стало словом "domaine", яке перекладається просто як "область". Таким чином ми описали нашу "доменну модель" = "предметну модель". Кожен елемент цієї моделі - це деяка "сутність", щось із реального життя. У нашому випадку це є сутністю: Категорія ( <code class=" language-none">Category</code>), Тема ( <code class=" language-none">Topic</code>). Створимо для сутностей окремий пакет, наприклад, з ім'ям model. І додамо туди Java класи, що описують сутності. У Java коді такі сутності являють собою звичайний <a href="https://www.geeksforgeeks.org/pojo-vs-java-beans/" target="_blank" rel="nofollow">POJO</a> , 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Category</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Long</span></span> id<span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">String</span></span> title<span class="token punctuation"><span class="token punctuation">;</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">String</span></span> <span class="token function"><span class="token function">getTitle</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">return</span></span> title<span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">setTitle</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> title<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>title <span class="token operator"><span class="token operator">=</span></span> title<span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Скопіюємо вміст класу та зробимо за аналогією клас <code class=" language-none">Topic</code>. Відрізнятися він буде лише тим, що знає про категорію, до якої належить. Тому, додамо в клас <code class=" language-none">Topic</code>поле категорії та методи роботи з нею: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Category</span></span> category<span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Category</span></span> <span class="token function"><span class="token function">getCategory</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">return</span></span> category<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">setCategory</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Category</span></span> category<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>category <span class="token operator"><span class="token operator">=</span></span> category<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Тепер у нас є Java додаток, який має свою доменну модель. Настав час тепер приступати до підключення до проекту JPA. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-max-width="255" alt="JPA : Знайомство з технологією - 5" src="https://cdn.javarush.com/images/article/fa26f42c-9ac8-4728-b0d7-fdd283bbcc6d/original.jpeg">
 </div>
</div>
<h2 id="Добавление-JPA">Додавання JPA</h2>Отже, як ми пам'ятаємо, JPA — це про те, що ми зберігатимемо щось у БД. Отже, нам потрібна база даних. Щоб використовувати підключення до БД у своєму проекті, нам потрібно додати в залежності бібліотеку, для підключення до БД. Як ми пам'ятаємо, ми використали Gradle, який створив нам білд скрипт <code class=" language-none">build.gradle</code>. У ньому ми й опишемо залежності, які потрібні нашому проекту. Залежно — це бібліотеки, без яких не може працювати наш код. Почнемо з опису залежності від підключення до БД. Робимо це так само, як би робабо, працюючи просто з JDBC: 
<pre class="line-numbers language-none" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-none">
dependencies {
	implementation 'com.h2database:h2:1.4.199'</code></pre> Тепер ми маємо БД. Ми можемо тепер додати до нашої програми рівень або шар (layer), що відповідає за відображення наших Java об'єктів у поняття бази даних (з Java мови на мову SQL). Як ми пам'ятаємо, ми збираємося використати для цього реалізацію специфікації JPA під назвою Hibernate: 
<pre class="line-numbers language-none" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-none">
dependencies {
	implementation 'com.h2database:h2:1.4.199'
	implementation 'org.hibernate:hibernate-core:5.4.2.Final'</code></pre> Тепер нам потрібно налаштувати JPA. Якщо ми прочитаємо специфікацію та розділ "8.1 Persistence Unit", то ми дізнаємося, що Persistence Unit - це деяке об'єднання конфігурацій, метаданих і сутностей. І щоб JPA запрацював, потрібно описати хоча б один Persistence Unit у файлі конфігурації, який має назву <code class=" language-none">persistence.xml</code>. Його розташування описано у розділі специфікації "8.2 Persistence Unit Packaging". Відповідно до цього розділу, якщо у нас Java SE оточення, ми повинні покласти його в корінь каталогу META-INF. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="3560e674-fabb-4b2c-8a25-e9346a3b1368" data-max-width="333" alt="JPA : Знайомство з технологією - 6" src="https://cdn.javarush.com/images/article/3560e674-fabb-4b2c-8a25-e9346a3b1368/256.jpeg" style="width: 333px;">
 </div>
</div>Зміст скопіюємо з прикладу, наведеного у специфікації JPA у розділі " <code class=" language-none">8.2.1 persistence.xml file</code>": 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span>persistence<span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span>
	<span class="token operator"><span class="token operator">&lt;</span></span>persistence<span class="token operator"><span class="token operator">-</span></span>unit name<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"CodeGym"</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
        <span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span>description<span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Persistence</span></span> <span class="token class-name"><span class="token class-name">Unit</span></span> <span class="token class-name"><span class="token class-name">For</span></span> test<span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>description<span class="token operator"><span class="token operator">&gt;</span></span>
        <span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token namespace"></span><span class="token class-name"><span class="token namespace"><span class="token namespace">hibernate<span class="token punctuation"><span class="token punctuation">.</span></span>model<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>Category</span></span><span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
        <span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token namespace"></span><span class="token class-name"><span class="token namespace"><span class="token namespace">hibernate<span class="token punctuation"><span class="token punctuation">.</span></span>model<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>Topic</span></span><span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
    <span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>persistence<span class="token operator"><span class="token operator">-</span></span>unit<span class="token operator"><span class="token operator">&gt;</span></span>
<span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>persistence<span class="token operator"><span class="token operator">&gt;</span></span></code></pre> Але цього замало. Потрібно розповісти, хто наш JPA Provider, тобто. той, хто реалізує специфікацію JPA: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java"><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span>provider<span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token namespace"></span><span class="token class-name"><span class="token namespace"><span class="token namespace">org<span class="token punctuation"><span class="token punctuation">.</span></span>hibernate<span class="token punctuation"><span class="token punctuation">.</span></span>jpa<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>HibernatePersistenceProvider</span></span><span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>provider<span class="token operator"><span class="token operator">&gt;</span></span></code></pre> А тепер додамо налаштування ( <code class=" language-none">properties</code>). Частина (починаються на <code class=" language-none">javax.persistence</code>) є стандартними JPA конфігураціями і описані у специфікації JPA у розділі "8.2.1.9 properties". Частина конфігурацій є провайдер-специфічними (у нашому випадку, впливають на Hibernate як на Jpa Provider'а. Наш блок налаштувань виглядатиме так: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span>properties<span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span>
    <span class="token operator"><span class="token operator">&lt;</span></span>property name<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"javax.persistence.jdbc.driver"</span></span> value<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"org.h2.Driver"</span></span> <span class="token operator"><span class="token operator">/</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
    <span class="token operator"><span class="token operator">&lt;</span></span>property name<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"javax.persistence.jdbc.url"</span></span> value<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"jdbc:h2:mem:db1;DB_CLOSE_DELAY=-1;MVCC=TRUE"</span></span> <span class="token operator"><span class="token operator">/</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
    <span class="token operator"><span class="token operator">&lt;</span></span>property name<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"javax.persistence.jdbc.user"</span></span> value<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"sa"</span></span> <span class="token operator"><span class="token operator">/</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
    <span class="token operator"><span class="token operator">&lt;</span></span>property name<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"javax.persistence.jdbc.password"</span></span> value<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">""</span></span> <span class="token operator"><span class="token operator">/</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
    <span class="token operator"><span class="token operator">&lt;</span></span>property name<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"hibernate.show_sql"</span></span> value<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"true"</span></span> <span class="token operator"><span class="token operator">/</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
    <span class="token operator"><span class="token operator">&lt;</span></span>property name<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"hibernate.hbm2ddl.auto"</span></span> value<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"create"</span></span> <span class="token operator"><span class="token operator">/</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
<span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>properties<span class="token operator"><span class="token operator">&gt;</span></span></code></pre> Тепер у нас є JPA-сумісний конфіг <code class=" language-none">persistence.xml</code>, є JPA провайдер Hibernate і є база даних H2, а також є 2 класи, які є нашою доменною моделлю. Давайте змусимо це все відпрацювати. У каталозі <code class=" language-none">/test/java</code>наш Gradle люб'язно нам згенерував шаблон для Unit тестів та назвав його AppTest. Давайте використовуємо його. Як говорить глава "7.1 Persistence Contexts" специфікації JPA, сутності у світі JPA живуть у деякому просторі, яке називається "Контекст персистенції" (або Контексті сталості, Persistence Context). Але безпосередньо ми не працюємо з Persistence Context. Для цього ми використовуємо <code class=" language-none">Entity Manager</code>або менеджер сутностей. Саме він знає про контекст та про те, які там живуть сутності. Ми ж взаємодіємо з <code class=" language-none">Entity Manager</code>Том. Тоді залишається тільки зрозуміти,<code class=" language-none">Entity Manager</code>? Відповідно до розділу "7.2.2 Obtaining an Application-managed Entity Manager" специфікації JPA ми повинні використовувати <code class=" language-none">EntityManagerFactory</code>. Тому, озброїмося специфікацією JPA і візьмемо приклад з розділу "7.3.2. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@Test</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">shouldStartHibernate</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">EntityManagerFactory</span></span> emf <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Persistence</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">createEntityManagerFactory</span></span><span class="token punctuation"><span class="token punctuation">(</span></span> <span class="token string"><span class="token string">"CodeGym"</span></span> <span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">EntityManager</span></span> entityManager <span class="token operator"><span class="token operator">=</span></span> emf<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">createEntityManager</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Цей тест покаже помилку "Unrecognized JPA persistence.xml XSD version". Причина — <code class=" language-none">persistence.xml</code>потрібно правильно вказати використовувану схему, як це сказано в специфікації JPA в розділі "8.3 persistence.xml Schema": 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token operator"><span class="token operator">&lt;</span></span>persistence xmlns<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"http://xmlns.jcp.org/xml/ns/persistence"</span></span>
             xmlns<span class="token operator"><span class="token operator">:</span></span>xsi<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span></span>
             xsi<span class="token operator"><span class="token operator">:</span></span>schemaLocation<span class="token operator"><span class="token operator">=</span></span>"http<span class="token operator"><span class="token operator">:</span></span><span class="token operator"><span class="token operator">/</span></span><span class="token operator"><span class="token operator">/</span></span>xmlns<span class="token punctuation"><span class="token punctuation">.</span></span>jcp<span class="token punctuation"><span class="token punctuation">.</span></span>org<span class="token operator"><span class="token operator">/</span></span>xml<span class="token operator"><span class="token operator">/</span></span>ns<span class="token operator"><span class="token operator">/</span></span>persistence
             http<span class="token operator"><span class="token operator">:</span></span><span class="token operator"><span class="token operator">/</span></span><span class="token operator"><span class="token operator">/</span></span>xmlns<span class="token punctuation"><span class="token punctuation">.</span></span>jcp<span class="token punctuation"><span class="token punctuation">.</span></span>org<span class="token operator"><span class="token operator">/</span></span>xml<span class="token operator"><span class="token operator">/</span></span>ns<span class="token operator"><span class="token operator">/</span></span>persistence<span class="token operator"><span class="token operator">/</span></span>persistence_2_2<span class="token punctuation"><span class="token punctuation">.</span></span>xsd"
             version<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"2.2"</span></span><span class="token operator"><span class="token operator">&gt;</span></span></code></pre> Крім того, важливим є порядок елементів. Тому <code class=" language-none">provider</code>повинен бути вказаний до перерахування класів. Після цього тест виконається успішно. Безпосереднє підключення JPA ми здійснабо. Перш ніж ми рухатимемося далі, подумаємо про інші тести. Кожен наш тест вимагатиме <code class=" language-none">EntityManager</code>. Давайте зробимо так, щоб у кожного тесту був свій <code class=" language-none">EntityManager</code>початок виконання. Крім того, ми хочемо, щоб БД щоразу була нова. Завдяки тому, що ми використовуємо <code class=" language-none">inmemory</code>варіант, достатньо закривати <code class=" language-none">EntityManagerFactory</code>. Створення <code class=" language-none">Factory</code>– дорога операція. Але для тестів це виправдано. JUnit дозволяє задати методи, які будуть виконуватися перед (Before) та після (After) виконанням кожного тесту: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">AppTest</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">EntityManager</span></span> em<span class="token punctuation"><span class="token punctuation">;</span></span>

    <span class="token annotation punctuation"><span class="token annotation punctuation">@Before</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">init</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">EntityManagerFactory</span></span> emf <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Persistence</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">createEntityManagerFactory</span></span><span class="token punctuation"><span class="token punctuation">(</span></span> <span class="token string"><span class="token string">"CodeGym"</span></span> <span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        em <span class="token operator"><span class="token operator">=</span></span> emf<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">createEntityManager</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token annotation punctuation"><span class="token annotation punctuation">@After</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getEntityManagerFactory</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Тепер, перед виконанням будь-якого тесту буде створено нову <code class=" language-none">EntityManagerFactory</code>, що спричинить створення нової БД, т.к. <code class=" language-none">hibernate.hbm2ddl.auto</code>має значення <code class=" language-none">create</code>. А з нової фабрики отримаємо новий <code class=" language-none">EntityManager</code>. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="7887bb89-5b23-40b3-924f-6a47fc7c67c2" data-max-width="306" alt="JPA : Знайомство з технологією - 7" src="https://cdn.javarush.com/images/article/7887bb89-5b23-40b3-924f-6a47fc7c67c2/256.jpeg" style="width: 306px;">
 </div>
</div>
<h2 id="Сущности-(Entities)">Сутності (Entities)</h2>Ми пам'ятаємо, ми створабо раніше класи, що описують нашу доменну модель. Ми вже говорабо, що це наші "сутності". Це і є Entity, якими ми керуватимемо за допомогою <code class=" language-none">EntityManager</code>. Напишемо простий тест щодо збереження сутності категорії: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@Test</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">shouldPersistCategory</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Category</span></span> cat <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Category</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	cat<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">setTitle</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"new category"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token comment"><span class="token comment">// JUnit обеспечит тест свежим EntityManager'ом</span></span>
	em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">persist</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>cat<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Але це тест не запрацює, т.к. ми отримаємо різні помилки, які нам допоможуть зрозуміти, що таке сутності: 
<ul>
 <li>
  <p><code class=" language-none">Unknown entity: hibernate.model.Category</code><br>
    Чому ж Hibernate не розуміє, що <code class=" language-none">Category</code>це <code class=" language-none">entity</code>? Справа в тому, що сутності повинні бути описані за стандартом JPA. <br>
    Класи сутностей повинні бути анотовані анотацією <code class=" language-none">@Entity</code>, як сказано у розділі "2.1 The Entity Class" специфікації JPA.</p></li>
 <li>
  <p><code class=" language-none">No identifier specified for entity: hibernate.model.Category</code><br>
    Для сутностей повинен бути вказаний унікальний ідентифікатор, яким можна відрізнити один запис від іншого. <br>
    Відповідно до глави "2.4 Primary Keys and Entity Identity" специфікації JPA "Every entity must have a primary key", тобто. кожна сутність повинна мати "первинний ключ". Такий первинний ключ має бути вказаний анотацією<code class=" language-none">@Id</code></p></li>
 <li>
  <p><code class=" language-none">ids for this class must be manually assigned before calling save()</code><br>
    Ідентифікатор повинен з'явитися звідкись. Його можна вказати вручну, а можна отримати автоматично. <br>
    Тому, як і зазначено в розділах "11.2.3.3 GeneratedValue" та "11.1.20 GeneratedValue Annotation", ми можемо вказати інструкцію <code class=" language-none">@GeneratedValue</code>.</p></li>
</ul>Таким чином, щоб клас категорії став сутністю, ми повинні виконати наступні зміни: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@Entity</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Category</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token annotation punctuation"><span class="token annotation punctuation">@Id</span></span>
    <span class="token annotation punctuation"><span class="token annotation punctuation">@GeneratedValue</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Long</span></span> id<span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Крім того, інструкція <code class=" language-none">@Id</code>вказує на те, який використовувати <code class=" language-none">Access Type</code>. Докладніше про тип доступу можна прочитати у специфікації JPA, у розділі "2.3 Access Type". Якщо дуже стисло, то т.к. ми вказали <code class=" language-none">@Id</code>над полем ( <code class=" language-none">field</code>), тип доступу буде за замовчуванням <code class=" language-none">field-based</code>, а не <code class=" language-none">property-based</code>. Отже, провайдер JPA читатиме і зберігатиме значення безпосередньо з полів. Якби помістабо <code class=" language-none">@Id</code>над геттером, то використовувався б <code class=" language-none">property-based</code>доступ, тобто. через геттер та сетер. При виконанні тесту ми бачимо навіть те, які запити надсилаються до бази (завдяки опції <code class=" language-none">hibernate.show_sql</code>). Але при збереженні ми не бачимо жодних <code class=" language-none">insert</code>'ів. Виходить, що ми насправді нічого не зберегли? JPA дозволяє синхронізувати контекст персистенції та БД за допомогою методу <code class=" language-none">flush</code>: 
<pre class="inline-block  language-java" tabindex="0"><code class="  language-java">entityManager<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">flush</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Але якщо ми його виконаємо, то отримаємо помилку: <em>no transaction is in progress</em> . І тут настає час дізнатися про те, як JPA використовує транзакції. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="eace2b76-9155-45c2-a579-7a50141de44c" data-max-width="289" alt="JPA : Знайомство з технологією - 8" src="https://cdn.javarush.com/images/article/eace2b76-9155-45c2-a579-7a50141de44c/256.jpeg" style="width: 289px;">
 </div>
</div>
<h2>JPA Transactions</h2>Як ми пам'ятаємо, в основі JPA лежить поняття контексту персистенції (Persistence Context). Це місце, де мешкають сутності. А ми керуємо сутностями через <code class=" language-none">EntityManager</code>. Коли ми виконуємо команду <code class=" language-none">persist</code>, то поміщаємо сутність у контекст. Точніше, ми говоримо <code class=" language-none">EntityManager</code>, що це потрібно зробити. Але контекст цей — це просто певна сфера зберігання. Його навіть іноді називають "кешем першого рівня". Але його потрібно з'єднати із базою даних. Команда <code class=" language-none">flush</code>, яка раніше у нас впала з помилкою, синхронізує дані з контексту персистенції з БД. Але для цього потрібний транспорт і цим транспортом є транзакція. Транзакції JPA описані в розділі специфікації "7.5 Controlling Transactions". Для використання транзакцій у JPA є спеціальний API: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java">entityManager<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getTransaction</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">begin</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
entityManager<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getTransaction</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">commit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Необхідно додати керування транзакціями до нашого коду, який виконується до тестів і після: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@Before</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">init</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">EntityManagerFactory</span></span> emf <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Persistence</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">createEntityManagerFactory</span></span><span class="token punctuation"><span class="token punctuation">(</span></span> <span class="token string"><span class="token string">"CodeGym"</span></span> <span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	em <span class="token operator"><span class="token operator">=</span></span> emf<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">createEntityManager</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getTransaction</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">begin</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token annotation punctuation"><span class="token annotation punctuation">@After</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getTransaction</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">isActive</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getTransaction</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">commit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
	em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getEntityManagerFactory</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Після додавання ми побачимо в лозі insert вираз на мові SQL, яких раніше не було: 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="d2bc6bda-19a5-440e-b160-06cc43859a6f" data-max-width="426" alt="JPA : Знайомство з технологією - 9" src="https://cdn.javarush.com/images/article/d2bc6bda-19a5-440e-b160-06cc43859a6f/256.jpeg" style="width: 426px;">
 </div>
</div>Зміни, накопичені <code class=" language-none">EntityManager</code>за допомогою транзакції були закоммічені (підтверджені та збережені) в БД. Спробуймо тепер знайти нашу сутність. Створимо тест на пошук сутності за її ID: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@Test</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">shouldFindCategory</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Category</span></span> cat <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Category</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	cat<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">setTitle</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"test"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">persist</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>cat<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Category</span></span> result <span class="token operator"><span class="token operator">=</span></span> em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">find</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Category</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token number"><span class="token number">1L</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token function"><span class="token function">assertNotNull</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>result<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> У цьому випадку ми отримаємо раніше збережену сутність, але в лозі ми не побачимо SELECT запитів. А все по тому, що ми говоримо: "Менеджер сутностей, будь ласка, знайди мені сутність Категорія з ID=1". А менеджер сутностей спочатку дивиться у себе в контексті (використовує його свого роду кеш), і тільки якщо не знаходить, йде шукати в БД. Варто змінити ID на 2 (такого ні, ми зберегли лише 1 екземпляр), як побачимо, що <code class=" language-none">SELECT</code>запит з'являється. Тому що в контексті не знайдено сутності і <code class=" language-none">EntityManager</code>намагається знайти сутність БД. Існують різні команди, якими ми можемо керувати станом сутності в контексті. Перехід сутності з одного стану до іншого називається життєвим циклом сутності — <code class=" language-none">lifecycle</code>. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-max-width="181" alt="JPA : Знайомство з технологією - 10" src="https://cdn.javarush.com/images/article/b86aabbf-c2d7-4b4a-be74-69849ce0b331/original.jpeg">
 </div>
</div>
<h2>Entity Lifecycle</h2>Життєвий цикл сутностей описаний у специфікації JPA у розділі "3.2 Entity Instance's Life Cycle". Т.к. сутності живуть у тих і ними управляє <code class=" language-none">EntityManager</code>, то кажуть, що сутності керовані, тобто. managed. Давайте подивимося на етапи життя сутності: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token comment"><span class="token comment">// 1. New або Transient (временный)</span></span>
<span class="token class-name"><span class="token class-name">Category</span></span> cat <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Category</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
cat<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">setTitle</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"new category"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token comment"><span class="token comment">// 2. Managed або Persistent</span></span>
entityManager<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">persist</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>cat<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token comment"><span class="token comment">// 3. Транзакция завершена, все сущности в контексте detached</span></span>
entityManager<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getTransaction</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">begin</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
entityManager<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getTransaction</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">commit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token comment"><span class="token comment">// 4. Сущность изымаем из контекста, она становится detached</span></span>
entityManager<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">detach</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>cat<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token comment"><span class="token comment">// 5. Сущность из detached можно снова сделать managed</span></span>
<span class="token class-name"><span class="token class-name">Category</span></span> managed <span class="token operator"><span class="token operator">=</span></span> entityManager<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">merge</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>cat<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token comment"><span class="token comment">// 6. И можно сделать Removed. Интересно, что cat всё равно detached</span></span>
entityManager<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">remove</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>managed<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> І ось для закріплення схема: 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="9fbfeb41-128b-4aba-bfd6-2a0cc0ed1315" data-max-width="623" alt="JPA : Знайомство з технологією - 11" src="https://cdn.javarush.com/images/article/9fbfeb41-128b-4aba-bfd6-2a0cc0ed1315/512.jpeg" style="width: 623px;">
 </div>
</div>
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-max-width="253" alt="JPA : Знайомство з технологією - 12" src="https://cdn.javarush.com/images/article/6e5ca9c6-4c4d-449c-83b6-177012590ed6/original.jpeg">
 </div>
</div>
<h2 id="Mapping">Mapping</h2>У JPA ми можемо описати відносини сутності між собою. Згадаймо, що ми вже розбирали стосунки сутностей між один одним, коли ми розбиралися з нашою доменною моделлю. Тоді ми використовували ресурс <a href="https://app.quickdatabasediagrams.com/#/" target="_blank" rel="nofollow">quickdatabasediagrams.com</a> : 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="09dbb7c0-a02e-4d77-8f54-008457c888f1" data-max-width="780" alt="JPA : Знайомство з технологією - 13" src="https://cdn.javarush.com/images/article/09dbb7c0-a02e-4d77-8f54-008457c888f1/512.jpeg" style="width: 780px;">
 </div>
</div>Встановлення зв'язків між сутностями називається мапінг або асоціюванням (Association Mappings). Види асоціацій, які можуть бути встановлені за допомогою JPA, представлені нижче: 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="4afb8b7e-a138-4fa3-902a-8be961395103" data-max-width="547" alt="JPA : Знайомство з технологією - 14" src="https://cdn.javarush.com/images/article/4afb8b7e-a138-4fa3-902a-8be961395103/512.jpeg" style="width: 547px;">
 </div>
</div>Давайте подивимося на суть <code class=" language-none">Topic</code>, яка описує тему. Що ми можемо сказати про ставлення <code class=" language-none">Topic</code>до <code class=" language-none">Category</code>? Багато <code class=" language-none">Topic</code>належатимуть до однієї категорії. Отже, нам потрібна асоціація <code class=" language-none">ManyToOne</code>. Виразимо цей зв'язок мовою JPA: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@ManyToOne</span></span>
<span class="token annotation punctuation"><span class="token annotation punctuation">@JoinColumn</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>name <span class="token operator"><span class="token operator">=</span></span> <span class="token string"><span class="token string">"category_id"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
<span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Category</span></span> category<span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Щоб запам'ятати, які анотації ставити можна запам'ятати, що остання частина відповідає за поле, над яким вказана анотація. <code class=" language-none">ToOne</code>- конкретний екземпляр. <code class=" language-none">ToMany</code>- Колекції. Зараз у нас зв'язок односторонній. Давайте зробимо з неї двосторонній зв'язок. Додамо у <code class=" language-none">Category</code>знання про всі <code class=" language-none">Topic</code>, які входять до цієї категорії. Закінчуватися повинен на <code class=" language-none">ToMany</code>тому, що у нас список <code class=" language-none">Topic</code>. Тобто ставлення "До багатьох" тем. Залишається питання - <code class=" language-none">OneToMany</code>або <code class=" language-none">ManyToMany</code>: 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="3d94a500-c55e-4a39-a423-c8fb7ed119b1" data-max-width="557" alt="JPA : Знайомство з технологією - 15" src="https://cdn.javarush.com/images/article/3d94a500-c55e-4a39-a423-c8fb7ed119b1/512.jpeg" style="width: 557px;">
 </div>
</div>На цю ж тему хорошу відповідь можна прочитати тут: " <a href="https://dev.to/mah3uz/explain-orm-onetomany-manytomany-relation-like-im-five-94i" target="_blank" rel="nofollow">Explain ORM oneToMany, manyToMany relation like I'm five</a> ". Якщо категорія має зв'язок з <code class=" language-none">ToMany</code>топіків, то кожен із цих топіків може мати тільки одну категорію, то буде <code class=" language-none">One</code>, а інакше <code class=" language-none">Many</code>. Таким чином, у <code class=" language-none">Category</code>список усіх тем буде виглядати так: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@OneToMany</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>cascade <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">CascadeType</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>ALL<span class="token punctuation"><span class="token punctuation">)</span></span>
<span class="token annotation punctuation"><span class="token annotation punctuation">@JoinColumn</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>name <span class="token operator"><span class="token operator">=</span></span> <span class="token string"><span class="token string">"topic_id"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
<span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Set</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Topic</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> topics <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">HashSet</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> І не забудемо по суті <code class=" language-none">Category</code>описати геттер для отримання списку всіх тем: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Set</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Topic</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> <span class="token function"><span class="token function">getTopics</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">return</span></span> <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>topics<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Двонаправлені стосунки — дуже складний для автоматичного відстеження момент. Тому JPA перекладає цей обов'язок на розробника. Для нас це означає, що коли ми встановлюємо по суті <code class=" language-none">Topic</code>зв'язок з <code class=" language-none">Category</code>, ми повинні забезпечити несуперечність даних самостійно. Робиться це просто: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">setCategory</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Category</span></span> category<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	category<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getTopics</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">add</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>category <span class="token operator"><span class="token operator">=</span></span> category<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Напишемо для перевірки простий тест: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@Test</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">shouldPersistCategoryAndTopics</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Category</span></span> cat <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Category</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	cat<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">setTitle</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"test"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Topic</span></span> topic <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Topic</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	topic<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">setTitle</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"topic"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	topic<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">setCategory</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>cat<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
 	em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">persist</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>cat<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Мапінг це ціла окрема тема. У рамках даного огляду слід зрозуміти, за допомогою яких засобів це досягається. Докладніше про мапінг можна прочитати тут: 
<ul>
 <li>" <a href="https://thoughts-on-java.org/ultimate-guide-association-mappings-jpa-hibernate/" target="_blank" rel="nofollow">Ultimate Guide - Association Mappings with JPA and Hibernate</a> ".</li>
 <li>" <a href="https://easyjava.ru/data/jpa/jpa-i-svyazi-mezhdu-obektami/" target="_blank" rel="nofollow">JPA та зв'язки між об'єктами</a> "</li>
 <li>" <a href="http://java-online.ru/hibernate-entities.xhtml" target="_blank" rel="nofollow">Пов'язані сутності в Hibernate</a> "</li>
</ul>
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="f29f552b-e340-43c1-92a8-97c72fd746dd" data-max-width="264" alt="JPA : Знайомство з технологією - 16" src="https://cdn.javarush.com/images/article/f29f552b-e340-43c1-92a8-97c72fd746dd/256.jpeg" style="width: 264px;">
 </div>
</div>
<h2 id="JPQL">JPQL</h2>JPA вводить цікавий інструмент – запити мовою Java Persistence Query Language. Ця мова схожа на SQL, але використовує об'єктну модель Java, а не SQL таблиці. Розглянемо приклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@Test</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">shouldPerformQuery</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Category</span></span> cat <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Category</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	cat<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">setTitle</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"query"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">persist</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>cat<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Query</span></span> query <span class="token operator"><span class="token operator">=</span></span> em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">createQuery</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"SELECT c from Category c WHERE c.title = 'query'"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
 	<span class="token function"><span class="token function">assertNotNull</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>query<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getSingleResult</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як бачимо, у запиті ми використовували вказівку на сутність <code class=" language-none">Category</code>, а чи не таблицю. А також на полі цієї сутності <code class=" language-none">title</code>. JPQL надає безліч корисних можливостей та претендує на окрему статтю. Детальніше можна ознайомитись у огляді: 
<ul>
 <li>" <a href="https://thoughts-on-java.org/jpql/" target="_blank" rel="nofollow">Ultimate Guide to JPQL Queries with JPA and Hibernate</a> "</li>
</ul>
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-max-width="219" alt="JPA : Знайомство з технологією - 17" src="https://cdn.javarush.com/images/article/eb27dd97-f714-4613-80b3-de46af969c7d/original.jpeg">
 </div>
</div>
<h2 id="Criteria-API">Criteria API</h2>І насамкінець хотілося б торкнутися Criteria API. JPA вводить інструмент динамічної побудови запитів. Приклад використання Criteria API: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@Test</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">shouldFindWithCriteriaAPI</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Category</span></span> cat <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Category</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">persist</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>cat<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">CriteriaBuilder</span></span> cb <span class="token operator"><span class="token operator">=</span></span> em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getCriteriaBuilder</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">CriteriaQuery</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Category</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> query <span class="token operator"><span class="token operator">=</span></span> cb<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">createQuery</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Category</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">Root</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Category</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> c <span class="token operator"><span class="token operator">=</span></span> query<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">from</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Category</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	query<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">select</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>c<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">List</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Category</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> resultList <span class="token operator"><span class="token operator">=</span></span> em<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">createQuery</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>query<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getResultList</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token function"><span class="token function">assertEquals</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> resultList<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">size</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Цей приклад дорівнює виконанню запиту " <code class=" language-none">SELECT c FROM Category c</code>". <strong>Criteria API</strong> – потужний інструмент. Докладніше про нього можна прочитати тут: 
<ul>
 <li><a href="https://www.objectdb.com/java/jpa/query/criteria" target="_blank" rel="nofollow">JPA Criteria API Queries</a></li>
 <li><a href="https://easyjava.ru/data/jpa/jpa-criteria/" target="_blank" rel="nofollow">JPA Criteria</a></li>
 <li><a href="https://www.ibm.com/developerworks/ru/library/j-typesafejpa/index.html" target="_blank" rel="nofollow">Динамічні типобезпечні запити в JPA 2.0</a></li>
</ul>
<div class="email-subscription">
 <iframe frameborder="0" src="https://secure.esputnik.com.ua/4Q0Ef6d2SOs" width="100%" height="200" scrolling="no" data-savepage-key="0-2"></iframe>
</div>
<h2 id="Заключение">Висновок</h2>Як ми бачимо, JPA надає величезну кількість можливостей та інструментів. Кожен із них потребує досвіду та знань. Навіть у рамках огляду JPA вийшло згадати не все, не кажучи вже про детальне занурення. Але сподіваюся, що після прочитання стало зрозуміліше, що взагалі таке ORM і JPA, як це працює і що з цим можна зробити. Ну і на закуску пропоную різні матеріали: 
<ul>
 <li><a href="https://www.youtube.com/watch?v=r8SlsJjmm8o&amp;list=PLCA5CB42F5A816A17&amp;index=5" target="_blank" rel="nofollow">JPA - Вступ</a></li>
 <li><a href="https://www.youtube.com/watch?v=uVLujq7_35E&amp;list=PL50BZOuKafAYFT_F4Yris5Vj2ApwzUfmR" target="_blank" rel="nofollow">Thoughts On Java - Hibernate Beginner</a></li>
 <li><a href="https://www.youtube.com/watch?v=4deURytlQLI&amp;list=PL50BZOuKafAbXxVJiD9csunZfQOJ5X7hP" target="_blank" rel="nofollow">Thoughts On Java - Hibernate Tips</a></li>
 <li><a href="https://www.objectdb.com/java/jpa/persistence/advanced" target="_blank" rel="nofollow">Advanced JPA Topics</a></li>
</ul>#Viacheslav