Spring - це не страшно, або як зрозуміти, що конкретно мала на увазі БД
<p>----------------------------------------</p>
До БД, як до справжньої жінки, потрібен свій підхід: мало того, що питати її необхідно по-своєму, то ще й над відповідями доведеться подумати. В одній з попередніх ви як практика продавали проектик про книги. Ось його й візьмемо за основу. 
<p>----------------------------------------</p>
<a href="https://codegym.cc/groups/posts/3092-spring-ehto-nestrashno" target="_blank" rel="nofollow"><strong>ЗМІСТ ЦИКЛУ СТАТЕЙ</strong></a> До БД, як до справжньої жінки, потрібен свій підхід: мало того, що питати її необхідно по-своєму, то ще й над відповідями доведеться подумати. В одній з попередніх<a href="https://codegym.cc/groups/posts/3099-spring-ehto-ne-strashno--ili-kak-zadatjh-vopros-bd" target="_blank" rel="nofollow"> статей</a> ви як практика продавали проектик про книги. Ось його й візьмемо за основу. Якщо ще не зробабо, то давайте реалізуємо скелет проекту якнайшвидше: git clone https: //FromJava@bitbucket.org/FromJava/book.git<a href="https://bitbucket.org/FromJava/book/src/master/" target="_blank" rel="nofollow"> https://bitbucket.org/FromJava/book/src/master/</a> подивіться його структуру, запустіть. Далі працюватимемо з ним. Пам'ятаєте цей запис із статті про запити до БД? 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">"select f.fruitName, p.providerName from  FruitEntity f left join ProviderEntity p on f.providerCode = p.id"</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">joinSting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Для бібліотеки зробимо те саме. Заходимо в <span>BookRepository</span> і пишемо: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>"select b<span class="token punctuation">.</span>nameBook<span class="token punctuation">,</span> a<span class="token punctuation">.</span>firstNameAuthor<span class="token punctuation">,</span> a<span class="token punctuation">.</span>lastNameAuthor<span class="token punctuation">,</span> b<span class="token punctuation">.</span>yearCreat
from  <span class="token class-name">AuthorEntity</span> a left join <span class="token class-name">BookEntity</span> b on a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>authorId"<span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">joinBookString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Реалізуємо метод у <span>BookService</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">joinBookSting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> bookRepository<span class="token punctuation">.</span><span class="token function">joinBookString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Використовуємо його в <span>InitialUtils</span> і виведемо в консоль: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\nТаблица книг и их авторов ,через строку"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> book<span class="token operator">:</span> bookService<span class="token punctuation">.</span><span class="token function">joinBookSting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Результат: 
<div class="terminal">
 Таблиця книг та їх авторів Горе від розуму,Олександр,Грибоєдов,1824 Війна і мир,Лев,Толстой,1863 Мцирі,Михайло,Лермонтов,1838 Євгеній Онєгін,Олександр,Пушкін,1833
</div> Думаю, багато хто з вас уже зрозумів, що рядок — це не найзручніший формат для роботи, і, напевно, багато хто вже намагався переробити запит, щоб отримати об'єкт. Давайте оголосимо в репозиторії книг <span>BookService</span> новий метод <span>joinBookObj()</span> з тим самим запитом, але замість <span>String</span> поставимо <span>Object[]</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>"select b<span class="token punctuation">.</span>nameBook<span class="token punctuation">,</span> a<span class="token punctuation">.</span>firstNameAutor<span class="token punctuation">,</span> a<span class="token punctuation">.</span>lastNameAutor<span class="token punctuation">,</span>
b<span class="token punctuation">.</span>yearCreat from  <span class="token class-name">AutorEntity</span> a left join <span class="token class-name">BookEntity</span> b on a<span class="token punctuation">.</span>id <span class="token operator">=</span> p<span class="token punctuation">.</span>autorId"<span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> joinBookObj <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Реалізуємо його в <span>BookService</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">joinBookObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> bookRepository<span class="token punctuation">.</span><span class="token function">joinBookObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> І використовуємо в <span>InitialUtils</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\nТаблица книг и их авторов, нечитаемый об'єкт"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Object</span> book<span class="token operator">:</span> bookService<span class="token punctuation">.</span><span class="token function">joinBookObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Ура, ми отримали об'єкт, тільки виведення в консоль цього запису зовсім не тішить. 
<div class="terminal">
 Таблиця книг та їх авторів, нечитаний об'єкт [Ljava.lang.Object; @ 48f2054d [Ljava.lang.Object; @ 4b3a01d8 [Ljava.lang.Object; @ 19fbc594 [Ljava.lang.Object;
</div> Та й не зрозуміло, як працювати з цими об'єктами далі. Настав час маппит і використовувати <a href="https://annimon.com/article/2778" target="_blank" rel="nofollow">StreamAPI</a> (спокій). Нагадаю, у нашому випадку мапінг – це конвертація одного об'єкта в інший. Один об'єкт вже є – це, наприклад, <span>[Ljava.lang.Object;@48f2054d6</span> , він є масивом об'єктів, з наступними елементами <span>Object[b.nameBook</span> , <span>a.firstNameAutor</span> , <span>a.lastNameAutor</span> , <span>b.yearCreat]</span> . А інший об'єкт із полями аналогічними елементам масиву ми зробимо самі. У пакеті <span>entities</span> створимо клас <span>BookValueEntity</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">ru<span class="token punctuation">.</span>java<span class="token punctuation">.</span>rush<span class="token punctuation">.</span>entities</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span></span><span class="token class-name">Accessors</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Entity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Id</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookValueEntities</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>

    <span class="token class-name">String</span> nameBook<span class="token punctuation">;</span>

    <span class="token class-name">String</span> firstNameAuthor<span class="token punctuation">;</span></code></pre> Тобто ми написали клас, який містить поля, аналогічні полям, які запитують у БД. Тепер у <span>BookService</span> реалізуємо сам мапінг із використанням стриму. Перепишіть цей метод у місці з коментарями, прочитайте їх, спробуйте зрозуміти, що робить цей метод на кожному етапі виконання. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookValueEntities</span><span class="token punctuation">&gt;</span></span> <span class="token function">bookValueEntitiesList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> objects <span class="token operator">=</span> bookRepository<span class="token punctuation">.</span><span class="token function">joinBookObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//положим ответ от БД в переменную с типом Лист массивов Object-ов</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookValueEntities</span><span class="token punctuation">&gt;</span></span> bookValueEntities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//создадим лист конечных об'єктов</span>

    objects<span class="token comment">//берем переменную типа List&lt;Object[]&gt; (Лист массивов Object-ов), с ответом БД</span>
            <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//превращаем Лист, состоящий из массивов Object-ов в стрим</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token comment">//фор ич - терминальный оператор, выполняет указанное действие для каждого елемента стрима</span>
                    <span class="token comment">//дальше идет лямбда, она говорит фор ичу - что делать для каждого елемента стрима</span>
                    <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">-&gt;</span><span class="token comment">//объявляем(называем) переменную "obj" ей будут присваиваться об'єкты стрима (массивы Object-ов)</span>
                    <span class="token punctuation">{</span><span class="token comment">//так як запись в лямбде у нас в несколько строк, ставим {}</span>
                        bookValueEntities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token comment">//фор ич возмет "obj" и добавит в List&lt;BookValue&gt;, предварительно сделав маппинг</span>
                                <span class="token keyword">new</span> <span class="token class-name">BookValueEntities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//создаем об'єкт BookValueEntities</span>
                                        <span class="token comment">//ниже происходит собственно маппинг</span>
                                        <span class="token comment">//поля(элементы) "obj" записываются в соответсвующие поля созданного BookValueEntities</span>
                                        <span class="token comment">//так як поле "obj" имеет тип Object  необходимо его привести к типу поля об'єкта BookValueEntities т.е. String</span>
                                        <span class="token punctuation">.</span><span class="token function">setNameBook</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">//записываем данные из одного поля в другое, [0] - значит первый элемент в массиве Object-ов</span>
                                        <span class="token comment">//так як поле "obj" имеет тип Object  необходимо его привести к типу поля об'єкта BookValue т.е. String</span>
                                        <span class="token punctuation">.</span><span class="token function">setFirstNameAuthor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> obj<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">//записываем данные из одного поля в другое, [1] - значит второй элемент в массиве Object-ов</span>
                                        <span class="token comment">//так як поле "obj" имеет тип Object  необходимо его привести к типу поля об'єкта BookValue т.е. String</span>
                                        <span class="token punctuation">.</span><span class="token function">setLastNameAuthor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> obj<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">//записываем данные из одного поля в другое, [2] - значит третий элемент в массиве Object-ов</span>
                                        <span class="token comment">//так як поле "obj" имеет тип Object  необходимо его привести к типу поля об'єкта BookValue т.е. Integer</span>
                                        <span class="token punctuation">.</span><span class="token function">setYearCreat</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> obj<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">//записываем данные из одного поля в другое, [3] - значит четвертый элемент в массиве Object-ов</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bookValueEntities<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Реалізуємо виведення в консоль в <span>InitiateUtils</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\nТаблица книг и их авторов , через стрим"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">BookValueEntities</span> book<span class="token operator">:</span> bookService<span class="token punctuation">.</span><span class="token function">bookValueEntitiesList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Натискаємо виконати. Отримуємо висновок: 
<div class="terminal">
 Таблиця книг та їх авторів, через стрім BookValueEntities(id=null, nameBook=Горе від розуму, firstNameAuthor=Олександр, lastNameAuthor=Грибоєдів, yearCreat=1824) BookValueEntities(id=null, nameBook=Війна та мир Толстой, yearCreat=1863) BookValueEntities(id=null, nameBook=Мцирі, firstNameAuthor=Михайло, lastNameAuthor=Лермонтів, yearCreat=1838) BookValueEntities(id=null, nameBook=Євген н, yearCreat=1833 )
</div> Із цими об'єктами тепер можна нормально працювати. Вам не подумати: чому id = null, і як зробити? щоб був не null? Як говорилося в попередніх статтях, для складних, зокрема міжтабличних запитів застосовують SQL. Погляньмо, що можна з цим зробити. Для початку переробимо запит на отримання «Таблиці книг та їх авторів» у SQL і покладемо цей запит у фінальну змінну у <span>class BookService</span> . 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SQL_COMPARISON <span class="token operator">=</span> <span class="token string">"select BOOKENTITY.id_book, BOOKENTITY.name_book, AUTHORENTITY.first_name, AUTHORENTITY.last_name,BOOKENTITY.year_creat from  "</span> <span class="token operator">+</span>
        <span class="token string">"AUTHORENTITY left join BOOKENTITY on AUTHORENTITY.id_author = BOOKENTITY.author_id"</span><span class="token punctuation">;</span></code></pre> COMPARISON російською – зіставлення. Давайте створимо в <span>entities</span> клас для порівняння цього запиту: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">ru<span class="token punctuation">.</span>java<span class="token punctuation">.</span>rush<span class="token punctuation">.</span>entities</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Column</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Entity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Id</span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookValueEntitiesComparison</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"id_book"</span><span class="token punctuation">)</span><span class="token comment">//назвали поле як в запите</span>
    <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token class-name">String</span> nameBook<span class="token punctuation">;</span><span class="token comment">//поле и так называется як в запите, потому что Hibernate сгенерирует для него ім'я сам (name_book)</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"first_name"</span><span class="token punctuation">)</span><span class="token comment">//назвали поле як в запите</span>
    <span class="token class-name">String</span> firstNameAuthor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"last_name"</span><span class="token punctuation">)</span><span class="token comment">//назвали поле як в запите</span>
    <span class="token class-name">String</span> lastNameAuthor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token class-name">Integer</span> yearCreat<span class="token punctuation">;</span> <span class="token comment">//поле и так называется як в запите</span></code></pre> Для реалізації методу в <span>class BookService</span> нам потрібно вивести на світ божий <a href="https://easyjava.ru/data/jpa/jpa-entitymanager-upravlyaem-sushhnostyami/" target="_blank" rel="nofollow">EntityManager</a> . Як очевидно з назви, це начальник над сутностями. Запишемо в <span>class BookService</span> змінну. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EntityManager</span> entityManager<span class="token punctuation">;</span></code></pre> Теж мені начальник знайшовся, зараз ми його збудуємо. Для цього в <span>class BookService</span> реалізуємо метод читання запиту: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookValueEntitiesComparison</span><span class="token punctuation">&gt;</span></span> <span class="token function">bookValueEntitiesComparisonList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> entityManager <span class="token comment">//зовем менеджера и начинаем ему указывать</span>
            <span class="token punctuation">.</span><span class="token function">createNativeQuery</span><span class="token punctuation">(</span><span class="token comment">//для начала создай пожалуйста "чистый"(native) SQL запит</span>
                    SQL_COMPARISON<span class="token punctuation">,</span><span class="token comment">//из этой строковой переменной возьми запит</span>
                    <span class="token class-name">BookValueEntitiesComparison</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">// ответ замаппить в этот класс</span>
            <span class="token punctuation">.</span><span class="token function">getResultList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//а результат мне заверни в лист!!! И побыстрее!!!Шнеля, шнеля!!!</span>
<span class="token punctuation">}</span></code></pre> Начебто потараканив виконувати наші вказівки, давайте глянемо як він упорався. <span>InitiateUtils</span> виведемо в консоль: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\nТаблица книг и их авторов, через сопоставление"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Object</span> book<span class="token operator">:</span> bookService<span class="token punctuation">.</span><span class="token function">bookValueEntitiesComparisonList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<div class="terminal">
 Таблиця книг та їх авторів, через зіставлення BookValueEntitiesComparison(id=1, nameBook=Горе від розуму, firstNameAuthor=Олександр, lastNameAuthor=Грибоєдів, yearCreat=1824) BookValueEntitiesComparison(id=2, name hor= Толстой, yearCreat=1863) BookValueEntitiesComparison(id=3, nameBook=Мцирі, firstNameAuthor=Михайло, lastNameAuthor=Лермонтів, yearCreat=1838) BookValueEntitiesComparison(id=4, name Author=Пушкін, yearCreat=1833 )
</div> Молодець, упорався. Як він це зробив? Просто зіставив найменування полів сутності-класу, що ми йому вказали, та результату запиту. Можна виконати це завдання іншим способом, через анотації: У <span>class BookService</span> створюємо нову змінну із запитом: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SQL_ANNOTATION <span class="token operator">=</span> <span class="token string">"select  BOOKENTITY.id_book as id_book_value, BOOKENTITY.name_book, AUTHORENTITY.first_name, AUTHORENTITY.last_name,BOOKENTITY.year_creat from  "</span> <span class="token operator">+</span>
        <span class="token string">"AUTHORENTITY left join BOOKENTITY on AUTHORENTITY.id_author = BOOKENTITY.author_id"</span><span class="token punctuation">;</span></code></pre> Зверніть увагу: він трохи змінився, знайдіть різницю. Створимо в <span>entities</span> окремий клас, куди будемо маппити. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">ru<span class="token punctuation">.</span>java<span class="token punctuation">.</span>rush<span class="token punctuation">.</span>entities</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SqlResultSetMapping</span><span class="token punctuation">(</span>
        name <span class="token operator">=</span> <span class="token string">"BookValueMapping"</span><span class="token punctuation">,</span><span class="token comment">//даем название нашему маппингу</span>
        entities <span class="token operator">=</span> <span class="token annotation punctuation">@EntityResult</span><span class="token punctuation">(</span>
                entityClass <span class="token operator">=</span> <span class="token class-name">BookValueEntitiesAnnotation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token comment">//указываем конечный класс куда будем маппить</span>
                fields <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment">//в блоке полей указываем соответствие полей(name =) конечного класса и полей(colum =) результата запита</span>
                        <span class="token annotation punctuation">@FieldResult</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">,</span> column <span class="token operator">=</span> <span class="token string">"id_book_value"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@FieldResult</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"nameBook"</span><span class="token punctuation">,</span> column <span class="token operator">=</span> <span class="token string">"name_book"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@FieldResult</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"firstNameAuthor"</span><span class="token punctuation">,</span> column <span class="token operator">=</span> <span class="token string">"first_name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@FieldResult</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"lastNameAuthor"</span><span class="token punctuation">,</span> column <span class="token operator">=</span> <span class="token string">"last_name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@FieldResult</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"yearCreat"</span><span class="token punctuation">,</span> column <span class="token operator">=</span> <span class="token string">"year_creat"</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"BookValueEntitiesAnnotation"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookValueEntitiesAnnotation</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@Column</span>
    <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token class-name">String</span> nameBook<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token class-name">String</span> firstNameAuthor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token class-name">String</span> lastNameAuthor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token class-name">Integer</span> yearCreat<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> У <span>class BookService</span> реалізуємо метод: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookValueEntitiesAnnotation</span><span class="token punctuation">&gt;</span></span> <span class="token function">bookValueEntitiesAnnotationList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> entityManager<span class="token comment">//як и в прошлый раз зовем начальника</span>
                <span class="token punctuation">.</span><span class="token function">createNativeQuery</span><span class="token punctuation">(</span><span class="token comment">//давай нам чистый SQL запит</span>
                        SQL_ANNOTATION<span class="token punctuation">,</span><span class="token comment">//вот тебе текст запита</span>
                        <span class="token string">"BookValueMapping"</span><span class="token punctuation">)</span><span class="token comment">//вот тебе ім'я нашего маппинга</span>
                <span class="token punctuation">.</span><span class="token function">getResultList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//и як обычно заверни нам в лист!!! Ты еще тут?</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Бачабо, яка солідна назва методу вийшла? Чим довше ви називаєте метод, тим з великою повагою ставляться до вас колеги 😁 (частка правди тут є). Проконтролюємо роботу менеджера як звичайно через <span>InitiateUtils</span> і виведемо в консоль: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\nТаблица книг и их авторов, через аннотацию"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Object</span> book<span class="token operator">:</span> bookService<span class="token punctuation">.</span><span class="token function">bookValueEntitiesAnnotationList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Результат аналогічний попереднім: 
<div class="terminal">
 Таблиця книг та їх авторів, через анотацію BookValueEntitiesAnnotation(id=1, nameBook=Горе від розуму, firstNameAuthor=Олександр, lastNameAuthor=Грибоєдів, yearCreat=1824) BookValueEntitiesAnnotation(id=2,Name = Толстой, yearCreat=1863) BookValueEntitiesAnnotation(id=3, nameBook=Мцирі, firstNameAuthor=Михайло, lastNameAuthor=Лермонтов, yearCreat=1838) BookValueEntitiesAnnotation(id=4, nameBook= hor=Пушкін, yearCreat=1833 )
</div> Ну і останній варіант за списком, але не за значенням, це зробити мапінг через файл XML-відображення. Файл зіставлення за промовчанням називається orm.xml і буде використовуватися автоматично, якщо він буде доданий до META-INF каталогу файлу jar. Як ви можете бачити нижче, це зіставлення дуже схоже на зіставлення на основі анотацій, яке ми обговорювали раніше. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token operator">&lt;</span>sql<span class="token operator">-</span>result<span class="token operator">-</span>set<span class="token operator">-</span>mapping name<span class="token operator">=</span><span class="token string">"BookMappingXml"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>entity<span class="token operator">-</span>result entity<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">=</span>"<span class="token class-name"><span class="token namespace">ru<span class="token punctuation">.</span>java<span class="token punctuation">.</span>rush<span class="token punctuation">.</span>entities
<span class="token punctuation">.</span></span>BookValueEntitiesAnnotation</span> "<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>field<span class="token operator">-</span>result name<span class="token operator">=</span><span class="token string">"id"</span> column<span class="token operator">=</span><span class="token string">" id_book_value "</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>field<span class="token operator">-</span>result name<span class="token operator">=</span><span class="token string">" nameBook "</span> column<span class="token operator">=</span><span class="token string">" name_book "</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>field<span class="token operator">-</span>result name<span class="token operator">=</span><span class="token string">" firstNameAuthor "</span> column<span class="token operator">=</span><span class="token string">" first_name"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>field<span class="token operator">-</span>result name<span class="token operator">=</span><span class="token string">" yearCreat "</span> column<span class="token operator">=</span><span class="token string">" year_creat "</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>entity<span class="token operator">-</span>result<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>sql<span class="token operator">-</span>result<span class="token operator">-</span>set<span class="token operator">-</span>mapping<span class="token operator">&gt;</span></code></pre> На цьому все! На поточному рівні вам цілком вистачить найпростішого мапінгу, про інші методи треба просто знати. Ось тут у <a href="https://thorben-janssen.com/result-set-mapping-basics/" target="_blank" rel="nofollow">статті буржуазною мовою</a> описані варіації методів роботи з відповідями від БД, які ми розібрали. За мову не переживайте, натисніть перекласти сторінку і вийде переклад. Я це точно знаю, тому що цю статтю підготовлено на її основі, а в школі я вчив німецьку. Для практики:
<ol>
 <li>Додайте до проекту нову сутність, сховище книг: 
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">BookStorageEntity</span>
<span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
<span class="token class-name">Integer</span> bookId<span class="token punctuation">;</span>
<span class="token class-name">String</span> status<span class="token punctuation">;</span> <span class="token comment">//книга выдана або нет</span></code></pre></li>
 <li>Наповніть таблицю: 
  <div class="terminal">
   Id = 1 bookId = 1 status = Видано; 
   <br>
    Id = 2 bookId = 2 status = У сховищі; 
   <br>
    Id = 3 bookId = 3 status = На реставрації; 
   <br>
    Id = 4 bookId = 4 status = Видано;
  </div></li>
 <li>Створіть <span>BookStorageRepository</span> та <span>BookStorageService</span> .</li>
 <li>Створіть міжтабличні JPQL та SQL запити, які виводять найменування книги та видана вона чи ні.</li>
 <li>Для JPQL реалізуйте мапінг за першим варіантом, для SQL - за другим і третім.</li>
</ol><a href="https://codegym.cc/groups/posts/3113-spring---ehto-ne-strashno-uchimsja-reshatjh-problemih" target="_blank" rel="nofollow">Бувайте усі! Побачимося!</a>