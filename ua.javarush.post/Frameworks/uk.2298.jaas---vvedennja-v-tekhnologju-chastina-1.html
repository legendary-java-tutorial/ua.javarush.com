JAAS - Введення в технологію (частина 1)
<p>----------------------------------------</p>
Безпека доступу реалізована в Java досить давно і архітектура забезпечення цієї безпеки називається JAAS - Java Authentication and Authorization Service. Цей огляд спробує розкрити таємницю, що таке автентифікація, авторизація і до чого тут
<p>----------------------------------------</p>
Безпека доступу реалізована в Java досить давно і архітектура забезпечення цієї безпеки називається JAAS - Java Authentication and Authorization Service. Цей огляд спробує розкрити таємницю, що таке автентифікація, авторизація і до чого тут JAAS. Як JAAS товаришує із Servlet API, а де у них у взаєминах проблеми. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="f92c6cd0-6377-4ce6-a833-d8cb84c690dc" data-max-width="291" alt="JAAS - Введення в технологію (частина 1) - 1" src="https://cdn.javarush.com/images/article/f92c6cd0-6377-4ce6-a833-d8cb84c690dc/256.jpeg" style="width: 291px;">
 </div>
</div>
<h2>Вступ</h2>Хотілося б у цьому огляді обговорити таку тему, як безпека веб-додатків. У Java є кілька технологій, які забезпечують безпеку: 
<ul>
 <li>
  <p>" <strong>Java SE Platform Security Architecture</strong> ", докладніше про яку можна прочитати в Guide від Oracle: " <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/spec/security-specTOC.fm.html" target="_blank" rel="nofollow">JavaTM SE Platform Security Architecture</a> ". Ця архітектура описує те, як необхідно захищати наші Java-додатки в Java SE середовищі виконання. Але це не є темою нашої сьогоднішньої розмови.</p></li>
 <li>
  <p>" <strong>Java Cryptography Architecture</strong> " - розширення (Java Extension), яке визначає шифрування даних. Докладніше про це розширення можна прочитати на CodeGym в огляді " <a href="https://codegym.cc/groups/posts/2277-java-cryptography-architecture--pervoe-znakomstvo" target="_blank" rel="nofollow">Java Cryptography Architecture: Перше знайомство</a> " або в Guide від Oracle: " <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/crypto/CryptoSpec.html" target="_blank" rel="nofollow">Java Cryptography Architecture (JCA) Reference Guide</a> ".</p></li>
</ul>Але наша сьогоднішня розмова буде про іншу технологію, яка отримала назву Java Authentication and Authorization Service (JAAS). Саме вона описує такі важливі речі, як автентифікація та авторизація. Давайте розберемося з цим детальніше. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="cfb4e490-9aba-4a40-af51-abe4e80aab26" data-max-width="267" alt="JAAS - Введення в технологію (частина 1) - 2" src="https://cdn.javarush.com/images/article/cfb4e490-9aba-4a40-af51-abe4e80aab26/256.jpeg" style="width: 267px;">
 </div>
</div>
<h2>JAAS</h2><strong>JAAS</strong> - це розширення Java SE і воно описано в документі " <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jaas/JAASRefGuide.html" target="_blank" rel="nofollow">Java Authentication and Authorization Service (JAAS) Reference Guide</a> ". Як випливає з назви технології, JAAS описує те, як потрібно виконувати аутентифікацію та авторизацію: 
<ul>
 <li>
  <p>" <strong>Аутентифікація</strong> ": у перекладі з грецької "authentikos" означає "реальний, справжній". Тобто автентифікація – це автентифікація. Що той, хто проходить автентифікацію, справді той, за кого себе видає.</p></li>
 <li>
  <p>" <strong>Авторизація</strong> " : у перекладі з англійської означає " дозвіл " . Тобто авторизація — це контроль доступу після успішного проходження аутентифікації.</p></li>
</ul> Тобто JAAS — це визначення тих, хто запитує доступ до ресурсу, і про винесення рішення, а чи може він цей доступ отримати. <u>Невелика аналогія із життя:</u>ви їдете дорогою і Вас зупиняє інспектор. Прохання надати документи – автентифікація. Чи можете Ви керувати автомобілем за документами — авторизація. Або, наприклад, у магазині Ви хочете купити алкоголь. Спочатку, у Вас просять паспорт – автентифікація. Далі на основі вашого віку вирішується, чи маєте Ви право купувати алкоголь. Це авторизація. У веб-додатках, вхід під користувачем (введення логіну та пароля) є автентифікацією. А визначення того, які вам можна відкривати сторінки - авторизацією. У цьому нам і допомагає "The Java Authentication and Authorization Service (JAAS)". Розглядаючи JAAS, важливо розуміти кілька ключових понять, які описує JAAS: Subject, Principals, Credentials. <strong>Subject</strong>- Це суб'єкт аутентифікації. Тобто це носій чи володар прав. У документації Subject визначено як джерело (source) запиту (request) виконання певної дії. Суб'єкт чи джерело необхідно якось описати і для цього використовується Principal, який російською теж іноді називають принципалом. Тобто кожен Principal є уявленням Subject із певної точки зору. Щоб стало зрозуміліше, наведемо приклад: Певна людина є Subject. А як Principal'ів можуть виступати: 
<ul>
 <li>його посвідчення водія, як подання людини як учасника дорожнього руху</li>
 <li>його паспорт, як подання людини як громадянина своєї країни</li>
 <li>його закордонний паспорт як подання людини як учасника міжнародних відносин</li>
 <li>його читацький квиток у бібліотеці, як подання людини як прикріпленого до бібліотеки читача</li>
</ul>Крім того, Subject має набір Credential, що в перекладі з англійської означає посвідчення. Це те, чим Subject підтверджує, що це він. Наприклад, як Credential може виступати пароль користувача. Або будь-який об'єкт, яким користувач може підтвердити, що він це справді він. Давайте подивимося, як JAAS використовується у веб-додатках. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="fa90a210-ae9b-42e0-a8ff-f63f3bb4849d" data-max-width="301" alt="JAAS - Введення в технологію (частина 1) - 3" src="https://cdn.javarush.com/images/article/fa90a210-ae9b-42e0-a8ff-f63f3bb4849d/256.jpeg" style="width: 301px;">
 </div>
</div>
<h2>Веб-додаток</h2>Отже, нам знадобиться веб-додаток. У його створенні нам допоможе система автоматичного збирання проектів Gradle. Завдяки використанню Gradle ми зможемо за допомогою виконання невеликих команд збирати Java проект у потрібному нам форматі, створювати автоматично потрібну структуру каталогів та багато іншого. Докладніше про Gradle можна прочитати в короткому огляді: " <a href="https://codegym.cc/groups/posts/2126-kratkoe-znakomstvo-s-gradle" target="_blank" rel="nofollow">Коротке знайомство з Gradle</a> " або в офіційній документації " <a href="https://docs.gradle.org/current/userguide/getting_started.html" target="_blank" rel="nofollow">Gradle Getting Started</a> ". Нам потрібно виконати ініціалізацію проекту (Initialization), а для цього в Gradle є спеціальний плагін: " <a href="https://docs.gradle.org/current/userguide/build_init_plugin.html#sec:build_init_types" target="_blank" rel="nofollow">Gradle Init Plugin</a> " (Init - скорочення від Initialization, легко запам'ятати). Щоб скористатися цим плагіном, виконаємо в командному рядку команду: 
<pre class="inline-block  language-java" tabindex="0"><code class="  language-java">gradle init <span class="token operator"><span class="token operator">--</span></span>type java<span class="token operator"><span class="token operator">-</span></span>application</code></pre> Після успішного виконання у нас з'явиться проект Java. Відкриємо тепер на редагування білд-скрипт нашого проекту. Білд скрипт - це файл з назвою <code class=" language-none">build.gradle</code>, який описує нюанси складання (білда) програми. Звідси й назва така, білд скрипт. Можна сказати, що це скрипт складання проекту. Gradle — це універсальний інструмент, базові можливості якого розширюються завдяки плагінам. Тому, насамперед звернемо увагу на блок "plugins" (плагіни): 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class="  language-java">plugins <span class="token punctuation"><span class="token punctuation">{</span></span>
    id <span class="token string"><span class="token string">'java'</span></span>
    id <span class="token string"><span class="token string">'application'</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> За замовчуванням Gradle, відповідно до вказаного нами <code class=" language-none">--type java-application</code>, виставив набір деяких базових плагінів (core plugins), тобто тих плагінів, які входять у постачання самого Gradle. Якщо перейти на сайті <a href="https://gradle.org/" target="_blank" rel="nofollow">gradle.org</a> у розділ "Docs" (тобто документація), то ліворуч у списку тем у розділі "Reference" бачимо розділ " <a href="https://docs.gradle.org/current/userguide/plugin_reference.html" target="_blank" rel="nofollow">Core Plugins</a> ", тобто. розділ із описом цих самих базових плагінів. Давайте оберемо саме ті плагіни, які нам потрібні, а не ті, що нам згенерував Gradle. Відповідно до документації, " <a href="https://docs.gradle.org/current/userguide/java_plugin.html" target="_blank" rel="nofollow">Gradle Java Plugin</a> " забезпечує базові операції з Java кодом, такі як компіляція вихідного коду. Також, згідно з документацією, " <a href="https://docs.gradle.org/current/userguide/application_plugin.html" target="_blank" rel="nofollow">Gradle application plugin</a>забезпечує нас засобами для роботи з "executable JVM application", тобто з java додатком, які можна запустити як самостійний додаток (наприклад, консольний додаток або додаток з власним UI). Виходить, що плагін "application" нам не потрібен, тому що нам не потрібна самостійна програма, нам потрібна веб-додаток. Видалимо його. А так само налаштування "mainClassName", яка відома тільки цьому плагіну. Далі, в тому ж розділі "Packaging and distribution", де було наведено <a href="https://docs.gradle.org/current/userguide/plugin_reference.html#packaging_and_distribution" target="_blank" rel="nofollow">посилання</a> на документацію по Application Plugin, є посилання на Gradle War Plugin <a href="https://docs.gradle.org/current/userguide/war_plugin.html" target="_blank" rel="nofollow">.</a>, як сказано в документації, надає підтримку створення Java веб-застосунків у форматі war. У форматі WAR означає, що замість JAR архіву буде створено архів WAR. Здається, це те, що нам потрібне. Крім того, як сказано в документації, "The War plugin extends the Java plugin". Тобто ми можемо замінити плагін java на плагін war. Отже, наш блок плагінів у результаті матиме такий вигляд: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java">plugins <span class="token punctuation"><span class="token punctuation">{</span></span>
    id <span class="token string"><span class="token string">'war'</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Так само в документації до Gradle War Plugin сказано, що плагін використовує додатковий Project Layout. Layout з англійської перекладається як розташування. Тобто war plugin за замовчуванням розраховує на існування деякого розташування файлів, які він використовуватиме для своїх завдань. Використовувати для зберігання файлів веб-програми він буде наступний каталог: <code class=" language-none">src/main/webapp</code> Поведінка плагіна описано так: 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="d90d8b3a-96d6-4345-88c8-e5cf0094c710" data-max-width="759" alt="JAAS - Введення в технологію (частина 1) - 4" src="https://cdn.javarush.com/images/article/d90d8b3a-96d6-4345-88c8-e5cf0094c710/512.jpeg" style="width: 759px;">
 </div>
</div>Тобто плагін буде враховувати файли з цього розташування при складанні WAR архіву нашого веб-додатку. Крім того, у документації Gradle War Plugin'а сказано, що цей каталог буде "root of the archive". І вже ми можемо створити каталог WEB-INF і додати туди файл web.xml. Що це за такий файл? <code class=" language-none">web.xml</code>- це "Deployment Descriptor" або "описувач розгортання". Це такий файл, який описує, як потрібно налаштувати наш веб-додаток для роботи. У цьому файлі вказується, які запити оброблятиме наша програма, налаштування безпеки та багато іншого. За своєю суттю він чимось схожий на manifest файл із JAR файлу (див. <a href="https://docs.oracle.com/javase/tutorial/deployment/jar/manifestindex.html" target="_blank" rel="nofollow">Working with Manifest Files: The Basics</a>Manifest файл розповідає, як працювати з Java Application (тобто з JAR архівом), а web.xml розповідає, як працювати з Java Web Application (тобто з WAR архівом). Саме поняття "Deployment Descriptor" виникло не саме собою, а описано в документі " <a href="https://javaee.github.io/servlet-spec/downloads/servlet-3.1/Final/servlet-3_1-final.pdf#page=173&amp;zoom=100,0,188" target="_blank" rel="nofollow">Servlet API Specification</a>Тобто мільйон програмістів довелося б писати для однієї і тієї ж мети код знову і знову. Тому за частину взаємодії з користувачем та за обмін даними відповідає веб-сервер, а за формування цих даних відповідає веб-додаток та розробник. Щоб зв'язати ці дві частини, тобто. веб-сервер і додаток, необхідний договір їх взаємодії, тобто. за якими правилами вони це робитимуть. Щоб якось описати контракт, як має виглядати взаємодія між веб-програмою та веб-сервером і придуманий Servlet API. Цікаво, що навіть якщо ви використовуєте фреймворки на кшталт Spring, то під капотом все одно працює Servlet API. Тобто ви використовуєте Spring, а Spring за Вас працює із Servlet API. Виходить, що наш проект веб-застосування повинен залежати (depends on) від Servlet API. І тут Servlet API буде залежністю (dependency). Як ми знаємо, Gradle зокрема дозволяє декларативним чином описувати залежності проекту. А те, як можна управляти залежностями, описують плагіни. Наприклад, Java Gradle Plugin вводить спосіб управління залежностями "testImplementation", який каже, що така залежність потрібна лише для тестів. А ось Gradle War Plugin додає спосіб управління залежностями "providedCompile", який каже, що така залежність не буде включена до WAR архіву нашого веб-додатку. Чому ми не включаємо Servlet API у наш WAR архів? Тому що Servlet API буде надано нашому веб-застосунку самим веб-сервером. Якщо веб-сервер надає Servlet API, такий сервер називають контейнер сервлетів. Тому надати нам Servlet API – це обов'язок веб-сервера, а наш обов'язок надати ServletAPI лише на момент компіляції коду. Тому й<code class=" language-none">providedCompile</code>. Таким чином, блок залежностей (dependencies) матиме такий вигляд: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class="  language-java">dependencies <span class="token punctuation"><span class="token punctuation">{</span></span>
    providedCompile <span class="token string"><span class="token string">'javax.servlet:javax.servlet-api:3.1.0'</span></span>
    testImplementation <span class="token string"><span class="token string">'junit:junit:4.12'</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Отже, повернемося до файлу web.xml. За замовчуванням Gradle не створює ніякого Deployment Descriptor, тому нам потрібно зробити це самостійно. Створимо каталог <code class=" language-none">src/main/webapp/WEB-INF</code>, а в ньому створимо XML-файл з назвою <code class=" language-none">web.xml</code>. Тепер давайте відкриємо саму специфікацію "Java Servlet Specification" та розділ " <a href="https://javaee.github.io/servlet-spec/downloads/servlet-3.1/Final/servlet-3_1-final.pdf#page=175&amp;zoom=100,0,246" target="_blank" rel="nofollow">CHAPTER 14 Deployment Descriptor</a> ". Як сказано в "14.3 Deployment Descriptor", XML документ Deployment Descriptor'а описаний схемою <a href="http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd" target="_blank" rel="nofollow">http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd</a> . XML схема описує, з яких елементів може складатися документ, у порядку вони мають йти. Які обов'язкові, а які ні. Загалом описує структуру документа і дозволяє перевірити, чи правильно XML документ складено. Тепер скористаємося прикладом із розділу "<a href="https://javaee.github.io/servlet-spec/downloads/servlet-3.1/Final/servlet-3_1-final.pdf#page=198&amp;zoom=100,0,465" target="_blank" rel="nofollow"></a>", але схему слід зазначити для версії 3.1, тобто. 
<pre class="inline-block  language-java" tabindex="0"><code class="  language-java">http<span class="token operator"><span class="token operator">:</span></span><span class="token operator"><span class="token operator">/</span></span><span class="token operator"><span class="token operator">/</span></span>xmlns<span class="token punctuation"><span class="token punctuation">.</span></span>jcp<span class="token punctuation"><span class="token punctuation">.</span></span>org<span class="token operator"><span class="token operator">/</span></span>xml<span class="token operator"><span class="token operator">/</span></span>ns<span class="token operator"><span class="token operator">/</span></span>javaee<span class="token operator"><span class="token operator">/</span></span>web<span class="token operator"><span class="token operator">-</span></span>app_3_1<span class="token punctuation"><span class="token punctuation">.</span></span>xsd</code></pre> Наш порожній <code class=" language-none">web.xml</code>буде виглядати так: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">?</span></span>xml version<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"1.0"</span></span> encoding<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"ISO-8859-1"</span></span><span class="token operator"><span class="token operator">?</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
<span class="token operator"><span class="token operator">&lt;</span></span>web<span class="token operator"><span class="token operator">-</span></span>app xmlns<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span>
         xmlns<span class="token operator"><span class="token operator">:</span></span>xsi<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span></span>
         xsi<span class="token operator"><span class="token operator">:</span></span>schemaLocation<span class="token operator"><span class="token operator">=</span></span>"http<span class="token operator"><span class="token operator">:</span></span><span class="token operator"><span class="token operator">/</span></span><span class="token operator"><span class="token operator">/</span></span>xmlns<span class="token punctuation"><span class="token punctuation">.</span></span>jcp<span class="token punctuation"><span class="token punctuation">.</span></span>org<span class="token operator"><span class="token operator">/</span></span>xml<span class="token operator"><span class="token operator">/</span></span>ns<span class="token operator"><span class="token operator">/</span></span>javaee
         http<span class="token operator"><span class="token operator">:</span></span><span class="token operator"><span class="token operator">/</span></span><span class="token operator"><span class="token operator">/</span></span>xmlns<span class="token punctuation"><span class="token punctuation">.</span></span>jcp<span class="token punctuation"><span class="token punctuation">.</span></span>org<span class="token operator"><span class="token operator">/</span></span>xml<span class="token operator"><span class="token operator">/</span></span>ns<span class="token operator"><span class="token operator">/</span></span>javaee<span class="token operator"><span class="token operator">/</span></span>web<span class="token operator"><span class="token operator">-</span></span>app_3_1<span class="token punctuation"><span class="token punctuation">.</span></span>xsd"
         version<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"3.1"</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
    <span class="token operator"><span class="token operator">&lt;</span></span>display<span class="token operator"><span class="token operator">-</span></span>name<span class="token operator"><span class="token operator">&gt;</span></span>JAAS <span class="token class-name"><span class="token class-name">Example</span></span><span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>display<span class="token operator"><span class="token operator">-</span></span>name<span class="token operator"><span class="token operator">&gt;</span></span>
<span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>web<span class="token operator"><span class="token operator">-</span></span>app<span class="token operator"><span class="token operator">&gt;</span></span></code></pre> Давайте тепер опишемо сервлет, який ми захищатимемо за допомогою JAAS. Раніше Gradle згенерував клас App. Давайте перетворимо його на сервлет. Як сказано в специфікації в " <a href="https://javaee.github.io/servlet-spec/downloads/servlet-3.1/Final/servlet-3_1-final.pdf#page=25&amp;zoom=100,0,188" target="_blank" rel="nofollow">CHAPTER 2 The Servlet Interface</a> ", щоб " <em>For most purposes, Developers буде extend HttpServlet до implement their servlets</em> ", тобто щоб зробити клас сервлетом необхідно успадкувати цей клас від <code class=" language-none">HttpServlet</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">App</span></span> <span class="token keyword"><span class="token keyword">extends</span></span> <span class="token class-name"><span class="token class-name">HttpServlet</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">String</span></span> <span class="token function"><span class="token function">getGreeting</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">return</span></span> <span class="token string"><span class="token string">"Secret!"</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token keyword"><span class="token keyword">protected</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">doGet</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">HttpServletRequest</span></span> request<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">HttpServletResponse</span></span> response<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">ServletException</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">IOException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        response<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getWriter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">print</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token function"><span class="token function">getGreeting</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як ми говорабо, Servlet API — це контракт між сервером і нашим веб-додатком. Це контракт дозволяє описати, що коли користувач звернутися до сервера, сервер сформує запит від користувача як об'єкт <code class=" language-none">HttpServletRequest</code>і передасть його в сервлет. А також надасть сервлету об'єкт <code class=" language-none">HttpServletResponse</code>, щоб сервлет зміг записати відповідь для користувача. Коли сервлет відпрацює, сервер зможе на основі <code class=" language-none">HttpServletResponse</code>надати відповідь користувачеві. Тобто сервлет безпосередньо не спілкується з користувачем, а лише із сервером. Щоб сервер знав, що у нас є сервлет і для яких запитів його потрібно задіяти, потрібно про це серверу розповісти в деплоймент дескрипторі: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span>servlet<span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span>
	<span class="token operator"><span class="token operator">&lt;</span></span>servlet<span class="token operator"><span class="token operator">-</span></span>name<span class="token operator"><span class="token operator">&gt;</span></span>app<span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>servlet<span class="token operator"><span class="token operator">-</span></span>name<span class="token operator"><span class="token operator">&gt;</span></span>
	<span class="token operator"><span class="token operator">&lt;</span></span>servlet<span class="token operator"><span class="token operator">-</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token operator"><span class="token operator">&gt;</span></span><span class="token class-name"><span class="token namespace"></span><span class="token class-name"><span class="token namespace"><span class="token namespace">jaas<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>App</span></span><span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>servlet<span class="token operator"><span class="token operator">-</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
<span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>servlet<span class="token operator"><span class="token operator">&gt;</span></span>
<span class="token operator"><span class="token operator">&lt;</span></span>servlet<span class="token operator"><span class="token operator">-</span></span>mapping<span class="token operator"><span class="token operator">&gt;</span></span>
	<span class="token operator"><span class="token operator">&lt;</span></span>servlet<span class="token operator"><span class="token operator">-</span></span>name<span class="token operator"><span class="token operator">&gt;</span></span>app<span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>servlet<span class="token operator"><span class="token operator">-</span></span>name<span class="token operator"><span class="token operator">&gt;</span></span>
	<span class="token operator"><span class="token operator">&lt;</span></span>url<span class="token operator"><span class="token operator">-</span></span>pattern<span class="token operator"><span class="token operator">&gt;</span></span><span class="token operator"><span class="token operator">/</span></span>secret<span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>url<span class="token operator"><span class="token operator">-</span></span>pattern<span class="token operator"><span class="token operator">&gt;</span></span>
<span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>servlet<span class="token operator"><span class="token operator">-</span></span>mapping<span class="token operator"><span class="token operator">&gt;</span></span></code></pre> В даному випадку всі запити <code class=" language-none">/secret</code>будуть адресаовані нашому одному сервлету на ім'я <code class=" language-none">app</code>, яке відповідає класу <code class=" language-none">jaas.App</code>. Як ми раніше говорабо, веб-додаток може бути розгорнутий лише на веб-сервері. Веб-сервер можна встановити окремо (standalone). Але для цілей цього огляду підійде альтернативний варіант - запуск на вбудованому (embedded) сервері. Це означає, що сервер буде створено та запущено програмно (за нас це зробить плагін), а разом з цим на ньому буде розгорнуто наш веб-додаток. Система складання Gradle дозволяє для цих цілей використовувати плагін " <a href="https://gretty-gradle-plugin.github.io/gretty-doc/" target="_blank" rel="nofollow">Gradle Gretty Plugin</a> ": 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class="  language-java">plugins <span class="token punctuation"><span class="token punctuation">{</span></span>
    id <span class="token string"><span class="token string">'war'</span></span>
    id <span class="token string"><span class="token string">'org.gretty'</span></span> version <span class="token string"><span class="token string">'2.2.0'</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Крім того, плагін Gretty має хорошу <a href="https://akhikhl.github.io/gretty-doc/" target="_blank" rel="nofollow">документацію</a> . Почнемо з того, що плагін Gretty дозволяє перемикатися між різними веб-серверами. Докладніше це описано в документації: " <a href="http://akhikhl.github.io/gretty-doc/Switching-between-servlet-containers.html" target="_blank" rel="nofollow">Switching between servlet containers</a> ". Переключимося на Tomcat, т.к. він є одним з найпопулярніших у використанні, а також має гарну документацію та безліч прикладів та розібраних проблем: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java">gretty <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token comment"><span class="token comment">// Переключаемся с дефолтного Jetty на Tomcat</span></span>
    servletContainer <span class="token operator"><span class="token operator">=</span></span> <span class="token string"><span class="token string">'tomcat8'</span></span>
    <span class="token comment"><span class="token comment">// Укажем Context Path, он же Context Root</span></span>
    contextPath <span class="token operator"><span class="token operator">=</span></span> <span class="token string"><span class="token string">'/jaas'</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Тепер ми можемо виконати "gradle appRun" і тоді наш веб-додаток буде доступний за адресаою http://localhost:8080/jaas/secret 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="be858cb8-068d-4ee8-a711-22dc58f75f2e" data-max-width="525" alt="JAAS - Введення в технологію (частина 1) - 5" src="https://cdn.javarush.com/images/article/be858cb8-068d-4ee8-a711-22dc58f75f2e/512.jpeg" style="width: 525px;">
 </div>
</div>Важливо перевірити, чи контейнер сервлетів вибраний Tomcat (див. #1) і перевірити, за якою адресаою доступна наша веб-додаток (див. #2). 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="b4421a27-5620-428f-906b-8541aadc6b19" data-max-width="312" alt="JAAS - Введення в технологію (частина 1) - 6" src="https://cdn.javarush.com/images/article/b4421a27-5620-428f-906b-8541aadc6b19/256.jpeg" style="width: 312px;">
 </div>
</div>
<h2>Аутентифікація</h2>Установки автентифікації часто складаються з двох частин: настройок на стороні сервера та настройок на стороні веб-програми, яка працює на цьому сервері. Установки безпеки веб-програми не можуть не взаємодіяти з налаштуваннями безпеки веб-сервера хоча б через те, що веб-програма не може не взаємодіяти з веб-сервером. Ми з Вами недаремно перейшли на Tomcat, т.к. Tomcat має добре описану архітектуру (див. " <a href="https://tomcat.apache.org/tomcat-8.0-doc/architecture/overview.html" target="_blank" rel="nofollow">Apache Tomcat 8 Architecture</a> "). З опису цієї архітектури видно, що Tomcat як веб-сервер представляє веб-додаток як деякий контекст, який і називають <a href="https://tomcat.apache.org/tomcat-8.0-doc/config/context.html" target="_blank" rel="nofollow">Tomcat Context</a><a href="https://www.mulesoft.com/tcat/tomcat-context" target="_blank" rel="nofollow">". Цей контекст дозволяє кожному веб-додатку мати свої налаштування, ізольовані</a> від інших веб-додатків. Крім того, веб-додаток може впливати на налаштування цього контексту. Гнучко і зручно. Для більш глибокого розуміння рекомендується до читання стаття " " і розділ документації Tomcat " <a href="https://tomcat.apache.org/tomcat-8.0-doc/config/context.html" target="_blank" rel="nofollow">The Context Container</a> ". Як вище було сказано, наш веб-додаток може впливати на Tomcat Context нашої програми за допомогою файлу <code class=" language-none">/META-INF/context.xml</code>. І однією з дуже важливих налаштувань, на яку ми можемо вплинути, є Security Realms. <strong>Security Realms</strong>- Це деяка "область безпеки". Область, для якої вказано певні параметри безпеки. Відповідно, використовуючи Security Realm, ми застосовуємо налаштування безпеки, визначені для цього Realm. Security Realms управляються контейнером, тобто. веб-сервером, а не нашим веб-програмою. Ми можемо тільки розповісти серверу, яку з областей безпеки потрібно поширити на наш додаток. Документація Tomcat у розділі " <a href="https://tomcat.apache.org/tomcat-8.0-doc/config/realm.html" target="_blank" rel="nofollow">The Realm Component</a> " описує Realm як набір даних про користувачів та їх ролі для виконання аутентифікації. Tomcat надає набір різних реалізацій Security Realm'ів, одним з яких є " <a href="https://tomcat.apache.org/tomcat-8.0-doc/config/realm.html#JAAS_Realm_-_org.apache.catalina.realm.JAASRealm" target="_blank" rel="nofollow">Jaas Realm</a> ". Розібравшись трохи з термінологією, давайте опишемо Tomcat Context у файлі <code class=" language-none">/META-INF/context.xml</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">?</span></span>xml version<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"1.0"</span></span> encoding<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"UTF-8"</span></span><span class="token operator"><span class="token operator">?</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
<span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Context</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span>
    <span class="token operator"><span class="token operator">&lt;</span></span><span class="token class-name"><span class="token class-name">Realm</span></span> className<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"org.apache.catalina.realm.JAASRealm"</span></span>
           appName<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"JaasLogin"</span></span>
           userClassNames<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"jaas.login.UserPrincipal"</span></span>
           roleClassNames<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"jaas.login.RolePrincipal"</span></span>
           configFile<span class="token operator"><span class="token operator">=</span></span><span class="token string"><span class="token string">"jaas.config"</span></span> <span class="token operator"><span class="token operator">/</span></span><span class="token operator"><span class="token operator">&gt;</span></span>
<span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span><span class="token class-name"><span class="token class-name">Context</span></span><span class="token operator"><span class="token operator">&gt;</span></span></code></pre><code class=" language-none">appName</code>- Ім'я додаток (application name). Tomcat спробує зіставити це ім'я з іменами, вказаними у <code class=" language-none">configFile</code>. <code class=" language-none">configFile</code>- Це "login configuration file". Його приклад можна побачити в документації JAAS: " <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jaas/JAASRefGuide.html#AppendixB" target="_blank" rel="nofollow">Appendix B: Example Login Configurations</a> ". Крім того, важливо, що файл буде шукатися спочатку в ресурсах. Тому наш веб-додаток може сам надати цей файл. Атрибути <code class=" language-none">userClassNames</code>і <code class=" language-none">roleClassNames</code>містять вказівку на класи, які є принципал користувача. JAAS поділяє поняття "користувач" і "роль" як два різні <code class=" language-none">java.security.Principal</code>. Давайте опишемо вказані вище класи. Створимо найпростішу реалізацію для принципала користувача: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">UserPrincipal</span></span> <span class="token keyword"><span class="token keyword">implements</span></span> <span class="token class-name"><span class="token class-name">Principal</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">String</span></span> name<span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">UserPrincipal</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> name<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>name <span class="token operator"><span class="token operator">=</span></span> name<span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">String</span></span> <span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">return</span></span> name<span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Таку ж реалізацію повторимо і для <code class=" language-none">RolePrincipal</code>. Як Ви могли побачити по інтерфейсу, головне для Principal – зберігати та повертати деяке ім'я (або ID), що представляють Principal. Тепер у нас є Security Realm, є класи принципалів. Залишилося заповнити файл з атрибуту " <code class=" language-none">configFile</code>", він же <code class=" language-none">login configuration file</code>. Його опис можна знайти в документації до Tomcat: " <a href="https://tomcat.apache.org/tomcat-8.0-doc/config/realm.html" target="_blank" rel="nofollow">The Realm Component</a> ". 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="089987fe-c778-40ed-b2cb-2659b36cb0e2" data-max-width="1024" alt="JAAS - Введення в технологію (частина 1) - 7" src="https://cdn.javarush.com/images/article/089987fe-c778-40ed-b2cb-2659b36cb0e2/1024.jpeg" style="width: 1024px;">
 </div>
</div>Тобто ми можемо помістити налаштування JAAS Login Config у ресурси своєї веб-додатки і завдяки Tomcat Context'у ми зможемо його використовувати. Даний файл повинен бути доступний як ресурс для ClassLoader'а, тому його шлях повинен бути таким: <code class=" language-none">\src\main\resources\jaas.config</code> Задамо вміст файлу: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">JaasLogin</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token class-name"><span class="token namespace"></span><span class="token class-name"><span class="token namespace"><span class="token namespace">jaas<span class="token punctuation"><span class="token punctuation">.</span></span>login<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>JaasLoginModule</span></span> required debug<span class="token operator"><span class="token operator">=</span></span><span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Варто звернути увагу, що тут і використано <code class=" language-none">context.xml</code>однакове ім'я. Таким чином Security Realm зіставляється з LoginModule. Отже, Tomcat Context повідомив, які класи представляють принципали, а також який LoginModule використовувати. Нам залишилося лише реалізувати цей LoginModule. <strong>LoginModule</strong> - це, мабуть, одна з найцікавіших речей у JAAS. У розробці LoginModule нам допоможе офіційна документація: " <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jaas/JAASLMDevGuide.html#Step_1" target="_blank" rel="nofollow">Java Authentication and Authorization Service (JAAS): LoginModule Developer's Guide</a> ". Давайте реалізуємо логін модуль. Створимо клас, який реалізує інтерфейс <code class=" language-none">LoginModule</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">JaasLoginModule</span></span> <span class="token keyword"><span class="token keyword">implements</span></span> <span class="token class-name"><span class="token class-name">LoginModule</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Спочатку опишемо метод ініціалізації <code class=" language-none">LoginModule</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">CallbackHandler</span></span> handler<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Subject</span></span> subject<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">initialize</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Subject</span></span> subject<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">CallbackHandler</span></span> callbackHandler<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token operator"><span class="token operator">?</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> sharedState<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Map</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token operator"><span class="token operator">?</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> options<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	handler <span class="token operator"><span class="token operator">=</span></span> callbackHandler<span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>subject <span class="token operator"><span class="token operator">=</span></span> subject<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Даний метод збереже <code class=" language-none">Subject</code>, який ми далі аутентифікуємо та заповнимо інформацією про принципали. А так само збережемо для подальшого використання <code class=" language-none">CallbackHandler</code>, який нам передають. За допомогою <code class=" language-none">CallbackHandler</code>ми зможемо запитати різну інформацію про суб'єкта автентифікації трохи пізніше. Докладніше <code class=" language-none">CallbackHandler</code>можна прочитати у відповідному розділі документації: " <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jaas/JAASRefGuide.html#CallbackHandler" target="_blank" rel="nofollow">JAAS Reference Guide: CallbackHandler</a> ". Далі виконується метод <code class=" language-none">login</code>для аутентифікації <code class=" language-none">Subject</code>. Це перша фаза аутентифікації: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">boolean</span></span> <span class="token function"><span class="token function">login</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">LoginException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token comment"><span class="token comment">// Добавляем колбэки</span></span>
	<span class="token class-name"><span class="token class-name">Callback</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> callbacks <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Callback</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token number"><span class="token number">2</span></span><span class="token punctuation"><span class="token punctuation">]</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	callbacks<span class="token punctuation"><span class="token punctuation">[</span></span><span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">NameCallback</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"login"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	callbacks<span class="token punctuation"><span class="token punctuation">[</span></span><span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">PasswordCallback</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"password"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token comment"><span class="token comment">// При помощи колбэков получаем через CallbackHandler логин и пароль</span></span>
	<span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		handler<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">handle</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>callbacks<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token class-name"><span class="token class-name">String</span></span> name <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">NameCallback</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> callbacks<span class="token punctuation"><span class="token punctuation">[</span></span><span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">]</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token class-name"><span class="token class-name">String</span></span> password <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">valueOf</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">PasswordCallback</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> callbacks<span class="token punctuation"><span class="token punctuation">[</span></span><span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">]</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getPassword</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token comment"><span class="token comment">// Далее выполняем валидацию.</span></span>
		<span class="token comment"><span class="token comment">// Тут просто для примера проверяем определённые значения</span></span>
		<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>name <span class="token operator"><span class="token operator">!=</span></span> <span class="token keyword"><span class="token keyword">null</span></span> <span class="token operator"><span class="token operator">&amp;&amp;</span></span> name<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">equals</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"user123"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">&amp;&amp;</span></span> password <span class="token operator"><span class="token operator">!=</span></span> <span class="token keyword"><span class="token keyword">null</span></span> <span class="token operator"><span class="token operator">&amp;&amp;</span></span> password<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">equals</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"pass123"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token comment"><span class="token comment">// Сохраняем информацию, которая будет использована в методе commit</span></span>
			<span class="token comment"><span class="token comment">// Не "пачкаем" Subject, т.к. не факт, что commit выполнится</span></span>
			<span class="token comment"><span class="token comment">// Для примера проставим группы вручную, "хардкодно".</span></span>
			login <span class="token operator"><span class="token operator">=</span></span> name<span class="token punctuation"><span class="token punctuation">;</span></span>
			userGroups <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ArrayList</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			userGroups<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">add</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"admin"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token keyword"><span class="token keyword">return</span></span> <span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">else</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token keyword"><span class="token keyword">throw</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">LoginException</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Authentication failed"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">IOException</span></span> <span class="token operator"><span class="token operator">|</span></span> <span class="token class-name"><span class="token class-name">UnsupportedCallbackException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">throw</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">LoginException</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>e<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getMessage</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Важливо, що <code class=" language-none">login</code>ми не повинні змінювати об'єкт <code class=" language-none">Subject</code>. Такі зміни мають відбуватися лише у методі підтвердження <code class=" language-none">commit</code>. Далі ми маємо описати метод підтвердження успішної аутентифікації: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">boolean</span></span> <span class="token function"><span class="token function">commit</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">LoginException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	userPrincipal <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">UserPrincipal</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>login<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	subject<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getPrincipals</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">add</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>userPrincipal<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>userGroups <span class="token operator"><span class="token operator">!=</span></span> <span class="token keyword"><span class="token keyword">null</span></span> <span class="token operator"><span class="token operator">&amp;&amp;</span></span> userGroups<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">size</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">&gt;</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> groupName <span class="token operator"><span class="token operator">:</span></span> userGroups<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			rolePrincipal <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">RolePrincipal</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>groupName<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			subject<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getPrincipals</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">add</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>rolePrincipal<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token keyword"><span class="token keyword">return</span></span> <span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Може здатися дивним поділ методу <code class=" language-none">login</code>та <code class=" language-none">commit</code>. Але річ у тому, що login модулі можуть бути об'єднані. І для успішної аутентифікації може бути необхідно, щоб успішно відпрацювало кілька логін модулів. І лише якщо відпрацюють усі потрібні модулі – тоді зберігати зміни. Це другий фазою аутентифікації. Завершимо методами <code class=" language-none">abort</code>і <code class=" language-none">logout</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">boolean</span></span> <span class="token function"><span class="token function">abort</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">LoginException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">return</span></span> <span class="token boolean"><span class="token boolean">false</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">boolean</span></span> <span class="token function"><span class="token function">logout</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">LoginException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	subject<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getPrincipals</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">remove</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>userPrincipal<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	subject<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getPrincipals</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">remove</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>rolePrincipal<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token keyword"><span class="token keyword">return</span></span> <span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Метод <code class=" language-none">abort</code>викликається тоді, коли завершилася невдачею перша фаза автентифікації. Метод <code class=" language-none">logout</code>викликається при виході із системи. Реалізувавши свій <code class=" language-none">Login Module</code>і настроївши <code class=" language-none">Security Realm</code>, Тепер нам треба вказати в <code class=" language-none">web.xml</code>той факт, що ми хочемо використовувати певний <code class=" language-none">Login Config</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token operator"><span class="token operator">&lt;</span></span>login<span class="token operator"><span class="token operator">-</span></span>config<span class="token operator"><span class="token operator">&gt;</span></span>
  <span class="token operator"><span class="token operator">&lt;</span></span>auth<span class="token operator"><span class="token operator">-</span></span>method<span class="token operator"><span class="token operator">&gt;</span></span>BASIC<span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>auth<span class="token operator"><span class="token operator">-</span></span>method<span class="token operator"><span class="token operator">&gt;</span></span>
  <span class="token operator"><span class="token operator">&lt;</span></span>realm<span class="token operator"><span class="token operator">-</span></span>name<span class="token operator"><span class="token operator">&gt;</span></span><span class="token class-name"><span class="token class-name">JaasLogin</span></span><span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>realm<span class="token operator"><span class="token operator">-</span></span>name<span class="token operator"><span class="token operator">&gt;</span></span>
<span class="token operator"><span class="token operator">&lt;</span></span><span class="token operator"><span class="token operator">/</span></span>login<span class="token operator"><span class="token operator">-</span></span>config<span class="token operator"><span class="token operator">&gt;</span></span></code></pre> Ми вказали ім'я нашого Security Realm і вказали Authentication Method - BASIC. Це один із видів аутентифікації, описаних у Servlet API у розділі " <a href="https://javaee.github.io/servlet-spec/downloads/servlet-3.1/Final/servlet-3_1-final.pdf#page=158&amp;zoom=100,0,185" target="_blank" rel="nofollow">13.6 Authentication</a> ". Залишився п