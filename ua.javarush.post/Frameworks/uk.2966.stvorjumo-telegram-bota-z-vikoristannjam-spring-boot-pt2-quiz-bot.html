Створюємо телеграм-бота з використанням Spring Boot Pt.2: Quiz Bot
<p>----------------------------------------</p>
Алоха! ми створили простий робот, який вітав нас на будь-яку подію. Ми вже написали не одну тисячу рядків коду, і настав час додати нашому боту складніший функціонал. Сьогодні ми спробуємо написати простенького бота, щоб у вільний час відто
<p>----------------------------------------</p>
<a href="https://codegym.cc/groups/posts/2959-sozdaem-telegram-bota-s-ispoljhzovaniem-spring-boot" target="_blank" rel="nofollow">ЧАСТИНА 1</a> Алоха! <a href="https://codegym.cc/groups/posts/2959-sozdaem-telegram-bota-s-ispoljhzovaniem-spring-boot" target="_blank" rel="nofollow">У попередній статті</a> ми створабо простий робот, який вітав нас на будь-яку подію. Ми вже написали не одну тисячу рядків коду, і настав час додати нашому боту складніший функціонал. Сьогодні ми спробуємо написати простенького бота, щоб у вільний час відточувати свої знання Java Core перед співбесідами (дивно, але жодного робочого бота такого роду я не знайшов). Для цього ми зробимо таке:
<ul>
 <li>підключимо зовнішню базу даних Postgres на Heroku;</li>
 <li>напишемо свої перші скрипти для ініціалізації та заповнення бази даних;</li>
 <li>підключимо Spring Boot Data JPA для роботи з базою даних;</li>
 <li>реалізуємо різні сценарії поведінки робота.</li>
</ul>Якщо це вам цікаво, і дочитавши статтю, ви не захочете кидатися тухлими помідорами, то ставте зірочку в <a href="https://github.com/whiskels/TelegramNotifierBot" target="_blank" rel="nofollow">моєму репозиторії</a> , мені буде приємно! У разі виникнення питань — обговоримо їх у коментарях. Ось що ми отримаємо в результаті: <img width="800" height="500" data-id="70c8b59c-16d3-4810-8bf3-4b44418793ed" alt="Створюємо телеграм-бота з використанням Spring Boot Pt.2: Quiz Bot - 1" src="https://cdn.javarush.com/images/article/70c8b59c-16d3-4810-8bf3-4b44418793ed/1080.jpeg"><img width="800" height="500" data-id="9f5d0b77-018c-426e-a63c-17453b989e6a" alt="Створюємо телеграм-бота з використанням Spring Boot Pt.2: Quiz Bot - 2" src="https://cdn.javarush.com/images/article/9f5d0b77-018c-426e-a63c-17453b989e6a/1080.jpeg"><img width="800" height="500" data-id="f7caf1eb-a333-4c49-9ec2-b1e018348bdb" alt="Створюємо телеграм-бота з використанням Spring Boot Pt.2: Quiz Bot - 3" src="https://cdn.javarush.com/images/article/f7caf1eb-a333-4c49-9ec2-b1e018348bdb/1080.jpeg">&lt;h2&gt;Отже, поїхали!&lt;/h2&gt;&lt;h3&gt;Створення бази даних на Heroku&lt;/h3&gt;Почнемо з того, що створимо свою першу зовнішню базу даних. Для локальної роботи я рекомендую ознайомитись з <a href="https://www.pgadmin.org/" target="_blank" rel="nofollow">pgAdmin</a> . Але я хочу, щоб ви орієнтувалися на те, що в майбутньому деплоїте бота на Heroku, щоб він не залежав від вашої локальної машини, а для цього давайте познайомимося з цим сервісом. Порядок дій:
<ul>
 <li>реєструємось на <a href="https://www.heroku.com/" target="_blank" rel="nofollow">Heroku</a> ;</li>
 <li>Заходимо в наш <a href="https://dashboard.heroku.com/apps" target="_blank" rel="nofollow">dashboard</a> -&gt; New -&gt; Create new app і створюємо новий додаток;</li>
 <li>Заходимо в нову програму, лякаємося безлічі кнопок, але концентруємося на панелі "Installed add-ons" - поряд з нею є кнопка Configure Add-ons, її ми і натискаємо;</li>
 <li>У пошук вводимо "Heroku Postgres", вибираємо план "Hobby Dev - Free" -&gt; Submit Order Form;</li>
 <li>Відкриваємо свіжоотриману базу даних -&gt; Settings -&gt; View Credentials. На цій вкладці будуть ключі для доступу до бази даних. Запам'ятовуємо їх розташування - вони нам знадобляться, щоб підключити базу даних, як DataSource в IDEA.</li>
</ul>&lt;h3&gt;Додаємо залежності в pom.xml&lt;/h3&gt;У рамках роботи над нашим ботом, додамо в наш pom наступні залежності: Lombok, Spring Boot Data JPA, PostgreSQL. Стоп! Що це таке і навіщо ми це додаємо?
<ul>
 <li><a href="https://projectlombok.org/" target="_blank" rel="nofollow">Lombok</a> — бібліотека, завдяки якій ми зменшимо кількість різного коду. З його допомогою ми можемо автоматично створювати конструктори, сетери, гетери та багато іншого.</li>
 <li><a href="https://spring.io/projects/spring-data-jpa" target="_blank" rel="nofollow">Spring Data JPA</a> – <a href="https://codegym.cc/groups/posts/2953-iz-rezjume-dzhuna-hibernate--freymvork-dlja-rabotih-s-bazami-dannihkh" target="_blank" rel="nofollow">фреймворк для роботи з базами даних</a> (хоча це звучить надто просто). Опис можливостей Spring Data JPA тягне на цикл статей, а вказана нами залежність ще тягне з собою Hibernate та багато іншого, так що опустимо подробиці та просто спробуємо сьогодні щось написати з використанням Spring JPA.</li>
 <li>PostgreSQL - тягнемо бібліотеку для отримання драйвера, який працюватиме з нашою базою даних.</li>
</ul>Наш pom.xml починає виглядати так: Properties: <img width="800" height="500" data-id="3057df74-6fb8-4b59-8d96-4ddede814484" alt="Створюємо телеграм-бота з використанням Spring Boot Pt.2: Quiz Bot - 1" src="https://cdn.javarush.com/images/article/3057df74-6fb8-4b59-8d96-4ddede814484/1080.jpeg">Dependencies: <img width="800" height="500" data-id="63ba3dfe-08d8-4389-b486-618e937790fa" alt="Створюємо телеграм-бота з використанням Spring Boot Pt.2: Quiz Bot - 2" src="https://cdn.javarush.com/images/article/63ba3dfe-08d8-4389-b486-618e937790fa/1080.jpeg">Якщо ви не читали попередню статтю, врахуйте, що тут ми додаємо нові залежності, так що це не повна структура pom.xml. Не забуваємо підвантажити ці залежності в наш проект (наприклад, зайшовши у віконце Maven -&gt; Reimport all Maven projects <a href="https://stackoverflow.com/a/45948177" target="_blank" rel="nofollow">)</a> . Після додавання плагіна нам потрібно налаштувати DataSource. Для цього спочатку увімкнемо відображення плагіна: View -&gt; Tool Windows -&gt; DB Browser. У вікні натискаємо на зелений плюс (new connection) -&gt; PostgreSQL. Тут нам знадобляться credentials, які ми вже бачабо на Heroku. Заповнюємо вікно:<img width="800" height="500" data-id="4cf0e6b4-57d9-487c-8b8b-9a08ffe95d0f" alt="Створюємо телеграм-бота з використанням Spring Boot Pt.2: Quiz Bot - 3" src="https://cdn.javarush.com/images/article/4cf0e6b4-57d9-487c-8b8b-9a08ffe95d0f/1080.jpeg">І натискаємо "Test Connection". Якщо все зроблено правильно — з'явиться вікно, що спливає, про успішне виконання підключення до бази даних. Зберігаємо наш Data Source.&lt;h3&gt;Створюємо таблиці в базі даних&lt;/h3&gt;Тепер давайте створимо таблиці, з якими ми працюватимемо. Спочатку встановимо собі <a href="https://www.postgresql.org/" target="_blank" rel="nofollow">PostgreSQL</a> . Після встановлення створимо файл initDB.sql у папці src/main/resources: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">DROP TABLE IF <span class="token class-name">EXISTS</span> java_quiz<span class="token punctuation">;</span>
DROP TABLE IF <span class="token class-name">EXISTS</span> users<span class="token punctuation">;</span>
CREATE SEQUENCE global_seq START <span class="token class-name">WITH</span> <span class="token number">100000</span><span class="token punctuation">;</span>

CREATE <span class="token class-name">TABLE</span> users
<span class="token punctuation">(</span>
    id         INTEGER PRIMARY KEY <span class="token class-name">DEFAULT</span> <span class="token function">nextval</span><span class="token punctuation">(</span><span class="token string">'global_seq'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    chat_id    INTEGER UNIQUE                <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
    name       VARCHAR                       <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
    score      INTEGER             DEFAULT <span class="token number">0</span> <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
    high_score INTEGER             DEFAULT <span class="token number">0</span> <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
    bot_state  VARCHAR                       <span class="token class-name">NOT</span> NULL
<span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE <span class="token class-name">TABLE</span> java_quiz
<span class="token punctuation">(</span>
    id             INTEGER PRIMARY KEY <span class="token class-name">DEFAULT</span> <span class="token function">nextval</span><span class="token punctuation">(</span><span class="token string">'global_seq'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    question       VARCHAR <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
    answer_correct VARCHAR <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
    option1        VARCHAR <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
    option2        VARCHAR <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
    option3        VARCHAR <span class="token class-name">NOT</span> NULL
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Що робить наш скрипт? Перші два рядки стирають таблиці за наявності, щоб виконати їхнє повторне створення. У третьому рядку створюється послідовність, яка буде використовуватися для створення унікальних id записів до нашої бази даних. Далі ми створюємо дві таблиці: для користувачів та питань. У користувача буде унікальний id, id телеграм чату, ім'я, кількість очок (поточна та максимальна), а також поточний статус бота. У питаннях також буде унікальний id, а також поля, які відповідають за питання та варіанти відповіді до нього. Отриманий скрипт ми можемо виконати, натиснувши правою кнопкою миші і вибравши "Execute SQL Script". Особливу увагу варто приділити пункту "Cmd-Line interface" - тут нам знадобиться новий PostgreSQL. При конфігуруванні цього поля вибираємо "New Cmd-Line interface" та вказуємо шлях до psql.exe. У результаті налаштування мають виглядати приблизно так:<img width="800" height="500" data-id="5f849062-b791-4a5f-b3a7-814554692842" alt="Створюємо телеграм-бота з використанням Spring Boot Pt.2: Quiz Bot - 4" src="https://cdn.javarush.com/images/article/5f849062-b791-4a5f-b3a7-814554692842/1080.jpeg">Виконуємо скрипт і якщо ми ніде не помаболися, результат нашої роботи буде наступним: <img width="800" height="500" data-id="90abcf80-f2d5-4d4a-accc-7ddd1cbf3e4f" alt="Створюємо телеграм-бота з використанням Spring Boot Pt.2: Quiz Bot - 8" src="https://cdn.javarush.com/images/article/90abcf80-f2d5-4d4a-accc-7ddd1cbf3e4f/1080.jpeg">&lt;h3&gt;Створюємо модель&lt;/h3&gt;Тепер час повертатися до написання Java коду. Для скорочення статті я опущу опис анотацій, які були використані для написання класів, щоб ви могли самі з ними ознайомитися. Створимо пакет model, у якому у нас буде три класи:
<ul>
 <li><span>AbstractBaseEntity</span> - клас, що описує будь-який об'єкт, у якого може бути id (цей клас - сильне спрощення того, що ви можете побачити на стажуванні): 
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Setter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token comment">// Аннотация, которая говорит нам, что это суперкласс для всех Entity</span>
<span class="token comment">// https://vladmihalcea.com/how-to-inherit-properties-from-a-base-class-entity-using-mappedsuperclass-with-jpa-and-hibernate/</span>
<span class="token annotation punctuation">@MappedSuperclass</span>
<span class="token comment">// http://stackoverflow.com/questions/594597/hibernate-annotations-which-is-better-field-or-property-access</span>
<span class="token annotation punctuation">@Access</span><span class="token punctuation">(</span><span class="token class-name">AccessType</span><span class="token punctuation">.</span>FIELD<span class="token punctuation">)</span>

<span class="token comment">// Аннотации Lombok для автогенерации сеттеров и геттеров на все поля</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractBaseEntity</span> <span class="token punctuation">{</span>

<span class="token comment">// Аннотации, описывающие механизм генерации id - разберитесь в документации каждой!</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@SequenceGenerator</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"global_seq"</span><span class="token punctuation">,</span> sequenceName <span class="token operator">=</span> <span class="token string">"global_seq"</span><span class="token punctuation">,</span> allocationSize <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> initialValue <span class="token operator">=</span> START_SEQ<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>SEQUENCE<span class="token punctuation">,</span> generator <span class="token operator">=</span> <span class="token string">"global_seq"</span><span class="token punctuation">)</span>
<span class="token comment">//  See https://hibernate.atlassian.net/browse/HHH-3718 and https://hibernate.atlassian.net/browse/HHH-12034</span>
<span class="token comment">//  Proxy initialization when accessing its identifier managed now by JPA_PROXY_COMPLIANCE setting</span>
    <span class="token keyword">protected</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token class-name">AbstractBaseEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></li>
 <li><span>User</span> : 
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot<span class="token punctuation">.</span></span><span class="token class-name">State</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Setter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">BatchSize</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>constraints<span class="token punctuation">.</span></span><span class="token class-name">NotBlank</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>constraints<span class="token punctuation">.</span></span><span class="token class-name">NotNull</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">FetchType</span><span class="token punctuation">.</span>EAGER<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"users"</span><span class="token punctuation">,</span> uniqueConstraints <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@UniqueConstraint</span><span class="token punctuation">(</span>columnNames <span class="token operator">=</span> <span class="token string">"chat_id"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"users_unique_chatid_idx"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBaseEntity</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"chat_id"</span><span class="token punctuation">,</span> unique <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> chatId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"name"</span><span class="token punctuation">,</span> unique <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NotBlank</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"score"</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> score<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"high_score"</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> highScore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"bot_state"</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NotBlank</span>
    <span class="token keyword">private</span> <span class="token class-name">State</span> botState<span class="token punctuation">;</span>

<span class="token comment">// Конструктор нужен для создания нового пользователя (а может и нет? :))</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token keyword">int</span> chatId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatId <span class="token operator">=</span> chatId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>highScore <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>botState <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">.</span>START<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></li>
 <li>Клас <span>Question</span> : 
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Setter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Column</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Entity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>constraints<span class="token punctuation">.</span></span><span class="token class-name">NotBlank</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"java_quiz"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Question</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBaseEntity</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"question"</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NotBlank</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> question<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"answer_correct"</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NotBlank</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> correctAnswer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"option2"</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NotBlank</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> optionOne<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"option1"</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NotBlank</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> optionTwo<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"option3"</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NotBlank</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> optionThree<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"Question{"</span> <span class="token operator">+</span>
                <span class="token string">"question='"</span> <span class="token operator">+</span> question <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", correctAnswer='"</span> <span class="token operator">+</span> correctAnswer <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", optionOne='"</span> <span class="token operator">+</span> optionOne <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", optionTwo='"</span> <span class="token operator">+</span> optionTwo <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", optionThree='"</span> <span class="token operator">+</span> optionThree <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></li>
</ul>&lt;h3&gt;Створюємо репозиторії&lt;/h3&gt;Тепер напишемо репозиторії Spring Data Jpa. Створюємо пакет repository, в якому будуть два <em>інтерфейси</em> : JpaUserRepository, JpaQuestionRepository. Вони успадковуватимуться від JpaRepository - інтерфейсу Spring Data, який дозволяє нам практично творити магію. Для розуміння їх роботи рекомендую переглянути <a href="https://www.youtube.com/watch?v=nwM7A4TwU3M" target="_blank" rel="nofollow">відео Євгена Борисова</a> . Класи будуть дуже маленькі:
<ul>
 <li>JpaUserRepository: 
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>repository</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">JpaRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Repository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Repository</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">JpaUserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token operator">&lt;</span>user<span class="token punctuation">,</span> integer<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// По названию метода Spring сам поймет, что мы хотим получить пользователя по переданному chatId</span>
    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span>user<span class="token punctuation">&gt;</span></span> <span class="token function">getByChatId</span><span class="token punctuation">(</span><span class="token keyword">int</span> chatId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>user<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>user<span class="token punctuation">,</span><span class="token operator">&gt;</span></code></pre></li>
 <li>JpaQuestionRepository: 
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>repository</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Question</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">JpaRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">Query</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Repository</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">JpaQuestionRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token operator">&lt;</span>question<span class="token punctuation">,</span> integer<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// А здесь мы написали SQL Query, которая будет выбирать 1 случайный вопрос из таблицы вопросов</span>
    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"SELECT *  FROM java_quiz ORDER BY random() LIMIT 1"</span><span class="token punctuation">)</span>
    <span class="token class-name">Question</span> <span class="token function">getRandomQuestion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>question<span class="token punctuation">,</span><span class="token operator">&gt;</span></code></pre></li>
</ul>&lt;h3&gt;Додаємо функціонал боту&lt;/h3&gt;У класі <span>User</span> ми маємо поле ще не створеного класу <span>State</span> , яке буде повідомляти нам про те, на якому етапі роботи з ботом користувач зараз знаходиться. Давайте його створимо у пакеті /bot: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    NONE<span class="token punctuation">,</span>
    START<span class="token punctuation">,</span>
    ENTER_NAME<span class="token punctuation">,</span>
    PLAYING_QUIZ<span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre> Далі ми створимо пакет bot/handler, у якому оголосимо інтерфейс handler: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot<span class="token punctuation">.</span>handler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot<span class="token punctuation">.</span></span><span class="token class-name">State</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">PartialBotApiMethod</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>

<span class="token comment">// основной метод, который будет обрабатывать действия пользователя</span>
    <span class="token class-name">List</span><span class="token operator">&lt;</span>partialbotapimethod<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span><span class="token operator">=</span><span class="token string">""</span> serializable<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;&gt;</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// метод, который позволяет узнать, можем ли мы обработать текущий State у пользователя</span>
    <span class="token class-name">State</span> <span class="token function">operatedBotState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// метод, который позволяет узнать, якие команды CallBackQuery мы можем обработать в этом классе</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>string<span class="token punctuation">&gt;</span></span> <span class="token function">operatedCallBackQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>string<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>partialbotapimethod<span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span></code></pre> Обробники ми створимо трохи пізніше, а поки що давайте делегуємо обробку подій новому класу <span>UpdateReceiver</span> , який ми створимо в корені пакету bot: <span>УВАГА! </span>Тут і далі будуть методи, які відображаються як List&gt; handle (args); насправді вони виглядають так, але форматтер коду їх зламав:<img width="800" height="500" data-id="39dedfac-cba4-4f72-a1c1-c571e2915413" alt="Створюємо телеграм-бота з використанням Spring Boot Pt.2: Quiz Bot - 6" src="https://cdn.javarush.com/images/article/39dedfac-cba4-4f72-a1c1-c571e2915413/1080.jpeg">
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">Handler</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">JpaUserRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">PartialBotApiMethod</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">CallbackQuery</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Message</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Update</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UpdateReceiver</span> <span class="token punctuation">{</span>
    <span class="token comment">// Храним доступные хендлеры в списке (подсмотрел у Miroha)</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>handler<span class="token punctuation">&gt;</span></span> handlers<span class="token punctuation">;</span>
    <span class="token comment">// Имеем доступ в базу пользователей</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JpaUserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UpdateReceiver</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>handler<span class="token punctuation">&gt;</span></span> handlers<span class="token punctuation">,</span> <span class="token class-name">JpaUserRepository</span> userRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handlers <span class="token operator">=</span> handlers<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Обрабатываем полученный Update</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>partialbotapimethod<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span><span class="token operator">=</span><span class="token string">""</span> serializable<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;&gt;</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// try-catch, чтобы при несуществующей команде просто возвращать пустой список</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// Проверяем, если Update - сообщение с текстом</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMessageWithText</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Получаем Message из Update</span>
                <span class="token keyword">final</span> <span class="token class-name">Message</span> message <span class="token operator">=</span> update<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Получаем айди чата с пользователем</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> chatId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Просим у репозитория пользователя. Если такого пользователя нет - создаем нового и возвращаем его.</span>
                <span class="token comment">// Как раз на случай нового пользователя мы и сделали конструктор с одним параметром в классе User</span>
                <span class="token keyword">final</span> <span class="token class-name">User</span> user <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">getByChatId</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">orElseGet</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Ищем нужный обработчик и возвращаем результат его работы</span>
                <span class="token keyword">return</span> <span class="token function">getHandlerByState</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getBotState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">.</span><span class="token function">hasCallbackQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">CallbackQuery</span> callbackQuery <span class="token operator">=</span> update<span class="token punctuation">.</span><span class="token function">getCallbackQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> chatId <span class="token operator">=</span> callbackQuery<span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">User</span> user <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">getByChatId</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">orElseGet</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token function">getHandlerByCallBackQuery</span><span class="token punctuation">(</span>callbackQuery<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> callbackQuery<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedOperationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Handler</span> <span class="token function">getHandlerByState</span><span class="token punctuation">(</span><span class="token class-name">State</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> handlers<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>h <span class="token operator">-&gt;</span> h<span class="token punctuation">.</span><span class="token function">operatedBotState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>h <span class="token operator">-&gt;</span> h<span class="token punctuation">.</span><span class="token function">operatedBotState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token class-name">UnsupportedOperationException</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Handler</span> <span class="token function">getHandlerByCallBackQuery</span><span class="token punctuation">(</span><span class="token class-name">String</span> query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> handlers<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>h <span class="token operator">-&gt;</span> h<span class="token punctuation">.</span><span class="token function">operatedCallBackQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>query<span class="token operator">::</span><span class="token function">startsWith</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token class-name">UnsupportedOperationException</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isMessageWithText</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>update<span class="token punctuation">.</span><span class="token function">hasCallbackQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> update<span class="token punctuation">.</span><span class="token function">hasMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> update<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>partialbotapimethod<span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>handler<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>handler<span class="token operator">&gt;</span></code></pre> І делегуємо йому обробку у класі Bot: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>bots<span class="token punctuation">.</span></span><span class="token class-name">TelegramLongPollingBot</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">PartialBotApiMethod</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>methods<span class="token punctuation">.</span>send<span class="token punctuation">.</span></span><span class="token class-name">SendMessage</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Update</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span></span><span class="token class-name">TelegramApiException</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Bot</span> <span class="token keyword">extends</span> <span class="token class-name">TelegramLongPollingBot</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${bot.name}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> botUsername<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${bot.token}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> botToken<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UpdateReceiver</span> updateReceiver<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Bot</span><span class="token punctuation">(</span><span class="token class-name">UpdateReceiver</span> updateReceiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>updateReceiver <span class="token operator">=</span> updateReceiver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onUpdateReceived</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token operator">&lt;</span>partialbotapimethod<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span><span class="token operator">=</span><span class="token string">""</span> serializable<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;&gt;</span> messagesToSend <span class="token operator">=</span> updateReceiver<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>messagesToSend <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>messagesToSend<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            messagesToSend<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>response <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token keyword">instanceof</span> <span class="token class-name">SendMessage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">executeWithExceptionCheck</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SendMessage</span><span class="token punctuation">)</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeWithExceptionCheck</span><span class="token punctuation">(</span><span class="token class-name">SendMessage</span> sendMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">execute</span><span class="token punctuation">(</span>sendMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TelegramApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"oops"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>partialbotapimethod<span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span></code></pre> Тепер наш бот делегує обробку подій класу <span>UpdateReceiver</span> , але обробників у нас ще немає. Давайте їх створимо! DISCLAIMER! Мені дуже хотілося поділитися можливостями написання такого бота, тому подальший код (як у принципі і код UpdateReceiver) можна дуже добре відрефакторити із застосуванням різних патернів. Але ми вчимося і наша мета - мінімально життєздатний бот, так що ще одним домашнім завданням можна відрефакторити все, що ви побачабо :) Створюємо пакет util, а в ньому - клас <span>TelegramUtil</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>methods<span class="token punctuation">.</span>send<span class="token punctuation">.</span></span><span class="token class-name">SendMessage</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>replykeyboard<span class="token punctuation">.</span>buttons<span class="token punctuation">.</span></span><span class="token class-name">InlineKeyboardButton</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TelegramUtil</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SendMessage</span> <span class="token function">createMessageTemplate</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">createMessageTemplate</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Создаем шаблон SendMessage с включенным Markdown</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SendMessage</span> <span class="token function">createMessageTemplate</span><span class="token punctuation">(</span><span class="token class-name">String</span> chatId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setChatId</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">enableMarkdown</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Создаем кнопку</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">InlineKeyboardButton</span> <span class="token function">createInlineKeyboardButton</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token class-name">String</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InlineKeyboardButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCallbackData</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Ми напишемо чотири обробники: HelpHandler, QuizHandler, RegistrationHandler, StartHandler. StartHandler: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot<span class="token punctuation">.</span>handler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot<span class="token punctuation">.</span></span><span class="token class-name">State</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">JpaUserRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">PartialBotApiMethod</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>methods<span class="token punctuation">.</span>send<span class="token punctuation">.</span></span><span class="token class-name">SendMessage</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">TelegramUtil</span><span class="token punctuation">.</span>createMessageTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StartHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${bot.name}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> botUsername<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JpaUserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">StartHandler</span><span class="token punctuation">(</span><span class="token class-name">JpaUserRepository</span> userRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>partialbotapimethod<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span><span class="token operator">=</span><span class="token string">""</span> serializable<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;&gt;</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Приветствуем пользователя</span>
        <span class="token class-name">SendMessage</span> welcomeMessage <span class="token operator">=</span> <span class="token function">createMessageTemplate</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
                        <span class="token string">"Hola! I'm *%s*%nI am here to help you learn Java"</span><span class="token punctuation">,</span> botUsername
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Просим назваться</span>
        <span class="token class-name">SendMessage</span> registrationMessage <span class="token operator">=</span> <span class="token function">createMessageTemplate</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"In order to start our journey tell me your name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Меняем пользователю статус на - "ожидание ввода имени"</span>
        user<span class="token punctuation">.</span><span class="token function">setBotState</span><span class="token punctuation">(</span><span class="token class-name">State</span><span class="token punctuation">.</span>ENTER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>welcomeMessage<span class="token punctuation">,</span> registrationMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">State</span> <span class="token function">operatedBotState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">State</span><span class="token punctuation">.</span>START<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>string<span class="token punctuation">&gt;</span></span> <span class="token function">operatedCallBackQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>string<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>partialbotapimethod<span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span></code></pre> RegistrationHandler: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot<span class="token punctuation">.</span>handler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot<span class="token punctuation">.</span></span><span class="token class-name">State</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">JpaUserRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">PartialBotApiMethod</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>replykeyboard<span class="token punctuation">.</span></span><span class="token class-name">InlineKeyboardMarkup</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>replykeyboard<span class="token punctuation">.</span>buttons<span class="token punctuation">.</span></span><span class="token class-name">InlineKeyboardButton</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">QuizHandler</span><span class="token punctuation">.</span>QUIZ_START<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">TelegramUtil</span><span class="token punctuation">.</span>createInlineKeyboardButton<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">TelegramUtil</span><span class="token punctuation">.</span>createMessageTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegistrationHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
    <span class="token comment">//Храним поддерживаемые CallBackQuery в виде констант</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> NAME_ACCEPT <span class="token operator">=</span> <span class="token string">"/enter_name_accept"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> NAME_CHANGE <span class="token operator">=</span> <span class="token string">"/enter_name"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> NAME_CHANGE_CANCEL <span class="token operator">=</span> <span class="token string">"/enter_name_cancel"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JpaUserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RegistrationHandler</span><span class="token punctuation">(</span><span class="token class-name">JpaUserRepository</span> userRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>partialbotapimethod<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span><span class="token operator">=</span><span class="token string">""</span> serializable<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;&gt;</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Проверяем тип полученного события</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>NAME_ACCEPT<span class="token punctuation">)</span> <span class="token operator">||</span> message<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>NAME_CHANGE_CANCEL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">accept</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>NAME_CHANGE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">changeName</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">checkName</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>partialbotapimethod<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span><span class="token operator">=</span><span class="token string">""</span> serializable<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;&gt;</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Если пользователь принял ім'я - меняем статус и сохраняем</span>
        user<span class="token punctuation">.</span><span class="token function">setBotState</span><span class="token punctuation">(</span><span class="token class-name">State</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Создаем кнопку для начала игры</span>
        <span class="token class-name">InlineKeyboardMarkup</span> inlineKeyboardMarkup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InlineKeyboardMarkup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>inlinekeyboardbutton<span class="token punctuation">&gt;</span></span> inlineKeyboardButtonsRowOne <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
                <span class="token function">createInlineKeyboardButton</span><span class="token punctuation">(</span><span class="token string">"Start quiz"</span><span class="token punctuation">,</span> QUIZ_START<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        inlineKeyboardMarkup<span class="token punctuation">.</span><span class="token function">setKeyboard</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>inlineKeyboardButtonsRowOne<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token function">createMessageTemplate</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
                <span class="token string">"Your name is saved as: %s"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setReplyMarkup</span><span class="token punctuation">(</span>inlineKeyboardMarkup<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>partialbotapimethod<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span><span class="token operator">=</span><span class="token string">""</span> serializable<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;&gt;</span> <span class="token function">checkName</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// При проверке имени мы превентивно сохраняем пользователю новое ім'я в базе</span>
        <span class="token comment">// идея для рефакторинга - добавить временное хранение имени</span>
        user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Робимо кнопку для применения изменений</span>
        <span class="token class-name">InlineKeyboardMarkup</span> inlineKeyboardMarkup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InlineKeyboardMarkup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>inlinekeyboardbutton<span class="token punctuation">&gt;</span></span> inlineKeyboardButtonsRowOne <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
                <span class="token function">createInlineKeyboardButton</span><span class="token punctuation">(</span><span class="token string">"Accept"</span><span class="token punctuation">,</span> NAME_ACCEPT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        inlineKeyboardMarkup<span class="token punctuation">.</span><span class="token function">setKeyboard</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>inlineKeyboardButtonsRowOne<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token function">createMessageTemplate</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"You have entered: %s%nIf this is correct - press the button"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setReplyMarkup</span><span class="token punctuation">(</span>inlineKeyboardMarkup<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>partialbotapimethod<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span><span class="token operator">=</span><span class="token string">""</span> serializable<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;&gt;</span> <span class="token function">changeName</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// При запите изменения имени мы меняем State</span>
        user<span class="token punctuation">.</span><span class="token function">setBotState</span><span class="token punctuation">(</span><span class="token class-name">State</span><span class="token punctuation">.</span>ENTER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Создаем кнопку для отмены операции</span>
        <span class="token class-name">InlineKeyboardMarkup</span> inlineKeyboardMarkup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InlineKeyboardMarkup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>inlinekeyboardbutton<span class="token punctuation">&gt;</span></span> inlineKeyboardButtonsRowOne <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
                <span class="token function">createInlineKeyboardButton</span><span class="token punctuation">(</span><span class="token string">"Cancel"</span><span class="token punctuation">,</span> NAME_CHANGE_CANCEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        inlineKeyboardMarkup<span class="token punctuation">.</span><span class="token function">setKeyboard</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>inlineKeyboardButtonsRowOne<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token function">createMessageTemplate</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
                <span class="token string">"Your current name is: %s%nEnter new name or press the button to continue"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setReplyMarkup</span><span class="token punctuation">(</span>inlineKeyboardMarkup<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">State</span> <span class="token function">operatedBotState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">State</span><span class="token punctuation">.</span>ENTER_NAME<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>string<span class="token punctuation">&gt;</span></span> <span class="token function">operatedCallBackQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>NAME_ACCEPT<span class="token punctuation">,</span> NAME_CHANGE<span class="token punctuation">,</span> NAME_CHANGE_CANCEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>string<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>inlinekeyboardbutton<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>partialbotapimethod<span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>inlinekeyboardbutton<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>partialbotapimethod<span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>inlinekeyboardbutton<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>partialbotapimethod<span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>partialbotapimethod<span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span></code></pre> Help Handler: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot<span class="token punctuation">.</span>handler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot<span class="token punctuation">.</span></span><span class="token class-name">State</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">PartialBotApiMethod</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>methods<span class="token punctuation">.</span>send<span class="token punctuation">.</span></span><span class="token class-name">SendMessage</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>replykeyboard<span class="token punctuation">.</span></span><span class="token class-name">InlineKeyboardMarkup</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>replykeyboard<span class="token punctuation">.</span>buttons<span class="token punctuation">.</span></span><span class="token class-name">InlineKeyboardButton</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>bot<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">RegistrationHandler</span><span class="token punctuation">.</span>NAME_CHANGE<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">TelegramUtil</span><span class="token punctuation">.</span>createInlineKeyboardButton<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>whiskels<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">TelegramUtil</span><span class="token punctuation">.</span>createMessageTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelpHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>partialbotapimethod<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span><span class="token operator">=</span><span class="token string">""</span> serializable<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;&gt;</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Создаем кнопку для смены имени</span>
        <span class="token class-name">InlineKeyboardMarkup</span> inlineKeyboardMarkup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InlineKeyboardMarkup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>inlinekeyboardbutton<span class="token punctuation">&gt;</span></span> inlineKeyboardButtonsRowOne <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
                <span class="token function">createInlineKeyboardButton</span><span class="token punctuation">(</span><span class="token string">"Change name"</span><span class="token punctuation">,</span> NAME_CHANGE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        inlineKeyboardMarkup<span class="token punctuation">.</span><span class="token function">setKeyboard</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>inlineKeyboardButtonsRowOne<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token function">createMessageTemplate</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">""</span> <span class="token operator">+</span>
                <span class="token string">"You've asked for help %s? Here it comes!"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setReplyMarkup</span><span class="token punctuation">(</span>inlineKeyboardMarkup<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">State</span> <span class="token function">operatedBotState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">State</span><span class="token punctuation">.</span>NONE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>string<span class="token punctuation">&gt;</span></span> <span class="token function">operatedCallBackQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>string<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>inlinekeyboardbutton<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>partialbotapimethod<span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span></code></pre> QuizHandler (найжахливіше