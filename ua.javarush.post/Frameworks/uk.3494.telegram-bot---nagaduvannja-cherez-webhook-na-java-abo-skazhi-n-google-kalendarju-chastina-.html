Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю! Частина 2
<p>----------------------------------------</p>
Друга частина проекту - ось на першу: І так клас : Для того, щоб наш бот розумів, що від нього чекають у певний момент часу, наприклад видалення нагадування, нам необхідно якось дати знати нашому боту що введені та відправлені зараз цифри в
<p>----------------------------------------</p>
Друга частина проекту - ось <a href="https://codegym.cc/groups/posts/3493-telegram-bot--napominalka-cherez-webhook-na-java-ili-skazhi-net-google-kalendarju" target="_blank" rel="nofollow">посилання</a> на першу: І так клас <strong>BotState</strong> : Для того, щоб наш бот розумів, що від нього чекають у певний момент часу, наприклад видалення нагадування, нам необхідно якось дати знати нашому боту що введені та відправлені зараз цифри варто сприймати як ID нагадування зі списку, його треба видалити. Тому після натискання на кнопку <em>«Видалити»</em> бот перетворюється на стан <strong>BotState.ENTERNUMBEREVENT</strong> , це спеціально створений клас Enum зі станами бота. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">BotState</span> <span class="token punctuation">{</span>
    ENTERDESCRIPTION<span class="token punctuation">,</span><span class="token comment">//the bot will wait for the description to be entered.</span>
    START<span class="token punctuation">,</span>
    MYEVENTS<span class="token punctuation">,</span> <span class="token comment">//the bot show to user list events.</span>
    ENTERNUMBEREVENT<span class="token punctuation">,</span><span class="token comment">//the bot will wait for the number of event to be entered.</span>
    ENTERDATE<span class="token punctuation">,</span> <span class="token comment">//the bot will wait for the date to be entered</span>
    CREATE<span class="token punctuation">,</span> <span class="token comment">//the bot run created event</span>
    ENTERNUMBERFOREDIT<span class="token punctuation">,</span> <span class="token comment">//the bot will wait for the number of event to be entered</span>
    EDITDATE<span class="token punctuation">,</span> <span class="token comment">//the bot will wait for the date to be entered</span>
    EDITDESCRIPTION<span class="token punctuation">,</span><span class="token comment">//the bot will wait for the description to be entered</span>
    EDITFREQ<span class="token punctuation">,</span><span class="token comment">//the bot will wait callbackquery</span>
    ALLUSERS<span class="token punctuation">,</span> <span class="token comment">// show all users</span>
    ALLEVENTS<span class="token punctuation">,</span> <span class="token comment">//show all events</span>
    ENTERNUMBERUSER<span class="token punctuation">,</span><span class="token comment">//the bot will wait for the number of user to be entered.</span>
    ENTERTIME<span class="token punctuation">,</span><span class="token comment">//the bot will wait for the hour to be entered.</span>
    ONEVENT <span class="token comment">// state toggle</span>
<span class="token punctuation">}</span></code></pre> І тепер від нас очікують введення цифр - " <em>Введіть номер нагадування зі списку</em> ." Після введення яких вони потраплять у необхідний спосіб обробки. Ось наш перемикач стану: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BotStateCash</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token punctuation">,</span> botstate<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;</span> botStateMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveBotState</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">BotState</span> botState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        botStateMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> botState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">long</span><span class="token punctuation">,</span><span class="token operator">&gt;</span></code></pre> Звичайна карта з ID користувача та його станом. Поле <em>int adminId</em> це для мене ) Далі логіка методу <em>handleUpdate</em> перевірять, що це за повідомлення? <strong>Сallbackquery</strong> чи просто текст? Якщо це звичайний текст, то ми вирушаємо в метод <em>handleInputMessage</em> , де ми обробляємо кнопки основного меню, і, якщо на них натиснули, то встановлюємо потрібний стан, якщо не натиснули і це незнайомий текст, то встановлюємо стан з кешу, якщо його немає, то встановлюємо стартовий стан. Далі текст переходить в обробку методу handle з потрібним нам станом. Тепер наведемо логіку класу <strong>MessageHandler</strong> , який відповідає за обробку повідомлень залежно від стану робота: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageHandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UserDAO</span> userDAO<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MenuService</span> menuService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventHandler</span> eventHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BotStateCash</span> botStateCash<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventCash</span> eventCash<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MessageHandler</span><span class="token punctuation">(</span><span class="token class-name">UserDAO</span> userDAO<span class="token punctuation">,</span> <span class="token class-name">MenuService</span> menuService<span class="token punctuation">,</span> <span class="token class-name">EventHandler</span> eventHandler<span class="token punctuation">,</span> <span class="token class-name">BotStateCash</span> botStateCash<span class="token punctuation">,</span> <span class="token class-name">EventCash</span> eventCash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userDAO <span class="token operator">=</span> userDAO<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>menuService <span class="token operator">=</span> menuService<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventHandler <span class="token operator">=</span> eventHandler<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>botStateCash <span class="token operator">=</span> botStateCash<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventCash <span class="token operator">=</span> eventCash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BotApiMethod</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">?</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">BotState</span> botState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> userId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> chatId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SendMessage</span> sendMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sendMessage<span class="token punctuation">.</span><span class="token function">setChatId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//if new user</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userDAO<span class="token punctuation">.</span><span class="token function">isExist</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">saveNewUser</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> sendMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//save state in to cache</span>
        botStateCash<span class="token punctuation">.</span><span class="token function">saveBotState</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> botState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//if state =...</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>botState<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"START"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token keyword">return</span> menuService<span class="token punctuation">.</span><span class="token function">getMainMenuMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">"Воспользуйтесь главным меню"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"ENTERTIME"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">//set time zone user. for correct sent event</span>
                <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">enterLocalTimeUser</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"MYEVENTS"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">//list events of user</span>
                <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">myEventHandler</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"ENTERNUMBEREVENT"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">//remove event</span>
                <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">removeEventHandler</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"ENTERDESCRIPTION"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">//enter description for create event</span>
                <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">enterDescriptionHandler</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"ENTERDATE"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">//enter date for create event</span>
                <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">enterDateHandler</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"CREATE"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">//start create event, set state to next step</span>
                botStateCash<span class="token punctuation">.</span><span class="token function">saveBotState</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token class-name">BotState</span><span class="token punctuation">.</span>ENTERDESCRIPTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//set new event to cache</span>
                eventCash<span class="token punctuation">.</span><span class="token function">saveEventCash</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sendMessage<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Введите описание события"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> sendMessage<span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"ENTERNUMBERFOREDIT"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">//show to user selected event</span>
                <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">editHandler</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"EDITDESCRIPTION"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">//save new description in database</span>
                <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">editDescription</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"EDITDATE"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">//save new date in database</span>
                <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">editDate</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"ALLEVENTS"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">//only admin</span>
                <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">allEvents</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"ALLUSERS"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">//only admin</span>
                <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">allUsers</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"ONEVENT"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">// on/off notification</span>
                <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token string">"ENTERNUMBERUSER"</span><span class="token punctuation">)</span><span class="token operator">:</span>
                <span class="token comment">//only admin</span>
                <span class="token keyword">return</span> eventHandler<span class="token punctuation">.</span><span class="token function">removeUserHandler</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unexpected value: "</span> <span class="token operator">+</span> botState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> у методі handle ми перевіряємо з яким станом до нас надійшло повідомлення та направляємо його в обробник подій – клас <strong>EventHandler. </strong> Тут у нас з'явилося два нових класи, <strong>MenuService та EventCash</strong> . <strong>MenuService</strong> – тут ми створюємо всі наші меню. <strong>EventCash</strong> - аналогічно як і <strong>BotStateCash</strong> буде зберігати частини нашої події після введення і коли введення буде завершено, ми збережемо подію в базі. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token comment">// used to save entered event data per session</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventCash</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token punctuation">,</span> event<span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;</span> eventMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveEventCash</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">long</span><span class="token punctuation">,</span><span class="token operator">&gt;</span></code></pre> Ну, тобто. коли ми наживаємо створити подію, в кеш створюється новий об'єкт <em>Event-eventCash.saveEventCash(userId, new Event()); </em> Потім ми вводимо опис події і додаємо його в кеш: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name"></span><em><span class="token class-name">Event</span> event <span class="token operator">=</span> eventCash<span class="token punctuation">.</span><span class="token function">getEventMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
event<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//save to cache</span>
eventCash<span class="token punctuation">.</span><span class="token function">saveEventCash</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span></em><span class="token punctuation"></span></code></pre> Потім вводимо число: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">Event</span> event <span class="token operator">=</span> eventCash<span class="token punctuation">.</span><span class="token function">getEventMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
event<span class="token punctuation">.</span><span class="token function">setDate</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//save data to cache</span>
eventCash<span class="token punctuation">.</span><span class="token function">saveEventCash</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Клас CallbackQueryHandler аналогічний <strong>MessageHandler</strong> , тільки ми обробляємо там callbackquery-повідомлення. Повністю розбирати логіку роботи з подіями – <strong>EventHandler</strong> не має сенсу, вже й так занадто багато літер, вона зрозуміла за назвами методів та коментарями в коді. І повністю його викладати текстом сенсу не бачу, там понад 300 рядків. Ось посилання на клас у <a href="https://github.com/papoff8295/webHookBotForHabr/blob/master/src/main/java/ru/popov/telegrambot/model/handler/EventHandler.java" target="_blank" rel="nofollow">Github</a> . Те саме стосується і класу <strong>MenuService</strong> , де ми створюємо наші меню. Про них можна детально почитати на сайті виробника бібліотеки. /api Тепер нам залишилося найсмачніше. Це клас для обробки повідомлень<strong>EventService</strong> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@EnableScheduling</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventDAO</span> eventDAO<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventCashDAO</span> eventCashDAO<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">EventService</span><span class="token punctuation">(</span><span class="token class-name">EventDAO</span> eventDAO<span class="token punctuation">,</span> <span class="token class-name">EventCashDAO</span> eventCashDAO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventDAO <span class="token operator">=</span> eventDAO<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventCashDAO <span class="token operator">=</span> eventCashDAO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//start service in 0:00 every day</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0 0 0 * * *"</span><span class="token punctuation">)</span>
    <span class="token comment">// @Scheduled(fixedRateString = "${eventservice.period}")</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">eventService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        calendar<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> day <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>DAY_OF_MONTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> month <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>MONTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> year <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>YEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//get event list is now date</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>event<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> eventDAO<span class="token punctuation">.</span><span class="token function">findAllEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">EventFreq</span> eventFreq <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getFreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//set user event time</span>
                <span class="token class-name">Calendar</span> calendarUserTime <span class="token operator">=</span> <span class="token function">getDateUserTimeZone</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> day1 <span class="token operator">=</span> calendarUserTime<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>DAY_OF_MONTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> month1 <span class="token operator">=</span> calendarUserTime<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>MONTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> year1 <span class="token operator">=</span> calendarUserTime<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>YEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>eventFreq<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token string">"TIME"</span><span class="token operator">:</span> <span class="token comment">//if one time - remove event</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>day <span class="token operator">==</span> day1 <span class="token operator">&amp;&amp;</span> month <span class="token operator">==</span> month1 <span class="token operator">&amp;&amp;</span> year <span class="token operator">==</span> year1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            eventDAO<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token keyword">case</span> <span class="token string">"EVERYDAY"</span><span class="token operator">:</span>
                        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token string">"MONTH"</span><span class="token operator">:</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>day <span class="token operator">==</span> day1<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token string">"YEAR"</span><span class="token operator">:</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>day <span class="token operator">==</span> day1 <span class="token operator">&amp;&amp;</span> month <span class="token operator">==</span> month1<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Event</span> event <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//set user event time</span>
            <span class="token class-name">Calendar</span> calendarUserTime <span class="token operator">=</span> <span class="token function">getDateUserTimeZone</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> hour1 <span class="token operator">=</span> calendarUserTime<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>HOUR_OF_DAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            calendarUserTime<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day<span class="token punctuation">,</span> hour1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> description <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> userId <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//save the event to the database in case the server reboots.</span>
            <span class="token class-name">EventCashEntity</span> eventCashEntity <span class="token operator">=</span> <span class="token class-name">EventCashEntity</span><span class="token punctuation">.</span><span class="token function">eventTo</span><span class="token punctuation">(</span>calendarUserTime<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            eventCashDAO<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>eventCashEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//create a thread for the upcoming event with the launch at a specific time</span>
            <span class="token class-name">SendEvent</span> sendEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sendEvent<span class="token punctuation">.</span><span class="token function">setSendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SendMessage</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> description<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sendEvent<span class="token punctuation">.</span><span class="token function">setEventCashId</span><span class="token punctuation">(</span>eventCashEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleTask</span><span class="token punctuation">(</span>sendEvent<span class="token punctuation">)</span><span class="token punctuation">,</span> calendarUserTime<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Calendar</span> <span class="token function">getDateUserTimeZone</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Calendar</span> calendarUserTime <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        calendarUserTime<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> timeZone <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//set correct event time with user timezone</span>
        calendarUserTime<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>HOUR_OF_DAY<span class="token punctuation">,</span> <span class="token operator">-</span>timeZone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> calendarUserTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>event<span class="token operator">&gt;</span></code></pre><em>@EnableScheduling</em> – включаємо роботу з розкладу у Spring. <em>@Scheduled(cron = "0 0 0 * * *")</em> – налаштовуємо запуск методу о 0:00 щодня <em>calendar.setTime(new Date()); </em>- Встановлюємо серверний час. Отримуємо список нагадувань на сьогодні, за допомогою магії стриму та лямбду. Проходимо по отриманому списку, встановлюємо правильний час відправки <em>calendarUserTime</em> і… Ось тут я вирішив викрутитись і запускати процеси відкладено за часом. За це у нас відповідає в java клас <strong>Time</strong> . <em>new Timer().schedule(new SimpleTask(sendEvent), calendarUserTime.getTime()); </em> Для нього нам необхідно створити нитку: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendEvent</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>


    <span class="token keyword">private</span> <span class="token keyword">long</span> eventCashId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SendMessage</span> sendMessage<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SendEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TelegramBot</span> telegramBot <span class="token operator">=</span> <span class="token class-name">ApplicationContextProvider</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">TelegramBot</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventCashDAO</span> eventCashDAO <span class="token operator">=</span> <span class="token class-name">ApplicationContextProvider</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">EventCashDAO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        telegramBot<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sendMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//if event it worked, need to remove it from the database of unresolved events</span>
        eventCashDAO<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>eventCashId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> та реалізацію <strong>TimerTask</strong>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleTask</span> <span class="token keyword">extends</span> <span class="token class-name">TimerTask</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SendEvent</span> sendEvent<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SimpleTask</span><span class="token punctuation">(</span><span class="token class-name">SendEvent</span> sendEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sendEvent <span class="token operator">=</span> sendEvent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sendEvent<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Так, я чудово розумію, що можна кожні 20 хвабон проходити по базі та розсилати повідомлення, але я на самому початку все написав про це)) Тут ще ми стикаємося з жмотством Heroku №1. На безкоштовному тарифі Вам дається якісь 550 dino, це щось на кшталт годин роботи вашої програми на місяць. На повний місяць роботи цього не вистачить, а ось якщо прив'язати карту, то Вам дається ще 450 dino, що вистачає за очі. Якщо переживаєте за карту, можете прив'язати якусь порожню, але щоб там було 0,6 $. Це перевірна сума, вона просто повинна бути на рахунку. Жодних прихованих списань не проводиться тільки якщо ви самі не зміните тариф. На безкоштовному тарифі, є ще одне невелике поджмотство, назвемо його №1а. загалом воно перезавантажується щодня десь опівночі МСК, а буває і в інший час. Від цього всі наші процеси у пам'яті віддаляються. Для вирішення цієї проблеми я вигадав таблицю EventCash. Перед надсиланням події зберігаються в окрему таблицю: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token class-name">EventCashEntity</span> eventCashEntity <span class="token operator">=</span> <span class="token class-name">EventCashEntity</span><span class="token punctuation">.</span><span class="token function">eventTo</span><span class="token punctuation">(</span>calendarUserTime<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
eventCashDAO<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>eventCashEntity<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> А після відправлення, видаляються: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TelegramBot</span> telegramBot <span class="token operator">=</span> <span class="token class-name">ApplicationContextProvider</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">TelegramBot</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventCashDAO</span> eventCashDAO <span class="token operator">=</span> <span class="token class-name">ApplicationContextProvider</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">EventCashDAO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    telegramBot<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sendMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//if event it worked, need to remove it from the database of unresolved events</span>
    eventCashDAO<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>eventCashId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><strong>ApplicationContextProvider</strong> – це спеціальний клас для отримання контексту на льоту: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Component</span>
<span class="token comment">//wrapper to receive Beans</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContextProvider</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationContextAware</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ApplicationContext</span> context<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ApplicationContext</span> <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> ac<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        context <span class="token operator">=</span> ac<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Для перевірки на невідпрацьовані події я зробив спеціальний сервіс, в якому є метод, помічений <em>@ PostConstruct</em> – він запускається після кожного старту програми. Він піднімає всі невідпрацьовані події з бази та повертає їх на згадку. Ось тобі шкідливий Heroku! 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendEventFromCache</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventCashDAO</span> eventCashDAO<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TelegramBot</span> telegramBot<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${telegrambot.adminId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> admin_id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">SendEventFromCache</span><span class="token punctuation">(</span><span class="token class-name">EventCashDAO</span> eventCashDAO<span class="token punctuation">,</span> <span class="token class-name">TelegramBot</span> telegramBot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventCashDAO <span class="token operator">=</span> eventCashDAO<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>telegramBot <span class="token operator">=</span> telegramBot<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token comment">//after every restart app  - check unspent events</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">afterStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>eventcashentity<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> eventCashDAO<span class="token punctuation">.</span><span class="token function">findAllEventCash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SendMessage</span> sendMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sendMessage<span class="token punctuation">.</span><span class="token function">setChatId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>admin_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sendMessage<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Произошла перезагрузка!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        telegramBot<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sendMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">EventCashEntity</span> eventCashEntity <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                calendar<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>eventCashEntity<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SendEvent</span> sendEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sendEvent<span class="token punctuation">.</span><span class="token function">setSendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SendMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>eventCashEntity<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> eventCashEntity<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sendEvent<span class="token punctuation">.</span><span class="token function">setEventCashId</span><span class="token punctuation">(</span>eventCashEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleTask</span><span class="token punctuation">(</span>sendEvent<span class="token punctuation">)</span><span class="token punctuation">,</span> calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>eventcashentity<span class="token operator">&gt;</span></code></pre> Наша програма готова, і час нам отримати адресау на Heroku для додатку та бази даних. Ваш додаток має бути викладено на Github! Заходимо на Heroku.com Натискаємо <strong>Create New App</strong> , вводимо свою назву програми, вибираємо <strong>Europe, create app</strong> . Все, місце для програми готове. Якщо натиснете <strong>open App,</strong> то браузер перенаправить вас на адресау вашої програми, це і є ваша адресаа webhook - <em>https://ваша_назва.herokuapp.com/</em> Реєструйте його в telegram, а в налаштуваннях <em>application.propertie</em> s змінюйте <em>telegrambot.webHookPath=https: //telegrambotsimpl.herokuapp.com/</em> на свій <em>server.port=5000</em> Ви можете видалити або закоментувати. Тепер підключимо базу даних. Заходимо у вкладку <strong>Resources</strong> на Heroku, натискаємо: <img width="800" height="500" data-id="6349441e-4bf5-4244-af1f-a7c962ef262b" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  Частина 2: - 1" src="https://cdn.javarush.com/images/article/6349441e-4bf5-4244-af1f-a7c962ef262b/1080.jpeg"> Знаходимо там <strong>Heroku Postgres</strong> , натискаємо <strong>install</strong> : Вас перенаправить на сторінку кабінету вашої бази даних. Знайдіть там у Settings/ <img width="800" height="500" data-id="f0917fce-5dcc-49f3-9a71-0201c58537d6" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  Частина 2: - 2" src="https://cdn.javarush.com/images/article/f0917fce-5dcc-49f3-9a71-0201c58537d6/1080.jpeg"> Там будуть усі необхідні дані від вашої бази. У <em>application.properties</em> тепер все має бути так: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">#server<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">5000</span>

telegrambot<span class="token punctuation">.</span>userName<span class="token operator">=</span><span class="token annotation punctuation">@calendar_event_bot</span>
telegrambot<span class="token punctuation">.</span>botToken<span class="token operator">=</span><span class="token number">1731265488</span><span class="token operator">:</span><span class="token class-name">AAFDjUSk3vu5SFfgdfh556gOOFmuml7SqEjwrmnEF5Ak</span>
telegrambot<span class="token punctuation">.</span>webHookPath<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>telegrambotsimpl<span class="token punctuation">.</span>herokuapp<span class="token punctuation">.</span>com<span class="token operator">/</span>
#telegrambot<span class="token punctuation">.</span>webHookPath<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>f5d6beeb7b93<span class="token punctuation">.</span>ngrok<span class="token punctuation">.</span>io


telegrambot<span class="token punctuation">.</span>adminId<span class="token operator">=</span><span class="token number">39376213</span>

eventservice<span class="token punctuation">.</span>period <span class="token operator">=</span><span class="token number">600000</span>

#spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">=</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span></span>Driver</span>
#spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>url<span class="token operator">=</span>jdbc<span class="token operator">:</span>postgresql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">5432</span><span class="token operator">/</span>telegramUsers
#spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>username<span class="token operator">=</span>postgres
#spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>password<span class="token operator">=</span>password

spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>url<span class="token operator">=</span>jdbc<span class="token operator">:</span>postgresql<span class="token operator">:</span>ec2<span class="token operator">-</span><span class="token number">54</span><span class="token operator">-</span><span class="token number">247</span><span class="token operator">-</span><span class="token number">158</span><span class="token operator">-</span><span class="token number">179.</span>eu<span class="token operator">-</span>west<span class="token operator">-</span><span class="token number">1.</span>compute<span class="token punctuation">.</span>amazonaws<span class="token punctuation">.</span>com<span class="token operator">:</span><span class="token number">5432</span><span class="token operator">/</span>d2um26le5notq<span class="token operator">?</span>ssl<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>sslmode<span class="token operator">=</span>require<span class="token operator">&amp;</span>sslfactory<span class="token operator">=</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span>NonValidatingFactory</span>
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>username<span class="token operator">=</span>ulmbeymwyvsxa
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>password<span class="token operator">=</span><span class="token number">4</span>c7646c69dbgeacbk98fa96e8daa6d9b1bl4894e67f3f3ddd6a27fe7b0537fd</code></pre> Замініть дані з кабінету на свої: У полі jdbc:postgresql:ec2-54-247-158-179.eu-west-1.compute.amazonaws.com:5432/d2um26le5notq?ssl=true&amp;sslmode=require&amp;sslfactory= .NonValidatingFactory потрібно замінити виділене жирним шрифтом на відповідні дані з кабінету (Host, Database) Поля username, password не важко здогадатися. Тепер нам потрібно створити таблиці у базі, я це робив з IDEA. Стане в нагоді наш скрипт для створення бази. Додаємо базу даних як це було написано Вище: <img width="800" height="500" data-id="07c4e13a-4b59-4602-ae47-6fc7b1bc7f02" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  Частина 2: - 3" src="https://cdn.javarush.com/images/article/07c4e13a-4b59-4602-ae47-6fc7b1bc7f02/1080.jpeg"> Поле <em>Host, User, Password, Database</em> беремо з кабінету. Поле <em>URL</em> – це наше поле spring.datasource.url до знака питання. Заходимо у вкладку <strong>Advanced</strong> , там має бути так: <img width="800" height="500" data-id="cfb9d4ce-e697-4abb-8f5b-ae1c3c6e6f51" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  Частина 2: - 4" src="https://cdn.javarush.com/images/article/cfb9d4ce-e697-4abb-8f5b-ae1c3c6e6f51/1080.jpeg"> Якщо Ви все зробабо правильно, то після натискання на test буде зелененька галочка. Натискаємо ОК. Натискаємо правою кнопкою на нашу базу і вибираємо <strong>Jump to query console</strong> . Копіюйте туди наш script і натискайте на <em>execute</em> . База має утворитися. Вам доступно 10 000 рядків нахаляву! Все готове до Deploy. Переходимо в наш додаток на Heroku у розділі Deploy. Вибираємо розділ Github: <img width="800" height="500" data-id="0a5e3fdb-c956-4e0e-8aba-8962f6666b52" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  Частина 2: - 5" src="https://cdn.javarush.com/images/article/0a5e3fdb-c956-4e0e-8aba-8962f6666b52/1080.jpeg"> Прив'язуємо свій репозиторій до Heroku. Тепер Ваші гілки будуть видні. Не забудьте зробити push Ваших останніх змін у .properties. Нижче вибираєте гілку, яка завантажуватиметься, і натискаємо <strong>Deploy branch</strong> . Якщо все зроблено правильно, то Вам буде повідомлено, що програма успішно розгорнута. Не забудьте увімкнути <strong>Automatic deploys from</strong>.. Щоб Ваша програма запускалася автоматично. До речі, коли ви робитимете push змін на GitHub, heroku буде автоматично перезапускати програму. Обережно ставтеся до цього, заведіть окрему гілку для знущань, а основну використовуйте тільки для робочої програми. Тепер Жмотство №2! Полягає у всьому відомому мінусі безкоштовного тарифу на heroku. За відсутності повідомлень, що надходять, програма переходить в режим standby, і після надходження повідомлення буде досить тривалий час запускатися, що не приємно. Для цього існує просте рішення – <a href="https://uptimerobot.com/" target="_blank" rel="nofollow">https://uptimerobot.com/ </a> І ні, примочки з пінгом Google не допоможуть, взагалі не знаю, звідки ця інфа взялася, я гуглив це питання, і вже років 10 як не працює ця тема точно, якщо взагалі працювала. Даний додаток буде на встановлений вами час відсилати HEAD-запити на вказану вами адресау та у разі, якщо вона не відповідає, надсилати повідомлення на email. Розібратися не складе Вам труднощів, там мало кнопок, щоб заплутатися)) Вітаю!! Якщо я нічого не забув і Ви були уважні, то у Вас власний додаток, який працює на халяву і ніколи не падає. Перед Вами відкривається можливість для знущань та експериментів. У будь-якому випадку я готовий відповідати на запитання та прийму будь-яку критику! Код: https://github.com/papoff8295/webHookBotForHabr Використані матеріали: https://tlgrm.ru/docs/bots/api – про боти. https://en.wikibooks. org/wiki/Java_Persistence - про відносини у базах даних. https://stackoverflow.com/questions/11432498/how-to-call-a-thread-to-run-on-specific-time-in-java - клас Time та TimerTask https://www.youtube.com/ watch?v=CUDgSbaYGx4 – як викласти код на Github https://github.com/rubenlagus/TelegramBots - бібліотека telegram та купа корисного про це.