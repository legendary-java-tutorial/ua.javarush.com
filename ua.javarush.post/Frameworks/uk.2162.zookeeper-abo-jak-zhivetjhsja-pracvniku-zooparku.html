Zookeeper або як живеться працівнику зоопарку
<p>----------------------------------------</p>
Програми Java часто мають різні конфігурації. Наприклад, адреса та порт підключення. Наприклад, це могло б виглядати так, якби використовували клас : І цього начебто достатньо, т.к. ми можемо Properties отримати із файлу. І наче у нас все н
<p>----------------------------------------</p>
<img data-id="841d0e1c-0a0c-4d92-99b0-5de0d4d89401" data-max-width="850" alt="Zookeeper або як живеться працівнику зоопарку." src="https://cdn.javarush.com/images/article/841d0e1c-0a0c-4d92-99b0-5de0d4d89401/800.jpeg" style="width: 850px;">
<h2>Вступ</h2>Програми Java часто мають різні конфігурації. Наприклад, адресаа та порт підключення. Наприклад, це могло б виглядати так, якби використовували клас <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Properties.html" target="_blank" rel="nofollow">Properties</a> : 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> <span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span>args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token class-name"><span class="token class-name">Properties</span></span> props <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Properties</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	props<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">setProperty</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"host"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token string"><span class="token string">"www.tutorialspoint.com"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Hello, "</span></span> <span class="token operator"><span class="token operator">+</span></span> props<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getProperty</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"host"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> І цього начебто достатньо, т.к. ми можемо Properties отримати із файлу. І наче у нас все на одній машині вживається добре. Але уявіть, що наша система починає складатися із різних систем, які розділені між собою? Така система ще називається розподіленою (Distributed Systems). У вікіпедії можна знайти таке визначення: <strong>Розподілені системи</strong> - це системи, компоненти які розташовані на різних мережевих комп'ютерах, які спілкуються між собою та координують свої дії обмінюючись одна з одною повідомленнями. Можна поглянути на таку схему: 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="1fa0bd3c-9827-401a-88ad-193ea0fa9c74" data-max-width="316" alt="Zookeeper або як живеться працівнику зоопарку - 2" src="https://cdn.javarush.com/images/article/1fa0bd3c-9827-401a-88ad-193ea0fa9c74/256.jpeg" style="width: 316px;">
 </div>
</div>За такого підходу єдина система розділена на компоненти. Конфігурування – окремий загальний компонент. Кожен із інших компонентів виступає у ролі клієнта для компонента конфігурування. Такий випадок називається " <strong>Розподілена конфігурація</strong> ". Існує безліч різних реалізацій розподіленої конфігурації. І в сьогоднішньому огляді пропоную познайомитись із однією з них, яка називається Zookeeper. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="6a65885d-9a55-44bd-8374-5b2aaff4c6e6" data-max-width="289" alt="Zookeeper або як живеться працівнику зоопарку - 3" src="https://cdn.javarush.com/images/article/6a65885d-9a55-44bd-8374-5b2aaff4c6e6/256.jpeg" style="width: 289px;">
 </div>
</div>
<h2>Zookeeper</h2>Шлях до знайомства з Zookeeper починається з їхнього офіційного сайту: <a href="https://zookeeper.apache.org/" target="_blank" rel="nofollow">zookeeper.apache.org</a> На офіційному сайті необхідно перейти в розділ " <a href="https://zookeeper.apache.org/releases.html#download" target="_blank" rel="nofollow">Download</a> ". У цьому розділі завантажуємо архів у форматі .tar.gz, наприклад "zookeeper-3.4.13.tar.gz". tar – це формат архіву, традиційний для Unit систем. gz означає, що для стиснення архіву використовується gzip. Якщо ми працюємо на Windows машині, нас це не повинно бентежити. Більшість сучасних архіваторів (наприклад, <a href="https://www.7-zip.org/" target="_blank" rel="nofollow">7-zip</a>), чудово вміють з ними працювати і на Windows. Витягнемо вміст у якийсь каталог. Заодно побачимо різницю - на диску у видобутому стані воно займатиме приблизно 60 мегабайт, а ми завантажували архів розміром близько 35 мегабайт. Як видно, стиск дійсно працює. Тепер потрібно запустити Zookeeper. Взагалі Zookeeper є свого роду сервером. Zookeeper може бути запущений в одному з двох режимів: <strong>Standalone</strong> або <strong>Replicated</strong> . Розглянемо найпростіший варіант, він перший варіант — Standalone mode. Щоб Zookeper запустився, йому потрібний файл конфігурації. Тому, створимо його тут: <code class=" language-none">[КаталогРаспаковкиZookeeper]/conf/zoo.cfg</code>. Для Windows скористаємося рекомендацією з Medium: " <a href="https://medium.com/@shaaslam/installing-apache-zookeeper-on-windows-45eda303e835" target="_blank" rel="nofollow">Installing Apache ZooKeeper on Windows</a>". Зміст конфігураційного файлу буде приблизно наступним: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java">tickTime<span class="token operator"><span class="token operator">=</span></span><span class="token number"><span class="token number">2000</span></span>
dataDir<span class="token operator"><span class="token operator">=</span></span><span class="token class-name"><span class="token class-name">C</span></span><span class="token operator"><span class="token operator">:</span></span><span class="token operator"><span class="token operator">/</span></span>zookeeper<span class="token operator"><span class="token operator">-</span></span><span class="token number"><span class="token number">3.4</span></span><span class="token number"><span class="token number">.13</span></span><span class="token operator"><span class="token operator">/</span></span>data
clientPort<span class="token operator"><span class="token operator">=</span></span><span class="token number"><span class="token number">2181</span></span></code></pre> Додамо змінну середовища оточення ZOOKEEPER_HOME, що містить шлях до кореневого каталогу zookeper (як в інструкції на medium), а також додамо змінну середовища оточення PATH наступний фрагмент: Так само каталог, вказаний в dataDir, повинен існувати, інакше Zookeeper не зможе <code class=" language-none">;%ZOOKEEPER_HOME%\bin;</code> запустити сервер. Тепер ми можемо сміливо запускати сервер за допомогою команди zkServer. Завдяки тому, що каталог Zookeeper був доданий до змінного середовища оточення path ми можемо викликати команди Zookeper звідки завгодно, а не тільки з каталогу bin. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="935a76ad-fe7c-4545-8d24-2a2bfd07af0c" data-max-width="439" alt="Zookeeper або як живеться працівнику зоопарку - 4" src="https://cdn.javarush.com/images/article/935a76ad-fe7c-4545-8d24-2a2bfd07af0c/256.jpeg" style="width: 439px;">
 </div>
</div>
<h2>ZNode</h2>Як сказано в " <a href="https://zookeeper.apache.org/doc/r3.4.13/zookeeperOver.html" target="_blank" rel="nofollow">Zookeeper Overview</a> ", дані в Zookeper представлені у вигляді <strong>ZNode</strong> (вузлів), які об'єднані в деревоподібну структуру. Тобто кожен ZNode може містити дані та мати дочірні ZNode. Докладніше про організацію ZNode можна прочитати в документації Zookeeper: " <a href="https://zookeeper.apache.org/doc/current/zookeeperOver.html#sc_dataModelNameSpace" target="_blank" rel="nofollow">Data model and the hierarchical namespace</a> ". Для роботи з Zookeeper та ZNode скористаємося <a href="https://www.tutorialspoint.com/zookeeper/zookeeper_cli.htm" target="_blank" rel="nofollow">Zookeeper CLI</a> (Command Line interface – інтерфейс командного рядка). Раніше ми запустабо сервер за допомогою команди zkServer. Тепер, для підключення виконаємо <code class=" language-none">zkCli.cmd -server 127.0.0.1:2181</code> При успішному виконанні буде створена сесія підключення до Zookeeper і ми побачимо приблизно такий висновок: 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="b68cad89-6f56-4267-b845-6c270c0ea24c" data-max-width="675" alt="Zookeeper або як живеться працівнику зоопарку - 5" src="https://cdn.javarush.com/images/article/b68cad89-6f56-4267-b845-6c270c0ea24c/512.jpeg" style="width: 675px;">
 </div>
</div> Цікаво, що навіть одразу після встановлення Zookeeper вже має ZNode. Має він наступний шлях:<code class=" language-none">/zookeeper/quota</code>
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="bb12fd00-27d1-4f9e-b8a1-adfc131a20d1" data-max-width="449" alt="Zookeeper або як живеться працівнику зоопарку - 6" src="https://cdn.javarush.com/images/article/bb12fd00-27d1-4f9e-b8a1-adfc131a20d1/256.jpeg" style="width: 449px;">
 </div>
</div>Це звані " <a href="https://zookeeper.apache.org/doc/r3.1.2/zookeeperQuotas.html" target="_blank" rel="nofollow">квоти</a> " . Як сказано в " <a href="https://subscription.packtpub.com/book/big_data_and_business_intelligence/9781784391324/5/ch05lvl1sec30/quota-and-authorization" target="_blank" rel="nofollow">Apache ZooKeeper Essentials</a> ", кожен ZNode може мати асоційовану з ним квоту, що обмежує збережені дані. Може бути вказано обмеження кількості znode і обсяг збережених даних. Якщо це обмеження перевищено, то операції з ZNode не скасовується, але буде отримано попередження про перевищення ліміту. Про ZNode рекомендується прочитати в " <a href="https://zookeeper.apache.org/doc/r3.1.2/zookeeperProgrammers.html#sc_zkDataModel_znodes" target="_blank" rel="nofollow">ZooKeeper Programmer's Guide: ZNodes</a> ". Декілька прикладів від туди, як можна працювати з ZNode: 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="a3daa1b7-2845-42ae-8dee-81cdebd1a9ce" data-max-width="470" alt="Zookeeper або як живеться працівнику зоопарку - 7" src="https://cdn.javarush.com/images/article/a3daa1b7-2845-42ae-8dee-81cdebd1a9ce/256.jpeg" style="width: 470px;">
 </div>
</div>Хочеться відзначити також, що ZNode бувають різні. Звичайні ZNode (якщо не вказати додаткові прапори) є типом " <strong>persistent</strong> ". Є ZNode типу " <a href="https://zookeeper.apache.org/doc/r3.1.2/zookeeperProgrammers.html#Ephemeral+Nodes" target="_blank" rel="nofollow">Ephemeral Node</a> ". Такі ZNode існують лише на час існування сесії підключення до Zookeeper, в рамках якої вони створювалися. Є ZNode типу " <a href="https://zookeeper.apache.org/doc/r3.1.2/zookeeperProgrammers.html#Sequence+Nodes+--+Unique+Naming" target="_blank" rel="nofollow">Sequence Node</a> ". До таких ZNode додається номер із послідовності, щоб гарантувати унікальність. Sequence Node може бути як persistent, і ephemeral. Про ZNode так само рекомендується невелика довідкова інформація тут: " <a href="https://data-flair.training/blogs/zookeeper-znodes/" target="_blank" rel="nofollow">Zookeeper ZNodes - Characteristics &amp; Example</a> ". 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-max-width="203" alt="Zookeeper або як живеться працівнику зоопарку - 8" src="https://cdn.javarush.com/images/article/b053e858-f3ef-404b-941e-7b6465020d81/original.jpeg">
 </div>
</div>
<h2>ZNode Watcher</h2>Хотілося б поговорити про спостерігачів (watchers). Докладно про них написано в документації Zookeeper'а: " <a href="https://zookeeper.apache.org/doc/r3.1.2/zookeeperProgrammers.html#ch_zkWatches" target="_blank" rel="nofollow">ZooKeeper Watches</a> ". Якщо коротко, то вотчер – це такий одноразовий тригер, який спрацьовує на певну подію. Отримуючи дані, виконуючи операції getData(), getChildren() або exists(), ми можемо створити тригер як додаткову дію. Zookeeper забезпечує порядок обробки event. Крім того, в документації зазначено, що перш ніж ми зможемо побачити нове значення ZNode, ми побачимо event про зміну старого значення на нове. Докладніше про Watcher'ів можна прочитати тут: " <a href="https://data-flair.training/blogs/zookeeper-watches/" target="_blank" rel="nofollow">ZooKeeper Watches - Features &amp; Guarantees</a> ". Для того щоб це спробувати, знову скористаємося <a href="http://www.corejavaguru.com/bigdata/zookeeper/cli" target="_blank" rel="nofollow">CLI</a>: Припустимо, у нас є деякий ZNode зі значенням, де ми зберігаємо статус деякого сервісу: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token punctuation"><span class="token punctuation">[</span></span>zk<span class="token operator"><span class="token operator">:</span></span> <span class="token number"><span class="token number">127.0</span></span><span class="token number"><span class="token number">.0</span></span><span class="token number"><span class="token number">.1</span></span><span class="token operator"><span class="token operator">:</span></span><span class="token function"><span class="token function">2181</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>CONNECTED<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> create <span class="token operator"><span class="token operator">/</span></span>services<span class="token operator"><span class="token operator">/</span></span>service1<span class="token operator"><span class="token operator">/</span></span>status stopped
<span class="token class-name"><span class="token class-name">Created</span></span> <span class="token operator"><span class="token operator">/</span></span>services<span class="token operator"><span class="token operator">/</span></span>service1<span class="token operator"><span class="token operator">/</span></span>status
<span class="token punctuation"><span class="token punctuation">[</span></span>zk<span class="token operator"><span class="token operator">:</span></span> <span class="token number"><span class="token number">127.0</span></span><span class="token number"><span class="token number">.0</span></span><span class="token number"><span class="token number">.1</span></span><span class="token operator"><span class="token operator">:</span></span><span class="token function"><span class="token function">2181</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>CONNECTED<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token number"><span class="token number">1</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> get <span class="token operator"><span class="token operator">/</span></span>services<span class="token operator"><span class="token operator">/</span></span>service1<span class="token operator"><span class="token operator">/</span></span>status <span class="token punctuation"><span class="token punctuation">[</span></span>watch<span class="token punctuation"><span class="token punctuation">]</span></span>
stopped</code></pre> Тепер, якщо дані <code class=" language-none">/services/service1/status</code>зміниться, то відпрацює наш одноразовий тригер: 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-id="52aa6b0f-eef8-4f53-b0c7-d55845af6df2" data-max-width="678" alt="Zookeeper або як живеться працівнику зоопарку - 9" src="https://cdn.javarush.com/images/article/52aa6b0f-eef8-4f53-b0c7-d55845af6df2/512.jpeg" style="width: 678px;">
 </div>
</div>Цікаво, що при підключенні до Zookeeper'у ми також бачимо, як відпрацьовує вотчер: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java">WATCHER<span class="token operator"><span class="token operator">::</span></span>
<span class="token class-name"><span class="token class-name">WatchedEvent</span></span> state<span class="token operator"><span class="token operator">:</span></span><span class="token class-name"><span class="token class-name">SyncConnected</span></span> type<span class="token operator"><span class="token operator">:</span></span><span class="token class-name"><span class="token class-name">None</span></span> path<span class="token operator"><span class="token operator">:</span></span><span class="token keyword"><span class="token keyword">null</span></span></code></pre><a href="https://zookeeper.apache.org/doc/r3.3.3/api/org/apache/zookeeper/Watcher.Event.KeeperState.html#SyncConnected" target="_blank" rel="nofollow">SyncConnected</a> є однією з можливих подій Zookeper. Докладніше про нього можна переглянути в описі API. 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-max-width="164" alt="Zookeeper або як живеться працівнику зоопарку - 10" src="https://cdn.javarush.com/images/article/9aaa885e-aeb4-4497-bf48-2ded07ce1030/original.jpeg">
 </div>
</div>
<h2>Zookeeper та Java</h2>Тепер у нас є деяке базове уявлення про те, що може Zookeeper. Давайте тепер із ним попрацюємо через Java, а не через CLI. І для цього нам знадобиться Java додаток, на якому ми побачимо, як же з Zookeeper'ом працювати. Для створення програми скористаємося системою складання проектів <a href="https://gradle.org/" target="_blank" rel="nofollow">Gradle</a> . За допомогою " <a href="https://docs.gradle.org/current/userguide/build_init_plugin.html" target="_blank" rel="nofollow">Gradle Build Init plugin</a> " виконаємо створення проекту. Для цього виконаємо команду:<code class=" language-none">gradle init --type java-application</code> Якщо Gradle нас буде запитувати уточнюючі питання, то залишимо значення за замовчуванням (просто натискаємо Enter). Тепер відкриємо білд-скрипт, тобто. файл build.gradle. У ньому опис того, з чого влаштований наш проект і від яких артефактів (бібліотек, фреймворків) залежить. Т.к. ми хочемо використовувати Zookeeper, треба додати його. Тому, додамо в блок залежності залежність від Zookeeper'а: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java">dependencies <span class="token punctuation"><span class="token punctuation">{</span></span>
    implementation <span class="token string"><span class="token string">'org.apache.zookeeper:zookeeper:3.4.13'</span></span></code></pre> Докладніше про Gradle можна прочитати в огляді: " <a href="https://codegym.cc/groups/posts/2126-kratkoe-znakomstvo-s-gradle" target="_blank" rel="nofollow">Коротке знайомство з Gradle</a> ". Отже, ми маємо Java проект, до нього ми підключабо бібліотеку Zookeeper'а. Давайте тепер щось напишемо. Як ми пам'ятаємо, за допомогою CLI ми підключалися приблизно так: <code class=" language-none">zkCli.cmd -server 127.0.0.1:2181</code> Давайте в класі App в main методі оголосимо атрибут "сервер": 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">String</span></span> server <span class="token operator"><span class="token operator">=</span></span> <span class="token string"><span class="token string">"127.0.0.1:2181"</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Підключення – дія не миттєва. Нам доведеться якось у головному потоці виконання програми чекати, коли відбудеться підключення. Тому нам знадобиться лок. Оголосимо його нижче: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Object</span></span> lock <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Object</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Тепер нам потрібний хтось, хто скаже, що підключення встановлено. Як ми пам'ятаємо, коли ми це робабо через CLI, у нас спрацьовував вотчер. Так ось в Java коді все так само. Наш вотчер виводитиме повідомлення про успішне виконання і повідомлятиме про це всіх, хто чекає через лок. Напишемо вотчер: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Watcher</span></span> connectionWatcher <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Watcher</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">process</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">WatchedEvent</span></span> we<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
		<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>we<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getState</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">==</span></span> <span class="token class-name"><span class="token class-name">Event<span class="token punctuation"><span class="token punctuation">.</span></span>KeeperState<span class="token punctuation"><span class="token punctuation">.</span></span>SyncConnected</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
			<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Connected to Zookeeper in "</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">currentThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
			<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>lock<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            	lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">notifyAll</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>
		<span class="token punctuation"><span class="token punctuation">}</span></span>
	<span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Тепер допишемо підключення до сервера zooKeeper'а: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">int</span></span> sessionTimeout <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">2000</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">ZooKeeper</span></span> zooKeeper <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">null</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>lock<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	zooKeeper <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ZooKeeper</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>server<span class="token punctuation"><span class="token punctuation">,</span></span> sessionTimeout<span class="token punctuation"><span class="token punctuation">,</span></span> connectionWatcher<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
	lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">wait</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Тут все просто. При виконанні main методу в головному потоці програми ми захоплюємо lock і запитуємо підключення до zookeeper'у. При цьому ми відпускаємо лок і чекаємо, поки хтось інший не захопить лок і не повідомить нас, що можна продовжувати. Коли підключення буде встановлено, то спрацює вічер. Він перевірить, що настала подія - SyncConnected (як ми пам'ятаємо, саме її ловив вотчер через CLI), і тоді напише повідомлення. Далі ми захоплюємо lock (т.к. раніше головний потік його відпустив) і повідомляємо всі потоки, що чекають lock, що можна продовжувати. Потік обробки події виходить із synchronized блоку, тим самим звільняючи lock. Головний потік отримав повідомлення та дочекавшись звільнення lock продовжує виконання, т.к. поки не отримає lock, то він не зможе вийти з synchronized блоку та продовжити роботу. Таким чином, використовуючи багатопотоковість і Zookeeper API ми можемо виконувати різні дії. Zookeeper API набагато ширше, ніж дозволяє використовувати CLI. Наприклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token comment"><span class="token comment">// створення нового узла</span></span>
<span class="token class-name"><span class="token class-name">String</span></span> znodePath <span class="token operator"><span class="token operator">=</span></span> <span class="token string"><span class="token string">"/zookeepernode2"</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">List</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span>ACL<span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> acls <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">ZooDefs<span class="token punctuation"><span class="token punctuation">.</span></span>Ids</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>OPEN_ACL_UNSAFE<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>zooKeeper<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">exists</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>znodePath<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token boolean"><span class="token boolean">false</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">==</span></span> <span class="token keyword"><span class="token keyword">null</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
	zooKeeper<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">create</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>znodePath<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token string"><span class="token string">"data"</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getBytes</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> acls<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">CreateMode</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>PERSISTENT<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>

<span class="token comment"><span class="token comment">// Получение данных из узла</span></span>
<span class="token keyword"><span class="token keyword">byte</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> data <span class="token operator"><span class="token operator">=</span></span> zooKeeper<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getData</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>znodePath<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">null</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">null</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Result: "</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>data<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token string"><span class="token string">"UTF-8"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Як видно, під час створення вузла ми можемо налаштувати ACL. Це ще одна важлива особливість. ACL – це дозволи, які поширюються на дії з ZNode. Налаштувань багато, тому за подробицями рекомендую звернутися до офіційної документації: " <a href="https://zookeeper.apache.org/doc/r3.3.3/zookeeperProgrammers.html#sc_ACLPermissions" target="_blank" rel="nofollow">Zookeeper ACL Permissions</a> ". 
<div class="row justify-content-center jr-image-wrap">
 <div class="col-12 col-sm-10 col-md-8">
  <img data-max-width="188" alt="Zookeeper або як живеться працівнику зоопарку - 11" src="https://cdn.javarush.com/images/article/36f72875-5fa4-4d55-9447-81aca08fbc82/original.jpeg">
 </div>
</div>
<h2>Висновок</h2>Навіщо ми це прочитали? Тому що Zookeeper використовується і в інших затребуваних технологіях. Наприклад, Apache Kafka вимагає Zookeeper, про що можна прочитати в " <a href="https://kafka.apache.org/quickstart" target="_blank" rel="nofollow">Kafka Quick Start Guide</a> ". Так само використовується в NOSQL базі даних HBase, про що можна докладніше прочитати в їх " <a href="http://hbase.apache.org/book.html#quickstart" target="_blank" rel="nofollow">HBase Quickstart Guide</a> ". Насправді багато інших проектів використовують Zookeeper. Частина з них наведена у списку у " <a href="http://qaru.site/questions/25258/real-world-use-of-zookeeper" target="_blank" rel="nofollow">Використання Zookeeper у реальному світі</a> ". Сподіваюся, на запитання "навіщо" я відповів. Найголовніше питання тепер: "Що далі?" По-перше, на тему Apache Zookeeper можна почитати такі книги: 
<ul>
 <li>" <a href="https://www.oreilly.com/library/view/zookeeper/9781449361297/" target="_blank" rel="nofollow">ZooKeeper: Distributed Process Coordination</a> " , Flavio Junqueira, Benjamin Reed</li>
 <li>" <a href="https://www.oreilly.com/library/view/apache-zookeeper-essentials/9781784391324/" target="_blank" rel="nofollow">Apache ZooKeeper Essentials</a> "</li>
</ul>По-друге, є чудові відео доповіді про Zookeeper. Рекомендуються до перегляду: 
<ul>
 <li>Семінар в Яндексі: " <a href="https://habr.com/ru/company/yandex/blog/234335/" target="_blank" rel="nofollow">У чому користь ZooKeeper для розробників</a> "</li>
 <li><a href="https://www.youtube.com/watch?v=2RfBHqDWa60" target="_blank" rel="nofollow">ZooKeeper intro</a></li>
 <li><a href="https://www.youtube.com/watch?v=XgNIGjFnPQE&amp;feature=youtu.be" target="_blank" rel="nofollow">Centralized Application Configuration with Spring and Apache ZooKeeper</a></li>
</ul>По-третє, є кілька корисних статей, які доповнять картину світу: 
<ul>
 <li><a href="https://habr.com/ru/post/144708/" target="_blank" rel="nofollow">ZooKeeper або пишемо сервіс розподілених блокувань</a></li>
 <li><a href="https://ru.bmstu.wiki/Apache_ZooKeeper" target="_blank" rel="nofollow">Національна бібліотека ім. Н. Е. Баумана: Apache ZooKeeper</a></li>
 <li><a href="https://data-flair.training/blogs/zookeeper-tutorial/" target="_blank" rel="nofollow">Apache ZooKeeper Tutorial – ZooKeeper Guide for Beginners</a></li>
</ul>Вийшов зовсім невеликий огляд, але як вступне слово, сподіваюся, буде корисним. #Viacheslav