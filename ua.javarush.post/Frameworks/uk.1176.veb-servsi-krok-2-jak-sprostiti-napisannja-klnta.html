Веб-сервіси. Крок 2. Як спростити написання клієнта?
<p>----------------------------------------</p>
У цій короткій нотатці я хотів би повернутися до коду клієнта веб-сервісу, який ми написали на . При цьому я припускатиму, що у вас відкрита IDEA, а в ній проект із Кроку 1. У цьому проекті має бути запущений наш веб-сервіс:
<p>----------------------------------------</p>
У цій короткій нотатці я хотів би повернутися до коду клієнта веб-сервісу, який ми написали на <a href="https://codegym.cc/groups/posts/1168-veb-servisih-shag-1-chto-takoe-veb-servis-i-kak-s-nim-rabotatjh" target="_blank">попередньому кроці</a> . При цьому я припускатиму, що у вас відкрита IDEA, а в ній проект із Кроку 1. У цьому проекті має бути запущений наш веб-сервіс: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">package</span></span> <span class="token namespace"><span class="token namespace">ru<span class="token punctuation"><span class="token punctuation">.</span></span>codegym<span class="token punctuation"><span class="token punctuation">.</span></span>client</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token comment"><span class="token comment">// нужно, чтобы получить wsdl описание и через него</span></span>
<span class="token comment"><span class="token comment">// дотянуться до самого веб-сервиса</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>net<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span>URL<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token comment"><span class="token comment">// такой эксепшн возникнет при работе с об'єктом URL</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>net<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">MalformedURLException</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token comment"><span class="token comment">// классы, чтобы пропарсить xml-ку c wsdl описанием</span></span>
<span class="token comment"><span class="token comment">// и дотянуться до тега service в нем</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">javax<span class="token punctuation"><span class="token punctuation">.</span></span>xml<span class="token punctuation"><span class="token punctuation">.</span></span>namespace<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">QName</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">javax<span class="token punctuation"><span class="token punctuation">.</span></span>xml<span class="token punctuation"><span class="token punctuation">.</span></span>ws<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Service</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token comment"><span class="token comment">// интерфейс нашего веб-сервиса (нам больше и нужно)</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">ru<span class="token punctuation"><span class="token punctuation">.</span></span>codegym<span class="token punctuation"><span class="token punctuation">.</span></span>ws<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">HelloWebService</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">HelloWebServiceClient</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">MalformedURLException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token comment"><span class="token comment">// создаем ссылку на wsdl описание</span></span>
        <span class="token class-name"><span class="token class-name">URL</span></span> url <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token function"><span class="token function">URL</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"http://localhost:1986/wss/hello?wsdl"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

        <span class="token comment"><span class="token comment">// Параметры следующего конструктора смотрим в самом первом теге WSDL описания - definitions</span></span>
        <span class="token comment"><span class="token comment">// 1-ый аргумент смотрим в атрибуте targetNamespace</span></span>
        <span class="token comment"><span class="token comment">// 2-ой аргумент смотрим в атрибуте name</span></span>
        <span class="token class-name"><span class="token class-name">QName</span></span> qname <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">QName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"http://ws.codegym.cc/"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token string"><span class="token string">"HelloWebServiceImplService"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

        <span class="token comment"><span class="token comment">// Теперь мы можем дотянуться до тега service в wsdl описании,</span></span>
        <span class="token class-name"><span class="token class-name">Service</span></span> service <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Service</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">create</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>url<span class="token punctuation"><span class="token punctuation">,</span></span> qname<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token comment"><span class="token comment">// а далее и до вложенного в него тега port, чтобы</span></span>
        <span class="token comment"><span class="token comment">// получить ссылку на удаленный от нас об'єкт веб-сервиса</span></span>
        <span class="token class-name"><span class="token class-name">HelloWebService</span></span> hello <span class="token operator"><span class="token operator">=</span></span> service<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getPort</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">HelloWebService</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

        <span class="token comment"><span class="token comment">// Ура! Теперь можно вызывать удаленный метод</span></span>
        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>hello<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getHelloString</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"CodeGym"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Зверніть увагу, скільки нам потрібно знати заздалегідь. Крім того, що потрібен доступ до <em>wsdl</em> опису (без цього, вибачте, ніяк): 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">URL</span></span> url <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token function"><span class="token function">URL</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"http://localhost:1986/wss/hello?wsdl"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> потрібно самому відкрити цей xml файл і подивитися тег <code class=" language-none">definitions</code>, а в ньому атрибути <code class=" language-none">targetNamespace</code>і <code class=" language-none">name</code>, щоб викликати конструктор <code class=" language-none">QName</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">QName</span></span> qname <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">QName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"http://ws.codegym.cc/"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token string"><span class="token string">"HelloWebServiceImplService"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> потім потрібно вручну підключитися до тегу <code class=" language-none">service</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Service</span></span> service <span class="token operator"><span class="token operator">=</span></span> <span class="token class-name"><span class="token class-name">Service</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">create</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>url<span class="token punctuation"><span class="token punctuation">,</span></span> qname<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> а в ньому до тегу <code class=" language-none">port</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">HelloWebService</span></span> hello <span class="token operator"><span class="token operator">=</span></span> service<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getPort</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">HelloWebService</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token keyword"><span class="token keyword">class</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> і лише після цього нам можна викликати віддалений метод: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java">hello<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getHelloString</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"CodeGym"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span></code></pre> Постає питання: для цього наші прадіди гинули на полях битв, щоб ми тепер все це робабо вручну? А якщо це навіть не наш веб-сервіс, а чужий. Тоді цей процес буде ще неприємнішим. XML формат створений для читання машиною, а чи не людиною. Тож давайте змусимо машину виконувати брудну роботу, а самі насолодимося процесом. І тому нам і робити особливо нічого треба, т.к. до складу нашого улюбленого SDK, який Java називається JDK, входить спеціальна утиліта <em>wsimport</em> . Але про все по порядку… Спершу давайте створимо новий проект у IDEA, вибравши в меню пункт <em>File &gt; New Project…</em> і давши проекту ім'я <em>HelloWS</em> . Коли нас запитають, де відкрити новий проект, то потрібно відповісти <em>New Window</em>, тобто. у новому вікні, оскільки ще раз зауважу, що дуже важливо, щоб попередній проект було відкрито, т.к. ми пам'ятаємо ще з Кроку 1, що у нас у тому проекті запущено наш веб-сервіс. Можна, звичайно, запустити його просто через консоль windows, але я цього робити не люблю. З нового проекту відкриємо консоль, вибравши <em>View &gt; Tool Windows &gt; Terminal</em> або просто натиснувши <em>Alt+F12</em> . Зараз ми знаходимося в корені проекту, а потрібно потрапити до папки <em>src</em> , тому вводимо в консоль наступну команду: <code class=" language-none">cd src</code> Тепер настав час скористатися утилітою <em>wsimport</em> . Вона працює за таким принципом: ми передаємо їй <em>WSDL</em> опис, а вона у відповідь створює файли заглушки (так звані,<code class=" language-none">Stub</code>-Класи), які вже містять всю необхідну нам функціональність для доступу до веб-сервісу. Ці класи розмістяться у пакеті <code class=" language-none">com.codegym.ws</code>. Якщо запитаєте, звідки береться ім'я пакета, відповім: ім'я пакета – це розгорнуте в зворотний бік цільовий простір імен з <em>WSDL</em> опису. Згадуємо атрибут <code class=" language-none">targetNamespace</code>у тезі <code class=" language-none">definitions</code>з <em>WSDL</em> . Там у нас було написано таке <code class=" language-none">http:// ws.codegym.cc/</code>. І це не адресаа сайту, це так прийнято в XML описувати простори імен і якщо відкинути <code class=" language-none">http://</code>і розгорнути те, що залишиться, у зворотному порядку, то отримаємо наше ім'я пакета. Отже, запустимо утиліту: <code class=" language-none">wsimport -keep http://localhost:1986/wss/hello?wsdl</code> Щоб вона спрацювала, потрібно, щоб шлях до неї був прописаний у змінній оточенні <em>PATH</em>або можна просто використовувати повний шлях до неї. У мене вона розташовується в папці <em>C:\Program Files\Java\jdk1.8.0_31\bin</em> . Зверніть увагу, що все, що потрібно зробити – це передати через ключ <em>–keep</em> файл <em>WSDL</em> , який у нас доступний віддалено за посиланням, якщо ми звичайно не відключабо веб-сервіс. Що це за класи заглушки? Їх лише два. Один із них – це<code class=" language-none">HelloWebService</code>, який по суті є тим самим інтерфейсом веб-сервісу, який ми створювали вручну на Кроку 1. Різниця мінімальна і вона полягає в тому, що трохи інакше використовуються інструкції, з якими ми вже зустрічалися, а також використовуються додаткові інструкції, про які я нічого не знаю, але якщо у нас і без них раніше все працювало, то вони, очевидно, мають не обов'язковий характер. Другий клас заглушка – це те <code class=" language-none">HelloWebServiceImplService</code>, що успадковується від класу <code class=" language-none">Service</code>. З класом<code class=" language-none">Service</code>ми вже стикалися у нашому клієнті. Наводити код цього не буду, т.к. навряд чи готовий пояснити всі його рядки, але суть класу зводиться до того, що все, що ми раніше писали в клієнті вручну, щоб підключитися до веб-сервісу, у цьому класі створено автоматично і нам достатньо викликати один його метод і все в нас буде в ажурі. Тому перепишемо код нашого клієнта в новому проекті з використанням цих класів і переконаємося, що код виходить більш лаконічним. Для початку в папці <em>src</em> нового проекту створимо пакет <code class=" language-none">com.codegym.client</code>, а в ньому клас <code class=" language-none">HelloWebServiceClient</code>із методом <code class=" language-none">main</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">package</span></span> <span class="token namespace"><span class="token namespace">ru<span class="token punctuation"><span class="token punctuation">.</span></span>codegym<span class="token punctuation"><span class="token punctuation">.</span></span>client</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token comment"><span class="token comment">// подключаем классы-заглушки</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">ru<span class="token punctuation"><span class="token punctuation">.</span></span>codegym<span class="token punctuation"><span class="token punctuation">.</span></span>ws<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token operator"><span class="token operator">*</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">HelloWebServiceClient</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token comment"><span class="token comment">// подключаемся к тегу service в wsdl описании</span></span>
        <span class="token class-name"><span class="token class-name">HelloWebServiceImplService</span></span> helloService <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">HelloWebServiceImplService</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token comment"><span class="token comment">// получив информацию из тега service подключаемся к самому веб-сервису</span></span>
        <span class="token class-name"><span class="token class-name">HelloWebService</span></span> hello <span class="token operator"><span class="token operator">=</span></span> helloService<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getHelloWebServiceImplPort</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

        <span class="token comment"><span class="token comment">// обращаемся к веб-сервису и выводим результат в консоль</span></span>
        <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span> hello<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getHelloString</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"CodeGym Community"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Розбір коду елементарний і досить того, що я описав у коментарях. Запустивши клієнта, ми повинні побачити рядок: <code class=" language-none">Hello, CodeGym Community!</code>При цьому клієнт із проекту з Кроку 1 продовжуватиме працювати і виводити свій текст, який ми в ньому прописали, а саме: <code class=" language-none">Hello, CodeGym!</code> На цьому, мабуть, можна закінчити цей Крок, т.к. мету його досягнуто. Ми зрозуміли, що якщо є <em>WSDL</em> опис веб-сервісу, то <em>jdk</em> готове надати нам автоматичну генерацію <code class=" language-none">stub</code>класів-заглушок для спрощення написання клієнта до даного веб-сервісу. На мій погляд, це дуже корисна можливість на випадок, коли хочеться потестувати чужий веб-сервіс і не залазити очима в його опис <em>WSDL</em> . <strong>Погляд у майбутнє</strong> У наступній статейці про веб-сервіси я хотів би викласти ідеї, як задеплоїти веб-сервіс у контейнер сервлетів Tomcat і в різні сервери додатків, щоб не потрібно було запускати веб-сервіс, як окремий додаток, як ми це робабо на перших 2-х Кроках. Але перед цим, вважаю, краще зробити невеликий відступ на тему, <a href="https://codegym.cc/groups/posts/1182-bez-pafosa-pogovorim-o-javaee-servletakh-i-ikh-konteynerakh" target="_blank">що таке сервлети, контейнери сервлетів і чим вони відрізняються від серверів додатків і звичайних веб-с...</a> . Крім того, доведеться зробити короткий <a href="https://codegym.cc/groups/posts/1196-obzor-serverov-prilozheniy-i-konechno-zhe-tomcat" target="_blank">огляд серверів додатків</a> , які, на мій погляд, заслуговують на нашу з вами уваги.