Класи Socket та ServerSocket, або «Алло, сервер? Ти мене чуєш?"
<p>----------------------------------------</p>
Якось один мій однокурсник викладав черговий результат свого вивчення Java у вигляді скріншота нової програми. Цією програмою був розрахований на багато користувачів чат. Я тоді тільки розпочинав свій власний шлях у освоєнні програмування ц
<p>----------------------------------------</p>
<strong>Введення: «На столі був комп'ютер, за ним був кодер ...»</strong> <img width="800" height="500" data-id="d93dfdca-5fa4-4b28-a6f9-18f3bbaaf0ac" alt="Класи Socket та ServerSocket, або «Алло, сервер?  Ти мене чуєш?&quot;  - 1" src="https://cdn.javarush.com/images/article/d93dfdca-5fa4-4b28-a6f9-18f3bbaaf0ac/1080.jpeg">Якось один мій однокурсник викладав черговий результат свого вивчення Java у вигляді скріншота нової програми. Цією програмою був розрахований на багато користувачів чат. Я тоді тільки розпочинав свій власний шлях у освоєнні програмування цією мовою, але точно відзначив для себе – «хочу!». Ішов час і закінчивши роботу з черговим проектом у рамках поглиблення своїх знань програмування, я згадав про той випадок і вирішив – настав час. Якось я вже починав чисто з цікавості копати цю тему, але в моєму основному підручнику з Java (це було повне керівництво Шілдта) було надано пакету java.net лише 20 сторінок. Це і зрозуміло – книга і така велика. Там було наведено таблиці методів і конструкторів основних класів, а й усе. Наступний крок - очевидно всемогутній гугл: міріади різних статей, де представлено одне й те саме — два-три слова про сокети, і готовий приклад. Класичний підхід (як мінімум у моєму стилі навчання) - це спочатку зрозуміти, що мені потрібно з інструментів для роботи, що вони з себе уявляють, навіщо вони потрібні і тільки потім якщо вирішення завдання неочевидно колупати готові лістинги, розгвинчуючи на гайки і болтики. Але я розібрався що до чого і в результаті написав розрахований на багато користувачів чат. Зовні вийшло якось так: <img width="800" height="500" data-id="ac6622e4-e5ff-4f0a-b20b-60f7a9e70f74" alt="Класи Socket та ServerSocket, або «Алло, сервер?  Ти мене чуєш?&quot;  - 2" src="https://cdn.javarush.com/images/article/ac6622e4-e5ff-4f0a-b20b-60f7a9e70f74/1080.jpeg">Тут я постараюся дати вам розуміння основ клієнт-серверних програм на основі сокетів Java на прикладі проектування чату. На курсі джавараш ви робитимете чат. Він буде кардинально іншого рівня, гарний, великий, багатофункціональний. Але завжди в першу чергу потрібно закласти фундамент, тому тут нам з вами потрібно розібратися що лежить в основі такого розділу. (Якщо ви знайшли якісь недоліки чи помилки, напишіть у ЛЗ або у коментарі під статтею). Почнемо. <em><strong>Голова Один: «Будинок, який…»</strong></em> Для пояснення як відбувається мережне з'єднання між сервером і одним клієнтом, візьмемо, що став вже класичним, приклад з багатоквартирним будинком. Допустимо, клієнту потрібно якимось чином встановити зв'язок з певним сервером. Що потрібно знати тому, хто шукає об'єкт пошуку? Так, адресаа. Сервер це не магічна сутність на хмарі, і тому він повинен знаходитися на певній машині. За аналогією з будинком, де має відбутися зустріч двох узгоджених сторін. І щоб знайти один одного в багатоквартирному будинку однієї адресаи будівлі недостатньо, необхідно вказати номер квартири, в якій відбудеться зустріч. Так і на одній обчислювальній машині може бути відразу кілька серверів, і клієнту, щоб зв'язатися з конкретним, потрібно вказати ще й номер порту по якому відбудеться з'єднання. Отже, адресаа та номер порту. <strong>Адреса</strong>має на увазі під собою ідентифікатор машини у просторі мережі Internet. Він може бути доменним ім'ям, наприклад, <u>codegym.cc</u> , або звичайним IP. <strong>Порт</strong> - унікальний номер, з яким пов'язаний певний сокет (цей термін буде розглянуто далі), простіше кажучи, його займає певна служба для того, щоб по ньому могли зв'язатися з нею. Так що для того, щоб відбулася зустріч як мінімум двох об'єктів на території одного (сервера) - господар місцевості (сервер) повинен зайняти конкретну квартиру (порт) на ній (машині), а другий повинен знайти місце зустрічі знаючи адресау будинку (домен або ip ), та номер квартири (порт). <em><strong>Голова Два: Знайомтеся, Socket</strong></em> Серед понять та термінів, пов'язаних із роботою в мережі, якщо одне дуже важливе – Сокет. Воно позначає точку, якою відбувається з'єднання. Простіше кажучи, сокет з'єднує у мережі дві програми. Клас <code class=" language-none"><strong>Socket</strong></code>реалізує ідею сокету. Через його канали введення/виводу будуть спілкуватися клієнт із сервером: <img width="800" height="500" data-id="6fe99b5f-d96b-4bc1-8efc-c189aae0ba3f" alt="Класи Socket та ServerSocket, або «Алло, сервер?  Ти мене чуєш?&quot;  - 3" src="https://cdn.javarush.com/images/article/6fe99b5f-d96b-4bc1-8efc-c189aae0ba3f/1080.jpeg"> Оголошується цей клас на стороні клієнта, а сервер відтворює його, отримуючи сигнал на підключення. Так відбувається спілкування у мережі. Для початку ось можливі конструктори класу <code class=" language-none"><strong>Socket</strong></code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Socket</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> ім'я_хоста<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">int</span></span> порт<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">UnknownHostException</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">IOException</span></span>
<span class="token class-name"><span class="token class-name">Socket</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InetAddress</span></span> IP<span class="token operator"><span class="token operator">-</span></span>адреса<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">int</span></span> порт<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">UnknownHostException</span></span></code></pre> "ім'я_хоста" - має на увазі під собою певний вузол мережі, ip-адресау. Якщо клас сокета не зміг перетворити його на реальну, існуючу адресау, то згенерується виняток <code class=" language-none"><strong>UnknownHostException</strong></code>. Порт є порт. Якщо як номер порту буде вказано 0, то система сама виділить вільний порт. Також при втраті з'єднання може статися виняток <code class=" language-none"><strong>IOException</strong></code>. Слід зазначити тип адресаи у другому конструкторі - <code class=" language-none"><strong>InetAddress</strong></code>. Він приходить на допомогу, наприклад, коли потрібно вказати як адресау доменне ім'я. Також коли під доменом мається на увазі кілька ip-адреса, то за допомогою<code class=" language-none"><strong>InetAddress</strong></code>можна одержати їх масив. Тим не менш, з ip він працює теж. Також можна отримати ім'я хоста, масив байт складових ip адреса і т.д. Ми трохи торкнемося його далі, але за повними відомостями доведеться пройти до офіційної документації. При ініціалізації об'єкта типу <code class=" language-none"><strong>Socket</strong></code>, клієнт, якому той належить, повідомляє в мережі, що хоче з'єднатися з сервером про певну адресау та номер порту. Нижче представлені найчастіше використовувані методи класу <code class=" language-none"><strong>Socket</strong></code>: <code class=" language-none">InetAddress getInetAddress()</code>- Повертає об'єкт містить дані про сокет. Якщо сокет не підключений – null <code class=" language-none">int getPort()</code>– повертає порт яким відбувається з'єднання з сервером <code class=" language-none">int getLocalPort()</code>- Повертає порт до якого прив'язаний сокет. Справа в тому, що "спілкуватися" клієнт і сервер можуть по одному порту, а порти, до яких вони прив'язані - можуть бути зовсім інші - повертає true, <code class=" language-none">boolean isConnected()</code>якщо з'єднання встановлено <code class=" language-none">void connect(SocketAddress адреса)</code>- вказує нове з'єднання <code class=" language-none">boolean isClosed()</code>- повертає true, якщо сокет закритий <code class=" language-none">boolean isBound()</code>- повертає true, якщо сокет дійсно прив'язаний до адресаи Клас <code class=" language-none"><strong>Socket</strong></code>реалізує інтерфейс <code class=" language-none"><strong>AutoCloseable</strong></code>, тому його можна використовувати у конструкції <code class=" language-none"><strong>try-with-resources</strong></code>. Проте закрити сокет можна класичним чином, за допомогою close(). <em><strong>Голова Три: а це ServerSocket</strong></em> Припустимо, ми оголосабо, у вигляді класу <code class=" language-none"><strong>Socket</strong></code>, на стороні клієнта запит на з'єднання. Як сервер розгадає наше бажання? Для цього сервер має такий клас як<code class=" language-none"><strong> ServerSocket</strong></code>, і метод accept() у ньому. Його конструктори представлені нижче: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">ServerSocket</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">IOException</span></span>
<span class="token class-name"><span class="token class-name">ServerSocket</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> порт<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">IOException</span></span>
<span class="token class-name"><span class="token class-name">ServerSocket</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> порт<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">int</span></span> максимум_подключений<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">IOException</span></span>
<span class="token class-name"><span class="token class-name">ServerSocket</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> порт<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">int</span></span> максимум_подключений<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">InetAddress</span></span> локальный_адреса<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">IOException</span></span></code></pre> Під час оголошення <code class=" language-none"><strong>ServerSocket </strong></code>не потрібно вказувати адресау з'єднання, тому що спілкування відбувається на машині сервера. Тільки при багатоканальному хості потрібно вказати, до якого ip прив'язаний сокет сервера. <em><strong>Голова Три.Один: Сервер, який каже ні</strong></em> Так як надавати програмі більше ресурсів, ніж їй необхідно - і витратна і не розумна справа, тому в конструкторі <code class=" language-none"><strong>ServerSocket</strong></code>вам пропонують оголосити максимум з'єднань, які приймає сервер при роботі. Якщо воно не вказано, то за умовчанням це число вважатиметься рівним 50. Так, за ідеєю можна припустити, що <code class=" language-none"><strong>ServerSocket</strong></code>це такий самий сокет, тільки для сервера. Але він грає зовсім іншу роль, ніж клас <code class=" language-none"><strong>Socket</strong></code>. Він потрібний лише на етапі створення з'єднання. Створивши об'єкт типу<code class=" language-none"><strong> ServerSocket</strong></code>необхідно з'ясувати, що із сервером хтось хоче з'єднатися. Тут підключається спосіб accept(). Шуканий чекає поки хтось не захоче приєднатися до нього, і коли це відбувається повертає об'єкт типу <code class=" language-none"><strong>Socket</strong></code>, тобто відтворений клієнтський сокет. І ось коли сокет клієнта створений за сервера, можна розпочинати двостороннє спілкування. Створити об'єкт типу <code class=" language-none"><strong>Socket</strong></code>на стороні клієнта та відтворити його за допомогою <code class=" language-none"><strong>ServerSocket</strong></code>на стороні сервера – ось необхідний мінімум для з'єднання. <em><strong>Голова Чотири: Лист "діду морозу"</strong></em> <code class=" language-none"><strong>Вопрос:</strong></code> Як конкретно спілкуються клієнт та сервер? <code class=" language-none"><strong>Ответ:</strong></code>Через потоки введення виводу. Що ми маємо? Сокет з адресаою сервера та номером порту у клієнта, і те саме, завдяки accept(), на стороні сервера. Так що розумно припустити, що спілкуватися вони будуть якраз через сокет. Для цього є два методи, які дають доступ до потоків <strong><code class=" language-none">InputStream</code></strong>і <strong><code class=" language-none">OutputStream</code></strong>об'єкта типу <code class=" language-none"><strong>Socket</strong></code>. Ось вони: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">InputStream</span></span> <span class="token function"><span class="token function">getInputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
<span class="token class-name"><span class="token class-name">OutputStream</span></span> <span class="token function"><span class="token function">getOutputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span></code></pre> Так як читати і писати голі байти не так ефективно – потоки можна обернути в класи адаптери, буферизовані, чи ні. Наприклад: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">BufferedReader</span></span> in <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">BufferedReader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">InputStreamReader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>socket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getInputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">BufferedWriter</span></span> out <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">BufferedWriter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">OutputStreamWriter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>socket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getOutputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Щоб спілкування було двонаправленим, такі операції необхідно зробити на обох сторонах. Тепер ви можете надіслати щось за допомогою in, і прийняти за допомогою out, і навпаки. Власне, це практично єдина функція класу <code class=" language-none"><strong>Socket</strong></code>. І так, не забувайте про спосіб flush() для <code class=" language-none"><strong> BufferedWriter</strong></code>- він виштовхує вміст буфера. Якщо цього не зробити, інформація не буде передана, а отже, не буде отримана. Також приймаючий потік чекає покажчик кінця рядка – «\n», інакше повідомлення буде прийнято, оскільки фактично повідомлення закінчено, і є цілим. Якщо вам це здається незручним, не засмучуйтесь, завжди можна скористатися класом <code class=" language-none"><strong>PrintWriter</strong></code>, яким потрібно обернути out, вказати другим аргументом true і тоді виштовхування з буфера буде відбуватися автоматично: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">PrintWriter</span></span> out <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">PrintWriter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">BufferedWriter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">OutputStreamWriter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>socket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getOutputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Також при цьому вказувати кінець рядка немає необхідності, за вас це робить цей клас. Але чи є введення/виведення рядків межами можливостей сокету? Ні, хочете оправляти об'єкти через потоки сокету? Заради Бога. Серіалізуйте їх і вперед: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">ObjectOutputStream</span></span> out <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>socket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getOutputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token class-name"><span class="token class-name">ObjectInputStream</span></span> in <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ObjectInputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>socket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getInputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre><em><strong>Голова П'ять: Реальний зв'язок по мережі Internet</strong></em> Так як для того, щоб з'єднатися по реальній мережі з реальною IP адресаою потрібно мати повноцінний сервер, а так: 
<ol>
 <li>Наш майбутній чат, як утиліта, таких здібностей не має. Він може лише встановити з'єднання та прийняти/надіслати повідомлення. Тобто він не має реальних можливостей сервера.</li>
 <li>Наш сервер, що містить лише дані сокету та потоків вводу/виводу, не може працювати як реальний WEB-або FTP-сервер, то маючи лише це ми не зможемо з'єднатися через мережу Internet.</li>
</ol>І до того ж, ми лише починаємо розробляти програму, а це означає, що вона не досить стабільна, щоб відразу працювати з реальною мережею, так що ми будемо використовувати як адресау для з'єднання локальний хост. Тобто за ідеєю клієнт і сервер все одно ніяк не будуть пов'язані крім як через сокет, але для налагодження програми вони перебуватиму на одній машині, без реального контакту по мережі. Для того щоб вказати в конструкторі <code class=" language-none"><strong>Socket</strong></code>, що адресаа локальна, існує два способи: 
<ol>
 <li>Написати як аргумент адресаи «localhost», що означає локальну заглушку. Так само для цього підходить «127.0.0.1» - це лише цифрова форма заглушки.</li>
 <li>За допомогою InetAddress: 
  <ol>
   <li><code class=" language-none">InetAddress.getByName(null)</code>- null вказує на локальний хост</li>
   <li><code class=" language-none">InetAddress.getByName("localhost")</code></li>
   <li><code class=" language-none">InetAddress.getByName("127.0.0.1") </code></li>
  </ol></li>
</ol> Для простоти ми будемо використовувати "localhost" типу String. Але решта варіантів теж працездатні. <em><strong>Голова Шість: Настав час для розмови</strong></em> Отже, все, що нам потрібно для реалізації сеансу розмови з сервером, у нас вже є. Залишилося зібрати це воєдино: Наступний лістинг показує, як підключається клієнт до сервера, відсилає йому одне повідомлення, а той у свою чергу підтверджує, що отримав повідомлення, використовуючи його як аргумент у своєму: "Server.java" 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>io<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token operator"><span class="token operator">*</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>net<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">ServerSocket</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>net<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Socket</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Server</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">Socket</span></span> clientSocket<span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Сокет для спілкування</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">ServerSocket</span></span> server<span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// серверсокет</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">BufferedReader</span></span> in<span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// потік читання із сокету</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">BufferedWriter</span></span> out<span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Потік запису в сокет</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">try</span></span>  <span class="token punctuation"><span class="token punctuation">{</span></span>
                server <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ServerSocket</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">4004</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// серверсокет прослуховує порт 4004</span></span>
                <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Сервер запущено!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// добре б серверу</span></span>
                <span class="token comment"><span class="token comment">// оголосити про свій запуск</span></span>
                clientSocket <span class="token operator"><span class="token operator">=</span></span> server<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">accept</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// accept() чекатиме поки</span></span>
                <span class="token comment"><span class="token comment">//Хто-небудь не захоче підключитися</span></span>
                <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span> <span class="token comment"><span class="token comment">// встановивши зв'язок та відтворивши сокет для спілкування з клієнтом можна перейти</span></span>
                    <span class="token comment"><span class="token comment">// До створення потоків введення/виводу.</span></span>
                    <span class="token comment"><span class="token comment">// тепер ми можемо приймати повідомлення</span></span>
                    in <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">BufferedReader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">InputStreamReader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>clientSocket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getInputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                    <span class="token comment"><span class="token comment">// і відправляти</span></span>
                    out <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">BufferedWriter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">OutputStreamWriter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>clientSocket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getOutputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

                    <span class="token class-name"><span class="token class-name">String</span></span> word <span class="token operator"><span class="token operator">=</span></span> in<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">readLine</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// чекаємо поки клієнт щось нам напише</span></span>
                    <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>word<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                    <span class="token comment"><span class="token comment">// Не довго думаючи відповідає клієнту</span></span>
                    out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">write</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Привіт, це Сервер! Підтверджую, ви написали:"</span></span> <span class="token operator"><span class="token operator">+</span></span> word <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">"\n"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                    out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">flush</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// виштовхуємо все з буфера</span></span>

                <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">finally</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span> <span class="token comment"><span class="token comment">// у будь-якому випадку сокет буде закритий</span></span>
                    clientSocket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                    <span class="token comment"><span class="token comment">// потоки теж добре закрити</span></span>
                    in<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                    out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token punctuation"><span class="token punctuation">}</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">finally</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Сервер закрито!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                    server<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">IOException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>err<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>e<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> "Client.java" 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>io<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token operator"><span class="token operator">*</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>net<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Socket</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Client</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">Socket</span></span> clientSocket<span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Сокет для спілкування</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">BufferedReader</span></span> reader<span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// нам потрібен рідер, що читає з консолі, інакше як</span></span>
    <span class="token comment"><span class="token comment">// ми дізнаємося, що хоче сказати клієнт?</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">BufferedReader</span></span> in<span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// потік читання із сокету</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">BufferedWriter</span></span> out<span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Потік запису в сокет</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                <span class="token comment"><span class="token comment">// адресаа - локальний хост, порт - 4004, такий самий як у сервера</span></span>
                clientSocket <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Socket</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"localhost"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token number"><span class="token number">4004</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// цим рядком ми запитуємо</span></span>
                <span class="token comment"><span class="token comment">// сервер має доступ на з'єднання</span></span>
                reader <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">BufferedReader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">InputStreamReader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>in<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token comment"><span class="token comment">// читати повідомлення із сервера</span></span>
                in <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">BufferedReader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">InputStreamReader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>clientSocket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getInputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token comment"><span class="token comment">// писати туди ж</span></span>
                out <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">BufferedWriter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">OutputStreamWriter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>clientSocket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getOutputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

                <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Ви щось хотіли сказати? Введіть це тут:"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token comment"><span class="token comment">// якщо з'єднання відбулося і потоки успішно створені – ми можемо</span></span>
                <span class="token comment"><span class="token comment">// працювати далі і запропонувати клієнту щось ввести</span></span>
                <span class="token comment"><span class="token comment">// якщо ні – вилетить виняток</span></span>
                <span class="token class-name"><span class="token class-name">String</span></span> word <span class="token operator"><span class="token operator">=</span></span> reader<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">readLine</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// чекаємо поки клієнт щось</span></span>
                <span class="token comment"><span class="token comment">// не напише в консоль</span></span>
                out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">write</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>word <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">"\n"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// надсилаємо повідомлення на сервер</span></span>
                out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">flush</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token class-name"><span class="token class-name">String</span></span> serverWord <span class="token operator"><span class="token operator">=</span></span> in<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">readLine</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// чекаємо, що скаже сервер</span></span>
                <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>serverWord<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// отримавши - виводимо на екран</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">finally</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span> <span class="token comment"><span class="token comment">// у будь-якому випадку необхідно закрити сокет та потоки</span></span>
                <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Клієнт був закритий..."</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                clientSocket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                in<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">IOException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>err<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>e<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Зрозуміло, запускати слід спочатку сервер, бо до чого підключатиметься клієнт при запуску якщо не буде того, що його підключить? :) Висновок буде такий: / * <em>Ви щось хотіли сказати? Введіть це тут: Алло, сервер? Ти мене чуєш? Привіт це Сервер! Підтверджую, ви написали: Алло, сервер? Ти мене чуєш? Клієнт був закритий...</em> */ Ура! Ми навчабо сервер спілкуватися із клієнтом! Щоб спілкування відбувалося не в дві репліки, а стільки скільки завгодно, просто оберніть читання і запис потоків в цикл while (true) і вкажіть для виходу що, за певним повідомленням, наприклад, exit, цикл переривався, і програма завершилася б. <em><strong>Голова Сім: Розрахований на багато користувачів - краще</strong></em> Те, що сервер нас чує це добре, але набагато краще, якщо можна було б поспілкуватися з кимось із собі подібних. Всі вихідники я докладу в кінці статті, так що тут я показуватиму не завжди великі, але важливі шматочки коду, які дадуть можливість при правильному використанні з'єднати розрахований на багато користувачів чат. Отже, ми хочемо, щоб через сервер ми могли спілкуватися з іншим клієнтом. Як це зробити? Очевидно, що клієнтська програма має свій метод<code class=" language-none">main</code>, тобто його можна запускати окремо від сервера і паралельно з іншими клієнтами. Що це нам дає? Якимось чином потрібно що при кожному новому підключенні сервер не переходив відразу до спілкування, а записував це з'єднання в якийсь список і переходив до очікування нового підключення, а спілкуванням з конкретним клієнтом займався б якийсь допоміжний сервіс. Та й клієнти повинні писати на сервер і чекати на відповідь незалежно один від одного. На допомогу приходять нитки. Допустимо, у нас є клас, який відповідає за запам'ятовування нових підключень: У нього повинні бути вказані: 
<ol>
 <li>Номер порту.</li>
 <li>Список, до якого записує нове з'єднання.</li>
 <li>І <code class=" language-none"><strong>ServerSocket</strong></code>, в єдиному (!) екземплярі.</li>
</ol>
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Server</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token keyword"><span class="token keyword">int</span></span> PORT <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">8080</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token class-name"><span class="token class-name">LinkedList</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">ServerSomthing</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> serverList <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">LinkedList</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Список всіх ниток</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">IOException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">ServerSocket</span></span> server <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ServerSocket</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>PORT<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">while</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                <span class="token comment"><span class="token comment">// Блокується до виникнення нової сполуки:</span></span>
                <span class="token class-name"><span class="token class-name">Socket</span></span> socket <span class="token operator"><span class="token operator">=</span></span> server<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">accept</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                    serverList<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">add</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ServerSomthing</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>socket<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// додати нове з'єднання до списку</span></span>
                <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">IOException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                    <span class="token comment"><span class="token comment">// Якщо завершиться невдачею, закривається сокет,</span></span>
                    <span class="token comment"><span class="token comment">/ / В іншому випадку, нитка закриє його при завершенні роботи:</span></span>
                    socket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token punctuation"><span class="token punctuation">}</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">finally</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            server<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">close</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Окей, тепер кожен відтворений сокет не загубиться, а зберігатиметься на сервері. Далі. Кожного клієнта має хтось слухати. Давайте створимо нитку із серверними функціями з попереднього розділу. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">ServerSomthing</span></span> <span class="token keyword"><span class="token keyword">extends</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Socket</span></span> socket<span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Сокет, через який сервер спілкується з клієнтом,</span></span>
    <span class="token comment"><span class="token comment">// Крім нього - клієнт і сервер не пов'язані</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">BufferedReader</span></span> in<span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// потік читання із сокету</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">BufferedWriter</span></span> out<span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Потік запису в сокет</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">ServerSomthing</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Socket</span></span> socket<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">IOException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>socket <span class="token operator"><span class="token operator">=</span></span> socket<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token comment"><span class="token comment">// якщо потоку введення/виводу призведуть до генерування виключення, воно прокинеться далі</span></span>
        in <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">BufferedReader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">InputStreamReader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>socket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getInputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        out <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">BufferedWriter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">OutputStreamWriter</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>socket<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getOutputStream</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Викликаємо run()</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">run</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token class-name"><span class="token class-name">String</span></span> word<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

            <span class="token keyword"><span class="token keyword">while</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                word <span class="token operator"><span class="token operator">=</span></span> in<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">readLine</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                <span class="token keyword"><span class="token keyword">if</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>word<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">equals</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"stop"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                    <span class="token keyword"><span class="token keyword">break</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>                <span class="token punctuation"><span class="token punctuation">}</span></span>
                <span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">ServerSomthing</span></span> vr <span class="token operator"><span class="token operator">:</span></span> <span class="token class-name"><span class="token class-name">Server</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>serverList<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                    vr<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">send</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>word<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// надіслати прийняте повідомлення з</span></span>
                   <span class="token comment"><span class="token comment">// Прив'язаного клієнта всім іншим, включаючи його</span></span>
                <span class="token punctuation"><span class="token punctuation">}</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>

        <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">IOException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">send</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> msg<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">write</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>msg <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">"\n"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">flush</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">IOException</span></span> ignored<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span><span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Отже, у конструкторі серверної нитки має бути ініціалізований сокет, через який нитка спілкуватиметься з конкретним клієнтом. Також потоки введення/виводу, і до того ж потрібно запустити нитку прямо з конструктора. Добре, але що відбуватиметься під час читання повідомлення від клієнта для серверної нитки? Відсилати назад лише своєму клієнту? Не дуже ефективно. Ми робимо розрахований на багато користувачів чат, тому нам потрібно що б кожен підключений клієнт отримав те що написав хтось один. Потрібно скористатися списком всіх серверних ниток, прив'язаних до своїх клієнтів, і надіслати кожне надіслане конкретної нитки повідомлення, щоб та надіслала його своєму клієнту: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">ServerSomthing</span></span> vr <span class="token operator"><span class="token operator">:</span></span> <span class="token class-name"><span class="token class-name">Server</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>serverList<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    vr<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">send</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>word<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Надіслати прийняте повідомлення</span></span>
    <span class="token comment"><span class="token comment">// з прив'язаного клієнта решті, включаючи його</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre>
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">send</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> msg<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">write</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>msg <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">"\n"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">flush</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">IOException</span></span> ignored<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span><span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Тепер всі клієнти дізнаються про те, що сказав один з них! Якщо ви не хочете, щоб повідомлення приходило тому, хто його відправив (він і так знає, що він написав!) просто при переборі ниток вкажіть, що б при обробці об'єкта<code class=" language-none"><strong>this</strong></code>цикл переходив до наступного елементу, не виконуючи з нього ніяких дій. Або ж, якщо хочете, надішліть повідомлення клієнту, в якому написано, що повідомлення успішно прийнято та надіслано. Із сервером тепер все зрозуміло. Перейдемо до клієнта, точніше до клієнтів! Там так само, за аналогією з клієнтом з попереднього розділу, тільки створюючи екземпляр потрібно як було показано в цьому розділі з сервером, створити все необхідне в конструкторі. Але якщо при створенні клієнта він ще не встиг нічого ввести, а йому вже щось відправабо? (Наприклад, історію листування тих, хто підключився до чату до нього). Так що цикли, в яких оброблятимуся надіслані повідомлення повинні бути відокремлені від тих, в яких читаються повідомлення з консолі і відправляються на сервер для пересилання іншим. На допомогу знову приходять нитки. Немає сенсу створювати клієнта як нитку. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token comment"><span class="token comment">// нитка читання повідомлень із сервера</span></span>
<span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">ReadMsg</span></span> <span class="token keyword"><span class="token keyword">extends</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">run</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

        <span class="token class-name"><span class="token class-name">String</span></span> str<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token keyword"><span class="token keyword">while</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                str <span class="token operator"><span class="token operator">=</span></span> in<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">readLine</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Чекаємо на повідомлення з сервера</span></span>
                <span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>str<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">equals</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"stop"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

                    <span class="token keyword"><span class="token keyword">break</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// виходимо з циклу, якщо прийшло "stop"</span></span>
                <span class="token punctuation"><span class="token punctuation">}</span></span>
                            <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">IOException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre>
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token comment"><span class="token comment">// нитка відправляє повідомлення, які надходять з консолі на сервер</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">WriteMsg</span></span> <span class="token keyword"><span class="token keyword">extends</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

    <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">run</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">while</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token boolean"><span class="token boolean">true</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token class-name"><span class="token class-name">String</span></span> userWord<span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
               userWord <span class="token operator"><span class="token operator">=</span></span> inputUser<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">readLine</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Повідомлення з консолі</span></span>
                <span class="token keyword"><span class="token keyword">if</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>userWord<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">equals</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"stop"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                    out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">write</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"stop"</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">"\n"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
                    <span class="token keyword"><span class="token keyword">break</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// виходимо з циклу, якщо прийшло "stop"</span></span>
                <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">else</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
                    out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">write</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>userWord <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">"\n"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// відправляємо на сервер</span></span>
                <span class="token punctuation"><span class="token punctuation">}</span></span>
                out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">flush</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> <span class="token comment"><span class="token comment">// Чистимо</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">IOException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

            <span class="token punctuation"><span class="token punctuation">}</span></span>

        <span class="token punctuation"><span class="token punctuation">}</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> У конструкторі клієнта потрібно просто запустити ці нитки. А як правильно закрити ресурси клієнта, якщо той захоче вийти? Чи потрібно закривати ресурси серверної нитки? Для цього необхідно буде швидше створити окремий метод, що викликається при виході з циклу обробки повідомлень. Там потрібно буде закрити сокет та потоки введення/виводу. Той самий сигнал закінчення сесії для конкретного клієнта має бути відправлений його серверної нитки, яка має зробити теж зі своїм сокетом і видалити себе зі списку ниток в основному класі сервера. <em><strong>Голова Вісім: Немає межі досконалості</strong></em> Можна довго вигадувати нові фічі для вдосконалення свого проекту. Але що точно має бути передано новому клієнту? Я думаю, що останні десять подій, що відбулися до його приходу. Для цього необхідно створити клас, в якому до оголошеного списку заноситиметься остання дія з будь-якою серверною ниткою, і, якщо список вже повний (тобто 10 вже є), видалити перше і занести останнім, що прийшло. Для того щоб вміст цього списку отримав новий підключився, потрібно при створенні серверної нитки, в потоці виведення, відіслати їх клієнту. Як це зробити? Наприклад, так: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">printStory</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">BufferedWriter</span></span> writer<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
<span class="token comment"><span class="token comment">// ...</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Серверна нитка вже створила потоки і може виводити потік виводу як аргумент. Далі просто потрібно в циклі перебору все, що необхідно передати новому клієнту. <em><strong>Це</strong></em> лише основи основ, і швидше за все така архітектура чату не підійде при створенні реального додатка. Ця програма створена у навчальних цілях і на її основі я показав, як можна змусити спілкуватися клієнта з сервером (і навпаки), як це зробити для кількох підключень, і, звичайно, як це організовано на сокетах. Нижче переставлені джерела, а також прикладено вихідний код програми, що розбирається. Це мій перший досвід написання статті) Дякуємо за увагу:) 
<ol>
 <li>Thinking in Java Enterprise, Bruce Eckel et. Al. 2003</li>
 <li>Java 8, Повне керівництво, Герберт Шилдт, 9 видання, 2017 (Глава 22)</li>
 <li>Програмування сокетів на Java <a href="http://www.quizful.net/post/java-socket-programming" target="_blank" rel="nofollow">стаття про сокети</a></li>
 <li><a href="https://docs.oracle.com/javase/7/docs/api/java/net/Socket.html" target="_blank" rel="nofollow">Socket в офіційній документації</a></li>
 <li><a href="https://docs.oracle.com/javase/7/docs/api/java/net/ServerSocket.html" target="_blank" rel="nofollow">ServerSocket в офіційній документації</a></li>
 <li><a href="https://github.com/izotopraspadov/Talk" target="_blank" rel="nofollow">вихідники на GitHub</a></li>
</ol>