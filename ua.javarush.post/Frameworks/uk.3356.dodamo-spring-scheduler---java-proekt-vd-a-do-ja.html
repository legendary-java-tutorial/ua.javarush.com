Додаємо Spring Scheduler - "Java-проект від А до Я"
<p>----------------------------------------</p>
Привіт усім, мої любі друзі. У ми підготували клієнт до роботи з JavaRush API для статей. Тепер можна писати логіку для роботи нашої джоби, яка виконуватиметься кожні 15 хвилин. Ось так, як показано на цій схемі . До речі, я вже у своєму ТГ
<p>----------------------------------------</p>
Привіт усім, мої любі друзі. У <a href="https://codegym.cc/groups/posts/3355-java-proekt-ot-a-do-ja-dobavljaem-klienta-k-statjhjam" target="_blank">попередній статті</a> ми підготували клієнт до роботи з CodeGym API для статей. Тепер можна писати логіку для роботи нашої джоби, яка виконуватиметься кожні 15 хвабон. Ось так, як показано на цій схемі <img data-max-width="1080" data-id="5e716b48-101a-47f8-8eb0-a637eff3702c" alt="&quot;Java-проект від А до Я&quot;: Додаємо Spring Scheduler - 1" src="https://cdn.javarush.com/images/article/5e716b48-101a-47f8-8eb0-a637eff3702c/1080.jpeg" style="width: 1080px;">.
<ol>
 <li>
  <p>Знаходить у всіх групах, які є у нашій БД, нові статті, що вийшли після попереднього виконання.</p>
  <div class="table-container">
   <table>
    <tbody>
     <tr>
      <td>У цій схемі вказано меншу кількість груп лише з активними користувачами. На той момент мені це здалося логічним, але зараз я розумію, що незалежно від того, чи є активні користувачі, підписані на конкретну групу чи ні, все одно потрібно тримати актуальним останню статтю, що бот обробив. Може виникнути ситуація, коли новому користувачеві прийде одразу вся кількість статей, що вийшла з моменту деактивації цієї групи. А це не очікувана поведінка, і щоб її уникнути, потрібно тримати актуальними й ті групи з нашої БД, що на даний момент не мають активних користувачів.</td>
     </tr>
    </tbody>
   </table>
  </div></li>
 <li>
  <p>Якщо є нові статті, сформувати повідомлення для всіх користувачів, які активно підписані на цю групу. Якщо нових статей немає, то просто завершуємо роботу.</p></li>
</ol>До речі, я вже <a href="https://t.me/romankh3/56" rel="nofollow" target="_blank">згадував</a> у своєму ТГ-каналі, бот вже працює та надсилає нові статті за підписками. Почнемо писати <span class="code">FindNewArtcileService</span> . У ньому відбуватиметься вся робота з пошуку та відправлення повідомлень, а джоба лише запускатиме метод цього сервісу:
<h4>FindNewArticleService:</h4>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Service for finding new articles.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FindNewArticleService</span> <span class="token punctuation">{</span>

   <span class="token comment">/**
    * Find new articles and notify subscribers about it.
    */</span>
   <span class="token keyword">void</span> <span class="token function">findNewArticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Дуже простий, правда? У цьому його й суть, а вся складність буде у реалізації: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>codegymclient<span class="token punctuation">.</span></span><span class="token class-name">CodeGymPostClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>codegymclient<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">PostInfo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">GroupSub</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FindNewArticleServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">FindNewArticleService</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> CODEGYM_WEB_POST_FORMAT <span class="token operator">=</span> <span class="token string">"https://codegym.cc/groups/posts/%s"</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">GroupSubService</span> groupSubService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CodeGymPostClient</span> codeGymPostClient<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SendBotMessageService</span> sendMessageService<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">public</span> <span class="token class-name">FindNewArticleServiceImpl</span><span class="token punctuation">(</span><span class="token class-name">GroupSubService</span> groupSubService<span class="token punctuation">,</span>
                                    <span class="token class-name">CodeGymPostClient</span> codeGymPostClient<span class="token punctuation">,</span>
                                    <span class="token class-name">SendBotMessageService</span> sendMessageService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>groupSubService <span class="token operator">=</span> groupSubService<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>codeGymPostClient <span class="token operator">=</span> codeGymPostClient<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageService <span class="token operator">=</span> sendMessageService<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findNewArticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       groupSubService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>gSub <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
           <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PostInfo</span><span class="token punctuation">&gt;</span></span> newPosts <span class="token operator">=</span> codeGymPostClient<span class="token punctuation">.</span><span class="token function">findNewPosts</span><span class="token punctuation">(</span>gSub<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gSub<span class="token punctuation">.</span><span class="token function">getLastArticleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token function">setNewLastArticleId</span><span class="token punctuation">(</span>gSub<span class="token punctuation">,</span> newPosts<span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token function">notifySubscribersAboutNewArticles</span><span class="token punctuation">(</span>gSub<span class="token punctuation">,</span> newPosts<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">notifySubscribersAboutNewArticles</span><span class="token punctuation">(</span><span class="token class-name">GroupSub</span> gSub<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PostInfo</span><span class="token punctuation">&gt;</span></span> newPosts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span>newPosts<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> messagesWithNewArticles <span class="token operator">=</span> newPosts<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>post <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"✨Вышла новая статья &lt;b&gt;%s&lt;/b&gt; в группе &lt;b&gt;%s&lt;/b&gt;.✨\n\n"</span> <span class="token operator">+</span>
                               <span class="token string">"&lt;b&gt;Описание:&lt;/b&gt; %s\n\n"</span> <span class="token operator">+</span>
                               <span class="token string">"&lt;b&gt;Ссылка:&lt;/b&gt; %s\n"</span><span class="token punctuation">,</span>
                       post<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gSub<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getPostUrl</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       gSub<span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">TelegramUser</span><span class="token operator">::</span><span class="token function">isActive</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> sendMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messagesWithNewArticles<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setNewLastArticleId</span><span class="token punctuation">(</span><span class="token class-name">GroupSub</span> gSub<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PostInfo</span><span class="token punctuation">&gt;</span></span> newPosts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       newPosts<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token class-name">PostInfo</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>id <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                   gSub<span class="token punctuation">.</span><span class="token function">setLastArticleId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   groupSubService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>gSub<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getPostUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>CODEGYM_WEB_POST_FORMAT<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Тут розберемося з усім по порядку:
<ol>
 <li>
  <p>За допомогою <span class="code">groupService</span> ми знаходимо всі групи, які є в базі даних.</p></li>
 <li>
  <p>Потім розбігаємось по всіх групах і для кожної викликаємо створений у минулій статті клієнт - <span class="code">codeGymPostClient.findNewPosts</span> .</p></li>
 <li>
  <p>Далі за допомогою методу <span class="code">setNewArticleId</span> ми оновлюємо ID шник нашої останньої нової статті, щоб наша база даних знала, що ми вже опрацювали нові.</p></li>
 <li>
  <p>І за допомогою того, що GroupSub має колекцію користувачів, пробігаємо по активних і надсилаємо повідомлення про нові статті.</p></li>
</ol>Яке там повідомлення зараз обговорювати не будемо, для нас це не дуже важливо. Головне, що метод працює. Логіка пошуку нових статей та відправлення повідомлень готова, тому можна перейти до створення джоби.
<h2>Створюємо FindNewArticleJob</h2>Ми вже говорабо про те, що таке SpringScheduler, але ще раз повторимо швидко: це механізм у Spring фреймворку для створення фонового процесу, який буде виконуватися в певний час, що задається нами. Що потрібно для цього? Перший етап - додати інструкцію <span class="code">@EnableScheduling</span> до нашого вхідного класу для спрингу: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableScheduling</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableScheduling</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavarushTelegramBotApplication</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">JavarushTelegramBotApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre> Другий етап - створити клас, додати його до <span class="code">ApplicationContext</span> і створити в ньому метод, який запускатиметься періодично. Створюємо пакет job на одному рівні з repository, service тощо і там створюємо клас <span class="code">FindNewArticleJob</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>job</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">FindNewArticleService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Scheduled</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">ZoneOffset</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Job for finding new articles.
*/</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FindNewArticlesJob</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">FindNewArticleService</span> findNewArticleService<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">public</span> <span class="token class-name">FindNewArticlesJob</span><span class="token punctuation">(</span><span class="token class-name">FindNewArticleService</span> findNewArticleService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>findNewArticleService <span class="token operator">=</span> findNewArticleService<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>fixedRateString <span class="token operator">=</span> <span class="token string">"${bot.recountNewArticleFixedRate}"</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findNewArticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">LocalDateTime</span> start <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Find new article job started."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       findNewArticleService<span class="token punctuation">.</span><span class="token function">findNewArticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">LocalDateTime</span> end <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Find new articles job finished. Took seconds: {}"</span><span class="token punctuation">,</span>
               end<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span>UTC<span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span>UTC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Щоб додати цей клас до <span class="code">Application Context</span> , я використав інструкцію <span class="code">@Component</span> . А щоб метод усередині класу знав, що йому потрібно запускатися періодично, я додав до методу інструкцію: <span class="code">@Scheduled(fixedRateString = "${bot.recountNewArticleFixedRate}")</span> . А ось яке значення буде – його ми задаємо вже в application.properties файлі: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java">bot<span class="token punctuation">.</span>recountNewArticleFixedRate <span class="token operator">=</span> <span class="token number">900000</span></code></pre> Тут значення вказано у мілісекундах. Це буде 15 хвабон. У цьому методі все просто: я для себе в логах додав супер просту метрику для підрахунку пошуку нових статей, щоб хоч приблизно уявляти, наскільки швидко працює.
<h2>Тестуємо новий функціонал</h2>Тепер тестуватимемо на нашому тестовому боті. Але як? Не буду ж я видаляти щоразу статті, щоб показати, що сповіщення прийшли? Ні звичайно. Просто правитимемо дані в БД і запускатимемо додаток. Тестуватиму я на своєму тестовому рівні. Для цього підпишемося на якусь групу. Коли підписку буде оформлено, групі буде поставлено актуальне ID останньої статті. Ходімо в основу і змінимо значення на дві статті тому. У результаті очікуємо, що буде стільки статей, на скільки раніше поставимо <span class="code">останнійматеріал</span> . <img data-max-width="512" data-id="45e1848f-2d41-44a9-88dd-39a7d5aab70a" alt="&quot;Java-проект від А до Я&quot;: Додаємо Spring Scheduler - 2" src="https://cdn.javarush.com/images/article/45e1848f-2d41-44a9-88dd-39a7d5aab70a/512.jpeg" style="width: 512px;">Далі йдемо на сайт, сортуємо статті в групі Java-проекти — <span class="text-bold">спочатку нові</span> — і заходимо до третьої статті зі списку: <img data-max-width="800" data-id="9cc45e77-7594-40f1-949e-83b57aceada3" alt="&quot;Java-проект від А до Я&quot;: Додаємо Spring Scheduler - 3" src="https://cdn.javarush.com/images/article/9cc45e77-7594-40f1-949e-83b57aceada3/800.jpeg" style="width: 800px;">Зайдемо в нижню статтю та з адресаного рядка отримаємо article Id — 3313: <img data-max-width="1080" data-id="af5c3554-cb74-478f-9a2d-65ff3354153c" alt="&quot;Java-проект від А до Я&quot;: Додаємо Spring Scheduler - 4" src="https://cdn.javarush.com/images/article/af5c3554-cb74-478f-9a2d-65ff3354153c/1080.jpeg" style="width: 1080px;">Далі йдемо в MySQL Workbench і змінюємо значення<span class="code">lastArticleId</span> на 3313. Подивимося, що така група є в базі: <img data-max-width="512" data-id="51820eac-8ccc-4e71-88e7-a8bc35ea8ce2" alt="&quot;Java-проект від А до Я&quot;: Додаємо Spring Scheduler - 5" src="https://cdn.javarush.com/images/article/51820eac-8ccc-4e71-88e7-a8bc35ea8ce2/512.jpeg" style="width: 512px;">І для неї виконаємо команду: <img data-max-width="800" data-id="0a5cc05d-901a-4ae3-92d8-02708dde7a9f" alt="&quot;Java-проект від А до Я&quot;: Додаємо Spring Scheduler - 6" src="https://cdn.javarush.com/images/article/0a5cc05d-901a-4ae3-92d8-02708dde7a9f/800.jpeg" style="width: 800px;">І все тепер потрібно почекати до наступного запуску джоби з пошуку нових статей. Очікуємо, що прийде два повідомлення про нову статтю із групи Java-проекти. Як кажуть, результат не забарився: <img data-max-width="512" data-id="506580dc-3c19-45ee-a725-b10c9d864429" alt="&quot;Java-проект від А до Я&quot;: Додаємо Spring Scheduler - 7" src="https://cdn.javarush.com/images/article/506580dc-3c19-45ee-a725-b10c9d864429/512.jpeg" style="width: 512px;">Виходить, що бот відпрацював так, як ми і очікували.
<h2>Закінчення</h2>Як завжди — оновлюємо версію в pom.xml і додаємо запис в RELEASE_NOTES, щоб історія роботи збереглася і завжди можна було повернутися і зрозуміти, що змінилося. Тому інкрементуємо одну одиницю версію: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">0.7</span><span class="token number">.0</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span></code></pre> І оновлюємо RELEASE_NOTES: 
<div class="terminal">
 ## 0.7.0-SNAPSHOT * JRTB-4: розширена здатність до нових повідомлень про нові елементи * JRTB-8: розширена здатність до набору в активному телеграмі користувача * JRTB-9: розширена здатність до набору активного користувача і/або натиснути його.
</div> Тепер можна створювати пулл-реквест і заливати нові зміни. Ось пулл-реквест із усіма змінами за дві частини: <a href="https://github.com/codegymcommunity/codegym-telegrambot/pull/25" rel="nofollow" target="_blank">STEP_8</a>. Що далі? Вже здавалося б усе готове і, як кажуть у нас, може виходити у продакшен, але є ще деякі речі, які хочеться зробити. Наприклад, налаштувати роботу адмінів у бота, додати їх та додати можливість задавати їх. Також перед закінченням добре б пройтися кодом і подивитися, чи немає речей, які можна відрефакторити. Я вже бачу розсинхрон в назві article/post. Насамкінець зробимо ретроспективу того, що ми планували і що отримали. І що хочеться зробити у майбутньому. Зараз поділюся з вами досить сирою ідеєю, яка може побачити світ: зробити springboot starter, який мав би всю функціональність по роботі з телеграм-ботом і пошуком статей. Це дасть змогу уніфікувати підхід та використовувати його для інших телеграм-ботів. Таким чином, цей проект стане більш доступним для інших і зможе принести користь більшій кількості людей. Це одна з ідей. Інша ідея — йти вглиб розробки нотифікацій. Але про це ми поговоримо дещо пізніше. <em>Всім дякую за увагу, з вас як завжди: <s>лайк - передплата - дзвіночок</s> , зірку <a href="https://github.com/codegymcommunity/codegym-telegrambot" rel="nofollow" target="_blank">нашому проекту</a> , коментар та оцінити статтю! </em> Дякую всім за прочитання.<a href="https://codegym.cc/login/signup" target="_blank"><img id="click_banner1_articles" data-max-width="1080" data-id="5736eb4b-2b1c-4ab6-b4cc-b9e2d1cef628" alt="&quot;Java-проект від А до Я&quot;: Додаємо Spring Scheduler - 2" src="https://cdn.javarush.com/images/article/5736eb4b-2b1c-4ab6-b4cc-b9e2d1cef628/1080.jpeg" style="width: 1080px;"></a>
<h4><a href="https://codegym.cc/groups/posts/2935-java-proekt-ot-a-do-ja-pishem-realjhnihy-proekt-dlja-portfolio#articles" target="_blank">Список всіх матеріалів серії на початку цієї статті.</a></h4>