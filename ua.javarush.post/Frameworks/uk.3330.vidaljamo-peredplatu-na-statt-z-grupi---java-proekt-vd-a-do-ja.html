Видаляємо передплату на статті з групи - "Java-проект від А до Я"
<p>----------------------------------------</p>
Всім привіт, мої дорогі друзі майбутні Senior Software Engineers. Продовжуємо розробку телеграм-бота. На цьому етапі нашого проекту розглянемо три завдання, у яких більше видимого значення, ніж програмного. Нам потрібно навчитися видаляти п
<p>----------------------------------------</p>
Всім привіт, мої дорогі друзі майбутні Senior Software Engineers. Продовжуємо розробку телеграм-бота. На цьому етапі нашого проекту розглянемо три завдання, у яких більше видимого значення, ніж програмного. Нам потрібно навчитися видаляти передплату на нові статті з певної групи: за допомогою команди <span class="text-bold">/ stop</span> деактивувати бота, а за допомогою команди <span class="text-bold">/ start</span> - активувати. Причому так, щоб усі запити та оновлення стосувалися лише активних користувачів бота. Як завжди, оновимо <span class="code">main</span> гілка, щоб отримати всі зміни, і створимо нову: STEP_7_JRTB-7. У цій частині поговоримо про видалення передплати та розглянемо 5 варіантів подій – буде цікаво.
<h2>JRTB-7: видалення передплати нових статей з групи</h2>Ясна річ, що всім користувачам захочеться мати можливість видалити передплату, щоб не отримувати сповіщення про нові статті. Його логіка буде дуже схожа на логіку додавання передплати. Якщо ми надаємо лише одну команду, у відповідь нам прийде список груп та їх ID, на які користувач уже підписаний, щоб можна було зрозуміти, що саме потрібно видалити. А якщо користувач разом із командою передасть ID групи, ми видалимо передплату. Тож підемо розробляти цю команду з боку телеграм-бота.
<ol>
 <li>
  <p>Додамо ім'я нової команди - <span class="text-bold">/deleteGroupSub</span> , а <span class="code">CommandName</span> - рядок:</p>
  <p></p>
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token function">DELETE_GROUP_SUB</span><span class="token punctuation">(</span><span class="token string">"/deleteGroupSub"</span><span class="token punctuation">)</span></code></pre>
  <p></p></li>
 <li>
  <p>Далі створимо команду <span class="text-bold">DeleteGroupSubCommand</span> :</p>
  <p></p>
  <pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">GroupSub</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">GroupSubService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TelegramUserService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">CollectionUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Update</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>rs<span class="token punctuation">.</span></span><span class="token class-name">NotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">CommandName</span><span class="token punctuation">.</span>DELETE_GROUP_SUB<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">CommandUtils</span><span class="token punctuation">.</span>getChatId<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">CommandUtils</span><span class="token punctuation">.</span>getMessage<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">String</span><span class="token punctuation">.</span>format<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span>SPACE<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span>isNumeric<span class="token punctuation">;</span>

<span class="token comment">/**
* Delete Group subscription {@link Command}.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeleteGroupSubCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">GroupSubService</span> groupSubService<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">DeleteGroupSubCommand</span><span class="token punctuation">(</span><span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">,</span> <span class="token class-name">GroupSubService</span> groupSubService<span class="token punctuation">,</span>
                                <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sendBotMessageService <span class="token operator">=</span> sendBotMessageService<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>groupSubService <span class="token operator">=</span> groupSubService<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>telegramUserService <span class="token operator">=</span> telegramUserService<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMessage</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>DELETE_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">sendGroupIdList</span><span class="token punctuation">(</span><span class="token function">getChatId</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token class-name">String</span> groupId <span class="token operator">=</span> <span class="token function">getMessage</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>SPACE<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> chatId <span class="token operator">=</span> <span class="token function">getChatId</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNumeric</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GroupSub</span><span class="token punctuation">&gt;</span></span> optionalGroupSub <span class="token operator">=</span> groupSubService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>optionalGroupSub<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">GroupSub</span> groupSub <span class="token operator">=</span> optionalGroupSub<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">TelegramUser</span> telegramUser <span class="token operator">=</span> telegramUserService<span class="token punctuation">.</span><span class="token function">findByChatId</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token class-name">NotFoundException</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               groupSub<span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
               groupSubService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>groupSub<span class="token punctuation">)</span><span class="token punctuation">;</span>
               sendBotMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Удалил подписку на группу: %s"</span><span class="token punctuation">,</span> groupSub<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               sendBotMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> <span class="token string">"Не нашел такой группы =/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           sendBotMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> <span class="token string">"неправильный формат ID группы.\n "</span> <span class="token operator">+</span>
                   <span class="token string">"ID должно быть целым положительным числом"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendGroupIdList</span><span class="token punctuation">(</span><span class="token class-name">String</span> chatId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> message<span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GroupSub</span><span class="token punctuation">&gt;</span></span> groupSubs <span class="token operator">=</span> telegramUserService<span class="token punctuation">.</span><span class="token function">findByChatId</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token class-name">NotFoundException</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">getGroupSubs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>groupSubs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           message <span class="token operator">=</span> <span class="token string">"Пока нет подписок на группы. Щобы добавить подписку напиши /addGroupSub"</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           message <span class="token operator">=</span> <span class="token string">"Щобы удалить подписку на группу - передай комадну вместе с ID группы. \n"</span> <span class="token operator">+</span>
                   <span class="token string">"Например: /deleteGroupSub 16 \n\n"</span> <span class="token operator">+</span>
                   <span class="token string">"я подготовил список всех групп, на которые ты подписан) \n\n"</span> <span class="token operator">+</span>
                   <span class="token string">"ім'я группы - ID группы \n\n"</span> <span class="token operator">+</span>
                   <span class="token string">"%s"</span><span class="token punctuation">;</span>

       <span class="token punctuation">}</span>
       <span class="token class-name">String</span> userGroupSubData <span class="token operator">=</span> groupSubs<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>group <span class="token operator">-&gt;</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s - %s \n"</span><span class="token punctuation">,</span> group<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> group<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       sendBotMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> <span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> userGroupSubData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
  <p></p></li>
</ol>Для цього довелося додати ще два методи для роботи з GroupSub сутністю - отримання з БД по ID та збереження самої сутності. Всі ці методи викликають вже готові методи репозиторію. Окремо розповім про видалення передплати. У схемі бази даних це та таблиця, яка відповідає за many-to-many процес, і щоб видалити цей зв'язок, потрібно видалити в ній запис. Це якщо скористатися загальним розумінням з боку БД. Але ми використовуємо Spring Data і там за умовчанням стоїть Hibernate, котрий вміє це робити інакше. Ми отримуємо сутність GroupSub, до якої підтягнуться всі користувачі, пов'язані з нею. З цієї колекції користувачів видалімо потрібну нам і назад збережемо groupSub в БД, але вже без цього користувача. Таким чином, Spring Data зрозуміє, що ми хотіли, і видалить запис.<img data-max-width="800" data-id="70607075-1edd-481c-a401-9695c490cf97" alt="&quot;Java-проект від А до Я&quot;: Видаляємо передплату на статті з групи - 1" src="https://cdn.javarush.com/images/article/70607075-1edd-481c-a401-9695c490cf97/800.jpeg" style="width: 800px;"><img data-max-width="800" data-id="a632e3f7-86ed-405a-887a-5f44e5fb39f7" alt="&quot;Java-проект від А до Я&quot;: Видаляємо передплату на статті з групи - 2" src="https://cdn.javarush.com/images/article/a632e3f7-86ed-405a-887a-5f44e5fb39f7/800.jpeg" style="width: 800px;">Щоб швидко видалити користувача, я додав анотацію EqualsAndHashCode для TelegramUser, виключивши список GroupSub, щоб не було жодних проблем. І викликав у колекції користувачів метод remove із потрібним нам користувачем. Ось як це виглядає у TelegramUser: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"tg_user"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EqualsAndHashCode</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token string">"groupSubs"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TelegramUser</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Id</span>
   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"chat_id"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> chatId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"active"</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> active<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">"users"</span><span class="token punctuation">,</span> fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span>EAGER<span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GroupSub</span><span class="token punctuation">&gt;</span></span> groupSubs<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> В результаті все злетіло, як ми хотіли. У команді є кілька варіантів подій, тому написати хороший тест на кожен із них — це чудова ідея. До слова про тести: поки писав їх, знайшов дефект у логіці та виправив його ще до виходу в прод. Не було б тесту - неясно, як швидко виявив би його. DeleteGroupSubCommandTest: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">GroupSub</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">GroupSubService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TelegramUserService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">BeforeEach</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DisplayName</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>mockito<span class="token punctuation">.</span></span><span class="token class-name">Mockito</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Update</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">AbstractCommandTest</span><span class="token punctuation">.</span>prepareUpdate<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">CommandName</span><span class="token punctuation">.</span>DELETE_GROUP_SUB<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">.</span>singletonList<span class="token punctuation">;</span>

<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"Unit-level testing for DeleteGroupSubCommand"</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">DeleteGroupSubCommandTest</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">Command</span> command<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">;</span>
   <span class="token class-name">GroupSubService</span> groupSubService<span class="token punctuation">;</span>
   <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">;</span>


   <span class="token annotation punctuation">@BeforeEach</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       sendBotMessageService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupSubService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">GroupSubService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       telegramUserService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">TelegramUserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteGroupSubCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> groupSubService<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldProperlyReturnEmptySubscriptionList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//given</span>
       <span class="token class-name">Long</span> chatId <span class="token operator">=</span> <span class="token number">23456L</span><span class="token punctuation">;</span>
       <span class="token class-name">Update</span> update <span class="token operator">=</span> <span class="token function">prepareUpdate</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> DELETE_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>telegramUserService<span class="token punctuation">.</span><span class="token function">findByChatId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">String</span> expectedMessage <span class="token operator">=</span> <span class="token string">"Пока нет подписок на группы. Щобы добавить подписку напиши /addGroupSub"</span><span class="token punctuation">;</span>

       <span class="token comment">//when</span>
       command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expectedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldProperlyReturnSubscriptionLit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//given</span>
       <span class="token class-name">Long</span> chatId <span class="token operator">=</span> <span class="token number">23456L</span><span class="token punctuation">;</span>
       <span class="token class-name">Update</span> update <span class="token operator">=</span> <span class="token function">prepareUpdate</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> DELETE_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">TelegramUser</span> telegramUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">GroupSub</span> gs1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       gs1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       gs1<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"GS1 Title"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       telegramUser<span class="token punctuation">.</span><span class="token function">setGroupSubs</span><span class="token punctuation">(</span><span class="token function">singletonList</span><span class="token punctuation">(</span>gs1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>telegramUserService<span class="token punctuation">.</span><span class="token function">findByChatId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">String</span> expectedMessage <span class="token operator">=</span> <span class="token string">"Щобы удалить подписку на группу - передай комадну вместе с ID группы. \n"</span> <span class="token operator">+</span>
               <span class="token string">"Например: /deleteGroupSub 16 \n\n"</span> <span class="token operator">+</span>
               <span class="token string">"я подготовил список всех групп, на которые ты подписан) \n\n"</span> <span class="token operator">+</span>
               <span class="token string">"ім'я группы - ID группы \n\n"</span> <span class="token operator">+</span>
               <span class="token string">"GS1 Title - 123 \n"</span><span class="token punctuation">;</span>

       <span class="token comment">//when</span>
       command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expectedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldRejectByInvalidGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//given</span>
       <span class="token class-name">Long</span> chatId <span class="token operator">=</span> <span class="token number">23456L</span><span class="token punctuation">;</span>
       <span class="token class-name">Update</span> update <span class="token operator">=</span> <span class="token function">prepareUpdate</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s %s"</span><span class="token punctuation">,</span> DELETE_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"groupSubId"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">TelegramUser</span> telegramUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">GroupSub</span> gs1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       gs1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       gs1<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"GS1 Title"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       telegramUser<span class="token punctuation">.</span><span class="token function">setGroupSubs</span><span class="token punctuation">(</span><span class="token function">singletonList</span><span class="token punctuation">(</span>gs1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>telegramUserService<span class="token punctuation">.</span><span class="token function">findByChatId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">String</span> expectedMessage <span class="token operator">=</span> <span class="token string">"неправильный формат ID группы.\n "</span> <span class="token operator">+</span>
               <span class="token string">"ID должно быть целым положительным числом"</span><span class="token punctuation">;</span>

       <span class="token comment">//when</span>
       command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expectedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldProperlyDeleteByGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//given</span>

       <span class="token comment">/// prepare update object</span>
       <span class="token class-name">Long</span> chatId <span class="token operator">=</span> <span class="token number">23456L</span><span class="token punctuation">;</span>
       <span class="token class-name">Integer</span> groupId <span class="token operator">=</span> <span class="token number">1234</span><span class="token punctuation">;</span>
       <span class="token class-name">Update</span> update <span class="token operator">=</span> <span class="token function">prepareUpdate</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s %s"</span><span class="token punctuation">,</span> DELETE_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> groupId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


       <span class="token class-name">GroupSub</span> gs1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       gs1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       gs1<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"GS1 Title"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">TelegramUser</span> telegramUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       telegramUser<span class="token punctuation">.</span><span class="token function">setChatId</span><span class="token punctuation">(</span>chatId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       telegramUser<span class="token punctuation">.</span><span class="token function">setGroupSubs</span><span class="token punctuation">(</span><span class="token function">singletonList</span><span class="token punctuation">(</span>gs1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       users<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
       gs1<span class="token punctuation">.</span><span class="token function">setUsers</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>groupSubService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>gs1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>telegramUserService<span class="token punctuation">.</span><span class="token function">findByChatId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">String</span> expectedMessage <span class="token operator">=</span> <span class="token string">"Удалил подписку на группу: GS1 Title"</span><span class="token punctuation">;</span>

       <span class="token comment">//when</span>
       command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       users<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>groupSubService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>gs1<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expectedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldDoesNotExistByGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//given</span>
       <span class="token class-name">Long</span> chatId <span class="token operator">=</span> <span class="token number">23456L</span><span class="token punctuation">;</span>
       <span class="token class-name">Integer</span> groupId <span class="token operator">=</span> <span class="token number">1234</span><span class="token punctuation">;</span>
       <span class="token class-name">Update</span> update <span class="token operator">=</span> <span class="token function">prepareUpdate</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s %s"</span><span class="token punctuation">,</span> DELETE_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> groupId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>groupSubService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">String</span> expectedMessage <span class="token operator">=</span> <span class="token string">"Не нашел такой группы =/"</span><span class="token punctuation">;</span>

       <span class="token comment">//when</span>
       command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>groupSubService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expectedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Тут кожен тест перевіряє окремий сценарій, а їх, нагадаю, лише п'ять:
<ul>
 <li>коли просто передали команду <span class="text-bold">/deleteGroupSub</span> і немає підписок на групи;</li>
 <li>коли просто передали команду <span class="text-bold">/deleteGroupSub</span> та є підписки на групи;</li>
 <li>коли передали невалідний ID групи, наприклад <span class="text-bold">/deleteGroupSub abc</span> ;</li>
 <li>сценарій, за якого все правильно вилучиться, як і очікується;</li>
 <li>сценарій, коли ID групи валідний, але такої групи немає у БД.</li>
</ul>Як можна побачити, всі ці сценарії потрібно покривати тестами. Я ось поки писав - зрозумів, що для кращого написання тестів варто пройти якісь курси тестувальників. Думаю, це допоможе правильно шукати різні варіанти. Це так думки на майбутнє. Далі потрібно додати в команді <span class="text-bold">/help</span> опис того, що тепер можна видаляти передплату. Помістимо її до секцій роботи з підписками. <img data-max-width="800" data-id="dda39455-c7f7-4fab-bf6a-8a1b79a52b52" alt="&quot;Java-проект від А до Я&quot;: Видаляємо передплату на статті з групи - 3" src="https://cdn.javarush.com/images/article/dda39455-c7f7-4fab-bf6a-8a1b79a52b52/800.jpeg" style="width: 800px;">Зрозуміло, щоб ця команда запрацювала, потрібно додати її ініціалізацію до <span class="code">CommandContainer</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>DELETE_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token keyword">new</span> <span class="token class-name">DeleteGroupSubCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> groupSubService<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre> Тепер можна тестувати функціонал на тестовому боті. Запускаємо нашу базу за допомогою docker-compose-test.yml: <span class="text-bold">docker-compose -f docker-compose-test.yml up</span> І через IDEA запускаємо SpringBoot. Повністю очищу листування з ботом і почну заново. Прожену всі варіанти, які можуть виникнути під час роботи з цією командою. <img data-max-width="800" data-id="6683ae95-de7d-44f2-88e3-52009a06e77e" alt="&quot;Java-проект від А до Я&quot;: Видаляємо передплату на статті з групи - 4" src="https://cdn.javarush.com/images/article/6683ae95-de7d-44f2-88e3-52009a06e77e/800.jpeg" style="width: 800px;">Як видно зі скріншоту, всі варіанти пройшли та пройшли успішно.
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <td>Друзі! Хочете відразу дізнаватися, коли вийде новий код за проектом? Коли виходить нова стаття? Приєднуйтесь до мого <a href="https://t.me/joinchat/SpqRPBFo_sM6qm05" rel="nofollow" target="_blank">Телеграм-каналу</a> . Там я збираю свою статтю, думки і open source розробку воєдино.</td>
   </tr>
  </tbody>
 </table>
</div>Оновлюємо версію нашого проекту на 0.6.0-SNAPSHOT Оновлюємо RELEASE_NOTES.md, додаючи опис того, що зроблено у новій версії: 
<div class="terminal">
 ## 0.6.0-SNAPSHOT * JRTB-7: added ability до delete group subscription.
</div> Код працює, тести на нього написані: настав час пушити завдання в репозиторій і створювати пул-реквест.<img data-max-width="1080" data-id="7368adf4-04e6-444c-847f-428cbab3bf4e" alt="&quot;Java-проект від А до Я&quot;: Видаляємо передплату на статті з групи - 5" src="https://cdn.javarush.com/images/article/7368adf4-04e6-444c-847f-428cbab3bf4e/1080.jpeg" style="width: 1080px;">
<h2>Замість закінчення</h2>Давно ми не дивабося на наш борд проекту, адже там відбулися великі зміни: <img data-max-width="800" data-id="8aef6fd9-bacc-475b-9686-d14914c25424" alt="&quot;Java-проект від А до Я&quot;: Видаляємо підписку на статті з групи - 6" src="https://cdn.javarush.com/images/article/8aef6fd9-bacc-475b-9686-d14914c25424/800.jpeg" style="width: 800px;">Залишилося всього 5 завдань. Тобто ми з вами вже наприкінці шляху. Залишилося небагато. Особливо його подивитися, що ця серія статей йде із середини вересня, тобто протягом 7 місяців! Я колись придумав цю ідею, не очікував, що буде тааак довго. Водночас результатом я задоволений більш ніж! Друзі, якщо не зрозуміло, що відбувається у статті, ставте запитання у коментарях. Так я знатиму, що щось варто краще описати, а щось додатково пояснити. <em>Ну і як завжди <s>лайк – передплата – дзвіночок,</s> ставте зірку <a href="https://github.com/codegymcommunity/codegym-telegrambot" rel="nofollow" target="_blank">нашому проекту</a> , пишіть коментарі та оцінюйте статтю!</em> Всім дякую. До наступної частини. Скоро поговоримо про те, як додати деактивацію та активацію бота через команди <span class="text-bold">/stop</span> &amp; <span class="text-bold">/start</span> і про те, як їх краще використовувати. До скорого!<a href="https://codegym.cc/login/signup" target="_blank"><img id="click_banner1_articles" data-max-width="1080" data-id="5736eb4b-2b1c-4ab6-b4cc-b9e2d1cef628" alt="&quot;Java-проект від А до Я&quot;: Видаляємо передплату на статті з групи - 7" src="https://cdn.javarush.com/images/article/5736eb4b-2b1c-4ab6-b4cc-b9e2d1cef628/1080.jpeg" style="width: 1080px;"></a>
<h4><a href="https://codegym.cc/groups/posts/2935-java-proekt-ot-a-do-ja-pishem-realjhnihy-proekt-dlja-portfolio#articles" target="_blank">Список всіх матеріалів серії на початку цієї статті.</a></h4>