Додаємо можливість передплатити групу статей. (Частина 3) - "Java-проект від А до Я"
<p>----------------------------------------</p>
Ще раз привіт. Це заключна стаття STEP_6, в якій ми поговоримо про додавання функціональності завдання . У тих двох попередніх статтях ( , ) ми вже підготували майже все, що потрібно. У цій частині – кульмінація процесу. Усім, хто дочитав ц
<p>----------------------------------------</p>
Ще раз привіт. Це заключна стаття STEP_6, в якій ми поговоримо про додавання функціональності завдання <a href="https://github.com/codegymcommunity/codegym-telegrambot/issues/6" rel="nofollow" target="_blank">JRTB-6</a> . У тих двох попередніх статтях ( <a href="https://codegym.cc/groups/posts/3300-java-proekt-ot-a-do-ja-dobavljaem-vozmozhnostjh-podpisatjhsja-na-gruppu-statey-chastjh-1" target="_blank">частина 1</a> , <a href="https://codegym.cc/groups/posts/3313-java-proekt-ot-a-do-ja-dobavljaem-vozmozhnostjh-podpisatjhsja-na-gruppu-statey-chastjh-2" target="_blank">частина 2</a> ) ми вже підготували майже все, що потрібно. У цій частині – кульмінація процесу. Усім, хто дочитав цю серію статей до цього моменту від самого початку, — великий респект. Це означає, що мотивації вистачить на те, щоб знайти чудову роботу. А тепер перейдемо до діла.<img data-max-width="800" data-id="3a674a8e-51d6-428e-8687-3421ec0aaec7" alt="&quot;Java-проект від А до Я&quot;: Додаємо можливість передплатити групу статей.  Частина 3 - 1" src="https://cdn.javarush.com/images/article/3a674a8e-51d6-428e-8687-3421ec0aaec7/800.jpeg" style="width: 800px;">
<h2>Реалізуємо JRTB-6</h2>Цього разу робитимемо завдання з боку телеграм-бота, тому що робота з оновлення БД вся зроблена, сутності БД налаштовані та готові до роботи. Додамо в <span class="code">CommandName</span> нове значення - LIST_GROUP_SUB: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token function">LIST_GROUP_SUB</span><span class="token punctuation">(</span><span class="token string">"/listGroupSub"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Створимо команду <span class="code">ListGroupSubCommand</span> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">GroupSub</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TelegramUserService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Update</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>rs<span class="token punctuation">.</span></span><span class="token class-name">NotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">CommandUtils</span><span class="token punctuation">.</span>getChatId<span class="token punctuation">;</span>

<span class="token comment">/**
* {@link Command} for getting list of {@link GroupSub}.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ListGroupSubCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">ListGroupSubCommand</span><span class="token punctuation">(</span><span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">,</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sendBotMessageService <span class="token operator">=</span> sendBotMessageService<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>telegramUserService <span class="token operator">=</span> telegramUserService<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//todo add exception handling</span>
       <span class="token class-name">TelegramUser</span> telegramUser <span class="token operator">=</span> telegramUserService<span class="token punctuation">.</span><span class="token function">findByChatId</span><span class="token punctuation">(</span><span class="token function">getChatId</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token class-name">NotFoundException</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"Я нашел все подписки на группы: \n\n"</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> collectedGroups <span class="token operator">=</span> telegramUser<span class="token punctuation">.</span><span class="token function">getGroupSubs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> <span class="token string">"Группа: "</span> <span class="token operator">+</span> it<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" , ID = "</span> <span class="token operator">+</span> it<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" \n"</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       sendBotMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message <span class="token operator">+</span> collectedGroups<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Тут все максимально просто - за наявним chat_id отримуємо користувача, і в нього вже в об'єкті будуть зібрані всі його підписки на групи. Ми це налаштовували у другій частині. Знову ж таки, додав //todo, щоб не забути додати обробку винятків, які можуть з'явитися під час роботи. Наступним етапом оновлюємо <span class="code">CommandContainer</span> , додаючи йому нову команду: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token function">put</span><span class="token punctuation">(</span>LIST_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GroupSubListCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre> По суті все: тепер потрібно написати ще тести, оновити команду <span class="text-bold">/help</span> (додати опис для нових команд) і протестувати новий функціонал через Телеграм. Напишемо тест для <span class="code">ListGroupSubCommand</span> . Так як логіка у команди не типова, то писатимемо тест, не прив'язуючись до <span class="code">AbstractCommandTest</span> класу, як ми робабо до цього: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">GroupSub</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TelegramUserService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DisplayName</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>mockito<span class="token punctuation">.</span></span><span class="token class-name">Mockito</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Message</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Update</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">CommandName</span><span class="token punctuation">.</span>LIST_GROUP_SUB<span class="token punctuation">;</span>

<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"Unit-level testing for ListGroupSubCommand"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ListGroupSubCommandTest</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldProperlyShowsListGroupSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//given</span>
       <span class="token class-name">TelegramUser</span> telegramUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       telegramUser<span class="token punctuation">.</span><span class="token function">setActive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       telegramUser<span class="token punctuation">.</span><span class="token function">setChatId</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GroupSub</span><span class="token punctuation">&gt;</span></span> groupSubList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupSubList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">populateGroupSub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"gs1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupSubList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">populateGroupSub</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"gs2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupSubList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">populateGroupSub</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"gs3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupSubList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">populateGroupSub</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"gs4"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       telegramUser<span class="token punctuation">.</span><span class="token function">setGroupSubs</span><span class="token punctuation">(</span>groupSubList<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">SendBotMessageService</span> sendBotMessageService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">TelegramUserService</span> telegramUserService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">TelegramUserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>telegramUserService<span class="token punctuation">.</span><span class="token function">findByChatId</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">ListGroupSubCommand</span> command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListGroupSubCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">Update</span> update <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>LIST_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       update<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">String</span> collectedGroups <span class="token operator">=</span> <span class="token string">"Я нашел все подписки на группы: \n\n"</span> <span class="token operator">+</span>
               telegramUser<span class="token punctuation">.</span><span class="token function">getGroupSubs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                       <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> <span class="token string">"Группа: "</span> <span class="token operator">+</span> it<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" , ID = "</span> <span class="token operator">+</span> it<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" \n"</span><span class="token punctuation">)</span>
                       <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//when</span>
       command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>telegramUser<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> collectedGroups<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token class-name">GroupSub</span> <span class="token function">populateGroupSub</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> title<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">GroupSub</span> gs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       gs<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
       gs<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> gs<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2>Обновимо /help команду</h2>У нашому випадку <span class="text-bold">/help</span> команда виконує роль документації для роботи з ботом, тому її потрібно не забувати оновлювати, щоб користувач зміг нею скористатися. У нас додалися дві команди, тому оновимо текст, який приходитиме: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> HELP_MESSAGE <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"✨Дотупные команды✨\n\n"</span>

               <span class="token operator">+</span> <span class="token string">"Начать\\закончить работу с ботом:\n"</span>
               <span class="token operator">+</span> <span class="token string">"%s - начать работу со мной\n"</span>
               <span class="token operator">+</span> <span class="token string">"%s - приостановить работу со мной\n\n"</span>

               <span class="token operator">+</span> <span class="token string">"Работа с подписками на группы:\n"</span>
               <span class="token operator">+</span> <span class="token string">"%s - подписаться на группу статей\n"</span>
               <span class="token operator">+</span> <span class="token string">"%s - получить список групп, на которые подписан\n\n"</span>

               <span class="token operator">+</span> <span class="token string">"%s - получить помощь в работе со мной\n"</span>
               <span class="token operator">+</span> <span class="token string">"%s - получить мою статистику использования\n"</span><span class="token punctuation">,</span>
       START<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ADD_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       LIST_GROUP_SUB<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HELP<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STAT<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Також я оновив текст відповідей бота: зробив так, щоб він завжди був на "ти" з користувачем, а то там було і "ти", і "ви"... Тепер можна буде створити зв'язок у роботі бота.
<h2>Тестуємо роботу оновленого робота</h2>Локально запускаємо нашого бота і робимо таке:
<ol>
 <li>Виконуємо <span class="text-bold">/start</span> команду – щоб бути впевненим, що користувач у тестовому випадку доданий до БД.</li>
 <li>Виконуємо <span class="text-bold">/help</span> команду - перевіряємо, що все, як ми хотіли.</li>
 <li>Далі виконуємо команду <span class="text-bold">/addGroupSub</span> .</li>
 <li>Із запропонованого списку ID-шників груп додаємо кілька разнобій.</li>
 <li>Виконуємо команду <span class="text-bold">/listGroupSub</span> , щоб переконатися, що групи записані на користувача.</li>
</ol>Поїхали! Запускаємо БД через docker-compose-test.yml та стартуємо наш SpringBoot. Далі, заходимо в нашого тестового бота і виконуємо /start команду, а за нею - <span class="text-bold">/help</span> : <img data-max-width="800" data-id="e056190a-d931-4e11-9764-9ba1d31423f6" alt="&quot;Java-проект від А до Я&quot;: Додаємо можливість передплатити групу статей.  Частина 3 - 2" src="https://cdn.javarush.com/images/article/e056190a-d931-4e11-9764-9ba1d31423f6/800.jpeg" style="width: 800px;">Далі вводимо команду <span class="text-bold">/addGroupSub</span> : <img data-max-width="800" data-id="b1687531-6eec-4041-b76e-d9f2e6327774" alt="&quot;Java-проект від А до Я&quot;: Додаємо можливість передплатити групу статей.  Частина 3 - 3" src="https://cdn.javarush.com/images/article/b1687531-6eec-4041-b76e-d9f2e6327774/800.jpeg" style="width: 800px;">Випадаючий список говорить, що Java-клієнт працює як потрібно: у нас всі групи з їх ID-шниками, опис команди допомагає (сподіваюся) зрозуміти, що потрібно далі, тому додаємо кілька груп у підписку: <img data-max-width="800" data-id="da476478-849f-4f2d-adc5-7c2c2a951481" alt="&quot;Java-проект від А до Я&quot;: Додаємо можливість передплатити групу статей.  Частина 3 - 4" src="https://cdn.javarush.com/images/article/da476478-849f-4f2d-adc5-7c2c2a951481/800.jpeg" style="width: 800px;">Тепер у нас є 5 підписок, так що можна виконати команду <span class="text-bold">/listGroupSub</span> : <img data-max-width="800" data-id="6c9673ab-6f20-4f02-8804-313a3e311ee5" alt="&quot;Java-проект від А до Я&quot;: Додаємо можливість передплатити групу статей.  Частина 3 – 5" src="https://cdn.javarush.com/images/article/6c9673ab-6f20-4f02-8804-313a3e311ee5/800.jpeg" style="width: 800px;">І тут ми отримуємо якусь дичину... Незрозуміло, чому щойно показувало <span class="text-bold">title</span> без будь-яких проблем, а тут ні. Ідемо до бази даних, щоб подивитися що там:<img data-max-width="512" data-id="60c70419-9ef9-4046-ae4f-fe7aae50158c" alt="&quot;Java-проект від А до Я&quot;: Додаємо можливість передплатити групу статей.  Частина 3 - 6" src="https://cdn.javarush.com/images/article/60c70419-9ef9-4046-ae4f-fe7aae50158c/512.jpeg" style="width: 512px;">У базі даних записані самі питання, але тільки для тих, де кирабоця. Значить якась проблема з кодуванням. Потрібно налаштувати, мабуть, базу даних та драйвер для з'єднання з БД. Нам потрібна UTF-8. Але як його додати? Після кількох хвабон пошуку в інтернетах <a href="https://stackoverflow.com/a/14603678/10219066" rel="nofollow" target="_blank">знайшов</a> : для драйвера потрібно оновити url змінну. І для налаштування образу докера в docker-compose взагалі <a href="https://stackoverflow.com/a/53398381/10219066" rel="nofollow" target="_blank">найперше посилання</a> , але відповідь не перша)) Тому, знаючи це, оновимо проперти і docker-compose файли. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">application<span class="token punctuation">.</span>properties<span class="token operator">:</span>
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>url<span class="token operator">=</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>jrtb<span class="token operator">-</span>db<span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>jrtb_db<span class="token operator">?</span>characterEncoding<span class="token operator">=</span>UTF<span class="token operator">-</span><span class="token number">8</span>

application<span class="token operator">-</span>test<span class="token punctuation">.</span>properties<span class="token operator">:</span>
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>url<span class="token operator">=</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>dev_jrtb_db<span class="token operator">?</span>characterEncoding<span class="token operator">=</span>UTF<span class="token operator">-</span><span class="token number">8</span>

docker<span class="token operator">-</span>compose<span class="token punctuation">.</span>yml <span class="token punctuation">(</span>добавил последнюю строку<span class="token punctuation">)</span><span class="token operator">:</span>
jrtb<span class="token operator">-</span>db<span class="token operator">:</span>
 image<span class="token operator">:</span> mysql<span class="token operator">:</span><span class="token number">5.7</span>
 restart<span class="token operator">:</span> always
 environment<span class="token operator">:</span>
   MYSQL_USER<span class="token operator">:</span> $<span class="token punctuation">{</span>BOT_DB_USERNAME<span class="token punctuation">}</span>
   MYSQL_PASSWORD<span class="token operator">:</span> $<span class="token punctuation">{</span>BOT_DB_PASSWORD<span class="token punctuation">}</span>
   MYSQL_DATABASE<span class="token operator">:</span> <span class="token string">'jrtb_db'</span>
   MYSQL_ROOT_PASSWORD<span class="token operator">:</span> <span class="token string">'root'</span>
 ports<span class="token operator">:</span>
   <span class="token operator">-</span> <span class="token string">'3306:3306'</span>
 expose<span class="token operator">:</span>
   <span class="token operator">-</span> <span class="token string">'3306'</span>
 command<span class="token operator">:</span> <span class="token operator">--</span>character<span class="token operator">-</span>set<span class="token operator">-</span>server<span class="token operator">=</span>utf8 <span class="token operator">--</span>collation<span class="token operator">-</span>server<span class="token operator">=</span>utf8_general_ci

docker<span class="token operator">-</span>compose<span class="token operator">-</span>test<span class="token punctuation">.</span>yml <span class="token punctuation">(</span>добавил последнюю строку<span class="token punctuation">)</span>
jrtb<span class="token operator">-</span>db<span class="token operator">-</span>dev<span class="token operator">:</span>
 image<span class="token operator">:</span> mysql<span class="token operator">:</span><span class="token number">5.7</span>
 restart<span class="token operator">:</span> always
 environment<span class="token operator">:</span>
   MYSQL_DATABASE<span class="token operator">:</span> <span class="token string">'dev_jrtb_db'</span>
   # <span class="token class-name">So</span> you don't have <span class="token keyword">to</span> <span class="token namespace">use</span> root<span class="token punctuation">,</span> but you can <span class="token keyword">if</span> you like
   MYSQL_USER<span class="token operator">:</span> <span class="token string">'dev_jrtb_db_user'</span>
   # <span class="token class-name">You</span> can use whatever password you like
   MYSQL_PASSWORD<span class="token operator">:</span> <span class="token string">'dev_jrtb_db_password'</span>
   # <span class="token class-name">Password</span> <span class="token keyword">for</span> root access
   MYSQL_ROOT_PASSWORD<span class="token operator">:</span> <span class="token string">'root'</span>
 ports<span class="token operator">:</span>
   # <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Port</span> exposed<span class="token punctuation">&gt;</span></span> <span class="token operator">:</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">MySQL</span> <span class="token class-name">Port</span> running inside container<span class="token punctuation">&gt;</span></span>
   <span class="token operator">-</span> <span class="token string">'3306:3306'</span>
 expose<span class="token operator">:</span>
   # <span class="token class-name">Opens</span> port <span class="token number">3306</span> on the container
     <span class="token operator">-</span> <span class="token string">'3306'</span>
 command<span class="token operator">:</span> <span class="token operator">--</span>character<span class="token operator">-</span>set<span class="token operator">-</span>server<span class="token operator">=</span>utf8 <span class="token operator">--</span>collation<span class="token operator">-</span>server<span class="token operator">=</span>utf8_general_ci</code></pre> Після цих оновлень потрібно стерти усі дані в БД та почати заново. Стерти дуже просто: потрібно виконати команду: <span class="text-bold">docker-compose -f docker-compose-test.yml down</span> після чого всі дані та БД видаляються. І знову запустити, вже з оновленим кодуванням: <span class="text-bold">docker-compose -f docker-compose-test.uml up</span> База готова. Запускаємо оновлений додаток і дивимося. Я одразу пробігу швидко і покажу результат: <img data-max-width="800" data-id="b4325325-cce2-4928-9c5c-636255732b7b" alt="&quot;Java-проект від А до Я&quot;: Додаємо можливість передплатити групу статей.  Частина 3 - 7" src="https://cdn.javarush.com/images/article/b4325325-cce2-4928-9c5c-636255732b7b/800.jpeg" style="width: 800px;">І ось тепер ми отримали саме те, що й хотіли. Ось це схоже на правду.
<h2>Закінчення</h2>Тепер я думаю, що можна завершувати роботу з цього кроку. Зроблено багато, справді багато. Оновимо версію програми до <span class="text-bold">0.5.0-SNAPSHOT</span> та RELEASE_NOTES. 
<div class="terminal">
 # Release Notes ## 0.5.0-SNAPSHOT * JRTB-5: added ability subscribe on group * JRTB-6: added ability to get a list of group subscriptions.
</div> Далі все як завжди: створюємо новий коміт із усіма змінами. Головне — для звітності додати опис двох завдань, які зробабо цей крок. Тому такий буде комент: 
<div class="terminal">
 STEP_6 JRTB-5: розширена здатність до підпису на групі JRTB-6: розширена здатність до сторінки текстової групи.
</div> У результаті вийшло 47 змінених файлів. Це велика зміна. Хоча за описом функціональності й не скажеш. Адже щоб зрозуміти всю глибину, потрібно знати, що необхідно написати джава клієнт до АПІ, оновити всі програми по суті. Ось така вона, робота на сервері - роботи багато, а видимість з боку клієнтської частини невелика ...)) <em>Друзі, традиційно пропоную вам спосіб показати інтерес до моєї роботи - підписатися на <a href="https://github.com/romankh3" rel="nofollow" target="_blank">аккаунт гітхаб</a> , приєднатися до <a href="https://t.me/romankh3" rel="nofollow" target="_blank">телеграм-каналу</a> і написати питання по статті, якщо щось незрозуміло! </em> Ось посилання на пулл-реквест із змінами за цей <a href="https://github.com/codegymcommunity/codegym-telegrambot/pull/22" rel="nofollow" target="_blank">STEP_6</a> . Дякую всім за прочитання. Далі більше — поговоримо про видалення передплати, деактивацію профілю та інше. Не перемикайтесь))<a href="https://codegym.cc/login/signup" target="_blank"><img id="click_banner1_articles" data-max-width="1080" data-id="5736eb4b-2b1c-4ab6-b4cc-b9e2d1cef628" alt="&quot;Java-проект від А до Я&quot;: Додаємо можливість передплатити групу статей.  Частина 3 - 8" src="https://cdn.javarush.com/images/article/5736eb4b-2b1c-4ab6-b4cc-b9e2d1cef628/1080.jpeg" style="width: 1080px;"></a>
<h4><a href="https://codegym.cc/groups/posts/2935-java-proekt-ot-a-do-ja-pishem-realjhnihy-proekt-dlja-portfolio#articles" target="_blank">Список всіх матеріалів серії на початку цієї статті.</a></h4>