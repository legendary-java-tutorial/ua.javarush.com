Оновлюємо статистику для адміну - "Java-проект від А до Я"
<p>----------------------------------------</p>
Всім привіт, дорогі друзі. Минулого ми додавали адмінські команди, а сьогодні поговоримо про те, як розширити нашу статистику. Також оскільки система вже по суті готова до MVP, проведемо невеликий рефакторинг. Стаття розрахована на тих, хто
<p>----------------------------------------</p>
Всім привіт, дорогі друзі. Минулого <a href="https://codegym.cc/groups/posts/3376-java-proekt-ot-a-do-ja-dobavljaem-vozmozhnostjh-rabotih-admina-i-statistiku-dlja-nego-chastjh-1" target="_blank">посту</a> ми додавали адмінські команди, а сьогодні поговоримо про те, як розширити нашу статистику. Також оскільки система вже по суті готова до MVP, проведемо невеликий рефакторинг.
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <td>Хочете одразу дізнаватися, коли вийде новий код проекту? Коли виходить нова стаття? Приєднуйтесь до мого <a href="https://t.me/joinchat/SpqRPBFo_sM6qm05" rel="nofollow" target="_blank">телеграм-каналу</a> . Там я збираю свої статті, свої думки, свою open-source розробку докупи.</td>
   </tr>
  </tbody>
 </table>
</div><img data-max-width="800" data-id="362434fe-ae53-4fcb-ae4e-be1331ff63e1" alt="&quot;Java-проект від А до Я&quot;: Оновлюємо статистику для адміну - 1" src="https://cdn.javarush.com/images/article/362434fe-ae53-4fcb-ae4e-be1331ff63e1/800.jpeg" style="width: 800px;">
<h2>На кого розраховано цю статтю?</h2>Стаття розрахована на тих, хто вже прочитав усю серію раніше. Тим, хто тут уперше – ось <a href="https://codegym.cc/groups/posts/2935-java-proekt-ot-a-do-ja-pishem-realjhnihy-proekt-dlja-portfolio" target="_blank">початок</a> . Хто може подолати цю серію? Так практично будь-яка людина, яка розуміється на Java Core. Все інше (як мені здається) я даю і так у серії статей. Тим, хто чекав на написання всього проекту, щоб почати розбиратися вже відразу і не чекати нових статей — уже можна починати, все практично зроблено.
<h2>Розширюємо статистику для адміну</h2>Цей етап складається з двох кроків: планування та реалізації. Приступимо.
<h3>Плануємо оновлену статистику робота</h3>Перш ніж узятись за функціонал, варто подумати, що ми хочемо. Яка статистика була б цікавою для адміна, щоб відстежувати роботу бота? Спочатку, щоб дізнатися думку людей, я створив <a href="https://t.me/romankh3/71" rel="nofollow" target="_blank">пост у телеграм-каналі</a> . Пропозицій не надійшло: єдине, що запропонували залишити все, як є, бо ідея показана, а як її реалізувати — кожен вирішує сам. Згоден, і свою думку треба мати, тому вирішив виділити ті дані, які мені цікаві:
<ul>
 <li>потрібно знати кількість активних користувачів робота (це вже зроблено);</li>
 <li>потрібно знати кількість неактивних користувачів - додамо це. Думаю, це дуже корисно, тому що буде зрозуміло, яка частка користувачів, які відмовляються користуватися ботом, серед усіх користувачів;</li>
 <li>кількість активних користувачів у кожній активній групі;</li>
 <li>середня кількість передплат на одного користувача.</li>
</ul>Ці дані слід відстежувати щодня, або кожні два дні, наприклад. А на основі цих даних – малювати статистику за тиждень/місяць/квартал. Це буде окрема джоба, яка виконуватиметься щодня. Також на основі цих даних можна відстежувати зміну активних користувачів у часі. Ось так, така статистика була б корисною для адміна і більш зрозумілою.
<h3>Реалізуємо обрану статистику</h3>Не думаю, що в рамках цієї статті ми реально встигнемо все реалізувати, але впевнений, що вона нам знадобиться вся. На основі ідей вище зробимо DTO клас із полями, які ми хочемо отримувати: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">EqualsAndHashCode</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
* DTO for getting bot statistics.
*/</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@EqualsAndHashCode</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatisticDTO</span> <span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> activeUserCount<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> inactiveUserCount<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GroupStatDTO</span><span class="token punctuation">&gt;</span></span> groupStatDTOs<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span> averageGroupCountByUser<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> та GroupStatDto 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">EqualsAndHashCode</span><span class="token punctuation">;</span>

<span class="token comment">/**
* DTO for showing group id and title without data
*/</span>
<span class="token annotation punctuation">@Data</span>

<span class="token annotation punctuation">@EqualsAndHashCode</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">"activeUserCount"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GroupStatDTO</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> activeUserCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Його ми створабо у пакеті <span class="text-bold">dto</span> поряд з service, bot, command та іншими. Цими DTO ми будемо користуватися, щоб передати дані StatisticService (ми зараз його створимо) і StatCommand. Напишемо StatisticService: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">StatisticDTO</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Service for getting bot statistics.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StatisticsService</span> <span class="token punctuation">{</span>
   <span class="token class-name">StatisticDTO</span> <span class="token function">countBotStatistic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> І його реалізацію: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">GroupStatDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">StatisticDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span>isEmpty<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatisticsServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">StatisticsService</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">GroupSubService</span> groupSubService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">StatisticsServiceImpl</span><span class="token punctuation">(</span><span class="token class-name">GroupSubService</span> groupSubService<span class="token punctuation">,</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>groupSubService <span class="token operator">=</span> groupSubService<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>telegramUserService <span class="token operator">=</span> telegramUserService<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">StatisticDTO</span> <span class="token function">countBotStatistic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GroupStatDTO</span><span class="token punctuation">&gt;</span></span> groupStatDTOS <span class="token operator">=</span> groupSubService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> <span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>groupSub <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">GroupStatDTO</span><span class="token punctuation">(</span>groupSub<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> groupSub<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> groupSub<span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> allInActiveUsers <span class="token operator">=</span> telegramUserService<span class="token punctuation">.</span><span class="token function">findAllInActiveUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> allActiveUsers <span class="token operator">=</span> telegramUserService<span class="token punctuation">.</span><span class="token function">findAllActiveUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">double</span> groupsPerUser <span class="token operator">=</span> <span class="token function">getGroupsPerUser</span><span class="token punctuation">(</span>allActiveUsers<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StatisticDTO</span><span class="token punctuation">(</span>allActiveUsers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allInActiveUsers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> groupStatDTOS<span class="token punctuation">,</span> groupsPerUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">getGroupsPerUser</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> allActiveUsers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> allActiveUsers<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> it<span class="token punctuation">.</span><span class="token function">getGroupSubs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> allActiveUsers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Зверніть увагу, що слідуючи SOLID'у лише на рівні сервісів, ми використовуємо лише сервіси інших сутностей (GroupSubService, TelgeramUserService), а чи не їх репозиторії. На перший погляд, це може виглядати надмірно, але ні. Таким чином ми уникаємо проблем із залежностями об'єктів один з одним. У TelegramUserService не було методу <span class="code">findAllInactiveUsers</span> , тому створимо його в TelegramUserService: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token comment">/**
* Retrieve all inactive {@link TelegramUser}
*
* @return the collection of the inactive {@link TelegramUser} objects.
*/</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAllInActiveUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> У TelegramUserServiceImple: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAllInActiveUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> telegramUserRepository<span class="token punctuation">.</span><span class="token function">findAllByActiveFalse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> Такого методу репозиторій немає, тому додамо його в TelegramUserRepository: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TelegramUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAllByActiveFalse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Це Spring Data, тому реалізовувати цей метод нам не потрібно. Сервіс написали, настав час зробити тест на цю справу. Створюємо StatisticServiceTest. Тут ми мокаємо дані з інших сервісів та перевіряємо, а на основі замоканих даних нам збирають правильний GroupStatDTO об'єкт: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">GroupStatDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">StatisticDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">GroupSub</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TelegramUser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Assertions</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">BeforeEach</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DisplayName</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>mockito<span class="token punctuation">.</span></span><span class="token class-name">Mockito</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">.</span>singletonList<span class="token punctuation">;</span>

<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"Unit-level testing for StatisticsService"</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">StatisticsServiceTest</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">GroupSubService</span> groupSubService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">TelegramUserService</span> telegramUserService<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">StatisticsService</span> statisticsService<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@BeforeEach</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       groupSubService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">GroupSubService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       telegramUserService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">TelegramUserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       statisticsService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatisticsServiceImpl</span><span class="token punctuation">(</span>groupSubService<span class="token punctuation">,</span> telegramUserService<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldProperlySendStatDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//given</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>telegramUserService<span class="token punctuation">.</span><span class="token function">findAllInActiveUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">TelegramUser</span> activeUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       activeUser<span class="token punctuation">.</span><span class="token function">setGroupSubs</span><span class="token punctuation">(</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GroupSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>telegramUserService<span class="token punctuation">.</span><span class="token function">findAllActiveUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token function">singletonList</span><span class="token punctuation">(</span>activeUser<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">GroupSub</span> groupSub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupSub<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"group"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupSub<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       groupSub<span class="token punctuation">.</span><span class="token function">setUsers</span><span class="token punctuation">(</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TelegramUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>groupSubService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token function">singletonList</span><span class="token punctuation">(</span>groupSub<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//when</span>
       <span class="token class-name">StatisticDTO</span> statisticDTO <span class="token operator">=</span> statisticsService<span class="token punctuation">.</span><span class="token function">countBotStatistic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>statisticDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> statisticDTO<span class="token punctuation">.</span><span class="token function">getActiveUserCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> statisticDTO<span class="token punctuation">.</span><span class="token function">getInactiveUserCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> statisticDTO<span class="token punctuation">.</span><span class="token function">getAverageGroupCountByUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GroupStatDTO</span><span class="token punctuation">(</span>groupSub<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> groupSub<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> groupSub<span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               statisticDTO<span class="token punctuation">.</span><span class="token function">getGroupStatDTOs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre> Далі потрібно оновити нашу команду StatCommand: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">AdminCommand</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">StatisticDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">StatisticsService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TelegramUserService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>telegram<span class="token punctuation">.</span>telegrambots<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>api<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">Update</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span><span class="token punctuation">;</span>

<span class="token comment">/**
* Statistics {@link Command}.
*/</span>
<span class="token annotation punctuation">@AdminCommand</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StatisticsService</span> statisticsService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> STAT_MESSAGE <span class="token operator">=</span> <span class="token string">"✨&lt;b&gt;Подготовил статистику&lt;/b&gt;✨\n"</span> <span class="token operator">+</span>
           <span class="token string">"- Количество активных пользователей: %s\n"</span> <span class="token operator">+</span>
           <span class="token string">"- Количество неактивных пользователей: %s\n"</span> <span class="token operator">+</span>
           <span class="token string">"- Среднее количество групп на одного пользователя: %s\n\n"</span> <span class="token operator">+</span>
           <span class="token string">"&lt;b&gt;Информация по активным группам&lt;/b&gt;:\n"</span> <span class="token operator">+</span>
           <span class="token string">"%s"</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">public</span> <span class="token class-name">StatCommand</span><span class="token punctuation">(</span><span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">,</span> <span class="token class-name">StatisticsService</span> statisticsService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sendBotMessageService <span class="token operator">=</span> sendBotMessageService<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>statisticsService <span class="token operator">=</span> statisticsService<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">StatisticDTO</span> statisticDTO <span class="token operator">=</span> statisticsService<span class="token punctuation">.</span><span class="token function">countBotStatistic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">String</span> collectedGroups <span class="token operator">=</span> statisticDTO<span class="token punctuation">.</span><span class="token function">getGroupStatDTOs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s (id = %s) - %s подписчиков"</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">getActiveUserCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       sendBotMessageService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>STAT_MESSAGE<span class="token punctuation">,</span>
                       statisticDTO<span class="token punctuation">.</span><span class="token function">getActiveUserCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       statisticDTO<span class="token punctuation">.</span><span class="token function">getInactiveUserCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       statisticDTO<span class="token punctuation">.</span><span class="token function">getAverageGroupCountByUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       collectedGroups<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Тут ми просто компонуємо всю інформацію з GroupStatDTO у повідомлення для адміну. Оскільки тепер у нас StatCommand – не просто команда, потрібно написати для неї окремий тест. Переписуємо StatCommandTest: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">GroupStatDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">StatisticDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">StatisticsService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">BeforeEach</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DisplayName</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>mockito<span class="token punctuation">.</span></span><span class="token class-name">InjectMocks</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>mockito<span class="token punctuation">.</span></span><span class="token class-name">Mock</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>mockito<span class="token punctuation">.</span></span><span class="token class-name">Mockito</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">AbstractCommandTest</span><span class="token punctuation">.</span>prepareUpdate<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>codegymcommunity<span class="token punctuation">.</span>jrtb<span class="token punctuation">.</span>command<span class="token punctuation">.</span></span><span class="token class-name">StatCommand</span><span class="token punctuation">.</span>STAT_MESSAGE<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">String</span><span class="token punctuation">.</span>format<span class="token punctuation">;</span>

<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"Unit-level testing for StatCommand"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatCommandTest</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">SendBotMessageService</span> sendBotMessageService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">StatisticsService</span> statisticsService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">Command</span> statCommand<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@BeforeEach</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       sendBotMessageService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">SendBotMessageService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       statisticsService <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">StatisticsService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       statCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatCommand</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">,</span> statisticsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldProperlySendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//given</span>
       <span class="token class-name">Long</span> chatId <span class="token operator">=</span> <span class="token number">1234567L</span><span class="token punctuation">;</span>
       <span class="token class-name">GroupStatDTO</span> groupDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupStatDTO</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"group"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">StatisticDTO</span> statisticDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatisticDTO</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>groupDto<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>statisticsService<span class="token punctuation">.</span><span class="token function">countBotStatistic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>statisticDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//when</span>
       statCommand<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token function">prepareUpdate</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> <span class="token class-name">CommandName</span><span class="token punctuation">.</span>STAT<span class="token punctuation">.</span><span class="token function">getCommandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">//then</span>
       <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>sendBotMessageService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">format</span><span class="token punctuation">(</span>STAT_MESSAGE<span class="token punctuation">,</span>
               statisticDTO<span class="token punctuation">.</span><span class="token function">getActiveUserCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               statisticDTO<span class="token punctuation">.</span><span class="token function">getInactiveUserCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               statisticDTO<span class="token punctuation">.</span><span class="token function">getAverageGroupCountByUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s (id = %s) - %s подписчиков"</span><span class="token punctuation">,</span> groupDto<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> groupDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> groupDto<span class="token punctuation">.</span><span class="token function">getActiveUserCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre> Тут ми перевірабо, що передається саме те повідомлення, на яке ми очікуємо. Зрозуміло, потрібно буде оновити CommandContainer і CodeGymTelegramBot, щоб CommandStat тепер передавав StatisticCommand. Залишу це на вашій совісті. Але як це виглядатиме? Запускаємо на тестовому боті і пишемо /stat, отримуємо: <img data-max-width="512" data-id="01b1d5e2-6e27-411e-9c18-cf77f484a464" alt="&quot;Java-проект від А до Я&quot;: Оновлюємо статистику для адміну - 2" src="https://cdn.javarush.com/images/article/01b1d5e2-6e27-411e-9c18-cf77f484a464/512.jpeg" style="width: 512px;">Зрозуміло, це тепер видно лише адмінам. Тепер їм буде зрозуміліше, що діється з ботом.
<h2>На завершення</h2>Востаннє ставимо нову SNAPSHOT версію в pom.xml: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">0.8</span><span class="token number">.0</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span></code></pre> Якщо оновабо версію, значить, потрібно оновити і RELEASE_NOTES: 
<div class="terminal">
 # Release Notes ## 0.8.0-SNAPSHOT * JRTB-10: extensed bot statistics for admins.
</div> Здавалося б, навіщо це заповнювати? Навіщо писати опис, хто його читатиме? Я вам скажу, що просто написати код — це лише третина (а то й чверть) справи. Бо хтось має потім цей код читати, розширювати, підтримувати. А документування дає можливість зробити це швидше та краще. Усі зміни за кодом ви знайдете в цьому <a href="https://github.com/codegymcommunity/codegym-telegrambot/pull/26" rel="nofollow" target="_blank">пулл-реквесті</a> . Що нам лишилося? Лише остання стаття з невеликими правками у рефакторингу разом із ретроспективою. Пошаманімо перед релізом і проаналізуємо, до чого ми прийшли за ці 8 місяців.
<h2>Думки про майбутнє бота</h2>Поки готував вечерю, думав про майбутнє телеграм-бота, що ще лишилося, що хочеться зробити. І зрозумів, що зовсім не торкнувся теми збереження стану бази (бекап) даних, щоб можна було відновити її у разі чого. Думаю, як би я хотів це бачити? Так щоб максимально автоматизувати цей процес. І на тлі цих думок дійшов такого висновку: хочеться, щоб бекапи бази даних створювалися час від часу і зберігалися десь без моєї участі. Але де ж зберігати? Безперечно, це потрібно робити поза docker'a, в якому розгорнута база. На основному сервері, де розгорнуть докер з додатком, теж не дуже хочеться, тому що з сервером може щось відбутися і все, цю-тю даним. І в результаті я дійшов до ідеї. Відразу скажу, що я не знаю, чи можна її реалізувати чи ні, але вона мені найбільше подобається. Сама ідея:
<ol>
 <li>Бекапи щодня (тиждень, місяць або інший проміжок часу) робитиме бекап у спеціальний чат у телеграмі, доступ до якого буде адмінам, наприклад. Таке розподілене сховище даних))</li>
 <li>Додати команду адміну моментального бекапу для адмінських потреб.</li>
 <li>Додати СУПЕР АДМІНСЬКУ команду, яка вміла б відновлювати базу даних по наданому файлу.</li>
</ol>Таким чином, управління даними БД стає простіше. Плюс робота робота стане більш незалежною від сервера, на якому знаходиться, і в будь-який момент може бути розгорнута за допомогою однієї команди на будь-якому іншому сервері. Але тут на думку спадають думки про те, що це не дуже безпечно, тому що доступ до даних досить простий. Тому логічніше буде поставити доступ лише до одного супер адміну до цих даних. <em>як завжди <s>лайк - передплата - дзвіночок</s> став зірку <a href="https://github.com/codegymcommunity/codegym-telegrambot" rel="nofollow" target="_blank">нашому проекту</a> , пиши коментарі та оцінюй статтю! </em> Востаннє в цій серії статей говорю вам до зустрічі!<a href="https://codegym.cc/login/signup" target="_blank"><img id="click_banner1_articles" data-max-width="1080" data-id="5736eb4b-2b1c-4ab6-b4cc-b9e2d1cef628" alt="&quot;Java-проект від А до Я&quot;: Додаємо Spring Scheduler - 2" src="https://cdn.javarush.com/images/article/5736eb4b-2b1c-4ab6-b4cc-b9e2d1cef628/1080.jpeg" style="width: 1080px;"></a>
<h4><a href="https://codegym.cc/groups/posts/2935-java-proekt-ot-a-do-ja-pishem-realjhnihy-proekt-dlja-portfolio#articles" target="_blank">Список всіх матеріалів серії на початку цієї статті.</a></h4>