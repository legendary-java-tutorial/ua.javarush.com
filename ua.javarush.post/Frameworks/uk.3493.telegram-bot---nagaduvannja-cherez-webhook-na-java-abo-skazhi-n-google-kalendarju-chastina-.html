Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю! Частина 1
<p>----------------------------------------</p>
Мене звати Владимир. Мені 43 роки. І якщо тобі, читачу за 40, то так, після 40 можна стати програмістом, якщо тобі це подобається. Моя робота взагалі ніяк не пов'язана з програмуванням, я керівник проекту в галузі автоматизації та всього та
<p>----------------------------------------</p>
Мене звати Владимир. Мені 43 роки. І якщо тобі, читачу за 40, то так, після 40 можна стати програмістом, якщо тобі це подобається. Моя робота взагалі ніяк не пов'язана з програмуванням, я керівник проекту в галузі автоматизації та всього такого. Але планую змінити рід діяльності. Ох вже ці нові віяння... змінювати сферу діяльності раз на 5-7 років. <strong>Так ось</strong> : Проект вийшов не маленький так що деякі моменти доведеться опускати або говорити про них коротко, сподіваючись, що читач вміє гуглити. На просторах інтернетів повно публікацій telegram-ботів, що працюють за принципом Long polling. І дуже мало, що працюють за принципом Webhook. Що це таке? <strong>Long polling</strong>- означає ваш додаток сам опитуватиме сервер telegram на предмет наявності повідомлень з певною періодичністю, повільно. <strong>Webhook</strong> - означає сервер telegram миттєво перенаправлятиме повідомлення на вказаний вами сервер. У нашому випадку, люб'язно наданий сервіс Heroku. Докладніше про все це і взагалі про бот можна звичайно ж почитати на сайті Telegram - https://tlgrm.ru/docs/bots/api Інтерфейс бот виглядає ось так: <img data-max-width="512" data-id="c3a3ec24-f4b2-4e61-97c1-68fd289c0e8b" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  - 1" src="https://cdn.javarush.com/images/article/c3a3ec24-f4b2-4e61-97c1-68fd289c0e8b/512.jpeg" style="width: 512px;"> Цей додаток я розглядаю саме як навчальний проект з тієї причини, що при написанні цього бота я засвоїв більше інформації, ніж при навчанні. Бажаєте навчитися програмувати? Почніть писати код! Але! Тут не буде докладних інструкцій, як залити додаток на github, як створити базу даних. Цього всього повно в інтернетах і розписано докладним чином, крім того, це і так вийде дуже довге читання. Додаток буде працювати наступним чином: Вводьте опис події, вводите дату та час події, вибираєте періодичність (можна на один раз, можна нагадування щодня у певний час, можна раз на місяць у певний час, або раз на рік). Варіації сповіщень можна допилювати нескінченно, у самих ідей багато. Далі введені дані зберігаються до бази даних (теж розгорнуто безкоштовно на heroku, безкоштовними є 10 000 рядків) Далі один раз на початку дня о 0:00 за серверним часом Spring витягує з бази всі події за критеріями, які повинні спрацювати в цей день і направляє їх на виконання у встановлений час. УВАГА!!! ЦЯ ЧАСТИНА ПРОГРАМИ ЕКСПЕРЕМЕНТАЛЬНА! ІСНУЄ РЕАЛІЗАЦІЯ БІЛЬШ ПРОСТІЙ І ВІРНА! ТАК ЗРОБЛЕНО СПЕЦІАЛЬНО, ЩОБ ПОДИВИТИСЯ ЯК ПРАЦЮЄ КЛАС Time! Доторкнутися своїми руками працюючого бота можна набравши в возі @calendar_event_bot але не розраховуйте на нього, бо я з нього все ще знущаюся. код - ТАК ЗРОБЛЕНО СПЕЦІАЛЬНО, ЩОБ ПОДИВИТИСЯ ЯК ПРАЦЮЄ КЛАС Time! Доторкнутися своїми руками працюючого бота можна набравши в возі @calendar_event_bot але не розраховуйте на нього, бо я з нього все ще знущаюся. код - ТАК ЗРОБЛЕНО СПЕЦІАЛЬНО, ЩОБ ПОДИВИТИСЯ ЯК ПРАЦЮЄ КЛАС Time! Доторкнутися своїми руками працюючого бота можна набравши в возі @calendar_event_bot але не розраховуйте на нього, бо я з нього все ще знущаюся. код -<a href="https://github.com/papoff8295/webHookBotForHabr" target="_blank" rel="nofollow">https://github.com/papoff8295/webHookBotForHabr</a> В принципі, щоб запустити власного вам необхідно зробити наступні кроки: • Пройти реєстрацію в <strong>@BotFather</strong> , це не складно, отримати токен та ім'я • Зробити fork проекту на github • Зареєструватися на <strong>Heroku</strong> , створити додаток(покроково розбиратимемо), зробити deploy з вашого репозиторію. • Створити на Heroku базу даних • Замінити в репозиторії відповідні поля на свої (токен, назва таблиць по суті, webHookPath, user name, пароль та шлях до бази, це все буде розбирати) • Змусити heroku працювати 24/7 за допомогою https: <a href="https://uptimerobot.com/" target="_blank" rel="nofollow">/ /uptimerobot.com/</a> Підсумкова структура проекту у мене вийшла така: <img data-max-width="512" data-id="08ed8555-d260-41f6-a29b-6edcc5d5fce4" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  - 2" src="https://cdn.javarush.com/images/article/08ed8555-d260-41f6-a29b-6edcc5d5fce4/512.jpeg" style="width: 512px;"> Почнемо зі створення проекту <a href="https://start.spring.io/" target="_blank" rel="nofollow">https://start.spring.io</a>Вибираємо потрібні нам залежності як показано на малюнку: <img data-max-width="800" data-id="7cff8a6a-d73e-43dd-a9fb-5c69f99d036d" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  - 3" src="https://cdn.javarush.com/images/article/7cff8a6a-d73e-43dd-a9fb-5c69f99d036d/800.jpeg" style="width: 800px;">Вибираємо власну назву для проекту та натискаємо <strong><em>Generate</em></strong> . Далі вам запропонують зберегти проект на диск. Залишається відкрити файл <strong>pom.xm</strong> l зі свого середовища розробки. Перед Вами готовий проект. Тепер нам лишилося додати нашу основну бібліотеку. Я використовував бібліотеку з <a href="https://github.com/rubenlagus/TelegramBots" target="_blank" rel="nofollow">https://github.com/rubenlagus/TelegramBots</a> Загалом можна заморочитися і обійтися без неї. <em>Адже весь зміст роботи полягає</em> в конкатенації URL на кшталт такого: https://api.telegram.org/bot1866835969:AAE6gJG6ptUyqhV2XX0MxyUak4QbAGGnz10/setWebhook?url=https://e9c658b548aa.ngro - Сервер telegram. <em>bot1866835969:AAE6gJG6ptUyqhV2XX0MxyUak4QbAGGnz10/</em> - після слова bot- секретний токен, який отримуєте при реєстрації бота. <em>setWebhook?url=https://e9c658b548aa.ngrok.io</em> – назва методу та його параметри. В даному випадку ми встановлюємо Ваш webhook сервер, на нього будуть надходити всі повідомлення. Загалом, я вирішив, що проект і так не маленький для публікації, а з ручною реалізацією взагалі буде нечитабельним. Отже, кінцевий вид файлу <strong>pom</strong> : 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>project xmlns<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0"</span> xmlns<span class="token operator">:</span>xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span> xsi<span class="token operator">:</span>schemalocation<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>modelversion<span class="token punctuation">&gt;</span></span><span class="token number">4.0</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>modelversion<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>parent<span class="token punctuation">&gt;</span></span>
      <span class="token generics"><span class="token punctuation">&lt;</span>groupid<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupid<span class="token operator">&gt;</span>
      <span class="token generics"><span class="token punctuation">&lt;</span>artifactid<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>parent<span class="token operator">&lt;</span><span class="token operator">/</span>artifactid<span class="token operator">&gt;</span>
      <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.5</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
      <span class="token generics"><span class="token punctuation">&lt;</span>relativepath<span class="token punctuation">&gt;</span></span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> lookup parent from repository <span class="token operator">--</span><span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token operator">/</span>relativepath<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>parent<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>groupid<span class="token punctuation">&gt;</span></span>ru<span class="token punctuation">.</span>popov<span class="token operator">&lt;</span><span class="token operator">/</span>groupid<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>artifactid<span class="token punctuation">&gt;</span></span>telegrambot<span class="token operator">&lt;</span><span class="token operator">/</span>artifactid<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>name<span class="token punctuation">&gt;</span></span>telegrambot<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>description<span class="token punctuation">&gt;</span></span><span class="token class-name">Demo</span> project <span class="token keyword">for</span> <span class="token class-name">Spring</span> <span class="token class-name">Boot</span><span class="token operator">&lt;</span><span class="token operator">/</span>description<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>properties<span class="token punctuation">&gt;</span></span>
      <span class="token generics"><span class="token punctuation">&lt;</span>java<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.8</span><span class="token operator">&lt;</span><span class="token operator">/</span>java<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token operator">/</span>properties<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>
      <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
         <span class="token generics"><span class="token punctuation">&lt;</span>groupid<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupid<span class="token operator">&gt;</span>
         <span class="token generics"><span class="token punctuation">&lt;</span>artifactid<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>web<span class="token operator">&lt;</span><span class="token operator">/</span>artifactid<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

      <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
         <span class="token generics"><span class="token punctuation">&lt;</span>groupid<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupid<span class="token operator">&gt;</span>
         <span class="token generics"><span class="token punctuation">&lt;</span>artifactid<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>data<span class="token operator">-</span>jpa<span class="token operator">&lt;</span><span class="token operator">/</span>artifactid<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

      <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
         <span class="token generics"><span class="token punctuation">&lt;</span>groupid<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupid<span class="token operator">&gt;</span>
         <span class="token generics"><span class="token punctuation">&lt;</span>artifactid<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>test<span class="token operator">&lt;</span><span class="token operator">/</span>artifactid<span class="token operator">&gt;</span>
         <span class="token generics"><span class="token punctuation">&lt;</span>scope<span class="token punctuation">&gt;</span></span>test<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mvnrepository<span class="token punctuation">.</span>com<span class="token operator">/</span>artifact<span class="token operator">/</span>org<span class="token punctuation">.</span>telegram<span class="token operator">/</span>telegrambots<span class="token operator">-</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter <span class="token operator">--</span><span class="token operator">&gt;</span>
      <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
         <span class="token generics"><span class="token punctuation">&lt;</span>groupid<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>telegram<span class="token operator">&lt;</span><span class="token operator">/</span>groupid<span class="token operator">&gt;</span>
         <span class="token generics"><span class="token punctuation">&lt;</span>artifactid<span class="token punctuation">&gt;</span></span>telegrambots<span class="token operator">-</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactid<span class="token operator">&gt;</span>
         <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">5.2</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

      <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
         <span class="token generics"><span class="token punctuation">&lt;</span>groupid<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>projectlombok<span class="token operator">&lt;</span><span class="token operator">/</span>groupid<span class="token operator">&gt;</span>
         <span class="token generics"><span class="token punctuation">&lt;</span>artifactid<span class="token punctuation">&gt;</span></span>lombok<span class="token operator">&lt;</span><span class="token operator">/</span>artifactid<span class="token operator">&gt;</span>
         <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.18</span><span class="token number">.16</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

      <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
         <span class="token generics"><span class="token punctuation">&lt;</span>groupid<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>postgresql<span class="token operator">&lt;</span><span class="token operator">/</span>groupid<span class="token operator">&gt;</span>
         <span class="token generics"><span class="token punctuation">&lt;</span>artifactid<span class="token punctuation">&gt;</span></span>postgresql<span class="token operator">&lt;</span><span class="token operator">/</span>artifactid<span class="token operator">&gt;</span>
         <span class="token generics"><span class="token punctuation">&lt;</span>scope<span class="token punctuation">&gt;</span></span>runtime<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

   <span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span>

   <span class="token generics"><span class="token punctuation">&lt;</span>build<span class="token punctuation">&gt;</span></span>
      <span class="token generics"><span class="token punctuation">&lt;</span>plugins<span class="token punctuation">&gt;</span></span>
         <span class="token generics"><span class="token punctuation">&lt;</span>plugin<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupid<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupid<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactid<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>maven<span class="token operator">-</span>plugin<span class="token operator">&lt;</span><span class="token operator">/</span>artifactid<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span><span class="token operator">/</span>plugin<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>plugins<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token operator">/</span>build<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>project<span class="token operator">&gt;</span></code></pre> Все готове до написання нашого бота. Створимо клас <strong>TelegramBot</strong> . Назва папок я писати не буду, можете подивитися у структурі проекту вище. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@FieldDefaults</span><span class="token punctuation">(</span>level <span class="token operator">=</span> <span class="token class-name">AccessLevel</span><span class="token punctuation">.</span>PRIVATE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TelegramBot</span> <span class="token keyword">extends</span> <span class="token class-name">SpringWebhookBot</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> botPath<span class="token punctuation">;</span>
    <span class="token class-name">String</span> botUsername<span class="token punctuation">;</span>
    <span class="token class-name">String</span> botToken<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">TelegramFacade</span> telegramFacade<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TelegramBot</span><span class="token punctuation">(</span><span class="token class-name">TelegramFacade</span> telegramFacade<span class="token punctuation">,</span> <span class="token class-name">DefaultBotOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">SetWebhook</span> setWebhook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> setWebhook<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>telegramFacade <span class="token operator">=</span> telegramFacade<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">TelegramBot</span><span class="token punctuation">(</span><span class="token class-name">TelegramFacade</span> telegramFacade<span class="token punctuation">,</span> <span class="token class-name">SetWebhook</span> setWebhook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>setWebhook<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>telegramFacade <span class="token operator">=</span> telegramFacade<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">BotApiMethod</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">?</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">onWebhookUpdateReceived</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> telegramFacade<span class="token punctuation">.</span><span class="token function">handleUpdate</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Клас розширюється від <strong>SpringWebhookBot</strong> з нашої біліотеки telegram, і нам необхідно реалізувати всього один метод <em>onWebhookUpdateReceived</em> . Він приймає рапарсенний <strong>JSON</strong> як об'єкт Update і повертає те, що хоче від нас «почути» сервер telegram. Тут у нас зустрічаються інструкції з бібліотеки <strong>Lombok</strong> . <strong>Lombok</strong> – робимо життя програміста легшим!! Ну, тобто. нам не треба перевизначати гетери та сеттери, це робить за нас Lombok, а також не треба писати ідентифікатор рівня доступу. Вже й не варто писати, що цим займаються анотації <em>@ Getter, @ Setter, @ FieldDefaults</em> Поле <em>botPath</em> – означає нашу адресау webhook, яку ми отримаємо на Heroku пізніше. Поле<em>botUsername</em> – це назва нашого бота, яку ми отримаємо при реєстрації нашого бота в Telegram. Поле <em>botToken</em> це наш токен, який ми отримаємо при реєстрації нашого бота в Telegram. Поле <em>telegramFacade</em> - це наш клас, де відбуватиметься обробка повідомлень, до нього ми повернемося трохи пізніше, нехай він поки буде червоним. Тепер нам час звернутися до <em>@BotFather</em> і отримати заповітний botToken і botUsername. <img data-max-width="512" data-id="36fa1f52-0f44-4879-b0c6-a611e3fd1960" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  - 4" src="https://cdn.javarush.com/images/article/36fa1f52-0f44-4879-b0c6-a611e3fd1960/512.jpeg" style="width: 512px;">Просто напишіть йому в telegram і він вам все підкаже. Записуємо дані в наш application.properties, повністю зрештою він виглядатиме ось так: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">server#server<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">5000</span>

telegrambot<span class="token punctuation">.</span>userName<span class="token operator">=</span><span class="token annotation punctuation">@calendar_event_bot</span>
telegrambot<span class="token punctuation">.</span>botToken<span class="token operator">=</span><span class="token number">1731265488</span><span class="token operator">:</span><span class="token class-name">AAFDjUSk3vu5SFfgdfh556gOOFmuml7SqEjwrmnEF5Ak</span>
#telegrambot<span class="token punctuation">.</span>webHookPath<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>telegrambotsimpl<span class="token punctuation">.</span>herokuapp<span class="token punctuation">.</span>com<span class="token operator">/</span>
telegrambot<span class="token punctuation">.</span>webHookPath<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>f5d6beeb7b93<span class="token punctuation">.</span>ngrok<span class="token punctuation">.</span>io


telegrambot<span class="token punctuation">.</span>adminId<span class="token operator">=</span><span class="token number">39376213</span>

eventservice<span class="token punctuation">.</span>period <span class="token operator">=</span><span class="token number">600000</span>

spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">=</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span></span>Driver</span>
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>url<span class="token operator">=</span>jdbc<span class="token operator">:</span>postgresql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">5432</span><span class="token operator">/</span>telegramUsers
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>username<span class="token operator">=</span>postgres
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>password<span class="token operator">=</span>password

#spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>url<span class="token operator">=</span>jdbc<span class="token operator">:</span>postgresql<span class="token operator">:</span>ec2<span class="token operator">-</span><span class="token number">54</span><span class="token operator">-</span><span class="token number">247</span><span class="token operator">-</span><span class="token number">158</span><span class="token operator">-</span><span class="token number">179.</span>eu<span class="token operator">-</span>west<span class="token operator">-</span><span class="token number">1.</span>compute<span class="token punctuation">.</span>amazonaws<span class="token punctuation">.</span>com<span class="token operator">:</span><span class="token number">5432</span><span class="token operator">/</span>d2um126le5notq<span class="token operator">?</span>ssl<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>sslmode<span class="token operator">=</span>require<span class="token operator">&amp;</span>sslfactory<span class="token operator">=</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span>NonValidatingFactory</span>
#spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>username<span class="token operator">=</span>ulmbeywyhvsxa
#spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>password<span class="token operator">=</span><span class="token number">4</span>c7646c69dbbgeacb98fa96e8daa6d9b1bl4894e67f3f3ddd6a27fe7b0537fd</code></pre> Ця конфігурація налаштована для роботи з локальною базою даних, згодом ми зробимо необхідні зміни. Замініть <em>botToken</em> та username на свої. Не можна використовувати дані з application.properties безпосередньо в програмі. Створимо з цих даних bean або клас обгортку. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@FieldDefaults</span><span class="token punctuation">(</span>level <span class="token operator">=</span> <span class="token class-name">AccessLevel</span><span class="token punctuation">.</span>PRIVATE<span class="token punctuation">)</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TelegramBotConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${telegrambot.webHookPath}"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> webHookPath<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${telegrambot.userName}"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${telegrambot.botToken}"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> botToken<span class="token punctuation">;</span></code></pre> Тут інструкція @Value ініціалізує відповідні рядки з файлу application.properties, про цю папку Spring знає за замовчуванням. А анотація @Component створює нам Bean під час запуску програми. Займемося тепер файлом конфігурації Spring: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TelegramBotConfig</span> botConfig<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AppConfig</span><span class="token punctuation">(</span><span class="token class-name">TelegramBotConfig</span> botConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>botConfig <span class="token operator">=</span> botConfig<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SetWebhook</span> <span class="token function">setWebhookInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">SetWebhook</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>botConfig<span class="token punctuation">.</span><span class="token function">getWebHookPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TelegramBot</span> <span class="token function">springWebhookBot</span><span class="token punctuation">(</span><span class="token class-name">SetWebhook</span> setWebhook<span class="token punctuation">,</span> <span class="token class-name">TelegramFacade</span> telegramFacade<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TelegramBot</span> bot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramBot</span><span class="token punctuation">(</span>telegramFacade<span class="token punctuation">,</span> setWebhook<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bot<span class="token punctuation">.</span><span class="token function">setBotToken</span><span class="token punctuation">(</span>botConfig<span class="token punctuation">.</span><span class="token function">getBotToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bot<span class="token punctuation">.</span><span class="token function">setBotUsername</span><span class="token punctuation">(</span>botConfig<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bot<span class="token punctuation">.</span><span class="token function">setBotPath</span><span class="token punctuation">(</span>botConfig<span class="token punctuation">.</span><span class="token function">getWebHookPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> bot<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Жодної магії тут немає, при старті Spring створює нам об'єкти SetWebhook і TelegramBot. Створимо тепер точки входу наших повідомлень: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebhookController</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TelegramBot</span> telegramBot<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">WebhookController</span><span class="token punctuation">(</span><span class="token class-name">TelegramBot</span> telegramBot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>telegramBot <span class="token operator">=</span> telegramBot<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">// point for message</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">BotApiMethod</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">?</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">onUpdateReceived</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> telegramBot<span class="token punctuation">.</span><span class="token function">onWebhookUpdateReceived</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Telegram сервер відправляє на зареєстровану адресау webhook повідомлення у форматі JSON методом POST, наш контролер їх приймає та передає бібліотеці telegram у вигляді об'єкта Update. Метод get я зробив просто так ) Тепер нам залишилося реалізувати якусь логіку обробки повідомлень та відповіді у класі <strong>TelegramFacade</strong> , я наведу його короткий код, щоб уже можна було запускати програму і далі йти своїм шляхом або перейти вже у deploy на Heroku, потім буде повна версія: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@FieldDefaults</span><span class="token punctuation">(</span>level <span class="token operator">=</span> <span class="token class-name">AccessLevel</span><span class="token punctuation">.</span>PRIVATE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TelegramFacade</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">BotApiMethod</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">?</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">handleUpdate</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">.</span><span class="token function">hasCallbackQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CallbackQuery</span> callbackQuery <span class="token operator">=</span> update<span class="token punctuation">.</span><span class="token function">getCallbackQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token class-name">Message</span> message <span class="token operator">=</span> update<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SendMessage</span> sendMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sendMessage<span class="token punctuation">.</span><span class="token function">setChatId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sendMessage<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Hello world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> sendMessage<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre> Цей метод відповідатиме на будь-яке повідомлення Hello world! Для того, щоб запустити наш додаток нам залишилося зробити так, щоб ми могли тестувати нашу програму прямо з IDEA. Для цього нам необхідно завантажити утиліту ngrok. <a href="https://ngrok.com/download" target="_blank" rel="nofollow">https://ngrok.com/download </a> Ця утиліта є командним рядком, який дає нам тимчасову адресау на 2 години і перенаправляє всі повідомлення на вказаний порт локального сервера. Запускаємо та пишемо у рядку <em>ngrok http 5000</em> (або можете вказати свій порт): <img data-max-width="800" data-id="d56ccc29-c9c9-4dad-a949-789fd941ad65" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  - 5" src="https://cdn.javarush.com/images/article/d56ccc29-c9c9-4dad-a949-789fd941ad65/800.jpeg" style="width: 800px;">Отримуємо результат: <img data-max-width="800" data-id="6d67eff5-ad5b-43aa-9685-2681639a5be5" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  - 6" src="https://cdn.javarush.com/images/article/6d67eff5-ad5b-43aa-9685-2681639a5be5/800.jpeg" style="width: 800px;">https://23b1a54ccbbd.ngrok.io – це і є наша webhook адресаа. Як ви могли помітити у файлі properties ми написали server.port=5000 при старті сервера tomcat, він буде займати порт 5000, стежте, щоб ці поля були однакові. Також не забуваємо, що адресаа дається на дві години. У командному рядку за цим слідкує поле Session Expires. Коли час скінчиться потрібно буде знову отримати адресау і пройти процедуру його реєстрації на telegram. Тепер беремо рядок . отриманий рядок та натискаємо enter. Повинен вийде такий результат: <img data-max-width="512" data-id="2fd336c1-4fb9-49d7-87fa-5fefcc144e7f" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  - 7" src="https://cdn.javarush.com/images/article/2fd336c1-4fb9-49d7-87fa-5fefcc144e7f/512.jpeg" style="width: 512px;">Все, тепер можна запускати додаток: <img data-max-width="512" data-id="60bfefa9-471b-42e5-9fc4-0bbc1c67dbb0" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  - 8" src="https://cdn.javarush.com/images/article/60bfefa9-471b-42e5-9fc4-0bbc1c67dbb0/512.jpeg" style="width: 512px;">Перевірте, що Ваш клас з методом<em>main</em> , був такий: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TelegramBotApplication</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TelegramBotApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Якщо Ви все зробабо правильно, то тепер Ваш бот буде відгукуватися на будь-яке повідомлення фразою - <strong>Hello world</strong> . Далі можете йти своїм шляхом. Якщо ж Ви зі мною і Вам цікаво піти всі кроки, то приступимо до написання сутностей бази даних і створимо саму базу даних. Почнемо з бази: Як я вже казав, вважаю, що Ви вже маєте мінімальні навички роботи з базою, і у вас встановлена ​​локальна база <em>postgreSQL</em> , якщо ні пройдіть цей шлях. <a href="https://www.postgresql.org/download/" target="_blank" rel="nofollow">https://www.postgresql.org/download/</a> У файлі application.properties замініть логін та пароль до бази даних на свої. У IDEA справа є вкладка database, у ній потрібно натиснути на <em>+/Data source/PostgreSQL</em> . В результаті при натисканні на <em>Test Connection</em>повинні отримати задовільний результат: <img data-max-width="800" data-id="6100bf1e-01d4-4062-a1a1-e6a90fdf291b" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  - 9" src="https://cdn.javarush.com/images/article/6100bf1e-01d4-4062-a1a1-e6a90fdf291b/800.jpeg" style="width: 800px;">Тепер ви можете створити базу з таблицями прямо із середовища розробки, а можете скористатися web-інтерфейсом <em>pgadmin</em> , який знаходиться в меню пуск. Нам знадобляться 3 таблиці: 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">CREATE <span class="token class-name">TABLE</span> users
<span class="token punctuation">(</span>
    id               INTEGER PRIMARY KEY UNIQUE <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
    name             VARCHAR<span class="token punctuation">,</span>
    time_zone        INTEGER <span class="token class-name">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    on_off           BOOLEAN <span class="token class-name">DEFAULT</span> <span class="token boolean">true</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE <span class="token class-name">TABLE</span> user_events
<span class="token punctuation">(</span>
    user_id INTEGER <span class="token punctuation">,</span>
    time timestamp <span class="token punctuation">,</span>
    description varchar <span class="token punctuation">,</span>
    event_id serial<span class="token punctuation">,</span>
    event_freq varchar <span class="token keyword">default</span> <span class="token string">'TIME'</span><span class="token punctuation">,</span>
    <span class="token class-name">FOREIGN</span> KEY <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token class-name">REFERENCES</span> users <span class="token punctuation">(</span>id<span class="token punctuation">)</span> ON <span class="token class-name">DELETE</span> CASCADE
<span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE <span class="token class-name">TABLE</span> event_cash
<span class="token punctuation">(</span>
    time timestamp <span class="token punctuation">,</span>
    description varchar <span class="token punctuation">,</span>
    user_id INTEGER <span class="token punctuation">,</span>
    id serial
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> Рекомендую створити окремо цей скрипт, він нам знадобиться для створення бази на Heroku, щоб не писати двічі. Пройдемося трохи. Відразу скажу таблиця <em>event_cash</em> нам знадобиться тільки для роботи з Heroku у зв'язку з його специфікою та моїм невгамовним бажанням попрацювати з класом <strong>Time</strong> , в локальній версії він не знадобиться. У таблицю <em>users</em> ми будемо записувати <em>id</em> облікового запису користувача telegram, його ім'я, якого може і не бути, буде розрахований часовий пояс користувача, для коректної відправки повідомлень, а також стан <em>on/off</em> розсилки повідомлень. У таблицю <em>user_events</em> у нас записуватиметься <em>id</em>користувача, час повідомлення, опис, буде автоматично генеруватися <em>id</em> для події, та встановлюватиметься частота повідомлень. У таблиці <em>event_cash</em> буде записуватися повідомлення перед відправкою, і, якщо воно надіслано, видалятися з таблиці. Таблиці готові, давайте тепер додамо сутності. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"user_events"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span> name <span class="token operator">=</span> <span class="token string">"event_id"</span><span class="token punctuation">,</span> columnDefinition <span class="token operator">=</span> <span class="token string">"serial"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> eventId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"time"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">"Need date!"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> date<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"description"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Size</span><span class="token punctuation">(</span>min <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> max <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">"Description must be between 0 and 200 chars!"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"event_freq"</span><span class="token punctuation">,</span> columnDefinition <span class="token operator">=</span> <span class="token string">"TIME"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Enumerated</span><span class="token punctuation">(</span><span class="token class-name">EnumType</span><span class="token punctuation">.</span>STRING<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">EventFreq</span> freq<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ManyToOne</span><span class="token punctuation">(</span>fetch<span class="token operator">=</span><span class="token class-name">FetchType</span><span class="token punctuation">.</span>EAGER<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"user_id"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@OnDelete</span><span class="token punctuation">(</span>action <span class="token operator">=</span> <span class="token class-name">OnDeleteAction</span><span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> user<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token keyword">int</span> eventId<span class="token punctuation">,</span>
                 <span class="token annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">"Need date!"</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> date<span class="token punctuation">,</span>
                 <span class="token annotation punctuation">@Size</span><span class="token punctuation">(</span>min <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> max <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">"Description must be between 0 and 200 chars!"</span><span class="token punctuation">)</span>
                         <span class="token class-name">String</span> description<span class="token punctuation">,</span>
                 <span class="token class-name">EventFreq</span> freq<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventId <span class="token operator">=</span> eventId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>date <span class="token operator">=</span> date<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> description<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>freq <span class="token operator">=</span> freq<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"users"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"name"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"time_zone"</span><span class="token punctuation">,</span> columnDefinition <span class="token operator">=</span> <span class="token string">"default 0"</span><span class="token punctuation">)</span>
    <span class="token comment">//sets the broadcast time of events for your time zone</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> timeZone<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>mappedBy<span class="token operator">=</span><span class="token string">"user"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>event<span class="token punctuation">&gt;</span></span> events<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"on_off"</span><span class="token punctuation">)</span>
    <span class="token comment">// on/off send event</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> on<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>event<span class="token operator">&gt;</span></code></pre>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"event_cash"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token comment">//serves to save unhandled events after rebooting heroku</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventCashEntity</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span> name <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">,</span> columnDefinition <span class="token operator">=</span> <span class="token string">"serial"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"time"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> date<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"description"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"user_id"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> userId<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">EventCashEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">EventCashEntity</span> <span class="token function">eventTo</span><span class="token punctuation">(</span><span class="token class-name">Date</span> date<span class="token punctuation">,</span> <span class="token class-name">String</span> description<span class="token punctuation">,</span> <span class="token keyword">long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">EventCashEntity</span> eventCashEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventCashEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        eventCashEntity<span class="token punctuation">.</span><span class="token function">setDate</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
        eventCashEntity<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
        eventCashEntity<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> eventCashEntity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Трохи пробіжимося основними моментами. <em>@Entity</em> – позначає клас нашого dada jpa, що це клас є сутністю для бази даних, тобто. при наданні даних з бази вони будуть представлені нам у вигляді об'єкта Event, User і EventCashEntity. <em>@Table</em> - кажемо як називається наша таблиця в базі даних. Для того, щоб назва таблиці не підкреслювалася червоною, нам потрібно в IDEA погодитися із запропонованим варіантом виправлення помилки і натиснути Assign data sources. І вибрати там нашу основу. <em>@id і @GeneratedValue</em> – використовується Spring для створення бази даних, якщо її ще немає. <em>@Column</em> – використовується для позначення назви полів у таблиці, якщо вони збігаються, але правила хорошого коду рекомендують це писати. Ставлення<em>OneToMany</em> - рекомендую витратити час і розібратися що це таке тут https://en.wikibooks.org/wiki/Java_Persistence Я не зможу викласти більш зрозуміло, просто повірте. Скажу лише, що в даному випадку анотація <em>@OneToMany</em> каже, що в одного користувача може бути багато подій, і вони будуть надані нам у вигляді списку. Тепер нам треба діставати дані із таблиць. У бібліотеці <strong>SRING DATA JPA</strong> вже все за нас написано, нам треба просто створити інтерфейс для кожної таблиці та розширити його від JpaRepository. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">EventRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token operator">&lt;</span>event<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Event</span> <span class="token function">findByEventId</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token operator">&lt;</span>user<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>

    <span class="token class-name">User</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">EventCashRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token operator">&lt;</span>eventcashentity<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">EventCashEntity</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>eventcashentity<span class="token punctuation">,</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>user<span class="token punctuation">,</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>event<span class="token punctuation">,</span><span class="token operator">&gt;</span></code></pre> Основну логіку роботи з базою даних винесено на сервіс, так званий <strong>Data Access Object(DAO):</strong>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDAO</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDAO</span><span class="token punctuation">(</span><span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">findByUserId</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>user<span class="token punctuation">&gt;</span></span> <span class="token function">findAllUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userRepository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isExist</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">findByUserId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventDAO</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventRepository</span> eventRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">EventDAO</span><span class="token punctuation">(</span><span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">,</span> <span class="token class-name">EventRepository</span> eventRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventRepository <span class="token operator">=</span> eventRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>event<span class="token punctuation">&gt;</span></span> <span class="token function">findByUserId</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">.</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>event<span class="token punctuation">&gt;</span></span> <span class="token function">findAllEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> eventRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span> <span class="token function">findByEventId</span><span class="token punctuation">(</span><span class="token keyword">long</span> eventId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> eventRepository<span class="token punctuation">.</span><span class="token function">findByEventId</span><span class="token punctuation">(</span>eventId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventRepository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>event<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>event<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>user<span class="token operator">&gt;</span></code></pre>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Service</span>
<span class="token comment">//handles events not dispatched after reboot heroku</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventCashDAO</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">EventCashRepository</span> eventCashRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEventCashRepository</span><span class="token punctuation">(</span><span class="token class-name">EventCashRepository</span> eventCashRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventCashRepository <span class="token operator">=</span> eventCashRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>eventcashentity<span class="token punctuation">&gt;</span></span> <span class="token function">findAllEventCash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> eventCashRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">EventCashEntity</span> eventCashEntity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventCashRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>eventCashEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventCashRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>eventcashentity<span class="token operator">&gt;</span></code></pre> В даному випадку ми не маємо ніякої обробки даних, ми просто дістаємо дані з таблиць. У нас все готово, щоб привести повний код класу T <strong>elegramFacade</strong> і почати розбирати логіку. 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@FieldDefaults</span><span class="token punctuation">(</span>level <span class="token operator">=</span> <span class="token class-name">AccessLevel</span><span class="token punctuation">.</span>PRIVATE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TelegramFacade</span> <span class="token punctuation">{</span>

    <span class="token keyword">final</span> <span class="token class-name">MessageHandler</span> messageHandler<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">CallbackQueryHandler</span> callbackQueryHandler<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">BotStateCash</span> botStateCash<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${telegrambot.adminId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> adminId<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token class-name">TelegramFacade</span><span class="token punctuation">(</span><span class="token class-name">MessageHandler</span> messageHandler<span class="token punctuation">,</span> <span class="token class-name">CallbackQueryHandler</span> callbackQueryHandler<span class="token punctuation">,</span> <span class="token class-name">BotStateCash</span> botStateCash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageHandler <span class="token operator">=</span> messageHandler<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>callbackQueryHandler <span class="token operator">=</span> callbackQueryHandler<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>botStateCash <span class="token operator">=</span> botStateCash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BotApiMethod</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">?</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">handleUpdate</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">.</span><span class="token function">hasCallbackQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CallbackQuery</span> callbackQuery <span class="token operator">=</span> update<span class="token punctuation">.</span><span class="token function">getCallbackQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> callbackQueryHandler<span class="token punctuation">.</span><span class="token function">processCallbackQuery</span><span class="token punctuation">(</span>callbackQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token class-name">Message</span> message <span class="token operator">=</span> update<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> message<span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">handleInputMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">BotApiMethod</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">?</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">handleInputMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BotState</span> botState<span class="token punctuation">;</span>
        <span class="token class-name">String</span> inputMsg <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//we process messages of the main menu and any other messages</span>
        <span class="token comment">//set state</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>inputMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"/start"</span><span class="token operator">:</span>
                botState <span class="token operator">=</span> <span class="token class-name">BotState</span><span class="token punctuation">.</span>START<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"Мои напоминания"</span><span class="token operator">:</span>
                botState <span class="token operator">=</span> <span class="token class-name">BotState</span><span class="token punctuation">.</span>MYEVENTS<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"Создать напоминание"</span><span class="token operator">:</span>
                botState <span class="token operator">=</span> <span class="token class-name">BotState</span><span class="token punctuation">.</span>CREATE<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"Отключить напоминания"</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token string">"Включить напоминания"</span><span class="token operator">:</span>
                botState <span class="token operator">=</span> <span class="token class-name">BotState</span><span class="token punctuation">.</span>ONEVENT<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"All users"</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> adminId<span class="token punctuation">)</span>
                botState <span class="token operator">=</span> <span class="token class-name">BotState</span><span class="token punctuation">.</span>ALLUSERS<span class="token punctuation">;</span>
                <span class="token keyword">else</span> botState <span class="token operator">=</span> <span class="token class-name">BotState</span><span class="token punctuation">.</span>START<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"All events"</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> adminId<span class="token punctuation">)</span>
                botState <span class="token operator">=</span> <span class="token class-name">BotState</span><span class="token punctuation">.</span>ALLEVENTS<span class="token punctuation">;</span>
                <span class="token keyword">else</span> botState <span class="token operator">=</span> <span class="token class-name">BotState</span><span class="token punctuation">.</span>START<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                botState <span class="token operator">=</span> botStateCash<span class="token punctuation">.</span><span class="token function">getBotStateMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">?</span>
                        <span class="token class-name">BotState</span><span class="token punctuation">.</span>START<span class="token operator">:</span> botStateCash<span class="token punctuation">.</span><span class="token function">getBotStateMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//we pass the corresponding state to the handler</span>
        <span class="token comment">//the corresponding method will be called</span>
        <span class="token keyword">return</span> messageHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> botState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> Розберемо для чого потрібні поля 
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">final</span> <span class="token class-name">MessageHandler</span> messageHandler<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">CallbackQueryHandler</span> callbackQueryHandler<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">BotStateCash</span> botStateCash<span class="token punctuation">;</span></code></pre> Якщо ми всі кодуватимемо в одному класі, то в нас вийде онуча до місяця, у зв'язку з цим ми відносимо логіку роботи з текстовими повідомленнями в клас MessageHandler, логіку <strong>роботи</strong> з повідомленнями callbackquery в клас <strong>СallbackQueryHandler</strong> . Настав час розібрати, що таке c <em>allbackquery</em> і які види меню бувають. Для цього наведу ще раз картинку з інтерфейсом робота: <img data-max-width="512" data-id="4ee859ec-45d3-4306-a11c-1385adea168f" alt="Telegram bot - нагадування через webHook на Java або скажи ні Google-календарю!  - 10" src="https://cdn.javarush.com/images/article/4ee859ec-45d3-4306-a11c-1385adea168f/512.jpeg" style="width: 512px;">Бувають два типи меню. Ті, що закріплені знизу вікна - основне меню, і ті, що закріплені за повідомленням, наприклад, кнопки видалити, редагувати, змінити пояс. При натисканні на кнопку основного меню надсилається однойменне повідомлення, наприклад, при натисканні <em>«Мої нагадування»</em> , буде просто надіслано текст <em>«Мої нагадування»</em>. А при встановленні клавіатури callbackquery, для кожної кнопки встановлюється певне значення і буде спрямоване значення без виведення на екран. Далі у нас є поле <strong>BotStateCash</strong> . Це спеціально створений клас, який стежитиме за станом бота, і увага, це складний елемент, треба напружитися. Було перевищено кількість символів, про що, до речі ніде не нписано )). Так що ось посилання на <a href="https://codegym.cc/groups/posts/3494-telegram-bot--napominalka-cherez-webhook-na-java-ili-skazhi-net-google-kalendarju-chastjh-2" target="_blank" rel="nofollow">другу частину</a>