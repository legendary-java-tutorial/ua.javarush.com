Динамічні проксі (Dynamic Proxies) у Java
<p>----------------------------------------</p>
Вітання! Сьогодні ми розглянемо досить важливу та цікаву тему – створення динамічних проксі-класів у Java. Вона не надто проста, тому спробуємо розібратися з нею на прикладах. Отже, найважливіше питання: що таке динамічні проксі і для чого 
<p>----------------------------------------</p>
Вітання! Сьогодні ми розглянемо досить важливу та цікаву тему – створення динамічних проксі-класів у Java. Вона не надто проста, тому спробуємо розібратися з нею на прикладах. Отже, найважливіше питання: що таке динамічні проксі і для чого вони потрібні? Проксі-клас - це деяка «надбудова» над оригінальним класом, яка дозволяє нам при необхідності змінити його поведінку. Що означає «змінити поведінку» та як це працює? Розглянемо найпростіший приклад. Допустимо, у нас є інтерфейс <code class=" language-none">Person</code>і простий клас <code class=" language-none">Man</code>, що реалізує цей інтерфейс 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">interface</span></span> <span class="token class-name"><span class="token class-name">Person</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">introduce</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> name<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">sayAge</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> age<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">sayFrom</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> city<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">String</span></span> country<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Man</span></span> <span class="token keyword"><span class="token keyword">implements</span></span> <span class="token class-name"><span class="token class-name">Person</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

   <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">String</span></span> name<span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">int</span></span> age<span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">String</span></span> city<span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">String</span></span> country<span class="token punctuation"><span class="token punctuation">;</span></span>

   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Man</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> name<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">int</span></span> age<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">String</span></span> city<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">String</span></span> country<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
       <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>name <span class="token operator"><span class="token operator">=</span></span> name<span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>age <span class="token operator"><span class="token operator">=</span></span> age<span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>city <span class="token operator"><span class="token operator">=</span></span> city<span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>country <span class="token operator"><span class="token operator">=</span></span> country<span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>

   <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">introduce</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> name<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Меня зовут "</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>name<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>

   <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">sayAge</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> age<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Мне "</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>age <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">"років"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>

   <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">sayFrom</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span> city<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">String</span></span> country<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Я из города "</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>city <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">", "</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>country<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>

   <span class="token comment"><span class="token comment">//..геттеры, сеттеры, и т.д.</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> У нашого класу <code class=" language-none">Man</code>є 3 методи: представитися, назвати свій вік і сказати, звідки ти родом. Припустимо, що цей клас ми отримали у складі готової JAR-бібліотеки і не можемо просто взяти та переписати його код. Тим не менш, нам потрібно змінити його поведінку. Наприклад, ми не знаємо, який саме метод буде викликаний у нашого об'єкта, а тому хочемо, щоб при виклику будь-якої з них людина спочатку говорила «Привіт!» (Ніхто не любить неввічливих). <img data-id="429d5f97-141a-4a7c-900e-249d35b4387b" data-max-width="850" alt="Динамічні проксі - 1" src="https://cdn.javarush.com/images/article/429d5f97-141a-4a7c-900e-249d35b4387b/800.jpeg" style="width: 850px;">Як же нам у такій ситуації вчинити? Нам знадобиться кілька речей: 
<ol>
 <li>
  <p><code class=" language-none"><strong>InvocationHandler</strong></code></p></li>
</ol>Що це таке? Можна перекласти дослівно - "перехоплювач викликів". Це точно опише його призначення. <code class=" language-none"><strong>InvocationHandler</strong></code>— це спеціальний інтерфейс, який дозволяє перехопити будь-які виклики методів до нашого об'єкту та додати потрібну нам додаткову поведінку. Нам необхідно зробити власний перехоплювач, тобто створити клас і реалізувати цей інтерфейс. Це досить просто: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>reflect<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">InvocationHandler</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>reflect<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Method</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">PersonInvocationHandler</span></span> <span class="token keyword"><span class="token keyword">implements</span></span> <span class="token class-name"><span class="token class-name">InvocationHandler</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

<span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Person</span></span> person<span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">PersonInvocationHandler</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Person</span></span> person<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
   <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>person <span class="token operator"><span class="token operator">=</span></span> person<span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span>

 <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Object</span></span> <span class="token function"><span class="token function">invoke</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Object</span></span> proxy<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Method</span></span> method<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Object</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">Throwable</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Вітання!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token keyword"><span class="token keyword">return</span></span> <span class="token keyword"><span class="token keyword">null</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Нам потрібно реалізувати лише один метод інтерфейсу — <code class=" language-none"><strong>invoke()</strong></code>. Він, власне, і робить те, що нам потрібно - перехоплює всі виклики методів до нашого об'єкта і додає необхідну поведінку (тут ми всередині методу <code class=" language-none">invoke()</code>виводимо в консоль "Привіт!"). 
<ol start="2">
 <li><strong>Оригінальний об'єкт та його проксі.</strong></li>
</ol>Створимо оригінальний об'єкт <code class=" language-none">Man</code>і надбудову (проксі) для нього: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>reflect<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Proxy</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Main</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

       <span class="token comment"><span class="token comment">//Создаем оригинальный об'єкт</span></span>
       <span class="token class-name"><span class="token class-name">Man</span></span> vasia <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Man</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Вася"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token number"><span class="token number">30</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token string"><span class="token string">"Санкт-Петербург"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token string"><span class="token string">"Россия"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token comment"><span class="token comment">//Получаем загрузчик класса у оригинального об'єкта</span></span>
       <span class="token class-name"><span class="token class-name">ClassLoader</span></span> vasiaClassLoader <span class="token operator"><span class="token operator">=</span></span> vasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getClass</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getClassLoader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token comment"><span class="token comment">//Получаем все интерфейсы, которые реализует оригинальный об'єкт</span></span>
       <span class="token class-name"><span class="token class-name">Class</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> interfaces <span class="token operator"><span class="token operator">=</span></span> vasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getClass</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getInterfaces</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token comment"><span class="token comment">//Создаем прокси нашего об'єкта vasia</span></span>
       <span class="token class-name"><span class="token class-name">Person</span></span> proxyVasia <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Person</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token class-name"><span class="token class-name">Proxy</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">newProxyInstance</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasiaClassLoader<span class="token punctuation"><span class="token punctuation">,</span></span> interfaces<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">PersonInvocationHandler</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasia<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token comment"><span class="token comment">//Вызываем у прокси об'єкта один из методов нашего оригинального об'єкта</span></span>
       proxyVasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">introduce</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

   <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Виглядає не дуже просто! Я спеціально написав до кожного рядка коду коментар: давай розберемося докладніше, що там відбувається.
<p></p>У першому рядку ми просто робимо оригінальний об'єкт, для якого створюватимемо проксі. Наступні два рядки можуть викликати у тебе скруту: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token comment"><span class="token comment">//Получаем загрузчик класса у оригинального об'єкта</span></span>
<span class="token class-name"><span class="token class-name">ClassLoader</span></span> vasiaClassLoader <span class="token operator"><span class="token operator">=</span></span> vasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getClass</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getClassLoader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token comment"><span class="token comment">//Получаем все интерфейсы, которые реализует оригинальный об'єкт</span></span>
<span class="token class-name"><span class="token class-name">Class</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> interfaces <span class="token operator"><span class="token operator">=</span></span> vasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getClass</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getInterfaces</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Але насправді нічого особливого тут не відбувається :) Для створення проксі нам потрібний <code class=" language-none">ClassLoader</code>(завантажувач класів) оригінального об'єкта та список усіх інтерфейсів, які реалізує наш оригінальний клас (тобто <code class=" language-none">Man</code>). Якщо ти не знаєш що таке <code class=" language-none">ClassLoader</code>, можеш почитати <a href="https://codegym.cc/groups/posts/646-kak-proiskhodit-zagruzka-klassov-v-jvm" target="_blank">цю статтю</a> про завантаження класів в JVM або <a href="https://habr.com/ru/post/103830/" rel="nofollow" target="_blank">цю на Хабре</a> , але поки що не особливо з цим морочися. Просто запам'ятай, що ми отримуємо трохи додаткової інформації, яка буде потрібна для створення проксі-об'єкта. У четвертому рядку ми використовуємо спеціальний клас <code class=" language-none"><strong>Proxy</strong></code>та його статичний метод <code class=" language-none"><strong>newProxyInstance()</strong></code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java"><span class="token comment"><span class="token comment">//Создаем прокси нашего об'єкта vasia</span></span>
<span class="token class-name"><span class="token class-name">Person</span></span> proxyVasia <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Person</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token class-name"><span class="token class-name">Proxy</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">newProxyInstance</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasiaClassLoader<span class="token punctuation"><span class="token punctuation">,</span></span> interfaces<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">PersonInvocationHandler</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasia<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Цей метод створює наш проксі-об'єкт. У метод ми передаємо ту інформацію про оригінальний клас, яку отримали на минулому кроці (його <code class=" language-none">ClassLoader</code>та список його інтерфейсів), а також об'єкт створеного нами раніше перехоплювача - <code class=" language-none">InvocationHandler</code>'a. Головне — не забудь передати перехоплювачу наш оригінальний об'єкт <code class=" language-none">vasia</code>, інакше йому нічого буде перехоплювати :) Що ж у нас у результаті вийшло? У нас тепер є проксі-об'єкт <code class=" language-none"><strong>vasiaProxy</strong></code>. Він може викликати <strong>будь-які методи інтерфейсу<code class=" language-none">Person</code></strong> . Чому? Тому що ми передали йому список усіх інтерфейсів – ось тут: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token comment"><span class="token comment">//Получаем все интерфейсы, которые реализует оригинальный об'єкт</span></span>
<span class="token class-name"><span class="token class-name">Class</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> interfaces <span class="token operator"><span class="token operator">=</span></span> vasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getClass</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getInterfaces</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token comment"><span class="token comment">//Создаем прокси нашего об'єкта vasia</span></span>
<span class="token class-name"><span class="token class-name">Person</span></span> proxyVasia <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Person</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token class-name"><span class="token class-name">Proxy</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">newProxyInstance</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasiaClassLoader<span class="token punctuation"><span class="token punctuation">,</span></span> interfaces<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">PersonInvocationHandler</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasia<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Тепер він "в курсі" всіх методів інтерфейсу <code class=" language-none">Person</code>. Крім того, ми передали нашому проксі об'єкт <code class=" language-none"><strong>PersonInvocationHandler</strong></code>, налаштований на роботу з об'єктом <code class=" language-none"><strong>vasia</strong></code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java"><span class="token comment"><span class="token comment">//Создаем прокси нашего об'єкта vasia</span></span>
<span class="token class-name"><span class="token class-name">Person</span></span> proxyVasia <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Person</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token class-name"><span class="token class-name">Proxy</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">newProxyInstance</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasiaClassLoader<span class="token punctuation"><span class="token punctuation">,</span></span> interfaces<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">PersonInvocationHandler</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasia<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Тепер, якщо ми викликаємо у проксі-об'єкта будь-який метод інтерфейсу <code class=" language-none">Person</code>, наш перехоплювач «словить» цей виклик і виконає замість нього свій метод <code class=" language-none"><strong>invoke()</strong></code>. Давай спробуємо запустити метод <code class=" language-none">main()</code>! <strong>Висновок у консоль: <em>Привіт! </em></strong> Чудово! Ми бачимо, що замість цього методу <code class=" language-none">Person.introduce()</code>викликаний метод <code class=" language-none">invoke()</code>нашого <code class=" language-none">PersonInvocationHandler()</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Object</span></span> <span class="token function"><span class="token function">invoke</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Object</span></span> proxy<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Method</span></span> method<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Object</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">Throwable</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

   <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Вітання!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token keyword"><span class="token keyword">return</span></span> <span class="token keyword"><span class="token keyword">null</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> І в консоль було виведено "Привіт!" <strong>Але це не зовсім та поведінка, яку ми хотіли отримати :/</strong> За нашим задумом спочатку має бути виведено «Привіт!», а потім спрацювати сам метод, який ми викликаємо. Іншими словами, ось цей виклик методу: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java">proxyVasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">introduce</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> має виводити в консоль «Привіт! Мене звуть Вася», а не просто «Привіт!» Як же нам досягти цього? Нічого складного: просто доведеться трохи похимічити над нашим перехоплювачем та методом <code class=" language-none">invoke()</code>:) Зверніть увагу, які аргументи передаються у цей метод: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Object</span></span> <span class="token function"><span class="token function">invoke</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Object</span></span> proxy<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Method</span></span> method<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Object</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span></code></pre><strong>Метод <code class=" language-none">invoke()</code>має доступ до методу, замість якого він викликається, і до всіх його аргументів</strong> (Method method, Object[] args). Іншими словами, якщо ми викликаємо метод <code class=" language-none"><strong>proxyVasia.introduce(vasia.getName())</strong></code>, і замість методу <code class=" language-none">introduce()</code>викликається метод <code class=" language-none">invoke()</code>, усередині цього методу ми маємо доступ і до оригінального методу <code class=" language-none">introduce()</code>, і до його аргументу! В результаті ми можемо зробити так: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>reflect<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">InvocationHandler</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>reflect<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Method</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">PersonInvocationHandler</span></span> <span class="token keyword"><span class="token keyword">implements</span></span> <span class="token class-name"><span class="token class-name">InvocationHandler</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

   <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Person</span></span> person<span class="token punctuation"><span class="token punctuation">;</span></span>

   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">PersonInvocationHandler</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Person</span></span> person<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

       <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>person <span class="token operator"><span class="token operator">=</span></span> person<span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>

   <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">Object</span></span> <span class="token function"><span class="token function">invoke</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Object</span></span> proxy<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Method</span></span> method<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">Object</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">Throwable</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Вітання!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token keyword"><span class="token keyword">return</span></span> method<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">invoke</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>person<span class="token punctuation"><span class="token punctuation">,</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Тепер ми додали метод <code class=" language-none">invoke()</code>виклик оригінального методу. Якщо ми спробуємо зараз запустити код із нашого попереднього прикладу: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>reflect<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Proxy</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Main</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

       <span class="token comment"><span class="token comment">//Создаем оригинальный об'єкт</span></span>
       <span class="token class-name"><span class="token class-name">Man</span></span> vasia <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Man</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Вася"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token number"><span class="token number">30</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token string"><span class="token string">"Санкт-Петербург"</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token string"><span class="token string">"Россия"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token comment"><span class="token comment">//Получаем загрузчик класса у оригинального об'єкта</span></span>
       <span class="token class-name"><span class="token class-name">ClassLoader</span></span> vasiaClassLoader <span class="token operator"><span class="token operator">=</span></span> vasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getClass</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getClassLoader</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token comment"><span class="token comment">//Получаем все интерфейсы, которые реализует оригинальный об'єкт</span></span>
       <span class="token class-name"><span class="token class-name">Class</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> interfaces <span class="token operator"><span class="token operator">=</span></span> vasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getClass</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getInterfaces</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token comment"><span class="token comment">//Создаем прокси нашего об'єкта vasia</span></span>
       <span class="token class-name"><span class="token class-name">Person</span></span> proxyVasia <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Person</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token class-name"><span class="token class-name">Proxy</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">newProxyInstance</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasiaClassLoader<span class="token punctuation"><span class="token punctuation">,</span></span> interfaces<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">PersonInvocationHandler</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasia<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token comment"><span class="token comment">//Вызываем у прокси об'єкта один из методов нашего оригинального об'єкта</span></span>
       proxyVasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">introduce</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> то побачимо, що тепер все працює як треба:) <strong>Висновок у консоль: <em>Привіт! Мене звуть Вася</em></strong> Де це може тобі знадобитися? Насправді багато де. Паттерн проектування «динамічний проксі» активно використовується в популярних технологіях ... а я, до речі, і забув тобі сказати, що <strong><code class=" language-none">Dynamic Proxy</code>це патерн</strong> ! Вітаю, ти вивчив ще одну! :) <img data-id="14e2066d-3c45-4ba9-b5b3-9fc7f12710dc" data-max-width="850" alt="Динамічні проксі - 2" src="https://cdn.javarush.com/images/article/14e2066d-3c45-4ba9-b5b3-9fc7f12710dc/800.jpeg" style="width: 850px;">Так ось, він активно використовується в популярних технологіях та фреймворках, пов'язаних із безпекою. Уяви, що ти маєш 20 методів, які можуть виконувати тільки залогінені користувачі твоєї програми. За допомогою вивчених прийомів ти легко зможеш додати в ці 20 методів перевірку того, чи ввів користувач логін та пароль, не дублюючи код перевірки окремо в кожному методі. Або, наприклад, якщо ти хочеш створити журнал, куди будуть записуватись всі дії користувачів, це також легко зробити з використанням проксі. Можна навіть зараз: просто допиши приклад код, щоб назва методу виводилася в консоль при виклику <code class=" language-none">invoke()</code>, і ти отримаєш простенький журнал логів нашої програми :) На завершення лекції, <strong>зверни увагу на одне важливе обмеження</strong>. Створення проксі об'єкта відбувається лише на рівні інтерфейсів, а чи не класів. Проксі створюється для інтерфейсу. Поглянь на цей код: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class="  language-java"><span class="token comment"><span class="token comment">//Создаем прокси нашего об'єкта vasia</span></span>
<span class="token class-name"><span class="token class-name">Person</span></span> proxyVasia <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Person</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token class-name"><span class="token class-name">Proxy</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">newProxyInstance</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasiaClassLoader<span class="token punctuation"><span class="token punctuation">,</span></span> interfaces<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">PersonInvocationHandler</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasia<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre> Тут ми створюємо проксі саме для інтерфейсу <code class=" language-none">Person</code>. Якщо спробуємо створити проксі для класу, тобто змінимо тип посилання і спробуємо зробити приведення до класу <code class=" language-none">Man</code>, у нас нічого не вийде. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class="  language-java"><span class="token class-name"><span class="token class-name">Man</span></span> proxyVasia <span class="token operator"><span class="token operator">=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Man</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token class-name"><span class="token class-name">Proxy</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">newProxyInstance</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasiaClassLoader<span class="token punctuation"><span class="token punctuation">,</span></span> interfaces<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">PersonInvocationHandler</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasia<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

proxyVasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">introduce</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>vasia<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span></code></pre><em><strong>Exception in thread "main" java.lang.ClassCastException: com.sun.proxy.$Proxy0 cannot be cast to Man</strong></em> Наявність інтерфейсу - обов'язкова вимога. Проксі працює на рівні інтерфейсів. На цьому на сьогодні все :) Як додатковий матеріал по темі проксі можу порекомендувати тобі відмінне<a href="https://www.youtube.com/watch?v=aMc1wHveqGM" rel="nofollow" target="_blank"> відео</a> , а також непогану<a href="https://restless-man.livejournal.com/24320.html" rel="nofollow" target="_blank"> статтю</a> . Ну а тепер було б непогано вирішити кілька завдань! :) До зустрічі!