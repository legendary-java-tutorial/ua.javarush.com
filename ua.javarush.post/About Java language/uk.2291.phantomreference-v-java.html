PhantomReference в Java
<p>----------------------------------------</p>
Вітання! На сьогоднішньому занятті ми докладно поговоримо про «фантомні посилання» (PhantomReference) у Java. Що за посилання такі, чому називаються «фантомними» і як ними користуватися? Як ти пам'ятаєш, у Java є 4 види посилань: Об'єкти тр
<p>----------------------------------------</p>
Вітання! На сьогоднішньому занятті ми докладно поговоримо про «фантомні посилання» (PhantomReference) у Java. Що за посилання такі, чому називаються «фантомними» і як ними користуватися? Як ти пам'ятаєш, у Java є 4 види посилань: 
<ol>
 <li>
  <p><span class="code">StrongReference</span> (звичайні посилання, які ми створюємо під час створення об'єкта):</p>
  <pre class="inline-block  language-java" tabindex="0"><code class="  language-java"><span class="token class-name"><span class="token class-name">Cat</span></span> cat <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Cat</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span></code></pre>
  <p><span class="code">cat</span> у цьому прикладі - Strong-посилання.</p></li>
 <li>
  <p><span class="code">SoftReference</span> (м'яке посилання). Ми мали <a href="https://codegym.cc/quests/lectures/questcollections.level04.lecture03" target="_blank">лекцію</a> про ці посилання.</p></li>
 <li>
  <p><span class="code">WeakReference</span> (слабке посилання). Про них також була лекція, <a href="https://codegym.cc/quests/lectures/questcollections.level04.lecture05" target="_blank">ось</a> .</p></li>
 <li>
  <p><span class="code">PhantomReference</span> (фантомне посилання).</p></li>
</ol>Об'єкти трьох останніх видів типізовані (наприклад, <span class="code">SoftReference&lt;Integer&gt;</span> , <span class="code">WeakReference&lt;MyClass&gt;</span> ). Класи <code class=" language-none">SoftReference</code>, <code class=" language-none">WeakReference</code>і <code class=" language-none">PhantomReference</code>успадковуються від класу <code class=" language-none"><strong>Reference</strong></code>. Найбільш важливі методи під час роботи з цими класами: 
<ul>
 <li>
  <p><code class=" language-none"><strong>get()</strong></code>- Повертає об'єкт, на який посилається це посилання;</p></li>
 <li><code class=" language-none"><strong>clear()</strong></code>- Видаляє посилання на об'єкт.
  <p></p></li>
</ul>Ці методи ти пам'ятаєш з лекцій про <code class=" language-none">SoftReference</code>і <code class=" language-none">WeakReference</code>. Важливо пам'ятати, що вони працюють по-різному із різними видами посилань. Ми сьогодні не будемо докладно розглядати перші три типи, а поговоримо про фантомні посилання. Інші види посилань ми теж торкнемося, але тільки в тій частині, де говоритимемо, чим фантомні посилання від них відрізняються. Поїхали! :) Почнемо з того, навіщо нам взагалі потрібні фантомні посилання. Як ти знаєш, звільненням пам'яті від непотрібних об'єктів Java займається <strong>збирач сміття</strong> (Garbage Collector або gc). <strong>Складальник видаляє об'єкт у два «проходи». </strong> У перший прохід він лише дивиться на об'єкти, і, якщо треба, позначає його як «непотрібний, що підлягає видаленню». Якщо цей об'єкт був перевизначений метод<code class=" language-none">finalize()</code>, він викликається. Або не викликається – як пощастить. Ти напевно пам'ятаєш, що <code class=" language-none">finalize()</code>штука непостійна :) У другий прохід збирача об'єкт видаляється, і пам'ять звільняється. Така непередбачувана поведінка збирача сміття створює для нас низку проблем. Ми не знаємо коли саме розпочнеться робота збирача сміття. Ми не знаємо чи буде викликаний метод <code class=" language-none">finalize()</code>. Плюс до всього, під час роботи <code class=" language-none">finalize()</code>може бути створена strong-посилання на об'єкт, і тоді його взагалі не буде видалено. У системах, вимогливих до обсягу вільної пам'яті, це може призвести до <code class=" language-none"><strong>OutOfMemoryError</strong></code>. Все це підштовхує нас до використання <strong>фантомних посилань</strong> . Справа в тому, що це змінює поведінку збирача сміття. Якщо на об'єкт залишабося лише фантомні посилання, то у нього: 
<ul>
 <li>
  <p>викликається метод <code class=" language-none">finalize()</code>(якщо він перевизначено);</p></li>
 <li>
  <p>якщо після роботи <code class=" language-none">finalize()</code>нічого не змінилося і об'єкт все ще може бути видалений, фантомне посилання на об'єкт міститься у спеціальну чергу - <code class=" language-none"><strong>ReferenceQueue</strong></code>.</p></li>
</ul>Найважливіше, що потрібно розуміти під час роботи з фантомними посиланнями, — <strong>об'єкт не видаляється з пам'яті доти, доки його фантомне посилання перебуває в цій черзі</strong> . Він буде видалений тільки після того, як у фантомного посилання буде викликаний метод <code class=" language-none"><strong>clear()</strong></code>. Давай розглянемо приклад. Для початку створимо тестовий клас, який зберігатиме в собі якісь дані. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">TestClass</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
   <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">StringBuffer</span></span> data<span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">TestClass</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
       <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>data <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">StringBuffer</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token keyword"><span class="token keyword">for</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">long</span></span> i <span class="token operator"><span class="token operator">=</span></span> <span class="token number"><span class="token number">0</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i <span class="token operator"><span class="token operator">&lt;</span></span> <span class="token number"><span class="token number">50000000</span></span><span class="token punctuation"><span class="token punctuation">;</span></span> i<span class="token operator"><span class="token operator">++</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
           <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>data<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">append</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">'x'</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token punctuation"><span class="token punctuation">}</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>
   <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
   <span class="token keyword"><span class="token keyword">protected</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">finalize</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"У об'єкта TestClass вызван метод finalize!!!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Ми спеціально добре «завантажуємо» об'єкти даними при створенні (додаємо в кожен об'єкт по 50 мільйонів символів «х»), щоб зайняти більше пам'яті. Крім того, ми спеціально перевизначаємо метод <code class=" language-none">finalize()</code>, щоб побачити, що він спрацював. Далі нам знадобиться клас, який успадковуватиметься від <code class=" language-none">PhantomReference</code>. Навіщо нам потрібний такий клас? Все просто. Так ми зможемо додати додаткову логіку до методу <code class=" language-none">clear()</code>, щоб побачити, що очищення фантомного посилання справді відбулося (а отже, об'єкт видалено). 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>ref<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">PhantomReference</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>ref<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">ReferenceQueue</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">MyPhantomReference</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">TestClass</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> <span class="token keyword"><span class="token keyword">extends</span></span> <span class="token class-name"><span class="token class-name">PhantomReference</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">TestClass</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">MyPhantomReference</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">TestClass</span></span> obj<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">ReferenceQueue</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">TestClass</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> queue<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

       <span class="token keyword"><span class="token keyword">super</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>obj<span class="token punctuation"><span class="token punctuation">,</span></span> queue<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">Thread</span></span> thread <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">QueueReadingThread</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">TestClass</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span>queue<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       thread<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">start</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>

   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">cleanup</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Очистка фантомной ссылки! Удаление об'єкта из памяти!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token function"><span class="token function">clear</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Далі нам знадобиться окремий потік, який чекатиме, поки збирач сміття зробить свою справу, і в нашій черзі <code class=" language-none">ReferenceQueue</code>з'являться фантомні посилання. Як тільки таке посилання потрапить у чергу, у неї буде викликаний метод <code class=" language-none">cleanup()</code>: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>ref<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Reference</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>ref<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">ReferenceQueue</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">QueueReadingThread</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">TestClass</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> <span class="token keyword"><span class="token keyword">extends</span></span> <span class="token class-name"><span class="token class-name">Thread</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

   <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">ReferenceQueue</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">TestClass</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> referenceQueue<span class="token punctuation"><span class="token punctuation">;</span></span>

   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">QueueReadingThread</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">ReferenceQueue</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">TestClass</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> referenceQueue<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
       <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>referenceQueue <span class="token operator"><span class="token operator">=</span></span> referenceQueue<span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>

   <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">run</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Поток, отслеживающий очередь, стартовал!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token class-name"><span class="token class-name">Reference</span></span> ref <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">null</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token comment"><span class="token comment">//ждем, пока в очереди появятся ссылки</span></span>
       <span class="token keyword"><span class="token keyword">while</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>ref <span class="token operator"><span class="token operator">=</span></span> referenceQueue<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">poll</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">==</span></span> <span class="token keyword"><span class="token keyword">null</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

           <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
               <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">50</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
           <span class="token punctuation"><span class="token punctuation">}</span></span>

           <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
               <span class="token keyword"><span class="token keyword">throw</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">RuntimeException</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Поток "</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token function"><span class="token function">getName</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token string"><span class="token string">" был прерван!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
           <span class="token punctuation"><span class="token punctuation">}</span></span>
       <span class="token punctuation"><span class="token punctuation">}</span></span>

       <span class="token comment"><span class="token comment">//як только в очереди появилась фантомная посилання - очистить ее</span></span>
       <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">MyPhantomReference</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> ref<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">cleanup</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> І, нарешті, нам знадобиться метод <code class=" language-none">main()</code>: винесемо його в окремий клас <code class=" language-none">Main</code>. У ньому ми створимо об'єкт <code class=" language-none">TestClass</code>, фантомне посилання на нього та чергу для фантомних посилань. Після цього ми викличемо збирач сміття і подивимося, що буде :) 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>ref<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token operator"><span class="token operator">*</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Main</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token keyword"><span class="token keyword">throws</span></span> <span class="token class-name"><span class="token class-name">InterruptedException</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
       <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">10000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">ReferenceQueue</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">TestClass</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> queue <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ReferenceQueue</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token class-name"><span class="token class-name">Reference</span></span> ref <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">MyPhantomReference</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">TestClass</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> queue<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"ref = "</span></span> <span class="token operator"><span class="token operator">+</span></span> ref<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">5000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Вызывается сборка мусора!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">gc</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">300</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"ref = "</span></span> <span class="token operator"><span class="token operator">+</span></span> ref<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">Thread</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">sleep</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">5000</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"Вызывается сборка мусора!"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">gc</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
   <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Висновок у консоль: <em>ref = MyPhantomReference@4554617c Потік, що відстежує чергу, стартував! Викликається складання сміття! Об'єкт TestClass має метод finalize!!! ref = MyPhantomReference@4554617c Викликається складання сміття! Очищення фантомного посилання! Видалення об'єкта з пам'яті! </em> Що ми тут бачимо? Все сталося, як ми планували! У нашого класу об'єкта був перевизначений метод <code class=" language-none">finalize()</code>і він був викликаний під час роботи збирача. Далі, фантомне посилання було поміщено в чергу <code class=" language-none">ReferenceQueue</code>. Там у неї був викликаний метод <code class=" language-none"><strong>clear()</strong></code>(з якого ми зробабо<code class=" language-none">cleanup()</code>, щоб додати вивід у консоль). У результаті об'єкт видалено з пам'яті. Тепер ти бачиш, як саме це працює :) Звичайно, тобі не треба зазубривати напам'ять всю пов'язану з фантомними посиланнями теорію. Але буде добре, якщо ти пам'ятатимеш хоча б головні моменти. <strong>По-перше</strong> , це найслабші посилання з усіх. Вони вступають у роботу тільки тоді, коли на об'єкт не залишилося жодних інших посилань. Список посилань, які ми привели вище, йде за «зменшенням сабо»: <code class=" language-none"><strong>StrongReference</strong></code>-&gt; <code class=" language-none"><strong>SoftReference</strong></code>-&gt; <code class=" language-none"><strong>WeakReference</strong></code>-&gt; <code class=" language-none"><strong>PhantomReference</strong></code> Фантомне посилання вступить у бій тільки коли на наш об'єкт не буде ні Strong, ні Soft, ні Weak посилань :) <strong>По-друге</strong> , метод <code class=" language-none">get()</code>для фантомного посилання завжди повертає<code class=" language-none">null</code>. Ось простий приклад, де ми створюємо три різні типи посилань для трьох різних видів автомобілів: 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>ref<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">PhantomReference</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>ref<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">ReferenceQueue</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>ref<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">SoftReference</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>lang<span class="token punctuation"><span class="token punctuation">.</span></span>ref<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">WeakReference</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Main</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

   <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">main</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">String</span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> args<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

       <span class="token class-name"><span class="token class-name">Sedan</span></span> sedan <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">Sedan</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token class-name"><span class="token class-name">HybridAuto</span></span> hybrid <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">HybridAuto</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token class-name"><span class="token class-name">F1Car</span></span> f1car <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">F1Car</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">SoftReference</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">Sedan</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> softReference <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">SoftReference</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span>sedan<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>softReference<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">get</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">WeakReference</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">HybridAuto</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> weakReference <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">WeakReference</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span>hybrid<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>weakReference<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">get</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">ReferenceQueue</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">F1Car</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> referenceQueue <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ReferenceQueue</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

       <span class="token class-name"><span class="token class-name">PhantomReference</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">F1Car</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> phantomReference <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">PhantomReference</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">(</span></span>f1car<span class="token punctuation"><span class="token punctuation">,</span></span> referenceQueue<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
       <span class="token class-name"><span class="token class-name">System</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>out<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">println</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>phantomReference<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">get</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

   <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre><strong>Висновок в консоль: <em>Sedan@4554617c HybridAuto@74a14482 null</em></strong> Метод <code class=" language-none">get()</code>повернув цілком нормальні об'єкти для м'якого посилання та слабкого посилання, але повернув <code class=" language-none">null</code>для фантомної. <strong>По-третє</strong> , основна область використання фантомних посилань - складні процедури видалення об'єктів з пам'яті. От і все! :) На цьому наше сьогоднішнє заняття закінчено. Але на одній теорії далеко не поїдеш, тому настав час повертатися до вирішення завдань! :)