Рівень 26. Відповіді питання до співбесіди на тему рівня. Частина 2. Запитання 6-9, 11-12
<p>----------------------------------------</p>
– це бібліотека класів Java, в якій зібрали спеціальні класи, оптимізовані для роботи з кількох ниток. Ці класи зібрані у пакеті . Їх можна схематично поділити за функціональною ознакою наступним чином: — набір колекцій, що ефективно працюю
<p>----------------------------------------</p>
<img data-id="f958617a-0110-40d9-9a2b-656c1e3a98dd" data-max-width="850" alt="Рівень 26. Відповіді питання до співбесіди на тему рівня.  Частина 2. Запитання 6-9, 11-12 - 1" src="https://cdn.javarush.com/images/article/f958617a-0110-40d9-9a2b-656c1e3a98dd/800.jpeg" style="width: 850px;">
<h2>6. Що таке канкаренсі?</h2><strong>Concurrency</strong> – це бібліотека класів Java, в якій зібрали спеціальні класи, оптимізовані для роботи з кількох ниток. Ці класи зібрані у пакеті <code class=" language-none">java.util.concurrent</code>. Їх можна схематично поділити за функціональною ознакою наступним чином: <img data-id="05dea82f-9363-43db-850d-59271569e951" data-max-width="740" alt="Рівень 26. Відповіді питання до співбесіди на тему рівня.  Частина 2. Запитання 6-9, 11-12 - 2" src="https://cdn.javarush.com/images/article/05dea82f-9363-43db-850d-59271569e951/512.jpeg" style="width: 740px;"><strong>Concurrent Collections</strong> — набір колекцій, що ефективно працюють у багатопотоковому середовищі, ніж стандартні універсальні колекції з <code class=" language-none">java.util</code>пакета. Замість базового враппера <code class=" language-none">Collections.synchronizedList</code>з блокуванням доступу до всієї колекції використовуються блокування за сегментами даних або оптимізується робота для паралельного читання даних за wait-free алгоритмами. <strong>Queues</strong>- Неблокуючі та блокуючі черги з підтримкою багатопоточності. Неблокуючі черги заточені на швидкість та роботу без блокування потоків. Блокуючі черги використовуються, коли потрібно "пригальмувати" потоки "Producer" або "Consumer", якщо не виконані будь-які умови, наприклад, черга порожня або перепонена, або немає вільного "Consumer"'a. <strong>Synchronizers</strong> – допоміжні утиліти для синхронізації потоків. Є потужною зброєю в «паралельних» обчисленнях. <strong>Executors</strong> - містить у собі відмінні фрейморки для створення пулів потоків, планування роботи асинхронних завдань із отриманням результатів. <strong>Locks</strong> - являє собою альтернативні та більш гнучкі механізми синхронізації потоків у порівнянні з базовими <code class=" language-none">synchronized</code>,<code class=" language-none">wait</code>, <code class=" language-none">notify</code>, <code class=" language-none">notifyAll</code>. <strong>Atomics</strong> – класи з підтримкою атомарних операцій над примітивами та посиланнями. <strong>Джерело:</strong>
<ul>
 <li><a href="https://habr.com/company/luxoft/blog/157273/" rel="nofollow" target="_blank">Огляд java.util.concurrent.*</a></li>
</ul>
<h2>7. Які класи з "канкаренсі" ти знаєш?</h2>Відповідь це питання добре викладено у <a href="https://habr.com/company/luxoft/blog/157273/" rel="nofollow" target="_blank">цій статті</a> . Змилу передруковувати всю її сюди я не бачу, тому наведу описи тільки тих класів, з якими мав честь побіжно ознайомитися. <strong>ConcurrentHashMap&lt;K, V&gt;</strong> — На відміну від <code class=" language-none">Hashtable</code>блоків і <code class=" language-none">synhronized</code>на <code class=" language-none">HashMap</code>, дані представлені у вигляді сегментів, розбитих по hash'ам ключів. В результаті, для доступу до даних лине по сегментах, а не по одному об'єкту. На додаток, ітератори подають дані на певний час і не кидають <code class=" language-none">ConcurrentModificationException</code>. <strong>—</strong> Що якщо в класі потрібно синхронізувати доступ до однієї простої змінної типу <code class=" language-none">int</code>? Можна використовувати конструкції з<code class=" language-none">synchronized</code>, а при використанні атомарних операцій <code class=" language-none">set/get</code>підійде також і <code class=" language-none">volatile</code>. Але можна зробити ще краще, використавши нові класи <code class=" language-none">Atomic*</code>. За рахунок використання CAS операції з цими класами працюють швидше, ніж якщо синхронізуватися через <code class=" language-none">synchronized/volatile</code>. Плюс існують методи атомарного додавання на задану величину, а також інкремент/декремент. 
<h2>8. Як влаштований клас ConcurrentHashMap?</h2>На момент появи <code class=" language-none">ConcurrentHashMap</code>Java-розробники потребували наступної реалізації хеш-карти: 
<ul>
 <li>Потокобезпека</li>
 <li>Відсутність блокувань усієї таблиці на час доступу до неї</li>
 <li>Бажано, щоб були відсутні блокування таблиці при виконанні операції читання</li>
</ul>Основні ідеї реалізації <code class=" language-none">ConcurrentHashMap</code>такі: 
<ol>
 <li>
  <p><strong>Елементи картки</strong></p>
  <p>На відміну від елементів <code class=" language-none">HashMap</code>, <code class=" language-none">Entry</code>оголошені <code class=" language-none">ConcurrentHashMap</code>як <code class=" language-none">volatile</code>. Це важлива особливість, пов'язана також зі змінами в <a href="https://habr.com/post/133981/" rel="nofollow" target="_blank">JMM</a> .</p>
  <pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">HashEntry</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">K</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">V</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">K</span></span> key<span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">final</span></span> <span class="token keyword"><span class="token keyword">int</span></span> hash<span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">volatile</span></span> <span class="token class-name"><span class="token class-name">V</span></span> value<span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">final</span></span> <span class="token class-name"><span class="token class-name">HashEntry</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">K</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">V</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> next<span class="token punctuation"><span class="token punctuation">;</span></span>

    <span class="token class-name"><span class="token class-name">HashEntry</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">K</span></span> key<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token keyword"><span class="token keyword">int</span></span> hash<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">HashEntry</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">K</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">V</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> next<span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">V</span></span> value<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">this</span></span> <span class="token punctuation"><span class="token punctuation">.</span></span>key <span class="token operator"><span class="token operator">=</span></span> key<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">this</span></span> <span class="token punctuation"><span class="token punctuation">.</span></span>hash <span class="token operator"><span class="token operator">=</span></span> hash<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">this</span></span> <span class="token punctuation"><span class="token punctuation">.</span></span>next <span class="token operator"><span class="token operator">=</span></span> next<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">this</span></span> <span class="token punctuation"><span class="token punctuation">.</span></span>value <span class="token operator"><span class="token operator">=</span></span> value<span class="token punctuation"><span class="token punctuation">;</span></span>
     <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token annotation punctuation"><span class="token annotation punctuation">@SuppressWarnings</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token string"><span class="token string">"unchecked"</span></span><span class="token punctuation"><span class="token punctuation">)</span></span>
    <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">final</span></span> <span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">K</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">V</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span> <span class="token class-name"><span class="token class-name">HashEntry</span></span><span class="token generics"><span class="token punctuation"></span><span class="token generics"><span class="token punctuation"><span class="token punctuation">&lt;</span></span><span class="token class-name"><span class="token class-name">K</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">V</span></span><span class="token punctuation"><span class="token punctuation">&gt;</span></span></span><span class="token punctuation"></span></span><span class="token punctuation"><span class="token punctuation">[</span></span><span class="token punctuation"><span class="token punctuation">]</span></span> <span class="token function"><span class="token function">newArray</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> i<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">return</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">HashEntry</span></span><span class="token punctuation"><span class="token punctuation">[</span></span>i<span class="token punctuation"><span class="token punctuation">]</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre></li>
 <li>
  <p><strong>Хеш-функція</strong></p>
  <p><code class=" language-none">ConcurrentHashMap</code>також використовується покращена функція хешування.</p>
  <p>Нагадаю, якою вона була з <code class=" language-none">HashMap</code>JDK 1.2:</p>
  <pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">int</span></span> <span class="token function"><span class="token function">hash</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> h<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    h <span class="token operator"><span class="token operator">^=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>h <span class="token operator"><span class="token operator">&gt;&gt;&gt;</span></span> <span class="token number"><span class="token number">20</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">^</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>h <span class="token operator"><span class="token operator">&gt;&gt;&gt;</span></span> <span class="token number"><span class="token number">12</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">return</span></span> h <span class="token operator"><span class="token operator">^</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>h <span class="token operator"><span class="token operator">&gt;&gt;&gt;</span></span> <span class="token number"><span class="token number">7</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">^</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>h <span class="token operator"><span class="token operator">&gt;&gt;&gt;</span></span> <span class="token number"><span class="token number">4</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre>
  <p>Версія з ConcurrentHashMap JDK 1.5:</p>
  <pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">private</span></span> <span class="token keyword"><span class="token keyword">static</span></span> <span class="token keyword"><span class="token keyword">int</span></span> <span class="token function"><span class="token function">hash</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token keyword"><span class="token keyword">int</span></span> h<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
    h <span class="token operator"><span class="token operator">+=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>h <span class="token operator"><span class="token operator">&lt;&lt;</span></span> <span class="token number"><span class="token number">15</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">^</span></span> <span class="token number"><span class="token number">0xffffcd7d</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    h <span class="token operator"><span class="token operator">^=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>h <span class="token operator"><span class="token operator">&gt;&gt;&gt;</span></span> <span class="token number"><span class="token number">10</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    h <span class="token operator"><span class="token operator">+=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>h <span class="token operator"><span class="token operator">&lt;&lt;</span></span> <span class="token number"><span class="token number">3</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    h <span class="token operator"><span class="token operator">^=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>h <span class="token operator"><span class="token operator">&gt;&gt;&gt;</span></span> <span class="token number"><span class="token number">6</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    h <span class="token operator"><span class="token operator">+=</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>h <span class="token operator"><span class="token operator">&lt;&lt;</span></span> <span class="token number"><span class="token number">2</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token operator"><span class="token operator">+</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>h <span class="token operator"><span class="token operator">&lt;&lt;</span></span> <span class="token number"><span class="token number">14</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">return</span></span> h <span class="token operator"><span class="token operator">^</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>h <span class="token operator"><span class="token operator">&gt;&gt;&gt;</span></span> <span class="token number"><span class="token number">16</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre>
  <p>У чому потреба ускладнення хеш-функції? Таблиці в хеш-карті мають довжину, що визначається ступенем двійки. Для хеш-кодів, двійкові уявлення яких не відрізняються в молодшій та старшій позиції, ми матимемо колізії. Ускладнення хеш-функції вирішує цю проблему, зменшуючи ймовірність колізій в карті.</p></li>
 <li>
  <p><strong>Сегменти</strong></p>
  <p>Карта ділиться на N різних сегментів (16 за замовчуванням, максимальне значення може бути 16-бітним і є ступенем двійки). Кожен сегмент є потокобезпечною таблицею елементів карти. Збільшення кількості сегментів сприятиме тому, що операції модифікації стосуватимуться різних сегментів, що зменшить ймовірність блокувань під час виконання.</p></li>
 <li>
  <p><strong>ConcurrencyLevel</strong></p>
  <p>Цей параметр впливає на використання картки пам'яті та кількість сегментів у картці.</p>
  <p>Кількість сегментів буде вибрано як найближчий ступінь двійки, більший за конкурентний рівень. Заниження конкуренціїРівень веде до того, що більш вірогідні блокування потоками сегментів картки під час запису. Завищення показника призводить до неефективного використання пам'яті. Якщо лише один потік змінюватиме карту, а решта читатиме — рекомендується використовувати значення 1.</p></li>
 <li style="list-style:none">
  <p><strong>Разом</strong></p>
  <p>Отже, основні переваги та особливості реалізації <code class=" language-none">ConcurrentHashMap</code>:</p>
  <ul>
   <li>Карта має схожий на <code class=" language-none">hashmap</code>інтерфейс взаємодії</li>
   <li>Операції читання не потребують блокувань та виконуються паралельно</li>
   <li>Операції запису часто можуть виконуватися паралельно без блокувань</li>
   <li>При створенні вказується необхідний <code class=" language-none">concurrencyLevel</code>, який визначається за статистикою читання та запису</li>
   <li>Елементи картки мають значення <code class=" language-none">value</code>, оголошене як<code class=" language-none">volatile</code></li>
  </ul><strong>Джерело: </strong> <a href="https://habr.com/post/132884/" rel="nofollow" target="_blank">Як працює ConcurrentHashMap</a></li>
</ol>
<h2>9. Що таке клас Lock?</h2>Для керування доступом до спільного ресурсу як альтернатива оператору synchronized ми можемо використовувати блокування. Функціональність блокувань укладена в пакеті <code class=" language-none">java.util.concurrent.locks</code>. Спочатку потік намагається отримати доступ до спільного ресурсу. Якщо він вільний, то потік на нього накладає блокування. Після завершення роботи блокування із загального ресурсу знімається. Якщо ж ресурс не вільний і на нього вже накладено блокування, то потік очікує, поки це блокування не буде знято. Класи блокувань реалізують інтерфейс <code class=" language-none">Lock</code>, який визначає такі методи: 
<ul>
 <li><code class=" language-none"><strong>void lock():</strong></code>очікує, доки не буде отримано блокування</li>
 <li><code class=" language-none"><strong>boolean tryLock():</strong></code>намагається отримати блокування, якщо блокування отримане, то повертає <em>true</em> . Якщо блокування не отримане, повертає <em>false</em> . На відміну від методу <code class=" language-none">lock()</code>не очікує отримання блокування, якщо воно недоступне</li>
 <li><code class=" language-none"><strong>void unlock():</strong></code>знімає блокування</li>
 <li><code class=" language-none"><strong>Condition newCondition():</strong></code>повертає об'єкт <code class=" language-none">Condition</code>, який пов'язаний з поточним блокуванням</li>
</ul>Організація блокування у випадку досить проста: щоб одержати блокування викликається метод <code class=" language-none">lock()</code>, а по закінченні роботи із загальними ресурсами викликається метод <code class=" language-none">unlock()</code>, який знімає блокування. Об'єкт <code class=" language-none">Condition</code>дозволяє керувати блокуванням. Як правило, для роботи з блокуваннями використовується клас <code class=" language-none"><strong>ReentrantLock</strong></code>із пакета <code class=" language-none">java.util.concurrent.locks.</code>Цей клас реалізує інтерфейс <code class=" language-none">Lock</code>. Розглянемо використання Java Lock API на прикладі невеликої програми: Отже, нехай у нас є клас <code class=" language-none">Resource</code>з парочкою потокобезпечних методів та методів, де потокобезпека не потрібна. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">Resource</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">doSomething</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token comment"><span class="token comment">// пусть здесь происходит работа с базой данных</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">doLogging</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token comment"><span class="token comment">// потокобезопасность для логгирования нам не требуется</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> А тепер беремо клас, який реалізує інтерфейс <code class=" language-none">Runnable</code>та використовує методи класу <code class=" language-none">Resource</code>. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">SynchronizedLockExample</span></span> <span class="token keyword"><span class="token keyword">implements</span></span> <span class="token class-name"><span class="token class-name">Runnable</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>

    <span class="token comment"><span class="token comment">// экземпляр класса Resource для работы с методами</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Resource</span></span> resource<span class="token punctuation"><span class="token punctuation">;</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">SynchronizedLockExample</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Resource</span></span> r<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>resource <span class="token operator"><span class="token operator">=</span></span> r<span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">run</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">synchronized</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span>resource<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            resource<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">doSomething</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
        resource<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">doLogging</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>
<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> А тепер перепишемо наведену вище програму з використанням Lock API замість ключового слова <code class=" language-none">synchronized</code>. 
<pre class=" line-numbers  language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class="  language-java"><span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span>locks<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">Lock</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
<span class="token keyword"><span class="token keyword">import</span></span> <span class="token namespace"><span class="token namespace">java<span class="token punctuation"><span class="token punctuation">.</span></span>util<span class="token punctuation"><span class="token punctuation">.</span></span>concurrent<span class="token punctuation"><span class="token punctuation">.</span></span>locks<span class="token punctuation"><span class="token punctuation">.</span></span></span><span class="token punctuation"></span></span><span class="token class-name"><span class="token class-name">ReentrantLock</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>

<span class="token comment"><span class="token comment">// класс для работы с Lock API. Переписан с приведенной выше программы,</span></span>
<span class="token comment"><span class="token comment">// но уже без использования ключевого слова synchronized</span></span>
<span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">class</span></span> <span class="token class-name"><span class="token class-name">ConcurrencyLockExample</span></span> <span class="token keyword"><span class="token keyword">implements</span></span> <span class="token class-name"><span class="token class-name">Runnable</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>

    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Resource</span></span> resource<span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token keyword"><span class="token keyword">private</span></span> <span class="token class-name"><span class="token class-name">Lock</span></span> lock<span class="token punctuation"><span class="token punctuation">;</span></span>

    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token class-name"><span class="token class-name">ConcurrencyLockExample</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">Resource</span></span> r<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>resource <span class="token operator"><span class="token operator">=</span></span> r<span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token keyword"><span class="token keyword">this</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>lock <span class="token operator"><span class="token operator">=</span></span> <span class="token keyword"><span class="token keyword">new</span></span> <span class="token class-name"><span class="token class-name">ReentrantLock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>

    <span class="token annotation punctuation"><span class="token annotation punctuation">@Override</span></span>
    <span class="token keyword"><span class="token keyword">public</span></span> <span class="token keyword"><span class="token keyword">void</span></span> <span class="token function"><span class="token function">run</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
        <span class="token keyword"><span class="token keyword">try</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token comment"><span class="token comment">// лочим на 10 секунд</span></span>
            <span class="token keyword"><span class="token keyword">if</span></span><span class="token punctuation"><span class="token punctuation">(</span></span>lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">tryLock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token number"><span class="token number">10</span></span><span class="token punctuation"><span class="token punctuation">,</span></span> <span class="token class-name"><span class="token class-name">TimeUnit</span></span><span class="token punctuation"><span class="token punctuation">.</span></span>SECONDS<span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
            resource<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">doSomething</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
            <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span> <span class="token keyword"><span class="token keyword">catch</span></span> <span class="token punctuation"><span class="token punctuation">(</span></span><span class="token class-name"><span class="token class-name">InterruptedException</span></span> e<span class="token punctuation"><span class="token punctuation">)</span></span> <span class="token punctuation"><span class="token punctuation">{</span></span>
            e<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">printStackTrace</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span><span class="token keyword"><span class="token keyword">finally</span></span><span class="token punctuation"><span class="token punctuation">{</span></span>
            <span class="token comment"><span class="token comment">//убираем лок</span></span>
            lock<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">unlock</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
        <span class="token punctuation"><span class="token punctuation">}</span></span>
        <span class="token comment"><span class="token comment">// Для логгирования не требуется потокобезопасность</span></span>
        resource<span class="token punctuation"><span class="token punctuation">.</span></span><span class="token function"><span class="token function">doLogging</span></span><span class="token punctuation"><span class="token punctuation">(</span></span><span class="token punctuation"><span class="token punctuation">)</span></span><span class="token punctuation"><span class="token punctuation">;</span></span>
    <span class="token punctuation"><span class="token punctuation">}</span></span>

<span class="token punctuation"><span class="token punctuation">}</span></span></code></pre> Як видно з програми, ми використовуємо метод <code class=" language-none">tryLock()</code>, щоб переконатися, що потік чекає лише певний час. Якщо він не отримує блокування на об'єкт, то просто логує та виходить. Ще один важливий момент. Необхідно використовувати блок <code class=" language-none">try-finally</code>, щоб переконатися, що блокування буде знято, навіть якщо метод <code class=" language-none">doSomething()</code>кине виняток. <strong>Джерела:</strong>
<ul>
 <li><a href="https://metanit.com/java/tutorial/8.9.php" rel="nofollow" target="_blank">Блокування. ReentrantLock</a></li>
</ul>
<h2>11. Що таке mutex?</h2><strong>Мютекс</strong> – це особливий об'єкт для синхронізації ниток/процесів. Він може приймати два стани – зайнятий та вільний. Якщо спростити, то мютекс - це boolean-змінна, яка приймає два значення: зайнятий (true) і вільний (false). Коли нитка хоче монопольно володіти деяким об'єктом, вона позначає його зайнятим, а коли закінчила роботу з ним - позначає його вільним. Мютекс прикріплений до кожного об'єкта Java. Прямий доступ до мютекс є тільки у Java-машини. Від програміста він прихований. 
<h2>12. Що таке монітор?</h2><strong>Монітор</strong> – це спеціальний механізм (шматок коду) – надбудова над мютексом, який забезпечує правильну роботу з ним. Адже мало помітити, що об'єкт – зайнятий, треба забезпечити, щоб інші нитки не пробували скористатися зайнятим об'єктом. У Java монітор реалізований за допомогою ключового слова <code class=" language-none">synchronized</code>. Коли ми пишемо блок synchronized, то компілятор Java замінює його трьома шматками коду: 
<ol>
 <li>На початку блоку <code class=" language-none">synchronized</code>додається код, який зазначає мютекс як зайнятий.</li>
 <li>Наприкінці блоку <code class=" language-none">synchronized</code>додається код, який зазначає мютекс як вільний.</li>
 <li>Перед блоком <code class=" language-none">synchronized</code>додається код, який дивиться, якщо мютекс зайнятий – то нитка має чекати на його звільнення.</li>
</ol><a href="https://codegym.cc/groups/posts/1580-urovenjh-26-otvetih-na-voprosih-k-sobesedovaniju-po-teme-urovnja-chastjh-1-voprosih-1-5-10" target="_blank">Частина 1</a>