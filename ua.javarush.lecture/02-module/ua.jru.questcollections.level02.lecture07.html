<p><span class="text-user">- Привіт, Аміго.</span></p>
<p class="amigo">- Здорово, Ріша.</p>
<p>— Сьогодні я розповім тобі нову та дуже цікаву тему —&nbsp; <b>динамічні проксі</b> .</p>
<p>У Java є кілька способів змінити функціональність потрібного класу.</p>
<p><b>Спосіб перший. успадкування</b></p>
<p>Найпростіший спосіб змінити поведінку деякого класу - це створити новий клас, успадкувати його від оригінального (базового) та перевизначити його методи. Потім замість об'єктів оригінального класу використовувати об'єкти класу спадкоємця. Приклад:</p>
<pre class="line-numbers  language-java" data-line="" data-start="" tabindex="0" style="counter-reset: linenumber 0 NaN 0;"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token class-name">Reader</span> <span class="text-red">reader</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="text-viola">UserCustomReader</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>Спосіб другий. Використання класу обгортки (Wrapper).</strong></p>
<p>Прикладом такого класу є <span class="text-corporate"><strong>BufferedReader</strong></span> . По-перше, він успадкований від <strong>Reader</strong> , тобто може бути використаний замість нього. По-друге, він переадресаує всі виклики до оригінального об'єкта <span class="text-red"><strong>Reader</strong> , який обов'язково потрібно передати у конструкторі об'єкту BufferedReader. </span>Приклад:</p>
<pre class="line-numbers  language-java" data-line="" data-start="" tabindex="0" style="counter-reset: linenumber 0 NaN 0;"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token class-name">Reader</span> <span class="text-green">readerOriginal</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="text-viola">UserCustomReader</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Reader</span> <span class="text-red">reader</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="text-corporate">BufferedReader</span></span><span class="token punctuation">(</span><span class="text-green">readerOriginal</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>Спосіб третій. Створення динамічного проксі (Proxy).</strong></p>
<div class="row">
 <div class="col">
  <img data-id="1718e788-2199-432a-acdd-db9a0dcab8a5" data-max-width="1427" alt="Dynamic Proxy - 1" src="https://cdn.javarush.com/images/article/1718e788-2199-432a-acdd-db9a0dcab8a5/1080.jpeg" style="width: 1427px;">
 </div>
</div>
<p>Java має спеціальний клас (java.lang.reflect.Proxy), за допомогою якого фактично <span class="text-red"><strong>можна сконструювати об'єкт під час виконання програми (динамічно), не створюючи для нього окремого класу.</strong></span></p>
<p>Це робиться дуже просто:</p>
<pre class="line-numbers  language-java" data-line="" data-start="" tabindex="0" style="counter-reset: linenumber 0 NaN 0;"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token class-name">Reader</span> <span class="text-red">reader</span> <span class="token operator">=</span> <span class="token punctuation"></span><strong><span class="token punctuation">(</span><span class="token class-name">Reader</span><span class="token punctuation">)</span></strong><span class="token punctuation"></span><span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><span class="text-user">— А це вже щось новеньке!</span></p>
<p>— Але ж нам не потрібен просто об'єкт без методів. Треба щоб цей об'єкт мав методи, і вони робабо те, що нам потрібно. Для цього Java використовується спеціальний інтерфейс <strong>InvocationHandler</strong> , за допомогою якого <strong><span class="text-red">можна перехоплювати всі виклики методів</span></strong> , звернені до proxy-об'єкту. Proxy-об'єкт можна створити лише за допомогою інтерфейсів.</p>
<p><span class="text-user"><strong>Invoke</strong></span> – стандартна назва для методу/класу, основне завдання якого просто викликати метод.</p>
<p><span class="text-red"><strong>Handler</strong></span> – стандартна назва для класу, що обробляє якусь подію. Наприклад, обробник кліка миші буде називатися MouseClickHandler, і т.д.</p>
<p>Інтерфейс InvocationHandler має єдиний <strong><span class="text-red">метод invoke, в який направляються всі виклики, звернені до proxy-об'єкта</span></strong> . Приклад:</p>
<div class="code-heading">
 Код
</div>
<pre class="line-numbers  language-java" data-line="" data-start="" tabindex="0" style="counter-reset: linenumber 0 NaN 0;"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token class-name"><span class="text-red">Reader</span></span> <strong><span class="text-red">reader</span></strong> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name"><span class="text-red">Reader</span></span><span class="token punctuation">)</span><span class="token class-name"></span><strong><span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span></strong><span class="token function"></span><span class="token punctuation">(</span><span class="token keyword"></span><span class="text-user"><span class="token keyword">new</span> <span class="token class-name">CustomInvocationHandler</span></span><span class="token class-name"></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<strong><span class="text-red">reader</span></strong><span class="token punctuation">.</span><span class="token function"><span class="text-corporate">close</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class="line-numbers  language-java" data-line="" data-start="" tabindex="0" style="counter-reset: linenumber 0 NaN 0;"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword"><strong>class</strong></span> <span class="token class-name">CustomInvocationHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span>
<span class="token punctuation">{</span>
 <span class="token keyword"><strong>public</strong></span> <span class="token class-name">Object</span> <span class="token function"><span class="text-user">invoke</span></span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span>
 <span class="token punctuation">{</span>
  <span class="token class-name"></span><strong><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span></strong><span class="token function"></span><span class="token punctuation">(</span><span class="token string">"<span class="text-green">yes!</span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword"><strong>return</strong></span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Під час виклику методу <span class="text-red">reader</span> . <span class="text-corporate">close</span> (), викличеться метод <strong><span class="text-user">invoke</span></strong> , і екран буде виведено напис “yes!”</p>
<p><span class="text-user">- Тобто. ми оголосабо клас <strong>CustomInvocationHandler,</strong> в ньому реалізували інтерфейс <strong>InvocationHandler</strong> та його метод <strong>invoke</strong> . Метод invoke при викликі виводить на екран рядок "yes!"- Потім ми створабо об'єкт типу <strong>CustomInvocationHandler</strong> і передали його в метод <strong>newProxyInstance</strong> при створенні об'єкта-proxy.</span></p>
<p>- Так все вірно.</p>
<p>Це дуже потужний інструмент, зазвичай створення таких проксі використовується для імітації <span class="text-corporate">об'єктів програм, які фізично запущені на іншому комп'ютері. </span>Або для контролю доступу</p>
<p>– у такому методі можна перевіряти права поточного користувача, обробляти помилки, логувати помилки та багато іншого.</p>
<p>Ось приклад, де метод invoke ще й викликає методи оригінального об'єкта:</p>
<div class="code-heading">
 Код
</div>
<pre class="line-numbers  language-java" data-line="" data-start="" tabindex="0" style="counter-reset: linenumber 0 NaN 0;"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name"><span class="text-green">Reader</span></span> <span class="text-green">original</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"></span><span class="text-red"><span class="token class-name"><span class="text-viola">UserCustomReader</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Reader</span></span><span class="token class-name"></span> <strong><span class="text-red">reader</span></strong> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name"><span class="text-red">Reader</span></span><span class="token punctuation">)</span><span class="token class-name"></span><strong><span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span></strong><span class="token function"></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="text-user">CustomInvocationHandler</span></span><span class="token punctuation">(</span><span class="text-green">original</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="text-red">reader</span><span class="token punctuation">.</span><span class="token function"><span class="text-corporate">close</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class="line-numbers  language-java" data-line="" data-start="" tabindex="0" style="counter-reset: linenumber 0 NaN 0;"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword"><strong>class</strong></span> <span class="token class-name"><span class="text-user">CustomInvocationHandler</span></span> <span class="token keyword"><strong>implements</strong></span> <span class="token class-name"></span><span class="text-user"><span class="token class-name">InvocationHandler</span>
<span class="token punctuation">{</span>
</span> <span class="token keyword"><strong>private</strong></span> <span class="token class-name">Reader</span> <span class="text-green">readerOriginal<span class="token punctuation">;</span>

</span> <span class="token class-name"><span class="text-user">CustomInvocationHandler</span></span><span class="token punctuation">(</span><span class="token class-name">Reader</span> <span class="text-green">readerOriginal</span><span class="token punctuation">)</span>
 <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="text-green">readerOriginal</span> <span class="token operator">=</span> <span class="text-green">readerOriginal<span class="token punctuation">;</span>
</span> <span class="token punctuation">}</span>

 <span class="token keyword"><span class="text-user">public</span></span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name"><span class="text-user"><strong>Method</strong></span></span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span>
 <span class="token punctuation">{</span>
  <span class="token keyword"><strong>if</strong></span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function"><strong>getName</strong></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"<span class="text-green">close</span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token class-name"></span><strong><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span></strong><span class="token function"></span><span class="token punctuation">(</span><span class="token string">"<span class="text-green">Reader closed!</span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// это вызов метода close у об'єкта readerOriginal</span>
  <span class="token comment">// ім'я метода и описание его параметров хранится в переменной method</span>
  <span class="token keyword">return</span> <span class="text-user">method</span><span class="token punctuation">.</span><span class="token function"><strong>invoke</strong></span><span class="token punctuation">(</span><span class="text-green">readerOriginal</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>У цьому прикладі є дві особливості.</p>
<p>По-перше, конструктор передається «оригінальний» об'єкт <span class="text-green"><strong>Reader</strong></span> , посилання на який зберігається всередині <span class="text-user">CustomInvocationHandler</span> .</p>
<p>По-друге, у методі invoke ми знову викликаємо той самий метод, але вже у «оригінального» об'єкта.</p>
<p><span class="text-user">- Ага. Тобто. ось цей останній рядок і є виклик того ж методу, але вже в оригінального об'єкта:</span></p>
<pre class="line-numbers  language-java" data-line="" data-start="" tabindex="0" style="counter-reset: linenumber 0 NaN 0;"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java"><span class="token keyword">return</span> <span class="text-user">method</span><span class="token punctuation">.</span><span class="token function"><strong>invoke</strong></span><span class="token punctuation">(</span><span class="text-green">readerOriginal</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>- Ага.</p>
<p><span class="text-user">— Не сказав би, що надто очевидно, але все ж таки зрозуміло. Начебто.</span></p>
<p>- Чудово. Тоді ще ось що. У метод newProxyInstance потрібно передавати ще трохи службової інформації для створення proxy-об'єкта. Проте, т.к. ми не створюємо монструозних проксі-об'єктів, то цю інформацію легко отримати з самого оригінального класу.</p>
<p>Ось тобі приклад:</p>
<div class="code-heading">
 Код
</div>
<pre class="line-numbers  language-java" data-line="" data-start="" tabindex="0" style="counter-reset: linenumber 0 NaN 0;"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name"></span><span class="text-green"><span class="token class-name"><strong>Reader</strong></span> original</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserCustomReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ClassLoader</span> <span class="text-corporate">classLoader</span> <span class="token operator">=</span> <span class="text-green">original</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function"><span class="text-corporate">getClassLoader</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="text-viola">interfaces</span> <span class="token operator">=</span> <span class="text-green">original</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function"><span class="text-viola">getInterfaces</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">CustomInvocationHandler</span> <span class="text-user">invocationHandler</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomInvocationHandler</span><span class="token punctuation">(</span><span class="text-green">original</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"></span><span class="text-red"><span class="token class-name">Reader</span> <strong>reader</strong></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name"><span class="text-red">Reader</span></span><span class="token punctuation">)</span><span class="token class-name"></span><strong><span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span></strong><span class="token function"></span><span class="token punctuation">(</span><span class="text-corporate">classLoader</span><span class="token punctuation">,</span> <span class="text-viola">interfaces<span class="token punctuation">,</span></span><span class="token punctuation"></span> <span class="text-green">invocationHandler<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation"></span></code></pre>
<pre class="line-numbers  language-java" data-line="" data-start="" tabindex="0" style="counter-reset: linenumber 0 NaN 0;"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword"><strong>class</strong></span> <span class="token class-name"><span class="text-user">CustomInvocationHandler</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="text-user">InvocationHandler</span></span>
<span class="token punctuation">{</span>
 <span class="token keyword"><strong>public</strong></span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span>
 <span class="token punctuation">{</span>
  <span class="token keyword"><strong>return</strong></span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><span class="text-user">- Ага. ClassLoader та список інтерфейсів. Це щось з Reflection, так?</span></p>
<p>- Ага.</p>
<p><span class="text-user">- Ясно. Що ж, гадаю, я зможу створити примітивний простенький проксі об'єкт, якщо це колись мені знадобиться.</span></p>
<p>— А ти спитай у Дієго</p>