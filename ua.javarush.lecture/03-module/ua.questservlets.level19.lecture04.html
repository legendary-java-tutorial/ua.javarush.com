<h2>Semaphore</h2><img data-max-width="1024" data-id="5b56b330-d15d-450e-9d26-15f951f2a98a" alt="" src="https://cdn.javarush.com/images/article/5b56b330-d15d-450e-9d26-15f951f2a98a/1024.jpeg" style="width: 1024px;">
<p>Семафори зазвичай використовуються, коли треба обмежити кількість потоків при роботі з файловою системою. Доступ до файлу або іншого спільного ресурсу керується через лічильник. Якщо його значення більше нуля, доступ дозволено, але в той же час покази лічильника будуть зменшуватися.</p>
<p>Коли лічильник поверне нуль, поточний потік буде заблокований до моменту звільнення ресурсу іншим потоком. Параметр кількості дозволів слід задавати через конструктор.</p>
<p>Підбирати цей параметр потрібно індивідуально, залежно від потужності комп'ютера або ноутбука.</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Semaphore</span> sem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">CommonResource</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommonResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> sem<span class="token punctuation">,</span> <span class="token string">"MyThread_1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> sem<span class="token punctuation">,</span> <span class="token string">"MyThread_2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> sem<span class="token punctuation">,</span> <span class="token string">"MyThread_3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">CommonResource</span> <span class="token punctuation">{</span>
   <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
   <span class="token class-name">CommonResource</span> commonResource<span class="token punctuation">;</span>
   <span class="token class-name">Semaphore</span> semaphore<span class="token punctuation">;</span>
   <span class="token class-name">String</span> name<span class="token punctuation">;</span>
   <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token class-name">CommonResource</span> commonResource<span class="token punctuation">,</span> <span class="token class-name">Semaphore</span> sem<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>commonResource <span class="token operator">=</span> commonResource<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>semaphore <span class="token operator">=</span> sem<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

       <span class="token keyword">try</span> <span class="token punctuation">{</span>
           <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">"Чекає дозвіл"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           commonResource<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
           <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> commonResource<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
               commonResource<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">"звільняє дозвіл"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2>CountDownLatch та інші</h2>
<p><span class="code"><span class="text-green">CountDownLatch</span></span> — дозволяє кільком потокам очікувати, доки не завершиться певна кількість операцій, що виконуються в інших потоках. Як приклад можна представити установку програми: вона почнеться, доки ти не приймеш правила користування, доки вибереш папку, куди встановлювати нову програму тощо. І тому є спеціальний метод<span class="code text-orange"> countDown()</span> — цей метод зменшує лічильник count down на одиницю.</p>
<p>Як тільки лічильник стає рівним нулю, всі потоки, що очікують, в await продовжать свою роботу, а всі наступні виклики await будуть проходити без очікувань. Лічильник count down одноразовий і не може бути скинутий у початковий стан.</p>
<p><span class="code"><span class="text-green">CyclicBarrier</span></span> – використовується для синхронізації заданої кількості потоків в одній точці. Бар'єр досягається у той час, коли N-потоків викличуть метод await(...) і блокуються. Після чого лічильник скидається у вихідне значення, а потоки, що очікують, будуть звільнені. Додатково, якщо потрібно, існує можливість запуску спеціального коду до розблокування потоків та скидання лічильника. Для цього через конструктор передається об'єкт з реалізацією інтерфейсу<span class="text-neon"><span class="text-bold"><em> Runnable</em></span></span> .</p>
<p><span class="code"><span class="text-green">Exchanger&lt;V&gt;</span></span> — клас<span class="code"><span class="text-green"> Exchanger</span></span> призначений обмінюватись даними між потоками. Він є типізованим і типізує тип даних, якими потоки мають обмінюватись.</p>
<p>Обмін даними здійснюється за допомогою єдиного методу цього класу <span class="code text-orange">exchange()</span> :</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token class-name">V</span> <span class="token function">exchange</span><span class="token punctuation">(</span><span class="token class-name">V</span> x<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span>
<span class="token class-name">V</span> <span class="token function">exchange</span><span class="token punctuation">(</span><span class="token class-name">V</span> x<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span></code></pre>
<p>Параметр x представляє буфер даних обміну. Друга форма методу також визначає параметр <span class="text-green">timeout</span> – час очікування та <span class="text-green">unit</span> – тип тимчасових одиниць, що застосовуються для параметра <span class="text-green">timeout</span> .</p>
<p>Клас <span class="code"><span class="text-green">Phaser</span></span> дозволяє синхронізувати потоки, що становлять окрему фазу або стадію виконання загальної дії. <span class="code"><span class="text-green">Phaser</span></span> визначає об'єкт синхронізації, який чекає, доки не завершиться певна фаза. Потім <span class="code"><span class="text-green">Phaser</span></span> переходить до наступної стадії або фази і знову чекає на її завершення.</p>
<p>При роботі з класом <span class="code"><span class="text-green">Phaser</span></span> зазвичай спочатку створюється його об'єкт. Далі нам треба зареєструвати всіх учасників. Для реєстрації для кожного учасника викликається метод <span class="code text-orange">register()</span> , або можна обійтися і без цього методу, передавши необхідну кількість учасників конструктор <span class="code"><span class="text-green">Phaser</span></span> .</p>
<p>Потім кожен учасник виконує певний набір дій, що становлять фазу. А синхронізатор <span class="code"><span class="text-green">Phaser</span></span> чекає, доки всі учасники не завершать виконання фази. Щоб повідомити синхронізатору, що фаза завершена, учасник повинен викликати метод <span class="code text-orange">arrive()</span> або <span class="code text-orange">arriveAndAwaitAdvance()</span> . Після цього синхронізатор переходить до наступної фази.</p>