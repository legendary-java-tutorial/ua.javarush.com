<h2>Non-Blocking Queues</h2><img data-max-width="512" data-id="128e424c-63bb-47db-9d23-7ce3ae97fa4a" alt="" src="https://cdn.javarush.com/images/article/128e424c-63bb-47db-9d23-7ce3ae97fa4a/512.jpeg" style="width: 512px;">
<p>Потокобезпечні та найважливіше неблокуючі імплементації <span class="text-neon"><span class="text-bold"><em>Queue</em></span></span> на зв'язаних нодах (linked nodes).</p>
<p><span class="code"><span class="text-green">ConcurrentLinkedQueue&lt;E&gt;</span></span> — тут використовується wait-free алгоритм, адаптований до роботи з garbage collector'ом. Цей алгоритм є досить ефективним і дуже швидким, оскільки побудований на CAS. Метод<span class="code text-orange"> size()</span> може працювати довго, тому краще постійно його не смикати.</p>
<p><span class="code"><span class="text-green">ConcurrentLinkedDeque&lt;E&gt;</span></span> — Deque розшифровується як Double ended queue. Це означає, що дані можна додавати та витягувати з обох сторін. Відповідно, клас підтримує обидва режими роботи: FIFO (First In First Out) та LIFO (Last In First Out).</p>
<p>На практиці <span class="code"><span class="text-green">ConcurrentLinkedDeque</span></span> варто використовувати в тому випадку, якщо обов'язково потрібно саме LIFO, тому що за рахунок двоспрямованості нід цей клас програє за продуктивністю наполовину порівняно з <span class="code"><span class="text-green">ConcurrentLinkedQueue</span></span> .</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentLinkedQueue</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span>  <span class="token class-name">ConcurrentLinkedQueueExample</span> <span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">Thread</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Thread</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

   <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>
   <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Клас для додавання елементів до черги"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
           <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Елемент #"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Додали: Елемент #"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

   <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>
   <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> str<span class="token punctuation">;</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Клас для отримання елементів із черги"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>str <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Витягнули:"</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">try</span> <span class="token punctuation">{</span>
               <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2>Blocking Queues</h2><img data-max-width="1080" data-id="de605ce4-5661-4edc-b4d9-8c4fc358ce35" alt="" src="https://cdn.javarush.com/images/article/de605ce4-5661-4edc-b4d9-8c4fc358ce35/1080.jpeg" style="width: 1080px;">
<p>Інтерфейс <span class="text-neon"><span class="text-bold"><em>BlockingQueue&lt;E&gt;</em></span></span> - при великій кількості даних <span class="code"><span class="text-green">ConcurrentLinkedQueue</span></span> не вистачає.</p>
<p>Коли потоки не справляються з поставленим завданням, ти легко можеш отримати <span class="text-red"><span class="text-bold">OutOfMemmoryException</span></span> . І щоб такі випадки не виникали, у нас для роботи є <span class="text-neon"><span class="text-bold"><em>BlockingQueue</em></span></span> з наявністю різних методів для заповнення та роботи з чергою та блокуванням за умовами.</p>
<p><span class="text-neon"><span class="text-bold"><em>BlockingQueue</em></span></span> не визнає нульових елементів (null) і викликає<span class="text-red"><span class="text-bold"> NullPointerException</span></span> при спробі додати або отримати такий елемент. Нульовий елемент повертає метод poll, якщо протягом таймууту не було розміщено в черзі черговий елемент.</p>
<h2>Реалізації BlockingQueue&lt;E&gt;</h2>
<p>Давай розберемо докладно кожну з реалізацій нашої <span class="text-neon"><span class="text-bold"><em>BlockingQueue</em></span></span> :</p>
<p><span class="code"><span class="text-green">ArrayBlockingQueue&lt;E&gt;</span></span> - клас блокуючої черги, побудований на класичному кільцевому буфері. Тут нам доступна можливість керувати "чесністю" блокувань. Якщо fair=false (за умовчанням), черговість роботи потоків не гарантується.</p>
<p><span class="code"><span class="text-green">DelayQueue&lt;E extends Delayed&gt;</span></span> - клас, який дозволяє витягувати елементи з черги тільки після деякої затримки, визначеної в кожному елементі через метод<span class="code text-orange"> getDelay</span> інтерфейсу<span class="text-neon"><span class="text-bold"><em> Delayed</em></span></span> .</p>
<p><span class="code"><span class="text-green">LinkedBlockingQueue&lt;E&gt;</span></span> - блокуюча черга на зв'язаних нодах, реалізована на "two lock queue" алгоритмі: перший лок - на додавання, другий - на витягування елемента з черги. За рахунок локів, у порівнянні з<span class="code"><span class="text-green"> ArrayBlockingQueue</span></span> , даний клас має високу продуктивність, але для нього потрібна більша кількість пам'яті. Розмір черги визначається через конструктор і за умовчанням дорівнює Integer.MAX_VALUE.</p>
<p><span class="code"><span class="text-green">PriorityBlockingQueue&lt;E&gt;</span></span> - багатопотокова обгортка над<span class="code"><span class="text-green"> PriorityQueue</span></span> . <span class="text-neon"><span class="text-bold"><em>Comparator</em></span></span> відповідає за те, за якою логікою буде додано елемент. Першим із черги виходить найменший елемент.</p>
<p><span class="code"><span class="text-green">SynchronousQueue&lt;E&gt;</span></span> - черга працює за принципом FIFO(first-in-first-out). Кожна операція вставки блокує потік "Producer", поки потік "Consumer" не витягне елемент з черги і навпаки, "Consumer" буде чекати поки "Producer" не вставить елемент.</p>
<p><span class="text-neon"><span class="text-bold"><em>BlockingDeque&lt;E&gt;</em></span></span> - інтерфейс, який описує додаткові методи для двонаправленої блокуючої черги. Дані можна вставляти та витягувати з обох боків черги.</p>
<p><span class="code"><span class="text-green">LinkedBlockingDeque&lt;E&gt;</span></span> - двонаправлена ​​блокуюча черга на зв'язаних нодах, реалізована як простий двонаправлений список з одним локом. Розмір черги визначається через конструктор і за умовчанням дорівнює Integer.MAX_VALUE.</p>
<p><span class="text-neon"><span class="text-bold"><em>TransferQueue&lt;E&gt;</em></span></span> — інтерфейс цікавий тим, що при додаванні елемента в чергу існує можливість заблокувати вставляючий потік<span class="text-green"><span class="text-bold"> Producer</span></span> доти, доки інший потік<span class="text-green"><span class="text-bold"> Consumer</span></span> не витягне елемент з черги. Також можна додати перевірку на певний тайм-аут або виставити перевірку на наявність тих, що очікують<span class="text-green"><span class="text-bold"> Consumer</span></span> . Як результат, ми отримуємо механізм передачі даних із підтримкою асинхронних та синхронних повідомлень.</p>
<p><span class="code"><span class="text-green">LinkedTransferQueue&lt;E&gt;</span></span> — реалізація<span class="text-neon"><span class="text-bold"><em> TransferQueue</em></span></span> на основі алгоритму Dual Queues with Slack. Активно використовує CAS (дивіться вище) та паркування потоків, коли вони знаходяться в режимі очікування.</p>