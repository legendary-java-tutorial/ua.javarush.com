<h2>5.1 Знайомство в NAT</h2>
<p>Ще одна цікава тема – це NAT. NAT розшифровується як <strong>Network Address Translation</strong> і зазвичай є у кожному роутері як сервіс. Так що ж це таке і навіщо воно потрібне?</p>
<p><strong>NAT</strong> – це точка, за допомогою якої локальні мережі можна підключати до глобальних мереж, таких як Інтернет, наприклад.</p>
<p>Як ти вже знаєш, у локальних мережах у всіх комп'ютерів (та інших пристроїв, підключених до мережі) є власні локальні IP-адресаи. А щоб обмінюватися даними з сервером в інтернеті, треба, щоб наш комп'ютер міг надіслати запит до сервера і сервер міг надіслати нам відповідь. А куди йому надсилати відповідь, якщо наша IP-адресаа невідома за межами нашої локальної мережі?</p>
<p>Уяви, що ти пишеш паперовий лист Дональду Трампу. Трамп – це публічна постать, він такий один – це наш публічний сервер. А як зворотна адресаа в листі ви вказуєте Машу. Маш багато. Якій саме Маші потрібно надіслати відповідь?</p>
<p>Тому ти відправляєш листа своєму знайомому з Вашингтона, теж публічній фігурі, із суворою вказівкою вислати його Трампу. Твій знайомий отримує листа, надсилає його Трампу, а як зворотна адресаа вказує свою адресау у Вашингтоні.</p>
<p>Потім, отримавши відповідь від Трампа, знайомий пересилає її тобі. Так само і з IP-пакетами.</p>
<p>Щоб дозволити пристрою з приватною IPv4-адресаою звертатися до пристроїв і ресурсів за межами локальної мережі, приватна адресаа спочатку повинна бути змінена на загальнодоступну публічну адресау.</p>
<p>Саме NAT переводить приватні адресаи в загальнодоступні. Це дозволяє пристрою з локальною IP-адресаою звертатися до ресурсів за межами приватної мережі. NAT у поєднанні з локальними IP-адресаами виявився корисним методом збереження загальнодоступних IPv4-адреса.</p>
<p>У світі живе 8 мільярдів людей, а мережевих пристроїв вже в рази більше: телефони, ноутбуки, смарт-годинники, сервери, будь-які розумні пристрої. А IP-адреса всього 4 мільярди. Раніше здавалося, що це багато, але зі швидким зростанням інтернету всім стало зрозуміло, що цього замало.</p>
<p>Тут нам на допомогу приходить NAT: одна публічна IPv4-адресаа може бути використана сотнями, навіть тисячами пристроїв, кожен з яких має локальну IPv4-адресау. NAT має додаткову перевагу, яка полягає в додаванні ступеня конфіденційності та безпеки в мережу, оскільки він приховує внутрішні IPv4-адресаи із зовнішніх мереж.</p>
<h2>5.2 Підмережі в NAT</h2>
<p>Локальні мережі зазвичай проектуються за допомогою приватних IP-адреса. Це адресаи приватних підмереж <code>10.0.0.0/8</code>, <code>172.16.0.0/12</code>і <code>192.168.0.0/16</code>. Ці IP-адресаи використовуються всередині організації або майданчики, щоб дозволити пристроям спілкуватися локально, вони не маршрутизуються в Інтернеті.</p>
<p>Роутери з підтримкою NAT можуть бути налаштовані з однією або декількома дійсними загальнодоступними IPv4-адресаами. Ці загальнодоступні адресаи називають пулом NAT.</p>
<p>Коли пристрій із внутрішньої мережі відправляє трафік із мережі назовні, то роутер з підтримкою NAT переводить внутрішню IP-адресау пристрою на публічну IP-адресау з пулу NAT. Для зовнішніх пристроїв весь трафік, що входить і виходить з мережі, має загальнодоступну IP-адресау.</p>
<p>Маршрутизатор NAT зазвичай працює на межі Stub-мережі. Stub-мережа – це термін з теорії мереж: тупикова мережа, яка має одне з'єднання із сусідньою мережею, один вхід та вихід із мережі.</p><img data-max-width="1024" data-id="1b701199-4628-43ca-bef0-8cc2bc1474b8" alt="" src="https://cdn.javarush.com/images/article/1b701199-4628-43ca-bef0-8cc2bc1474b8/1024.jpeg" style="width: 1024px;">
<p>Коли пристрій всередині Stub-мережі хоче зв'язуватися з пристроєм за межами своєї мережі, пакет пересилається роутеру і він виконує NAT-процес, переводячи внутрішню приватну адресау пристрою на публічну, зовнішню адресау, що маршрутизується.</p>
<h2>5.3 Термінологія NAT</h2>
<p>Якщо заглибитися в теорію мереж, то NAT — це внутрішня мережа, яка є набором підмереж, що підлягають перекладу. Зовнішня мережа відноситься до всіх інших мереж.</p>
<p>При використанні NAT, IP адресаи мають різні позначення, засновані на тому, чи вони знаходяться в приватній мережі або в загальнодоступній мережі (в інтернеті) і є трафік вхідним або вихідним.</p>
<p>NAT включає чотири типи адреса:</p>
<ul>
 <li><strong>Внутрішня локальна адресаа</strong> (Inside local address);</li>
 <li><strong>Внутрішня глобальна адресаа (Inside Global Address</strong> );</li>
 <li><strong>Зовнішня місцева адресаа</strong> (Outside local address);</li>
 <li><strong>Зовнішня глобальна адресаа</strong> (Outside global address);</li>
</ul>
<p>При визначенні того, який тип адресаи використовується, важливо пам'ятати, що термінологія NAT завжди застосовується з точки зору пристрою з адресаою трансльованої:</p>
<ul>
 <li><strong>Внутрішня адресаа</strong> (Inside address) – адресаа пристрою, що транслюється NAT;</li>
 <li><strong>Зовнішня адресаа</strong> (Outside address) – адресаа пристрою призначення;</li>
 <li><strong>Локальна адресаа</strong> (Local address) – це будь-яка адресаа, яка відображається у внутрішній частині мережі;</li>
 <li><strong>Глобальна адресаа</strong> (Global address) – це будь-яка адресаа, яка відображається у зовнішній частині мережі.</li>
</ul>
<p>Розглянемо це з прикладу схеми.</p><img data-max-width="1024" data-id="dfbcd791-f023-4b1e-9ece-1637d4a5b715" alt="" src="https://cdn.javarush.com/images/article/dfbcd791-f023-4b1e-9ece-1637d4a5b715/1024.jpeg" style="width: 1024px;">
<p>Комп'ютер на малюнку зліва має внутрішній локальний ( <strong>Inside local</strong> ) адресау <code>192.168.1.5</code>і з його точки зору веб-сервер має зовнішню ( <strong>outside</strong> ) адресау <code>208.141.17.4</code>. Коли з комп'ютера відправляються пакети даних на глобальну адресау веб-сервера, внутрішній локальний ( <strong>Inside local</strong> ) адресаа ПК транслюється в <code>208.141.16.5</code>( <strong>inside global</strong> ). Адреса зовнішнього пристрою зазвичай не перекладається, оскільки вона є загальнодоступною адресаою IPv4.</p>
<p>Варто зауважити, що комп'ютер має дві адресаи: локальний і глобальний адресаи, тоді як веб-сервер має однакову публічну IP-адресау. На його думку трафік, що виходить з комп'ютера, надходить з внутрішньої глобальної адресаи <code>208.141.16.5</code>. Роутер з NAT є точкою поділу між внутрішньою та зовнішньою мережами, та між локальними та глобальними адресаами.</p>
<p>Терміни <strong>inside</strong> і <strong>outside</strong> об'єднані з термінами <strong>local</strong> і <strong>global</strong> , щоб посилатися на конкретні адресаи. На малюнку роутер налаштований на надання NAT і має пул загальнодоступних адреса для призначення внутрішнім хостам.</p>
<h2>5.4 Шлях проходження пакету</h2>
<p>Якщо ти вже втомився, то переходь до наступної лекції. Якщо тобі все ще цікаво, то ласкаво просимо далі в кротову нору.</p>
<p>На малюнку нижче показано, як трафік відправляється з внутрішнього комп'ютера на зовнішній веб-сервер через маршрутизатор з підтримкою NAT, надсилається і перетворюється на зворотний бік.</p><img data-max-width="1024" data-id="64fead98-c4dd-4309-ae80-88fb61cee243" alt="Підмережі в NAT 3" src="https://cdn.javarush.com/images/article/64fead98-c4dd-4309-ae80-88fb61cee243/1024.jpeg" style="width: 1024px;">
<div class="table-container">
 <table>
  <tbody align="center">
   <tr>
    <th colspan="4">NAT-таблиця маршрутизатора</th>
   </tr>
   <tr>
    <td colspan="2">ПК</td>
    <td colspan="2">Веб-сервер</td>
   </tr>
   <tr>
    <td>Insde Global</td>
    <td>Inside Local</td>
    <td>Outside Local</td>
    <td>Outside Global</td>
   </tr>
   <tr>
    <td>208.141.17.4</td>
    <td>192.168.1.5</td>
    <td>208.141.16.5</td>
    <td>208.141.16.5</td>
   </tr>
  </tbody>
 </table>
</div>
<p>Внутрішня локальна адресаа ( <strong>Inside local address</strong> ) – адресаа джерела, видима з внутрішньої мережі. На малюнку адресау <code>192.168.1.5</code>присвоєно комп'ютеру – і є його внутрішню локальну адресау.</p>
<p>Внутрішня глобальна адресаа (Inside global address) – адресаа джерела, видима із зовнішньої мережі. На малюнку, коли трафік з комп'ютера відправляється на веб-сервер за адресаою <code>208.141.17.4</code>, роутер переводить внутрішню локальну адресау (local address) на внутрішню глобальну адресау (Inside global address). У цьому випадку роутер змінює адресау джерела <strong>IPv4</strong> з <code>192.168.1.5</code>.<code>208.141.16.5</code></p>
<p>Зовнішня глобальна адресаа (Outside global address) – адресаа адресаата, видима із зовнішньої мережі. Це IP-адресаа, що глобально маршрутизується, призначена хосту в інтернеті. На схемі веб-сервер доступний за адресаою <code>208.141.17.4</code>. Найчастіше зовнішні локальні та зовнішні глобальні адресаи однакові.</p>
<p>Зовнішня локальна адресаа (Outside local address) – адресаа одержувача, видима з внутрішньої мережі. У цьому прикладі комп'ютер відправляє трафік на веб-сервер за адресаою<code>208.141.17.4</code></p>
<p>Тепер давай розглянемо весь шлях проходження пакета. Комп'ютер з адресаою <code>192.168.1.5</code>намагається встановити зв'язок з веб-сервером <code>208.141.17.4</code>. Коли пакет прибуває в маршрутизатор з підтримкою NAT, він зчитує IP-адресау призначення пакета, щоб визначити, чи пакет відповідає критеріям, зазначеним для перекладу. У цьому прикладі вихідна адресаа відповідає критеріям і перекладається <code>192.168.1.5</code>(Inside local address) на <code>208.141.16.5</code>(Inside global address).</p>
<p>Роутер додає це зіставлення локального в глобальну адресау таблицю NAT і відправляє пакет з переведеним адресаою джерела до пункту призначення. Веб-сервер відповідає пакетом, адресаованим внутрішній глобальній адресаі ПК ( <code>208.141.16.5</code>).</p>
<p>Роутер отримує пакет з адресаою призначення <code>208.141.16.5</code>та перевіряє таблицю NAT, в якій знаходить запис для цього зіставлення. Він використовує цю інформацію і переводить назад внутрішню глобальну адресау ( <code>208.141.16.5</code>) на внутрішню локальну адресау ( <code>192.168.1.5</code>), пакет перенаправляється у бік ПК.</p>
<h2>5.5 Переваги та недоліки NAT</h2>
<p>Сервіс NAT – це дуже сильне рішення, яке використовується повсюдно. NAT надає <strong>безліч переваг</strong> , у тому числі:</p>
<ul>
 <li>NAT зберігає зареєстровану схему адресаації, забезпечуючи гнучку роботу локальних мереж. При NAT внутрішні хости можуть спільно використовувати одну публічну IP-адресау всім зовнішніх комунікацій. У цьому типі конфігурації потрібно дуже мало зовнішніх адреса для підтримки багатьох внутрішніх хостів.</li>
 <li>NAT збільшує гнучкість з'єднань з інтернетом. Численні пули, пули резервного копіювання та пули балансування навантаження можуть бути реалізовані для забезпечення надійних загальнодоступних мережних підключень.</li>
 <li>NAT забезпечує узгодженість внутрішніх схем адресаації мережі. У мережі, яка не використовує приватні IP-адресаи та NAT, зміна загальної схеми IP-адреса вимагає переадресаації всіх хостів у існуючій мережі. Вартість переадресаації хостів може бути значною. NAT дозволяє існуючій приватній схемі IPv4 залишатися, дозволяючи легко змінювати нову схему загальнодоступної адресаації. Це означає, що організація може змінювати провайдерів і не потрібно міняти жодного зі своїх внутрішніх клієнтів.</li>
 <li>NAT <strong>забезпечує мережеву безпеку</strong> . Оскільки приватні мережі не рекламують свої адресаи або внутрішню топологію, вони залишаються досить надійними під час використання разом із NAT щоб одержати контрольованого зовнішнього доступу. Однак потрібно розуміти, що NAT не замінює фаєрволи.</li>
</ul>
<p>Але у NAT є деякі <strong>недоліки</strong> . Той факт, що хости в інтернеті, мабуть, безпосередньо взаємодіють із пристроєм з підтримкою NAT, а не з фактичним хостом усередині приватної мережі, створює низку проблем:</p>
<ul>
 <li>Один із недоліків використання NAT пов'язаний із продуктивністю мережі, особливо для протоколів реального часу, таких як VoIP. NAT збільшує затримки перемикання, тому що переклад кожної IP-адресаи в заголовках пакетів потребує часу.</li>
 <li>Іншим недоліком використання NAT є те, що наскрізна адресаація втрачається. Багато інтернет-протоколів та програм залежать від наскрізної адресаації від джерела до місця призначення. Деякі програми не працюють із NAT. Програми, які використовують фізичні адресаи, а не кваліфіковане доменне ім'я, не доходять до адресаатів, які транслюються через маршрутизатор NAT. Іноді цього можна уникнути, реалізуючи статичні зіставлення NAT.</li>
 <li>Також втрачається наскрізне трасування IPv4. Складніше трасувати пакети, які зазнають численних змін адреса пакетів протягом декількох NAT-переходів, що ускладнює пошук і усунення несправностей.</li>
 <li>Використання NAT також ускладнює протоколи тунелювання, такі як IPsec, оскільки NAT змінює значення заголовків, які заважають перевіркам цілісності, що виконуються IPsec та іншими протоколами тунелювання.</li>
 <li>Служби, що вимагають ініціювання TCP-з'єднань із зовнішньої мережі, або stateless протоколи, наприклад, що використовують UDP, можуть бути порушені. Якщо маршрутизатор NAT не налаштований для підтримки таких протоколів, вхідні пакети не можуть досягти свого адресаата.</li>
</ul>